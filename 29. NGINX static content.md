См.: [NGINX Load balancer](https://github.com/sherbettt/BASH-cheats/blob/main/28.%20NGINX%20Load%20balancer.md)
<br/> См.: [типы директивы location](https://github.com/sherbettt/BASH-cheats/blob/main/27.%20NGINX%2C%20типы%20директивы%20location.md)

Имеется файл `index.html` в директории `/tmp/front`. Т.е. это - Angular-приложение (или подобное SPA), которое требует правильной настройки NGINX для корректной работы.

```nginx
<!doctype html>
<html lang="en" class="notranslate" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="google" content="notranslate"/>
  <title>VoIP PBX</title>
  <base href="/">
  <style>
    body:not(.material-icons-loaded) .mat-icon {
      display: none;
    }
    @font-face {
      font-family: 'Material Icons';
      font-style: normal;
      font-display: fallback;
      font-weight: 400;
      src:  url(assets/styles/icons/material-design-icons/MaterialIcons-Regular.woff2) format('woff2'),
            url(assets/styles/icons/material-design-icons/MaterialIcons-Regular.ttf) format('ttf');
    }
    #hideMe {
      -webkit-animation: cssAnimation 5s forwards;
      animation: cssAnimation 5s forwards;
    }
    @keyframes cssAnimation {
      0%   {opacity: 1;}
      90%  {opacity: 1;}
      100% {opacity: 0;}
    }
    @-webkit-keyframes cssAnimation {
      0%   {opacity: 1;}
      90%  {opacity: 1;}
      100% {opacity: 0;}
    }

    .bg-loader {
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: white !important;
    }
    .r-loader {
      position: fixed;
      top: calc(50% - 50px);
      left: calc(50% - 50px);
      transform: translate(-50%, -50%);
      transform: -webkit-translate(-50%, -50%);
      transform: -moz-translate(-50%, -50%);
      transform: -ms-translate(-50%, -50%);
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(lightgray, transparent);

      animation: rotating 1s linear infinite;
    }

    .r-loader::before {
      content: '';
      position: absolute;
      width: 70px;
      height: 70px;
      top: 25px;
      left: 25px;
      border-radius: 50%;
      background: white !important;
    }

    @keyframes rotating {
      from {
        transform: rotate(360deg);
      }
      to {
        transform: rotate(0deg);
      }
    }
  </style>

  <meta name="viewport" content="width=device-width, initial-scale=1">
<!--  <script src="https://telegram.org/js/telegram-web-app.js" ></script>-->
<link rel="stylesheet" href="styles.450782dab24630ab.css"></head>
<body>
  <app-root>
    <div id="loader" class="bg-loader"><div class="r-loader"></div></div>
  </app-root>
  <script>
    window.addEventListener('load',function () {
      const loader = document.getElementById("loader");
      if (loader) {

        if (window.location.pathname == '/login') {
          loader.style.opacity = '0';
        }
        else if (window.location.pathname.includes('/webapp')) {
          loader.style.opacity = '0';
        }
        else {
          loader.style.opacity = '1';
        }
      }

    });
  </script>
<script src="runtime.bd68ea7a68b0ad50.js" type="module"></script><script src="polyfills.36dbc1e4d5dd6f3e.js" type="module"></script><script src="scripts.17c6b2093de53c7f.js" defer></script><script src="main.c9d8b78e79c558cf.js" type="module"></script></body>
</html>
```


Для настройки NGINX на выдачу статического контента на порту 82 на вашем Ubuntu-подобном роутере, выполните следующие шаги:

1. Создайте конфигурационный файл для вашего сайта. Например, создайте файл `/etc/nginx/sites-available/static-content` с содержимым:

```nginx
server {
    listen 82;
    listen 192.168.96.113:82; # опционально с другого интерфейса
 #   listen 192.168.87.112:82;
    server_name _;  # Можно указать конкретное имя хоста или IP

    root /tmp/front;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
        add_header 'Access-Control-Allow-Origin' '*';  # Allow CORS
    }

    # Настройки для статических файлов
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|map)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        try_files $uri =404;
    }

    # Дополнительная настройка для js.map файлов
    location ~* \.js\.map$ {
        expires off;
        add_header Cache-Control "public, no-transform";
        try_files $uri =404;
    }
}
```

2. Активируйте конфигурацию, создав символическую ссылку:
```bash
sudo ln -s /etc/nginx/sites-available/static-content /etc/nginx/sites-enabled/
```

3. Проверьте конфигурацию NGINX на ошибки:
```bash
sudo nginx -t
sudo nginx -s reload
```

4. Если проверка прошла успешно, перезапустите NGINX:
```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

5. Откройте порт 82 в брандмауэре (если используется):
```bash
sudo ufw allow 82/tcp
  или
sudo iptables -A INPUT -p tcp --dport 82 -j ACCEPT;
sudo iptables-save > /etc/iptables.rules;
pre-up iptables-restore < /etc/iptables.rules;
apt install netfilter-persistent iptables-persistent
```

Теперь статический контент из `/tmp/front` будет доступен:
- По адресу `http://192.168.87.112:82` для внешнего доступа через eth0
- По адресу `http://192.168.96.113:82` для внешнего доступа через eth2

---------------------
---------------------

### **Директива `try_files` в NGINX**  

**`try_files`** — это директива, которая проверяет существование файлов или URI (Uniform Resource Identifier) в указанном порядке и обрабатывает первый найденный. Если ни один из вариантов не найден, можно задать fallback-действие (например, отдать `index.html`, вернуть 404 или перенаправить запрос).  

---

## **Как работает `try_files`?**  
Синтаксис:  
```nginx
try_files file1 file2 ... fallback;
```
- NGINX проверяет файлы/пути **последовательно**.
- Первый существующий файл или URI обрабатывается.
- Если ни один не найден — выполняется последний параметр (`fallback`).

---

## **Примеры использования**  

### **1. Стандартный вариант для SPA (React, Angular, Vue)**  
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```
- `$uri` — проверяет, есть ли файл с таким именем (например, `/styles.css`).  
- `$uri/` — проверяет, есть ли директория (например, `/assets/`).  
- `/index.html` — если ничего не найдено, отдаёт `index.html` (важно для SPA, где маршрутизация на клиенте).  

### **2. Отдача статики с fallback на 404**  
```nginx
location ~* \.(js|css|png|jpg)$ {
    try_files $uri =404;
}
```
- Если файл (например, `/script.js`) существует — NGINX отдаёт его.  
- Если нет — возвращает **404 Not Found**.  

### **3. Перенаправление на бэкенд (например, PHP-FPM, Node.js)**  
```nginx
location / {
    try_files $uri $uri/ /index.php?$query_string;
}
```
- Если файл не найден, запрос передаётся в `index.php` (например, для Laravel, WordPress).  

### **4. Проверка нескольких альтернативных путей**  
```nginx
location /images/ {
    try_files /cache/$uri /originals/$uri /placeholder.png;
}
```
- Сначала ищет файл в `/cache/`.  
- Если нет — в `/originals/`.  
- Если и там нет — отдаёт `placeholder.png`.  

---

## **Параметры и специальные переменные**  
| Параметр | Описание |  
|----------|----------|  
| `$uri` | Текущий URI запроса (без параметров). |  
| `$uri/` | Проверяет существование директории. |  
| `=404` | Возвращает HTTP 404, если файл не найден. |  
| `=503` | Возвращает HTTP 503 (Service Unavailable). |  
| `@proxy` | Перенаправляет запрос на именованный location (`@proxy`). |  
| `/fallback.html` | Отдаёт указанный файл, если остальные не найдены. |  

---

## **Почему `try_files` важен?**  
1. **Оптимизация запросов** — NGINX сразу отдаёт статику без лишних проверок.  
2. **Гибкость маршрутизации** — можно задавать разные fallback-сценарии.  
3. **Поддержка SPA и ЧПУ** — если файла нет, отдаётся `index.html`, и роутинг работает на клиенте.  
4. **Защита от дублирования кода** — вместо нескольких `if` используется одна строка.  

---

## **Ваш случай (выдача статики на порту 82)**  
В вашей конфигурации:  
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```
- Если запрошен `/styles.css` → NGINX проверит его наличие в `/tmp/front/styles.css`.  
- Если запрошен `/some-route` (которого нет в файлах) → отдаст `index.html`, и фронтенд (React/Angular/Vue) обработает маршрут.  

Для статики (CSS, JS, изображения):  
```nginx
location ~* \.(js|css|png|svg)$ {
    try_files $uri =404;
}
```
- Если файл есть → отдаётся.  
- Если нет → **404 Not Found** (чтобы избежать ошибок загрузки битых ресурсов).  

---

### **Вывод**  
`try_files` — мощная директива для управления обработкой запросов в NGINX. Она позволяет:  
- Отдавать статику напрямую (без лишних запросов к бэкенду).  
- Поддерживать SPA (все маршруты ведут на `index.html`).  
- Гибко настраивать fallback-логику (404, прокси, другой файл).  

 







