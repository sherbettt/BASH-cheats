[Управление nginx](https://nginx.org/ru/docs/control.html)
<br/> [Параметры cli](https://nginx.org/ru/docs/switches.html)
<br/> [Имена сервера](https://nginx.org/ru/docs/http/server_names.html)
<br/> [Create NGINX Plus and NGINX Configuration Files](https://docs.nginx.com/nginx/admin-guide/basic-functionality/managing-configuration-files/)
<br/>

---------------------------------------------------------


### 1. Как писать конфигурацию и основные файлы

**Структура конфигурации:**
Конфигурация NGINX состоит из **директив** (команд) и **блоков** (контекстов). Директивы заканчиваются точкой с запятой `;`, блоки заключаются в фигурные скобки `{}`.

**Основные файлы и их расположение (типичное для Linux):**

*   **Основной конфигурационный файл:** `/etc/nginx/nginx.conf`
*   **Дополнительные конфиги (обычно подключаются):**
    *   `/etc/nginx/conf.d/` — папка, файлы `*.conf` отсюда автоматически подключаются в основной конфиг. **Стандартное место для виртуальных хостов (сайтов)**.
    *   `/etc/nginx/sites-available/` — хранит доступные конфиги сайтов (в Debian/Ubuntu).
    *   `/etc/nginx/sites-enabled/` — хранит симлинки на конфиги из `sites-available`, которые должны быть активны (в Debian/Ubuntu).
*   **Файлы по умолчанию:** `/etc/nginx/nginx.conf` обычно подключает файлы из `conf.d/` и `sites-enabled/` директивой `include`.
*   **Логи:** `/var/log/nginx/access.log` и `error.log`
*   **Документ рут (корневая папка сайтов по умолчанию):** `/usr/share/nginx/html/` или `/var/www/html/`

**Базовый пример конфига виртуального хоста (файл `/etc/nginx/conf.d/mysite.conf`):**

```nginx
server {
    listen 80; # Слушать порт 80 (HTTP)
    server_name mysite.ru www.mysite.ru; # Имена сервера

    # Корневая директория сайта
    root /var/www/mysite;

    # Настройки для локации "/" (главная страница)
    location / {
        index index.html index.htm; # Файлы по умолчанию
        try_files $uri $uri/ =404; # Попытаться отдать файл или папку, иначе 404
    }

    # Локация для статических файлов (картинки, css, js)
    location /static/ {
        expires 30d; # Кэшировать в браузере 30 дней
        access_log off; # Не логировать запросы к статике
    }

    # Проксирование запросов на бэкенд (например, Node.js, Gunicorn)
    location /api/ {
        proxy_pass http://localhost:3000/; # Адрес бэкенд-приложения
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Обработка ошибок
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
```

### 2. Основные контексты (блоки)

*   **`main` (глобальный):** Находится вне любых блоков. Настройки всего NGINX (worker processes, error log и т.д.).
*   **`events`:** Настройки обработки соединений на уровне ОС.
*   **`http`:** Содержит всё, что связано с HTTP-трафиком (серверы, mime types, логирование).
*   **`server`:** Определяет виртуальный хост (сайт). Может быть несколько в одном `http` блоке.
*   **`location`:** Самый важный блок. Определяет, как обрабатывать запросы к определённым URI (путям) внутри сервера. **Имеет приоритет по совпадению** (`=`, `~`, `~*`, `^~`).

### 3. Основные встроенные переменные NGINX

Переменные начинаются со знака `$`. Они часто используются в условиях и для передачи заголовков.

*   **`$host`:** Имя сервера из строки запроса или заголовка `Host`.
*   **`$remote_addr`:** IP-адрес клиента.
*   **`$request_uri`:** Полный исходный URI запроса (с аргументами).
*   **`$uri`:** Текущий нормализованный URI (без аргументов).
*   **`$args` / `$query_string`:** Аргументы запроса (часть после `?`).
*   **`$request_method`:** Метод запроса (GET, POST и т.д.).
*   **`$status`:** Код ответа HTTP (200, 404, 500).
*   **`$server_name`:** Имя сервера, которое обработало запрос (из директивы `server_name`).
*   **`$http_*`:** Значение любого заголовка запроса. Например, `$http_user_agent`, `$http_referer`.
*   **`$scheme`:** Протокол запроса (`http` или `https`).
*   **`$document_root`:** Корневая директория для текущего запроса (из директивы `root`).
*   **`$realpath_root`:** Абсолютный путь к корневой директории.

### 4. Порядок работы и проверки

1.  **Синтаксис:** После правки конфига **всегда** проверяй его:
    ```bash
    sudo nginx -t
    ```
    Команда покажет ошибки и предупреждения. Если всё ок — `test is successful`.

2.  **Применение изменений:** После успешной проверки:
    ```bash
    sudo systemctl reload nginx  # "Горячая" перезагрузка без разрыва соединений
    # ИЛИ
    sudo systemctl restart nginx # Полный перезапуск (реже)
    ```

3.  **Логи:** Если что-то не работает, смотри логи:
    ```bash
    sudo tail -f /var/log/nginx/error.log
    sudo tail -f /var/log/nginx/access.log
    ```

### Краткий алгоритм для настройки нового сайта:

1.  Создай папку для файлов сайта, например, `/var/www/mysite`.
2.  Создай конфиг в `/etc/nginx/conf.d/mysite.conf`.
3.  Пропиши в нём блок `server` с `server_name` и `root`.
4.  Настрой нужные `location` блоки (статику, проксирование).
5.  Выполни `sudo nginx -t`.
6.  Выполни `sudo systemctl reload nginx`.




-----------------------------------------
1. Узнать пользователя и группу приложения nginx:
   ```bash
    # getent passwd | grep 'www'; getent group | grep 'www'
    www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
    www-data:x:33:
   ```
2. Узнать процесс nginx:
   ```bash
    ┌─ root /etc/nginx/sites-available 
    ─ test-gw 
    └─ # ps aux|grep nginx|grep -v grep
    root       12433  0.0  0.0  10364  1428 ?        Ss   09:07   0:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
    www-data   12434  0.0  0.2  12064  5012 ?        S    09:07   0:00 nginx: worker process
    www-data   12435  0.0  0.2  12064  4756 ?        S    09:07   0:00 nginx: worker process
    ┌─ root /etc/nginx/sites-available 
    ─ test-gw 
    └─ # ps axw -o pid,ppid,user,%cpu,vsz,wchan,command | egrep '(nginx|PID)'
      PID    PPID USER     %CPU    VSZ WCHAN  COMMAND
    12433       1 root      0.0  10364 sigsus nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
    12434   12433 www-data  0.0  12064 do_epo nginx: worker process
    12435   12433 www-data  0.0  12064 do_epo nginx: worker process
    12764   11865 root      0.0   3328 pipe_r grep -E (nginx|PID)
   ```
3. Параметры командной строки nginx
    - `nginx -t` - тестирование конфигурационного файла: nginx проверяет синтаксическую правильность конфигурации, а затем пытается открыть файлы, описанные в конфигурации.
    - `nginx -T` - то же, что и -t, а также вывод конфигурационных файлов в стандартный поток вывода (1.9.2).
    - `nginx -g <директивы>` - задание [глобальных директив конфигурации](https://nginx.org/ru/docs/ngx_core_module.html).
    - `nginx -s reload` - перезагрузка конфигурации, старт нового рабочего процесса с новой конфигурацией, плавное завершение старых рабочих процессов.



