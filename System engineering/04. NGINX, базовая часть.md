[Управление nginx](https://nginx.org/ru/docs/control.html)
<br/> [Параметры cli](https://nginx.org/ru/docs/switches.html)
<br/> [Имена сервера](https://nginx.org/ru/docs/http/server_names.html)
<br/> [Create NGINX Plus and NGINX Configuration Files](https://docs.nginx.com/nginx/admin-guide/basic-functionality/managing-configuration-files/)
<br/>

---------------------------------------------------------
[Документация](https://nginx.org/ru/docs/)
<br/> [Алфавитный указатель переменных](https://nginx.org/ru/docs/varindex.html)
<br/> [Алфавитный указатель директив](https://nginx.org/ru/docs/dirindex.html)

---------------------------------------------------------
<br/>


### 1. Как писать конфигурацию и основные файлы

**Структура конфигурации:**
Конфигурация NGINX состоит из **директив** (команд) и **блоков** (контекстов). Директивы заканчиваются точкой с запятой `;`, блоки заключаются в фигурные скобки `{}`.

**Основные файлы и их расположение (типичное для Linux):**

*   **Основной конфигурационный файл:** `/etc/nginx/nginx.conf`
*   **Дополнительные конфиги (обычно подключаются):**
    *   `/etc/nginx/conf.d/` — папка, файлы `*.conf` отсюда автоматически подключаются в основной конфиг. **Стандартное место для виртуальных хостов (сайтов)**.
    *   `/etc/nginx/sites-available/` — хранит доступные конфиги сайтов (в Debian/Ubuntu).
    *   `/etc/nginx/sites-enabled/` — хранит симлинки на конфиги из `sites-available`, которые должны быть активны (в Debian/Ubuntu).
*   **Файлы по умолчанию:** `/etc/nginx/nginx.conf` обычно подключает файлы из `conf.d/` и `sites-enabled/` директивой `include`.
*   **Логи:** `/var/log/nginx/access.log` и `error.log`
*   **Документ рут (корневая папка сайтов по умолчанию):** `/usr/share/nginx/html/` или `/var/www/html/`

**Базовый пример конфига виртуального хоста (файл `/etc/nginx/conf.d/mysite.conf`):**

```nginx
server {
    listen 80; # Слушать порт 80 (HTTP)
    server_name mysite.ru www.mysite.ru; # Имена сервера

    # Корневая директория сайта
    root /var/www/mysite;

    # Настройки для локации "/" (главная страница)
    location / {
        index index.html index.htm; # Файлы по умолчанию
        try_files $uri $uri/ =404; # Попытаться отдать файл или папку, иначе 404
    }

    # Локация для статических файлов (картинки, css, js)
    location /static/ {
        expires 30d; # Кэшировать в браузере 30 дней
        access_log off; # Не логировать запросы к статике
    }

    # Проксирование запросов на бэкенд (например, Node.js, Gunicorn)
    location /api/ {
        proxy_pass http://localhost:3000/; # Адрес бэкенд-приложения
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Обработка ошибок
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
```

### 2. Основные контексты (блоки)

*   **`main` (глобальный):** Находится вне любых блоков. Настройки всего NGINX (worker processes, error log и т.д.).
*   **`events`:** Настройки обработки соединений на уровне ОС.
*   **`http`:** Содержит всё, что связано с HTTP-трафиком (серверы, mime types, логирование).
*   **`server`:** Определяет виртуальный хост (сайт). Может быть несколько в одном `http` блоке.
*   **`location`:** Самый важный блок. Определяет, как обрабатывать запросы к определённым URI (путям) внутри сервера. **Имеет приоритет по совпадению** (`=`, `~`, `~*`, `^~`).

### 3. Основные встроенные переменные NGINX

Переменные начинаются со знака `$`. Они часто используются в условиях и для передачи заголовков.

*   **`$host`:** Имя сервера из строки запроса или заголовка `Host`.
*   **`$remote_addr`:** IP-адрес клиента.
*   **`$request_uri`:** Полный исходный URI запроса (с аргументами).
*   **`$uri`:** Текущий нормализованный URI (без аргументов).
*   **`$args` / `$query_string`:** Аргументы запроса (часть после `?`).
*   **`$request_method`:** Метод запроса (GET, POST и т.д.).
*   **`$status`:** Код ответа HTTP (200, 404, 500).
*   **`$server_name`:** Имя сервера, которое обработало запрос (из директивы `server_name`).
*   **`$http_*`:** Значение любого заголовка запроса. Например, `$http_user_agent`, `$http_referer`.
*   **`$scheme`:** Протокол запроса (`http` или `https`).
*   **`$document_root`:** Корневая директория для текущего запроса (из директивы `root`).
*   **`$realpath_root`:** Абсолютный путь к корневой директории.

### 4. Порядок работы и проверки

1.  **Синтаксис:** После правки конфига **всегда** проверяй его:
    ```bash
    sudo nginx -t
    ```
    Команда покажет ошибки и предупреждения. Если всё ок — `test is successful`.

2.  **Применение изменений:** После успешной проверки:
    ```bash
    sudo systemctl reload nginx  # "Горячая" перезагрузка без разрыва соединений
    # ИЛИ
    sudo systemctl restart nginx # Полный перезапуск (реже)
    ```

3.  **Логи:** Если что-то не работает, смотри логи:
    ```bash
    sudo tail -f /var/log/nginx/error.log
    sudo tail -f /var/log/nginx/access.log
    ```

### Краткий алгоритм для настройки нового сайта:

1.  Создай папку для файлов сайта, например, `/var/www/mysite`.
2.  Создай конфиг в `/etc/nginx/conf.d/mysite.conf`.
3.  Пропиши в нём блок `server` с `server_name` и `root`.
4.  Настрой нужные `location` блоки (статику, проксирование).
5.  Выполни `sudo nginx -t`.
6.  Выполни `sudo systemctl reload nginx`.
<br/>

------------------------------------------------

## Пример 1.

Это **основной конфигурационный файл NGINX** (`nginx.conf`), который задаёт глобальные настройки. Давайте разберём его по блокам:

<details>
<summary>❗ `/etc/nginx/nginx.conf` ❗</summary>

```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # Virtual Host Configs
        ##

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
}


#mail {
#       # See sample authentication script at:
#       # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#       # auth_http localhost/auth.php;
#       # pop3_capabilities "TOP" "USER";
#       # imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#       server {
#               listen     localhost:110;
#               protocol   pop3;
#               proxy      on;
#       }
#
#       server {
#               listen     localhost:143;
#               protocol   imap;
#               proxy      on;
#       }
#}
```
</details>

## 1. Основные настройки (Main Context)
```nginx
user www-data;                     # NGINX будет работать от имени пользователя www-data
worker_processes auto;             # Автоматически определять количество worker-процессов (по числу CPU ядер)
pid /run/nginx.pid;                # Файл, куда записывается PID основного процесса
error_log /var/log/nginx/error.log; # Лог ошибок
include /etc/nginx/modules-enabled/*.conf; # Подключает динамические модули
```

## 2. Блок Events (обработка соединений)
```nginx
events {
    worker_connections 768;        # Каждый worker может обрабатывать 768 одновременных соединений
    # multi_accept on;             # Закомментировано - не принимать сразу несколько соединений
}
```
**Максимальное число соединений** = `worker_processes × worker_connections`

## 3. HTTP блок (самая важная часть)

### **Базовые настройки:**
```nginx
sendfile on;                       # Использовать sendfile() для отправки файлов (быстрее)
tcp_nopush on;                     # Оптимизация отправки пакетов
types_hash_max_size 2048;          # Макс размер хэша для MIME-типов
# server_tokens off;               # Закомментировано - NGINX показывает свою версию в заголовках (небезопасно!)
```

### **MIME-типы:**
```nginx
include /etc/nginx/mime.types;     # Подключает файл соответствий расширений → MIME-типов
default_type application/octet-stream; # Тип по умолчанию для неизвестных файлов (скачивание)
```

### **SSL настройки:**
```nginx
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Разрешённые протоколы
ssl_prefer_server_ciphers on;      # Предлагать свои шифры, а не клиентские
```
⚠️ **Проблема:** `TLSv1` и `TLSv1.1` устарели и небезопасны! Нужно удалить их.

### **Логирование:**
```nginx
access_log /var/log/nginx/access.log; # Лог всех запросов
```

### **Сжатие Gzip:**
```nginx
gzip on;                          # Включить сжатие
# остальные настройки gzip закомментированы (используются значения по умолчанию)
```
Если раскомментировать остальные директивы, можно тонко настроить сжатие.

### **Подключение конфигов виртуальных хостов:**
```nginx
include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
```
**Это ключевые строки!** Они загружают:
- Все файлы `.conf` из `/etc/nginx/conf.d/`
- Все файлы из `/etc/nginx/sites-enabled/` (в нашем случае - симлинк на `default`)

## 4. Mail блок (закомментирован)
```nginx
#mail {
#   ... конфигурация почтового прокси ...
#}
```
Не используется, так как NGINX настроен только как веб-сервер.

## Что происходит при запуске NGINX?

1. **Читается `nginx.conf`** (этот файл)
2. **Подключаются модули** из `modules-enabled/`
3. **Создаются worker-процессы** (кол-во = число CPU ядер)
4. **Настраивается обработка HTTP-соединений** (через events)
5. **Загружаются MIME-типы** из `mime.types`
6. **Подключаются конфиги сайтов** из:
   - `conf.d/*.conf` (пусто)
   - `sites-enabled/*` (симлинк на `/etc/nginx/sites-available/default`)

## Проблемы в этой конфигурации:

1. **`server_tokens off;`** закомментирован → NGINX показывает версию в заголовках (информация для хакеров)
2. **Устаревшие SSL протоколы** (TLSv1, TLSv1.1) - нужно удалить
3. **Нет настроенных шифров SSL** (`ssl_ciphers`) - уязвимость к слабым шифрам
4. **Нет настроек безопасности** (X-Frame-Options, CSP и др.)
5. **Много закомментированных оптимизаций** в gzip

## Рекомендации по улучшению:

```nginx
# В блоке http добавить:
# 1. Безопасность SSL
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;

# 2. Безопасные заголовки
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;

# 3. Оптимизация производительности
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# 4. Ограничения
client_max_body_size 10m;          # Максимальный размер тела запроса
client_body_timeout 12;            # Таймаут чтения тела запроса
```

## Как это работает с нашим конфигом Jira?

**Иерархия конфигурации:**
1. `nginx.conf` (основные настройки)
2. ↓ включает → `sites-enabled/default` (конфиг Jira)
3. ↓ проксирует → Jira на `192.168.87.219:8080`

Таким образом, `nginx.conf` задаёт **общие параметры**, а конкретные сайты настраиваются в отдельных файлах.

------------------------------------------------

## Пример 2.

## Анализ структуры каталогов

<details>
<summary>❗ /etc/nginx/sites-available/default ❗</summary>

```nginx
server {
        listen 80 default_server;
        listen [::]:80 default_server;
        return 301 https://jira.runtel.ru$request_uri;
}
server {
        listen 443 ssl default_server;
        root /var/www/html;

        proxy_set_header X-Forwarded-Proto $scheme;

        server_name jira.runtel.ru;
        ssl_certificate /etc/nginx/runtel.pem;
        ssl_certificate_key /etc/nginx/runtel.pem;

        location / {
                client_max_body_size 20m;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'Upgrade';
                proxy_read_timeout 1200;
                proxy_connect_timeout 1200;
                proxy_next_upstream error timeout invalid_header http_500 http_502 http_403;        
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://192.168.87.219:8080;
        }


}

```
</details>


```bash
drwxr-xr-x   2 root root 4,0K июл 29 14:53 snippets/       # Общие фрагменты конфигов
-rw-r--r--   1 root root 5,2K июн 14  2025 runtel.pem      # SSL сертификат (скорее всего, объединенный)
-rw-r--r--   1 root root 1,5K мар 14  2023 nginx.conf      # Главный конфиг
```

Видим, что используется **Debian/Ubuntu-style структура** с `sites-available`/`sites-enabled`.

## Разбор конфига `sites-available/default`

### **Первый блок `server` (HTTP → HTTPS редирект):**

```nginx
server {
    listen 80 default_server;           # Слушает порт 80 для всех доменов на этом IP
    listen [::]:80 default_server;      # IPv6 версия
    return 301 https://jira.runtel.ru$request_uri;  # Постоянный редирект на HTTPS
}
```
**Что делает:** Любой HTTP-запрос (порт 80) будет перенаправлен на HTTPS версию того же URL.
- `default_server` — обрабатывает запросы ко всем доменам, не попавшим в другие `server` блоки
- `$request_uri` — сохраняет оригинальный путь запроса после редиректа

---

### **Второй блок `server` (HTTPS обработка):**

```nginx
server {
    listen 443 ssl default_server;      # Слушает HTTPS, тоже default_server
    root /var/www/html;                 # Корневая директория (не используется с proxy_pass)

    proxy_set_header X-Forwarded-Proto $scheme;  # Передает протокол в бэкенд
    
    server_name jira.runtel.ru;         # Обрабатывает только этот домен
    ssl_certificate /etc/nginx/runtel.pem;      # SSL серт
    ssl_certificate_key /etc/nginx/runtel.pem;  # И ключ в том же файле
```

**Важный момент:** Используется один файл `.pem` и для сертификата, и для приватного ключа — это объединенный файл (обычно содержит: приватный ключ + сертификат + цепочку доверия).

---

### **Блок `location /` (проксирование):**

```nginx
location / {
    client_max_body_size 20m;           # Макс размер загружаемого файла 20 МБ
    
    # WebSocket поддержка для real-time функций Jira
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'Upgrade';
    
    # Таймауты увеличены для долгих операций
    proxy_read_timeout 1200;            # 20 минут
    proxy_connect_timeout 1200;         # 20 минут
    
    # Поведение при ошибках бэкенда
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_403;
    
    # Передача информации о клиенте в бэкенд
    proxy_set_header X-Forwarded-Proto $scheme;  # http или https
    proxy_set_header Host $host;                 # Оригинальный хост из запроса
    proxy_set_header X-Real-IP $remote_addr;     # Реальный IP клиента
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка прокси
    
    proxy_pass http://192.168.87.219:8080;       # Куда проксировать
}
```

**Переменные NGINX в этом конфиге:**
- `$request_uri` — полный URI запроса (с параметрами)
- `$scheme` — протокол (`http`/`https`)
- `$http_upgrade` — значение заголовка `Upgrade` из запроса
- `$host` — домен из заголовка `Host` запроса
- `$remote_addr` — IP клиента
- `$proxy_add_x_forwarded_for` — добавляет IP клиента к существующему заголовку X-Forwarded-For

## Что делает вся эта конфигурация?

1. **Все HTTP запросы** (порт 80) перенаправляются на HTTPS (порт 443)
2. **HTTPS трафик** для домена `jira.runtel.ru` принимается NGINX
3. NGINX **терминирует SSL** (расшифровывает HTTPS)
4. Запрос **проксируется на внутренний сервер** `192.168.87.219:8080` (Jira на порту 8080)
5. Jira получает запрос **как HTTP** (без шифрования), но с правильными заголовками о клиенте

## Проблемы и рекомендации:

1. **`root /var/www/html;`** — бесполезен, так как всё проксируется. Можно убрать.
2. **`default_server` на порту 443** — потенциально опасно. Если на IP придет запрос с другим доменом, он получит сертификат для `jira.runtel.ru` → ошибка SSL.
3. **SSL конфигурация упрощена** — нет параметров шифров, протоколов. В продакшене нужно добавить:
   ```nginx
   ssl_protocols TLSv1.2 TLSv1.3;
   ssl_ciphers '...';
   ssl_prefer_server_ciphers off;
   ```
4. **Нет кэширования статики** — Jira отдает много статических файлов (CSS, JS), их можно кэшировать в NGINX:
   ```nginx
   location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
       expires 1y;
       add_header Cache-Control "public, immutable";
   }
   ```
5. **Дублирование** — `proxy_set_header X-Forwarded-Proto $scheme;` указано дважды (внутри и снаружи `location`)

## Проверка и применение:
```bash
# Проверить синтаксис
sudo nginx -t

# Посмотреть, какие конфиги загружены
sudo nginx -T

# Перезагрузить конфиг
sudo systemctl reload nginx
```
<br/>


-----------------------------------------
1. Узнать пользователя и группу приложения nginx:
   ```bash
    # getent passwd | grep 'www'; getent group | grep 'www'
    www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
    www-data:x:33:
   ```
2. Узнать процесс nginx:
   ```bash
    ┌─ root /etc/nginx/sites-available 
    ─ test-gw 
    └─ # ps aux|grep nginx|grep -v grep
    root       12433  0.0  0.0  10364  1428 ?        Ss   09:07   0:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
    www-data   12434  0.0  0.2  12064  5012 ?        S    09:07   0:00 nginx: worker process
    www-data   12435  0.0  0.2  12064  4756 ?        S    09:07   0:00 nginx: worker process
    ┌─ root /etc/nginx/sites-available 
    ─ test-gw 
    └─ # ps axw -o pid,ppid,user,%cpu,vsz,wchan,command | egrep '(nginx|PID)'
      PID    PPID USER     %CPU    VSZ WCHAN  COMMAND
    12433       1 root      0.0  10364 sigsus nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
    12434   12433 www-data  0.0  12064 do_epo nginx: worker process
    12435   12433 www-data  0.0  12064 do_epo nginx: worker process
    12764   11865 root      0.0   3328 pipe_r grep -E (nginx|PID)
   ```
3. Параметры командной строки nginx
    - `nginx -t` - тестирование конфигурационного файла: nginx проверяет синтаксическую правильность конфигурации, а затем пытается открыть файлы, описанные в конфигурации.
    - `nginx -T` - то же, что и -t, а также вывод конфигурационных файлов в стандартный поток вывода (1.9.2).
    - `nginx -g <директивы>` - задание [глобальных директив конфигурации](https://nginx.org/ru/docs/ngx_core_module.html).
    - `nginx -s reload` - перезагрузка конфигурации, старт нового рабочего процесса с новой конфигурацией, плавное завершение старых рабочих процессов.



