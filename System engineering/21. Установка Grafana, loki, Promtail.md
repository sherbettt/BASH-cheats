# Установка

Статья для руководства [Установка и использование Grafana Loki на Linux](https://www.dmosk.ru/instruktions.php?object=grafana-loki)

## Установка необходимых компонент
```bash
apt install -y iptables-persistent
apt install -y wget curl git
```


## Правила iptables для портов
Забегая вперёд, есть смысл заранее разрешить правила для портов.
```bash
iptables -I INPUT 1 -p tcp --dport 3100 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 9080 -j ACCEPT
netfilter-persistent save
iptables -L -nv
```


## Установка Go
Смотрим [доступные версии GO](https://go.dev/dl/) и качаем.
```bash
cd /usr/local/
wget https://go.dev/dl/go1.25.1.linux-amd64.tar.gz
tar -xvf go1.25.1.linux-amd64.tar.gz
```
Редактируем **`/etc/profile`**, добавляя вниз:
```ini
export PATH=$PATH:/usr/local/go/bin
```
И один раз выполняем данную команду: ***`export PATH=$PATH:/usr/local/go/bin`***
```sh
root@app /usr/local/go
14:04:20 # go version
go version go1.25.1 linux/amd64
```


## Установка Grafana
Увы, но для РФ бинарники отсюда https://dl.grafana.com/grafana/release/12.1.1/grafana_12.1.1_16903967602_linux_amd64.deb недоступны.
<br/> Будем использовать ссылку https://dl.grafana.com/oss/release/grafana_12.1.1_amd64.deb

```
root@loki-grafana /etc/promtail
10:55:46 # ss -tlnp | grep 3000
LISTEN 0      4096               *:3000             *:*    users:(("grafana",pid=22100,fd=22))  
```

После установки отредактируем конфиг. файл **`/etc/grafana/grafana.ini`**:
```ini
### общие настройки пользователей

[users]
# Разрешить самостоятельную регистрацию
allow_sign_up = false

# Разрешить создание организаций
allow_org_create = false

# Автоматически назначать организацию для новых пользователей
auto_assign_org = true

# ID организации по умолчанию
auto_assign_org_id = 1

# Роль по умолчанию для новых пользователей (Viewer, Editor, Admin)
auto_assign_org_role = Viewer
```
```ini
### секции аутентификации - от них зависит, как создаются пользователи

[auth.anonymous]
# Анонимный доступ
enabled = false

[auth.basic]
# Базовая аутентификация
enabled = true
```
```ini
### Внешние провайдеры (LDAP, OAuth, SAML и др.)

[auth.ldap]
enabled = true
config_file = /etc/grafana/ldap.toml

[auth.github]
enabled = false
```


После чего можно в CLI создавать пользователей:
```bash
curl -X POST -H "Content-Type: application/json" \
-d '{"name":"User","email":"user@example.com","login":"user","password":"password"}' \
http://admin:admin@localhost:3000/api/admin/users
```
```bash
curl -X POST http://192.168.87.209:3000/api/admin/users \
  -H "Content-Type: application/json" \
  -d '{
    "name":"Kirill Korablin",
    "email":"k@runtel.ru",
    "login":"kkorablin",
    "password":"securepassword"
  }' \
  -u admin:admin_password
```


## Установка Loki
```bash
# Скачиваем последнюю версию Loki
wget https://github.com/grafana/loki/releases/download/v3.4.5/loki_3.4.5_amd64.deb

# Устанавливаем
sudo dpkg -i loki_3.4.5_amd64.deb
sudo apt --fix-broken install -y

loki --version
loki, version 3.4.5 (branch: release-3.4.x, revision: b2c87ba6)
```


## Установка Promtail
```bash
# Скачиваем последнюю версию Promtail
wget https://github.com/grafana/loki/releases/download/v2.9.5/promtail_2.9.5_amd64.deb

# Устанавливаем
sudo dpkg -i promtail_2.9.5_amd64.deb
sudo apt --fix-broken install -y

promtail --version
promtail, version 2.9.5 (branch: release-2.9.x, revision: eee3598)
```


## Установка logcli
Проверить **`/etc/resolv.conf`**, должно быть:
```ini
# --- BEGIN PVE ---
nameserver 8.8.8.8
nameserver 1.1.1.1
nameserver 77.88.8.8
# --- END PVE ---
```
Проверка сетевой доступности github:
```bash
ping -c 3 185.199.108.133
nslookup github.com 8.8.8.8
nslookup github.com 1.1.1.1
```

```bash
wget https://github.com/grafana/loki/releases/download/v3.5.3/logcli_3.5.3_amd64.deb
dpkg -i logcli_3.5.3_amd64.deb
logcli --version
```
Или прямое скачивание:
```bash
curl -L -o logcli.deb https://github.com/grafana/loki/releases/download/v3.5.3/logcli_3.5.3_arm64.deb
```

Проверка логов:
```bash
logcli series --addr=http://localhost:3100 '{}'
logcli series --addr=http://localhost:3100 '{job="varlogs"}'
logcli series --addr=http://localhost:3100 '{job="syslog"}'
logcli series --addr=http://localhost:3100 '{job="auth"}'
logcli series --addr=http://localhost:3100 '{job="runtel-logs-60"}'
logcli query --addr=http://localhost:3100 '{job=~"varlogs|syslog|runtel*"}'
logcli series --addr=http://localhost:3100 '{service_name="runtel-logs-209"}'
logcli query --addr=http://localhost:3100 '{job="runtel-logs-209",level="error"}'

# Проверим логи с машины 60
logcli query --addr=http://localhost:3100 '{job=~".*-60"}' --limit=10
logcli query --addr=http://localhost:3100 '{job=~".*-60"}' --limit=20

# Логи за последний час
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --since=1h

# Логи с лимитом
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --limit=20
```

Проверка меток:
```bash
# Все доступные label names
logcli labels --addr=http://localhost:3100

# Значения для конкретной метки
logcli labels --addr=http://localhost:3100 job
```

<br/>



# Конфигурирование

## Создание конфигурационных файлов

Создаём файл **`/etc/loki/loki-config.yml`**
<details>
<summary>❗loki-config.yml❗</summary>

```yml
auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  path_prefix: /tmp/loki
  storage:
    filesystem:
      chunks_directory: /tmp/loki/chunks
      rules_directory: /tmp/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory

limits_config:
  allow_structured_metadata: false  # для отключения structured metadata

query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 100

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

analytics:
  reporting_enabled: false
```
</details>  


Создаём файл **`/etc/promtail/promtail-config.yml`**
<details>
<summary>❗promtail-config.yml❗</summary>

```yml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push
#  - url: http://192.168.87.60:3100/loki/api/v1/push
#  - url: http://192.168.87.209:3100/loki/api/vq/push


scrape_configs:
- job_name: system-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*.log

- job_name: grafana-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: grafana-209
      __path__: /var/log/grafana/*.log

- job_name: syslog-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog-209
      __path__: /var/log/syslog

- job_name: auth-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth-209
      __path__: /var/log/auth.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\w{3} \d{1,2} \d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<daemon>\S+)(?:\[(?P<pid>\d+)\])?: (?P<message>.*)'
    - labels:
        daemon:


- job_name: runtel-logs-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: runtel-logs-209
      __path__: /var/log/runtel/*.log
  pipeline_stages:
    - regex:
        expression: '^\s*(?P<timestamp>\d{2}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \| (?P<pid>\d+) \| (?P<module>[^|]+) \| (?P<function>[^:]+):(?P<line>\d+) \| (?P<level>\w+) \| (?P<message>.*)'
    - labels:
        level:
        module:
```
</details> 




Создаём файл **`/etc/promtail/promtail-config.yml` на другой машине**
<details>
<summary>❗promtail-config.yml❗</summary>

```yml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
#  - url: http://localhost:3100/loki/api/v1/push
  - url: http://192.168.87.209:3100/loki/api/v1/push

scrape_configs:
- job_name: system-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs-60
      __path__: /var/log/*.log

- job_name: grafana-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: grafana-60
      __path__: /var/log/grafana/*.log

- job_name: syslog-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog-60
      __path__: /var/log/syslog

- job_name: auth-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth-60
      __path__: /var/log/auth.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\w{3} \d{1,2} \d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<daemon>\S+)(?:\[(?P<pid>\d+)\])?: (?P<message>.*)'
    - labels:
        daemon:


- job_name: runtel-logs-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: runtel-logs-60
      host: app-60
      __path__: /var/log/runtel/*.log
  pipeline_stages:
    - regex:
        expression: '^\s*(?P<timestamp>\d{2}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \| (?P<pid>\d+) \| (?P<module>[^|]+) \| (?P<function>[^:]+):(?P<line>\d+) \| (?P<level>\w+) \| (?P<message>.*)'
    - labels:
        level:
        module:
```
</details> 




## Редактирование systemd юнитов

```ini
### /etc/systemd/system/loki.service
[Unit]
Description=Grafana Loki service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=loki
ExecStart=/usr/bin/loki -config.file /etc/loki/loki-config.yml
# Give a reasonable amount of time for the server to start up/shut down
TimeoutSec = 120
Restart = on-failure
RestartSec = 2

[Install]
WantedBy=multi-user.target
```

```ini
### /etc/systemd/system/promtail.service
[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
User=promtail
#User-root
ExecStart=/usr/bin/promtail -config.file /etc/promtail/promtail-config.yml
# Give a reasonable amount of time for promtail to start up/shut down
TimeoutSec = 60
Restart = on-failure
RestartSec = 2

[Install]
WantedBy=multi-user.target
```
<br/>



# Запуск

Для проверка и запуска используем следующие команды:
```bash 
/usr/bin/loki -config.file /etc/loki/loki-config.yml -verify-config
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml --dry-run                # запуск Promtail
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml -check-syntax
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml -inspect
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml --client.external-labels=hostname=$(hostname) -log.level=debug
```
Проверка с помощью curl
```bash
curl -s http://192.168.87.209:9080/targets | grep -iE job | sort
curl -s http://192.168.87.60:9080/targets | grep -iE job | sort | uniq
curl -s -o /dev/null -w "%{http_code}" http://192.168.87.60:9080/ready

curl -s http://192.168.87.60:9080/metrics
curl -s http://192.168.87.60:9080/metrics | grep promtail_target_entries
curl -s http://192.168.87.60:9080/metrics | grep promtail_target
curl -s http://192.168.87.60:9080/metrics | grep promtail_file

curl -s http://192.168.87.60:9080/api/v1/targets | jq .

curl -s http://192.168.87.60:9080/metrics | grep -E '(promtail_target_.*|promtail_file_.*)' | grep -v '#'
```

Проверяем в бразуере:
- http://192.168.87.209:3000 -> Grafana
- http://192.168.87.209:3100/metrics -> Loki
- http://192.168.87.209:9080/targets -> Promtail
- http://192.168.87.60:9080/targets -> Promtail на удалённой машине

текущая архитектура:
```
192.168.87.60 (app) 
    └── Promtail → логи runtel/*.log → 192.168.87.209:3100 (Loki)

192.168.87.209 (loki-grafana)
    └── Promtail → логи /var/log/*.log → localhost:3100 (Loki)
    └── Loki (порт 3100)
    └── Grafana (подключается к Loki)
```
