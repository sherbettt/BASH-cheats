# –°–æ–∑–¥–∞–Ω–∏–µ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ etcd

<details>
<summary>‚¨á ip -c a s ‚¨á</summary>

```bash
root@pmx5:~# ip -c a s
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: enp4s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master vmbr0 state UP group default qlen 1000
    link/ether 74:56:3c:40:a6:3f brd ff:ff:ff:ff:ff:ff
3: vxlan_dmznet: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master dmznet state UNKNOWN group default qlen 1000
    link/ether d6:ff:b1:9d:3d:5c brd ff:ff:ff:ff:ff:ff
4: dmznet: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether d6:ff:b1:9d:3d:5c brd ff:ff:ff:ff:ff:ff
    inet6 fe80::d4ff:b1ff:fe9d:3d5c/64 scope link 
       valid_lft forever preferred_lft forever
5: vxlan_pgnet: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master pgnet state UNKNOWN group default qlen 1000
    link/ether fa:72:12:dd:ba:d2 brd ff:ff:ff:ff:ff:ff
6: pgnet: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether fa:72:12:dd:ba:d2 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::f872:12ff:fedd:bad2/64 scope link 
       valid_lft forever preferred_lft forever
7: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 74:56:3c:40:a6:3f brd ff:ff:ff:ff:ff:ff
    inet 192.168.87.20/24 scope global vmbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::7656:3cff:fe40:a63f/64 scope link 
       valid_lft forever preferred_lft forever
8: wlp3s0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether f0:a6:54:c5:22:47 brd ff:ff:ff:ff:ff:ff
13: tap138i0: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master fwbr138i0 state UNKNOWN group default qlen 1000
    link/ether a6:c5:8f:d1:14:fb brd ff:ff:ff:ff:ff:ff
******
67: fwpr157p0@fwln157i0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master vmbr0 state UP group default qlen 1000
    link/ether be:27:3c:43:53:29 brd ff:ff:ff:ff:ff:ff
68: fwln157i0@fwpr157p0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master fwbr157i0 state UP group default qlen 1000
    link/ether ce:13:6e:15:32:4a brd ff:ff:ff:ff:ff:ff
```

</details> 
<br/>


–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–µ—Ö –Ω–æ–¥ –≤ —Å–µ—Ç–∏ `pgnet` —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π Debian 12, etcd –∏ Patroni, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### üî∑ 1. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∏ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ–¥—É)

<details>
<summary>–î–ª–∏–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä</summary>
    
**–ù–æ–¥–∞ 1:**
```bash
pct create 201 local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \
  --hostname pg-node1 \
  --cores 4 \
  --memory 4096 \
  --swap 2048 \
  --rootfs /stg/8tb:30 \      # –ü—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏
  --storage local \
  --net0 name=eth0,bridge=pgnet,ip=10.10.10.1/24,gw=10.10.10.1 \
  --unprivileged 1 \
  --start
```

**–ù–æ–¥–∞ 2:**
```bash
pct create 202 local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \
  --hostname pg-node2 \
  --cores 4 \
  --memory 4096 \
  --swap 2048 \
  --rootfs /stg/8tb:30 \      # –ü—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏
  --storage local \
  --net0 name=eth0,bridge=pgnet,ip=10.10.10.2/24,gw=10.10.10.1 \
  --unprivileged 1 \
  --start
```

**–ù–æ–¥–∞ 3:**
```bash
pct create 203 local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \
  --hostname pg-node3 \
  --cores 4 \
  --memory 4096 \
  --swap 2048 \
  --rootfs /stg/8tb:30 \      # –ü—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏
  --storage local \
  --net0 name=eth0,bridge=pgnet,ip=10.10.10.3/24,gw=10.10.10.1 \
  --unprivileged 1 \
  --start
```
</details>

### üî∑ 1. [ALT] –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω (LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
–°–æ–∑–¥–∞–¥–∏–º —Ç—Ä–∏ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Debian 12 –≤ —Å–µ—Ç–∏ `pgnet`:

```bash
for i in {1..3}; do
  pct create $((200+i)) \
    local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \
    --hostname pg-node${i} \
    --cores 4 \
    --memory 4096 \
    --swap 2048 \
    --rootfs /stg/8tb:30 \      # –ü—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏
    --storage local \           # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    --net0 name=eth0,bridge=pgnet,ip=10.10.10.${i}/24,gw=10.10.10.1 \
    --unprivileged 1 \
    --start
done
```

### üî∑ 1. [ALT2] –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω (GUI –≤–∞—Ä–∏–∞–Ω—Ç)
–ö–ª–∞—Å—Ç–µ—Ä —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- ***`https://192.168.87.20:8006/#v1:0:18:4:::::::`*** - pmx5;
- ***`https://192.168.87.6:8006/#v1:0:18:4:::::::`*** - pmx6;
- ***`https://192.168.87.17:8006/#v1:0:18:4:::::::`*** - prox4;

–ß–µ—Ä–µ–∑ GUI ProxMox —Å–æ–∑–¥–∞—ë–º —Ç—Ä–∏ –º–∞—à–∏–Ω—ã (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–¥—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ pgnet (ProxMox)) –≤ —Ä–∞–º–∫–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞:
- ***`192.168.45.201`*** - *pg1* –Ω–∞ pmx5;
- ***`192.168.45.202`*** - *pg2* –Ω–∞ pmx6;
- ***`192.168.45.204`*** - *pg3* –Ω–∞ prox4;

 –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–∞—à–∏–Ω—É `pg1` –Ω–∞ `pmx5`, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –Ω–µ—ë –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é, –≤–∫–ª—é—á–∞—è ***nat*** –¥–ª—è ***iptables***, –∞ –ø–æ—Å–ª–µ - —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—ë —Ç–∞–∫–∂–µ –≤ pmx5 —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ –∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –∑–∞–±—ã–≤ –ø–æ–º–µ–Ω—è—Ç—å IP –∞–¥—Ä–µ—Å–∞.
<br/> *–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —á–∏—Ç–∞–π –≤ —Å—Ç–∞—Ç—å–µ* **[System engineering/14. ProxMox: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/14.%20ProxMox%3A%20–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è.md)**

### üî∫ 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã
–ó–∞–π–¥–∏—Ç–µ –≤ –∫–∞–∂–¥—É—é –Ω–æ–¥—É (`pct enter 201`, `pct enter 202`, `pct enter 203`) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:
```bash
apt update && apt upgrade -y
```

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
apt install -y sudo curl wget gnupg2 software-properties-common
```

### üî∫ 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ etcd –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–∞ Proxmox –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–¥–∞—Ö
#### üîπ 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ etcd –Ω–∞ –≤—Å–µ –Ω–æ–¥—ã

–ù–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
# –î–ª—è Ubuntu/Debian
apt update
apt install -y etcd-server
apt install -y etcd-client
etcdctl version
```
####  üîπ 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ etcd
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª. 

##### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
 # EXAMPLE:
ETCD_NAME="app"
ETCD_LISTEN_CLIENT_URLS="http://192.168.87.60:2379,http://127.0.0.1:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.87.60:2379,http://127.0.0.1:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.87.60:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.87.60:2380"
ETCD_INITIAL_CLUSTER="app=http://192.168.87.60:2380,app2=http://192.168.87.61:2380,app3=http://192.168.87.62:2380"
```

<details>
<summary>Config file etcd</summary>

##### –î–ª—è pg1 (192.168.45.201):
```bash
sudo tee /etc/default/etcd <<EOF
ETCD_NAME="pg1"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_CLIENT_URLS="http://192.168.45.201:2379,http://127.0.0.1:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.45.201:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.45.201:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.45.201:2380"
ETCD_INITIAL_CLUSTER="pg1=http://192.168.45.201:2380,pg2=http://192.168.45.202:2380,pg3=http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"
EOF
```
##### –î–ª—è pg2 (192.168.45.202):
```bash
sudo tee /etc/default/etcd <<EOF
ETCD_NAME="pg2"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_CLIENT_URLS="http://192.168.45.202:2379,http://127.0.0.1:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.45.202:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.45.202:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.45.202:2380"
ETCD_INITIAL_CLUSTER="pg1=http://192.168.45.201:2380,pg2=http://192.168.45.202:2380,pg3=http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"
EOF
```

##### –î–ª—è pg3 (192.168.45.204):
```bash
### /etc/default/etcd 
ETCD_NAME="pg3"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_CLIENT_URLS="http://192.168.45.204:2379,http://127.0.0.1:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.45.204:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.45.204:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER="pg1=http://192.168.45.201:2380,pg2=http://192.168.45.202:2380,pg3=http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –Ω–µ –¥–æ–∞–≤–±–ª—è—Ç—å
ETCD_INITIAL_CLUSTER_STATE="new"
```
</details>
    
—É–¥–∞–ª–∏—Ç—å –≤—Å—ë –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/var/lib/etcd/*`, –≤—ã–ø–æ–ª–Ω–∏—Ç—å `systemctl daemon-reload`.

*–ß–∏—Ç–∞–π –ø–æ–¥—Ä–æ–±–Ω–µ–µ* **[System engineering/ProxMox: "etcd" conf file](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/ProxMox%3A%20%22etcd%22%20conf%20file.md)**


#### üîπ 3. –ó–∞–ø—É—Å–∫ etcd:
–ù–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
# –ø–æ–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∏ –¥–æ—Å—Ç—É–ø
getent passwd | grep etcd
chown -R etcd:etcd /var/lib/etcd/
chmod -R 700 /var/lib/etcd/

# –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–∏—Å
systemctl daemon-reload
systemctl enable --now etcd.service etcd2.service
systemctl status etcd.service --no-pager; systemctl status etcd2.service --no-pager;
# Alias etcd2.service - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
ll /etc/systemd/system/etcd2.service
sudo systemctl start etcd
```
#### üîπ 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:
–ù–∞ –ª—é–±–æ–π –∏–∑ –Ω–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
```bash
etcdctl --endpoints=http://192.168.45.201:2379,http://192.168.45.202:2379,http://192.168.45.204:2379 member list
etcdctl --endpoints=http://192.168.45.201:2379,http://192.168.45.202:2379,http://192.168.45.204:2379 endpoint health
etcdctl --endpoints=http://192.168.45.201:2379,http://192.168.45.202:2379,http://192.168.45.204:2379 endpoint status --write-out=table
```
```bash
root@pg1 ~ # etcdctl --endpoints=http://192.168.45.201:2379,http://192.168.45.202:2379,http://192.168.45.204:2379 endpoint status --write-out=table
+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| http://192.168.45.201:2379 | 45118786a02ebed7 |  3.4.23 |   20 kB |     false |      false |         8 |         19 |                 19 |        |
| http://192.168.45.202:2379 | ecfc677436a5045b |  3.4.23 |   20 kB |      true |      false |         8 |         19 |                 19 |        |
| http://192.168.45.204:2379 | 5585773618e2da39 |  3.4.23 |   20 kB |     false |      false |         8 |         19 |                 19 |        |
+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
```
#### –°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–æ–¥—ã –º–æ–≥—É—Ç –æ–±—â–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π –ø–æ –ø–æ—Ä—Ç–∞–º 2379 (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π) –∏ 2380 (–ø–∏—Ä–∏–Ω–≥–æ–≤—ã–π)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ firewall —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —ç—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è



# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –∏ Patroni —Å etcd –≤ –∫–∞—á–µ—Å—Ç–≤–µ DCS

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL —Å Patroni –∏ etcd –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

## ‚ô¶Ô∏è 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ –≤—Å–µ –Ω–æ–¥—ã

–ù–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ (pg1, pg2, pg3):

```bash
# –î–ª—è Ubuntu/Debian
sudo apt update
sudo apt install -y postgresql-15 postgresql-client-15 postgresql-contrib-15
psql --version
```

## ‚ô¶Ô∏è 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Patroni –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è PostgreSQL (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
apt update
apt install -y curl gnupg2

# –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π PostgreSQL
curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/postgresql.gpg >/dev/null
echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
apt update

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π Patroni
apt install -y patroni python3-etcd3 python3-psycopg2

patroni --version
```


## ‚ô¶Ô∏è 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Patroni –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (PIP).

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ pip
sudo apt install patroni python3-etcd
sudo apt install -y python3-setuptools python3-psycopg2 python3-etcd python3-requests
sudo apt install -y python3-full python3-pip python3-psycopg2

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt install python3-venv python3-pip

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv ~/patroni_venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
source ~/patroni_venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Patroni —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
pip install patroni[etcd] python-etcd

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
patroni --version

# –ù–∞—Å—Ç—Ä–æ—Å–∏—Ç—å —Ñ–∞–π–ª /etc/patroni.yml, —á–∏—Ç–∞–π –Ω–∏–∂–µ
vim /etc/patroni.yml

# –í—ã—Ö–æ–¥ –∏–∑ venv
deactivate

## ----
# –ï—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ –∑–∞—â–∏—Ç—É (–Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å–∏—Å—Ç–µ–º—É!)
pip install --break-system-packages patroni[etcd] python-etcd
```

## ‚ô¶Ô∏è 3. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ Patroni
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ Patroni
systemctl stop patroni
apt remove --purge patroni python3-patroni python3-etcd -y
apt autoremove -y

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
rm -rf /etc/patroni.yml /var/lib/postgresql/patroni/ /var/log/patroni/
```


## ‚ô¶Ô∏è 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Patroni

–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Patroni –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ (**`/etc/patroni.yml`**):

<details>
<summary>–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Patroni</summary>

### –î–ª—è pg1 (192.168.45.201):
```yaml
scope: pg_cluster
namespace: /service/
name: pg1

restapi:
  listen: 192.168.45.201:8008
  connect_address: 192.168.45.201:8008

etcd:
  hosts: ["192.168.45.201:2379", "192.168.45.202:2379", "192.168.45.204:2379"]
  protocol: http
  api_version: v3
  use_http: true
  allow_reconnect: true
  username: "root"
  password: "runtel"

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        max_connections: 100
        shared_buffers: 1GB
        dynamic_shared_memory_type: posix
        wal_level: logical
        wal_log_hints: "on"
        archive_mode: "on"
        archive_timeout: 1800s
        archive_command: "/bin/true"
        max_wal_senders: 10
        max_replication_slots: 10
        hot_standby: "on"
        wal_keep_size: 1024MB
        synchronous_commit: "on"
        synchronous_standby_names: "1 (pg2,pg3)"

  initdb:
    - encoding: UTF8
    - data-checksums

  pg_hba:
    - host replication replicator 192.168.45.0/24 md5
    - host all all 192.168.45.0/24 md5

postgresql:
  listen: 192.168.45.201:5432
  connect_address: 192.168.45.201:5432
  data_dir: /var/lib/postgresql/15/main
  bin_dir: /usr/lib/postgresql/15/bin
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: securepassword
    superuser:
      username: postgres
      password: securepassword
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```
### –î–ª—è pg2 (192.168.45.202):
```yaml
scope: pg_cluster
namespace: /service/
name: pg2

restapi:
  listen: 192.168.45.202:8008
  connect_address: 192.168.45.202:8008

etcd:
  hosts: ["192.168.45.201:2379", "192.168.45.202:2379", "192.168.45.204:2379"]
  protocol: http
  api_version: v3
  use_http: true

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        max_connections: 100
        shared_buffers: 1GB
        dynamic_shared_memory_type: posix
        wal_level: logical
        wal_log_hints: "on"
        archive_mode: "on"
        archive_timeout: 1800s
        archive_command: "/bin/true"
        max_wal_senders: 10
        max_replication_slots: 10
        hot_standby: "on"
        wal_keep_size: 1024MB
        synchronous_commit: "on"
        synchronous_standby_names: "1 (pg1,pg3)"

  initdb:
    - encoding: UTF8
    - data-checksums

  pg_hba:
    - host replication replicator 192.168.45.0/24 md5
    - host all all 192.168.45.0/24 md5

postgresql:
  listen: 192.168.45.202:5432
  connect_address: 192.168.45.202:5432
  data_dir: /var/lib/postgresql/15/main
  bin_dir: /usr/lib/postgresql/15/bin
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: securepassword
    superuser:
      username: postgres
      password: securepassword
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```
### –î–ª—è pg3 (192.168.45.204):
```yaml
scope: pg_cluster
namespace: /service/
name: pg3

restapi:
  listen: 192.168.45.204:8008
  connect_address: 192.168.45.204:8008

etcd:
  hosts: ["192.168.45.201:2379", "192.168.45.202:2379", "192.168.45.204:2379"]
  protocol: http
  api_version: v3
  use_http: true

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        max_connections: 100
        shared_buffers: 1GB
        dynamic_shared_memory_type: posix
        wal_level: logical
        wal_log_hints: "on"
        archive_mode: "on"
        archive_timeout: 1800s
        archive_command: "/bin/true"
        max_wal_senders: 10
        max_replication_slots: 10
        hot_standby: "on"
        wal_keep_size: 1024MB
        synchronous_commit: "on"
        synchronous_standby_names: "1 (pg1,pg2)"

  initdb:
    - encoding: UTF8
    - data-checksums

  pg_hba:
    - host replication replicator 192.168.45.0/24 md5
    - host all all 192.168.45.0/24 md5

postgresql:
  listen: 192.168.45.204:5432
  connect_address: 192.168.45.204:5432
  data_dir: /var/lib/postgresql/15/main
  bin_dir: /usr/lib/postgresql/15/bin
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: securepassword
    superuser:
      username: postgres
      password: securepassword
  parameters:
    unix_socket_directories: '/var/run/postgresql'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```
</details>

–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `postgres`:
```bash
getent passwd | grep postgres; getent group | grep postgres;
chown postgres:postgres /etc/patroni.yml
chmod 640 /etc/patroni.yml
```

<br/>


## ‚ô¶Ô∏è 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd –¥–ª—è Patroni

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å–µ—Ä–≤–∏—Å–∞ **`/etc/systemd/system/patroni.service`**:

```ini
[Unit]
Description=Runners to orchestrate a high-availability PostgreSQL
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
# ExecStart=/usr/local/bin/patroni /etc/patroni.yml  # –µ—Å–ª–∏ —á–µ—Ä–µ–∑ pip
ExecStart=/usr/bin/patroni /etc/patroni.yml
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
```

- –ï—Å–ª–∏ ***/usr/bin/patroni*** —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ *`ExecStart=/usr/bin/patroni /etc/patroni.yml`*.
- –ï—Å–ª–∏ ***/usr/bin/patroni*** –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –°–æ–∑–¥–∞–π—Ç–µ —Å–∏–º–ª–∏–Ω–∫ –∏ –æ—Å—Ç–∞–≤—å—Ç–µ *`ExecStart=/usr/local/bin/patroni`*.

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —á–µ—Ä–µ–∑ systemd –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é:
```bash
sudo -u postgres /usr/bin/patroni /etc/patroni.yml
```

–û–±–Ω–æ–≤–∏—Ç–µ systemd –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ Patroni:

```bash
sudo systemctl daemon-reload
sudo systemctl enable patroni
sudo systemctl start patroni
```

## ‚ô¶Ô∏è 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞

–ù–∞ –≥–ª–∞–≤–Ω–æ–π –Ω–æ–¥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, pg1) –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
sudo -u postgres patronictl -c /etc/patroni.yml init pg_cluster
```

## ‚ô¶Ô∏è 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
patronictl -c /etc/patroni.yml list
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
+---------+-----------+------------------+--------+---------+----+-----------+
| Cluster |  Member   |       Host       |  Role  |  State  | TL | Lag in MB |
+---------+-----------+------------------+--------+---------+----+-----------+
| pg_cluster |  pg1     | 192.168.45.201  | Leader | running |  1 |           |
| pg_cluster |  pg2     | 192.168.45.202  |        | running |  1 |         0 |
| pg_cluster |  pg3     | 192.168.45.204  |        | running |  1 |         0 |
+---------+-----------+------------------+--------+---------+----+-----------+
```

## ‚ô¶Ô∏è 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

```bash
sudo apt install -y pgbouncer pgadmin4
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
   - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TLS –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

2. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å –ø–æ–º–æ—â—å—é pg_basebackup –∏–ª–∏ barman

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –ø–æ–º–æ—â—å—é Prometheus + Grafana
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ pg_stat_statements –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

4. **–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ**:
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ vacuum –∏ analyze
   - –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –∏ –ª–∞–≥–∏

5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**:
   - –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ staging —Å—Ä–µ–¥–µ
   - –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ secondary -> primary

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã failover –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```bash
# –ù–∞ primary –Ω–æ–¥–µ
sudo systemctl stop postgresql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover
patronictl -c /etc/patroni.yml list
```


