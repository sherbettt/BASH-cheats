
## **1. Основы `pvesh`**
**`pvesh`** — это API-клиент Proxmox, который позволяет управлять кластером через командную строку.  
- Работает через **HTTP API** (как и веб-интерфейс).  
- Поддерживает **GET, POST, PUT, DELETE** запросы.  
- Полезен для автоматизации (скрипты, cron, задачи).  

### **Синтаксис**
```bash
pvesh <метод> <путь> [--параметры]
```
- **Методы:** `get` (чтение), `create` (создание), `set` (изменение), `delete` (удаление).  
- **Путь:** Аналогичен API (например, `/nodes/pmx5/lxc/107/snapshot`).  

---

## **2. Работа со снепшотами через `pvesh`**
### **🔹 Просмотр всех снепшотов контейнера (LXC)**
```bash
pvesh get /nodes/pmx5/lxc;
pvesh get /nodes/pmx5/lxc/107/snapshot;
 #или в json формате
pvesh get /nodes/pmx5/lxc/107/snapshot --output-format json-pretty;
```
Вывод (условно):
```
┌───────────────┬─────────┬────────┬─────────────────────┐
│ description   │ name    │ parent │ snaptime            │
╞═══════════════╪═════════╪════════╪═════════════════════╡
│ Автоснепшот   │ auto_1  │        │ 2024-05-10 00:00:00 │
│ Ручной        │ manual  │        │ 2024-05-05 12:30:00 │
└───────────────┴─────────┴────────┴─────────────────────┘
```

### **🔹 Создание снепшота**
```bash
pvesh create /nodes/pmx5/lxc/107/snapshot --snapname "auto_$(date +%Y%m%d)" \
  --description "Автоснепшот"
```
- `--snapname` — имя снепшота (лучше использовать дату).  
- `--description` — описание (необязательно).
  Сами снепшоты ищи в **`/stg/8tb/dump/`**

### **🔹 Удаление снепшота**
```bash
pvesh delete /nodes/pmx5/lxc/107/snapshot/auto_1
```
- Где `auto_1` — имя снепшота.  

### **🔹 Восстановление контейнера из снепшота**
```bash
pvesh create /nodes/pmx5/lxc/107/snapshot/auto_1/rollback
```
- Контейнер будет **перезагружен** с состоянием на момент снепшота.  

---

## **3. Примеры других полезных команд**
### **🔸 Просмотр всех контейнеров на ноде**
```bash
pvesh get /nodes/pmx5/lxc
```

### **🔸 Получение информации о контейнере**
```bash
pvesh get /nodes/pmx5/lxc/107/status
```
Вывод:
```
┌──────────────┬───────────────────────┐
│ key          │ value                 │
╞══════════════╪═══════════════════════╡
│ status       │ running               │
│ maxmem       │ 4096                  │
│ uptime       │ 123456                │
└──────────────┴───────────────────────┘
```

### **🔸 Запуск/остановка контейнера**
```bash
pvesh create /nodes/pmx5/lxc/107/status/start
pvesh create /nodes/pmx5/lxc/107/status/stop
```

### **🔸 Просмотр задач (Tasks)**
```bash
pvesh get /cluster/tasks
```

---

## **4. Фильтрация вывода (grep/jq)**
Так как `pvesh` возвращает данные в JSON или табличном формате, можно использовать:  
- **`grep`** — для простой фильтрации:  
  ```bash
  pvesh get /nodes/pmx5/lxc/107/snapshot | grep -oE 'auto_[^"]+'
  ```
- **`jq`** — для обработки JSON (установите через `apt install jq`):  
  ```bash
  pvesh get /nodes/pmx5/lxc/107/snapshot --output-format json | jq '.[].name'
  ```

---

## **5. Автоматизация (пример скрипта)**
```bash
#!/bin/bash
CTID=107
MAX_SNAPS=4

# Создать снепшот
pvesh create /nodes/pmx5/lxc/$CTID/snapshot \
  --snapname "auto_$(date +%Y%m%d_%H%M)" \
  --description "Автоснепшот"

# Удалить старые (оставить только MAX_SNAPS)
 # SNAPS=$(pvesh get /nodes/pmx5/lxc/$CTID/snapshot | jq -r '.[].name' | grep 'auto_')
SNAPS=$(pvesh get /nodes/pmx5/lxc/$CTID/snapshot --output-format json | jq -r '.[].name' | grep 'auto_')
COUNT=$(echo "$SNAPS" | wc -l)

if [ $COUNT -gt $MAX_SNAPS ]; then
    echo "$SNAPS" | head -n $(($COUNT - $MAX_SNAPS)) | while read -r SNAP; do
        pvesh delete /nodes/pmx5/lxc/$CTID/snapshot/$SNAP
        echo "Удалён снепшот: $SNAP"
    done
fi
```

---

## **6. Где искать документацию?**
- Официальная документация:  
  ```bash
  man pvesh
  ```
- Список всех API-путей:  
  ```bash
  pvesh get / --output-format json-pretty
  ```
---


### **1. Системные разделы**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/aplinfo**  | Список доступных шаблонов (Appliance) для LXC-контейнеров (Alpine, Ubuntu и др.). |
| **/nodes/pmx5/apt**      | Управление пакетами APT (обновления, список пакетов).                   |
| **/nodes/pmx5/capabilities** | Возможности ноды (поддержка KVM, LXC, типы хранилищ и т.д.).          |
| **/nodes/pmx5/config**   | Конфигурация ноды (настройки сети, DNS, имя хоста).                     |
| **/nodes/pmx5/disks**    | Информация о физических дисках (HDD, SSD, SMART-статус).                |
| **/nodes/pmx5/dns**      | Настройки DNS сервера ноды.                                             |
| **/nodes/pmx5/hosts**    | Содержимое файла `/etc/hosts` ноды.                                     |
| **/nodes/pmx5/journal**  | Системный журнал (аналог `journalctl`).                                 |
| **/nodes/pmx5/syslog**   | Просмотр системных логов (`/var/log/syslog`).                           |
| **/nodes/pmx5/time**     | Настройки времени и NTP.                                                |
| **/nodes/pmx5/version**  | Версия Proxmox VE и ядра ОС.                                            |

---

### **2. Виртуализация и контейнеры**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/lxc**      | Управление LXC-контейнерами (запуск, остановка, снепшоты).              |
| **/nodes/pmx5/qemu**     | Управление виртуальными машинами (QEMU/KVM).                            |
| **/nodes/pmx5/migrateall** | Массовая миграция всех ВМ/контейнеров на другую ноду.                  |
| **/nodes/pmx5/startall** | Запуск всех ВМ/контейнеров на ноде.                                     |
| **/nodes/pmx5/stopall**  | Остановка всех ВМ/контейнеров.                                          |
| **/nodes/pmx5/suspendall** | Приостановка (suspend) всех ВМ.                                        |

---

### **3. Сеть и хранилища**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/network**  | Настройки сетевых интерфейсов (мосты, VLAN, firewall).                   |
| **/nodes/pmx5/netstat**  | Статистика сети (аналог `netstat`).                                      |
| **/nodes/pmx5/storage**  | Управление хранилищами (локальные, NFS, Ceph, ZFS и т.д.).              |
| **/nodes/pmx5/ceph**     | Управление кластером Ceph (если подключён).                              |
| **/nodes/pmx5/sdn**      | Программно-определяемые сети (SDN) в Proxmox.                            |

---

### **4. Мониторинг и задачи**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/tasks**    | Текущие выполняемые задачи (аналог вкладки "Tasks" в GUI).              |
| **/nodes/pmx5/rrd**      | Данные для графиков мониторинга (CPU, RAM, сеть и т.д.).                |
| **/nodes/pmx5/rrddata**  | "Сырые" данные RRD (используются для визуализации в GUI).                |
| **/nodes/pmx5/report**   | Отчёт о состоянии ноды (ресурсы, хранилища, сеть).                       |
| **/nodes/pmx5/status**   | Общий статус ноды (uptime, нагрузка, версия).                            |

---

### **5. Безопасность и доступ**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/certificates** | Управление SSL-сертификатами ноды.                                     |
| **/nodes/pmx5/firewall** | Настройки firewall (правила, группы, политики).                          |
| **/nodes/pmx5/subscription** | Информация о подписке Proxmox (если есть).                             |
| **/nodes/pmx5/termproxy** | Доступ к терминалу через прокси (используется веб-интерфейсом).        |
| **/nodes/pmx5/vncshell** | Запуск VNC-сессии для доступа к консоли ноды.                            |

---

### **6. Резервное копирование**
| Путь                     | Описание                                                                 |
|--------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/vzdump**   | Управление задачами резервного копирования (аналог `vzdump`).           |
| **/nodes/pmx5/replication** | Настройки репликации ВМ/контейнеров между нодами.                      |

---

### **7. Разное**
| Путь                          | Описание                                                                 |
|-------------------------------|--------------------------------------------------------------------------|
| **/nodes/pmx5/hardware**      | Информация о железе (CPU, RAM, PCI-устройства).                         |
| **/nodes/pmx5/query-url-metadata** | Загрузка метаданных с URL (используется для импорта образов).         |
| **/nodes/pmx5/scan**         | Сканирование сети или хранилищ (например, поиск ISO-образов).            |
| **/nodes/pmx5/spiceshell**    | Доступ к SPICE-консоли (для ВМ с SPICE-графикой).                        |
| **/nodes/pmx5/wakeonlan**     | Отправка Wake-on-LAN пакетов (если поддерживается).                      |

---

### **Как использовать?**
Примеры команд:
```bash
# Просмотр всех LXC-контейнеров
pvesh get /nodes/pmx5/lxc

# Проверить состояние хранилищ
pvesh get /nodes/pmx5/storage

# Посмотреть задачи
pvesh get /nodes/pmx5/tasks

# Получить информацию о CPU/RAM
pvesh get /nodes/pmx5/status
```
```bash
# Основная информация о хранилище (тип, контент, размер)
pvesh get /nodes/pmx6/storage

# Подробности конкретного хранилища (включая путь)
cat /etc/pve/storage.cfg | grep -A 5 "storage_8tb\|ssd_1tb"
```

Для детального изучения конкретного раздела используйте:
```bash
pvesh get /nodes/pmx5/путь --output-format json-pretty
```




