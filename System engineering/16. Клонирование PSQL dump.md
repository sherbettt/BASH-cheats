## 1. Клонирование машины в ProxMox.

 Заходим в кластер по одной из ссылок:
- https://192.168.87.17:8006/#v1:0:18:4::::::: - prox4;
- https://192.168.87.20:8006/#v1:0:18:4::::::: - pmx5;
- https://192.168.87.6:8006/#v1:0:18:4::::::: - pmx6.


Исходные данные:
-  машина ***Container 102 (dmzgateway) on node 'pmx6'***, у которой три интерфейса с типом Bridge:
    - **vmbr0**: `192.168.87.2/24` (шлюз `192.168.87.1`) - внешка и-нет;
    - **dmznet**: `192.168.46.1/24` - является шлюзом для других машин в этой сети;
    - **pgnet**: `192.168.45.1/24` - является шлюзом для других машин в этой сети;
- машина ***Container 172 (keycloak) on node 'prox4'***, в сети `vmbr0` которую требуется склонировать;
- машина ***Container 272 (keycloack) on node 'prox4'***, в сети `dmznet`, которая будет создана после клонирования;
- просканировать при помощи утилиты *nmap* сеть 192.168.45.0/24 и выяснить свободные IP адреса;
- добавить в ***Container 272*** интерфейс **eth1**, статический `192.168.45.50/24` (шлюз: `192.168.45.1`); ✅

<details>
<summary>❗ root@keycloack - интерфейс ❗</summary>

```bash
root@keycloack ~ # ipc
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: eth0@if161: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether bc:24:11:38:6d:a4 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.46.16/24 brd 192.168.46.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::be24:11ff:fe38:6da4/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1@if165: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether bc:24:11:de:5b:0c brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.45.50/24 brd 192.168.45.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::be24:11ff:fede:5b0c/64 scope link 
       valid_lft forever preferred_lft forever
```
</details> 
<br/>


## 2. Создание дампа БД PostgreSQL.

### 1.Для исправления проблемы с локалями выполните:
```bash
sudo localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
export LANG=ru_RU.UTF-8
```
### 2.Для подключения к PostgreSQL требуется.
см.: [Шпаргалка по основным командам PostgreSQL](https://www.oslogic.ru/knowledge/598/shpargalka-po-osnovnym-komandam-postgresql/)

Подключиться под существующим стандартным пользователем:
```bash
cd /tmp
sudo -u postgres psql
```
Если нужно просто посмотреть список пользователей БД, проще всего использовать:
```bash
sudo -u postgres psql -c "\du"
```
```bash
                                          Список ролей
 Имя роли |                                Атрибуты                                 | Член ролей 
----------+-------------------------------------------------------------------------+------------
 keycloak |                                                                         | {}
 postgres | Суперпользователь, Создаёт роли, Создаёт БД, Репликация, Пропускать RLS | {}
```


## 3. Анализ вывода "\du".

1. **postgres** — суперпользователь с полными правами (может создавать БД, роли и управлять сервером).  
2. **keycloak** — обычная роль без особых привилегий (по умолчанию не может создавать БД или другие роли).

### Если нужно дать права пользователю `keycloak`
Сейчас `keycloak` имеет минимальные права. Если Keycloak требует доступ к своей БД, выполните:

#### 1. Создайте БД для Keycloak (если ещё не создана):
```bash
sudo -u postgres psql -c "CREATE DATABASE keycloak_db;"
```

#### 2. Дайте права пользователю `keycloak` на эту БД:
```bash
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE keycloak_db TO keycloak;"
```

#### 3. (Опционально) Если Keycloak требует права на создание схем и таблиц:
```bash
sudo -u postgres psql -c "ALTER ROLE keycloak WITH CREATEDB CREATEROLE;"
```
*(Будьте осторожны с `CREATEROLE` — это даёт право создавать других пользователей!)*

### Проверка прав:
```bash
sudo -u postgres psql -c "\l"  # Список БД и их владельцев
sudo -u postgres psql -c "\du keycloak"  # Детали роли keycloak
```


## 4. Создание дампа.








<br/>

----------------------------------------------------------------------
### Установка пароля для пользователя **postgres** в PostgreSQL

#### 1. **Войдите в консоль PostgreSQL от имени суперпользователя**:
```bash
sudo -u postgres psql
```
*(Если возникает ошибка доступа, сначала выполните `cd /tmp`)*

#### 2. **В интерактивной консоли PostgreSQL выполните**:
```sql
ALTER ROLE postgres WITH PASSWORD 'ваш_пароль';
```
Замените `ваш_пароль` на надежный пароль (например, `Str0ngP@ssw0rd!`).

#### 3. **Выйдите из консоли**:
```sql
\q
```

### Дополнительные настройки (если PostgreSQL не принимает пароль)

#### 1. **Измените метод аутентификации в `pg_hba.conf`**:
Откройте файл конфигурации:
```bash
sudo nano /etc/postgresql/15/main/pg_hba.conf
```
*(Путь может отличаться в зависимости от версии PostgreSQL и ОС. Актуальную версию можно проверить командой `ls /etc/postgresql/`)*

Найдите строку:
```
local   all             postgres                                peer
```
И замените `peer` на `md5` или `scram-sha-256`:
```
local   all             postgres                                md5
```

#### 2. **Перезапустите PostgreSQL**:
```bash
sudo systemctl restart postgresql
```

### Проверка пароля
Попробуйте подключиться с паролем:
```bash
psql -U postgres -h localhost -W
```
*(Система запросит пароль. Введите тот, что задали через `ALTER ROLE`)*


### Важные замечания:
1. **Безопасность пароля**:
   - Не используйте простые пароли вроде `12345`.
   - Рекомендуется: буквы (верхний/нижний регистр), цифры, спецсимволы (`!@#$%^&*`).

2. **Если забыли пароль**:
   - Сбросить его можно через `ALTER ROLE` (как показано выше), но для этого нужен доступ к `sudo`.

3. **Для Keycloak**:
   Если Keycloak использует PostgreSQL, задайте пароль и для его пользователя:
   ```sql
   ALTER ROLE keycloak WITH PASSWORD 'пароль_для_keycloak';
   ```

4. **Локализация**:
   Если снова появляются ошибки локали (`perl: warning`), выполните:
   ```bash
   sudo dpkg-reconfigure locales
   ```
   И выберите `ru_RU.UTF-8`.
