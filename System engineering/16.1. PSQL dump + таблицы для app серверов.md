# Проверка Лидера Patroni 

## Смотрим лидера/реплику и конфигурацию
```bash
root@app ~ > patronictl -c /etc/patroni/config.yml show-config

root@app /var/backups/postgresql > patronictl -c /etc/patroni/config.yml topology
+ Cluster: postgres ----------+---------+---------+-----+-----------+
| Member | Host               | Role    | State   |  TL | Lag in MB |
+--------+--------------------+---------+---------+-----+-----------+
| app3   | 192.168.87.62:5433 | Leader  | running | 400 |           |
| + app  | 192.168.87.60:5433 | Replica | running | 400 |         0 |
| + app2 | 192.168.87.61:5433 | Replica | running | 400 |         0 |
+--------+--------------------+---------+---------+-----+-----------+
```

## Перкключаем мастер на app сервер
```bash
# Выполняем switchover (переключение ролей)
patronictl -c /etc/patroni/config.yml switchover --candidate app --force

# Или используем более явную команду (выбираем из app, app2, app3)
patronictl -c /etc/patroni/config.yml switchover --master app --candidate app

# Проверяем результат
patronictl -c /etc/patroni/config.yml topology

# Дополнительная проверка на самой ноде app
sudo -u postgres psql -h /var/lib/postgresql/patroni -p 5433 -c "SELECT pg_is_in_recovery();"
# Если вернет 'f' - это мастер, если 't' - реплика

##--------
# Если switchover не работает
patronictl -c /etc/patroni/config.yml failover --candidate app

# Или перезапустить мастер и заставить выбрать новый
patronictl -c /etc/patroni/config.yml restart --role master
```
<br/>


# Проверка подключения БД 

## Проверка портов
```bash
root@app /var/backups/postgresql > ss -tulpn | grep -E "(5433|5432|haproxy|patroni)"
tcp   LISTEN 0      4096   192.168.87.60:7000       0.0.0.0:*    users:(("haproxy",pid=277,fd=6))                                                                                               
tcp   LISTEN 0      5      192.168.87.60:8008       0.0.0.0:*    users:(("patroni",pid=272235,fd=5))                                                                                            
tcp   LISTEN 0      4096       127.0.0.1:5434       0.0.0.0:*    users:(("haproxy",pid=277,fd=9))                                                                                               
tcp   LISTEN 0      4096       127.0.0.1:5435       0.0.0.0:*    users:(("haproxy",pid=277,fd=10))                                                                                              
tcp   LISTEN 0      4096       127.0.0.1:5433       0.0.0.0:*    users:(("haproxy",pid=277,fd=8))                                                                                               
tcp   LISTEN 0      4096   192.168.87.60:5432       0.0.0.0:*    users:(("haproxy",pid=277,fd=7))                                                                                               
tcp   LISTEN 0      4096   192.168.87.60:5433       0.0.0.0:*    users:(("postgres",pid=272546,fd=5))  
```

## Проверка подключения
```bash
root@app ~ > su - postgres 
postgres@app:~$ psql 
psql: ошибка: подключиться к серверу через сокет "/var/run/postgresql/.s.PGSQL.5432" не удалось: Нет такого файла или каталога
        Сервер действительно работает локально и принимает подключения через этот сокет?
```
Значит нужно подключаться через сокет
```bash
root@app ~ > find / -name ".s.PGSQL.5433" 2>/dev/null
/var/lib/postgresql/patroni/.s.PGSQL.5433
root@app ~ > psql -h /var/lib/postgresql/patroni -p 5433 -U postgres
psql (15.14 (Debian 15.14-0+deb12u1))
Введите "help", чтобы получить справку.

postgres=# 
```

## Найдём файл .pgpass, если он существует
```bash
root@app ~ > find / -name ".pgpass" 2>/dev/null 
/var/lib/postgresql/.pgpass
```
 Пароли БД можно посмотреть ещё в `/etc/patroni/config.yml`


## Создать директории для дампов
```bash
root@app3 ~ > mkdir -p /var/backups/postgresql/
root@app3 ~ > chown postgres:postgres /var/backups/postgresql/
```
<br/>


# Создание дампов БД

## **1. Сначала на МАСТЕРЕ (app):**

### A. Посмотреть информацию о кластере:
```bash
# На app (мастере)
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "SELECT pg_is_in_recovery();"
# Должно вернуть 'f' - значит это мастер
```

### B. Посмотреть ВСЕ базы данных:
```bash
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "\l"
```

### C. Посмотреть ВСЕХ пользователей:
```bash
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "\du+"
```

### D. Создать полный бэкап ВСЕГО кластера на мастере:
```bash
# Переходим в директорию бэкапов
cd /var/backups/postgresql/

# Создаем поддиректорию с датой
mkdir -p full_backup_$(date +%Y%m%d_%H%M)
cd full_backup_$(date +%Y%m%d_%H%M)

# 1. Бэкап глобальных объектов (роли, табличные пространства) - ТОЛЬКО НА МАСТЕРЕ!
pg_dumpall -h /var/lib/postgresql/patroni -p 5433 -U postgres -g -f globals.sql

# 2. Бэкап всех БД одним файлом
pg_dumpall -h /var/lib/postgresql/patroni -p 5433 -U postgres -f all_databases.sql

# 3. Бэкап каждой БД отдельно в custom формате (сжатый)
for DB in $(psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname NOT IN ('postgres');"); do
    echo "Создаю дамп БД: $DB"
    pg_dump -h /var/lib/postgresql/patroni -p 5433 -U postgres -Fc -Z 9 -f ${DB}.dump ${DB}
done

# 4. Создать файл с информацией
echo "=== ИНФОРМАЦИЯ О БЭКАПЕ ===" > backup_info.txt
echo "Дата: $(date)" >> backup_info.txt
echo "Сервер: app (мастер)" >> backup_info.txt
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "SELECT version();" >> backup_info.txt
echo "" >> backup_info.txt
echo "Список БД:" >> backup_info.txt
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "\l" >> backup_info.txt
```

### E. Проверить бэкап:
```bash
# Посмотреть что создалось
ls -la /var/backups/postgresql/full_backup_*/ 

# Проверить размеры
du -sh /var/backups/postgresql/full_backup_*/

# Проверить один из дампов
pg_restore -l /var/backups/postgresql/full_backup_*/pbxv2.dump | head -10
```

## **2. Теперь на РЕПЛИКАХ (app2 и app3):**

### На каждой реплике выполняем:

#### A. Проверяем что это реплика:
```bash
# На app2 и app3
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "SELECT pg_is_in_recovery();"
# Должно вернуть 't' - значит это реплика
```

#### B. Создаем бэкап с реплики (только данные БД):
```bash
# Переходим в директорию бэкапов
cd /var/backups/postgresql/

# Создаем поддиректорию с датой
mkdir -p replica_backup_$(date +%Y%m%d_%H%M)
cd replica_backup_$(date +%Y%m%d_%H%M)

# Бэкап каждой БД отдельно (глобальные объекты НЕ бэкапим на реплике!)
for DB in $(psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname NOT IN ('postgres');"); do
    echo "Создаю дамп БД: $DB"
    pg_dump -h /var/lib/postgresql/patroni -p 5433 -U postgres -Fc -Z 9 -f ${DB}.dump ${DB}
done

# Создать файл с информацией
echo "=== ИНФОРМАЦИЯ О БЭКАПЕ ===" > backup_info.txt
echo "Дата: $(date)" >> backup_info.txt
echo "Сервер: $(hostname) (реплика)" >> backup_info.txt
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "SELECT version();" >> backup_info.txt
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -c "SELECT pg_is_in_recovery();" >> backup_info.txt
```

## **3. Посмотреть таблицы в конкретной БД:**

### На любой ноде:
```bash
# Смотрим таблицы в БД pbxv2
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -d pbxv2 -c "\dt+"

# Или подробнее:
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres -d pbxv2 -c "
SELECT 
    schemaname,
    tablename,
    tableowner,
    pg_size_pretty(pg_total_relation_size(schemaname || '.' || tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname || '.' || tablename)) as table_size,
    pg_size_pretty(pg_total_relation_size(schemaname || '.' || tablename) - pg_relation_size(schemaname || '.' || tablename)) as index_size,
    n_live_tup as rows
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname || '.' || tablename) DESC
LIMIT 20;
"
```

## **4. Быстрая команда для бэкапа ОДНОЙ важной БД:**

```bash
# Например, для pbxv2 на любой ноде:
pg_dump -h /var/lib/postgresql/patroni -p 5433 -U postgres \
    -Fc -Z 9 -v \
    -f /var/backups/postgresql/pbxv2_emergency_$(date +%Y%m%d_%H%M%S).dump \
    pbxv2
```

## **5. Проверить разницу между бэкапами на разных нодах:**

```bash
# На мастере проверяем размер
ls -lh /var/backups/postgresql/full_backup_*/

# На реплике проверяем размер
ls -lh /var/backups/postgresql/replica_backup_*/

# Сравнить хэши (должны совпадать, т.к. данные одинаковые)
md5sum /var/backups/postgresql/full_backup_*/pbxv2.dump
md5sum /var/backups/postgresql/replica_backup_*/pbxv2.dump
```

## **6. Пример восстановления (если нужно):**

```bash
# Восстановить одну БД из дампа (на любой ноде):
pg_restore -h /var/lib/postgresql/patroni -p 5433 -U postgres \
    -d postgres \
    -c -v \
    /var/backups/postgresql/full_backup_*/pbxv2.dump

# Восстановить глобальные объекты (только на мастере):
psql -h /var/lib/postgresql/patroni -p 5433 -U postgres \
    -f /var/backups/postgresql/full_backup_*/globals.sql
```

## **7. Очистить старые бэкапы (если нужно):**

```bash
# Удалить бэкапы старше 3 дней
find /var/backups/postgresql -name "*backup_*" -type d -mtime +3 -exec rm -rf {} \;
```

## **Итоговая структура бэкапов:**

```
/var/backups/postgresql/
├── full_backup_20241203_1015/      # С мастера (app)
│   ├── globals.sql                 # Роли, tablespaces
│   ├── all_databases.sql          # Все БД одним файлом
│   ├── pbxv2.dump                 # Каждая БД отдельно
│   ├── logging_db.dump
│   ├── media_db.dump
│   └── backup_info.txt
├── replica_backup_20241203_1015/   # С реплики app2
│   ├── pbxv2.dump
│   ├── logging_db.dump
│   ├── media_db.dump
│   └── backup_info.txt
└── replica_backup_20241203_1015/   # С реплики app3
    ├── pbxv2.dump
    ├── logging_db.dump
    ├── media_db.dump
    └── backup_info.txt
```

**Важно:** Бэкапы с реплик будут идентичны бэкапам с мастера (кроме файла globals.sql).










