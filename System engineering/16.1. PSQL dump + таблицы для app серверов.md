# Проверка Лидера Patroni 

## Смотрим лидера/реплику и конфигурацию
```bash
root@app ~ > patronictl -c /etc/patroni/config.yml show-config

root@app /var/backups/postgresql > patronictl -c /etc/patroni/config.yml topology
+ Cluster: postgres ----------+---------+---------+-----+-----------+
| Member | Host               | Role    | State   |  TL | Lag in MB |
+--------+--------------------+---------+---------+-----+-----------+
| app3   | 192.168.87.62:5433 | Leader  | running | 400 |           |
| + app  | 192.168.87.60:5433 | Replica | running | 400 |         0 |
| + app2 | 192.168.87.61:5433 | Replica | running | 400 |         0 |
+--------+--------------------+---------+---------+-----+-----------+
```

## Перкключаем мастер на app сервер
```bash
# Выполняем switchover (переключение ролей)
patronictl -c /etc/patroni/config.yml switchover --candidate app --force

# Или используем более явную команду (выбираем из app, app2, app3)
patronictl -c /etc/patroni/config.yml switchover --master app --candidate app

# Проверяем результат
patronictl -c /etc/patroni/config.yml topology

# Дополнительная проверка на самой ноде app
sudo -u postgres psql -h /var/lib/postgresql/patroni -p 5433 -c "SELECT pg_is_in_recovery();"
# Если вернет 'f' - это мастер, если 't' - реплика

##--------
# Если switchover не работает
patronictl -c /etc/patroni/config.yml failover --candidate app

# Или перезапустить мастер и заставить выбрать новый
patronictl -c /etc/patroni/config.yml restart --role master
```
<br/>


# Создание дампа 

## Проверка подключения
```bash
root@app ~ > su - postgres 
postgres@app:~$ psql 
psql: ошибка: подключиться к серверу через сокет "/var/run/postgresql/.s.PGSQL.5432" не удалось: Нет такого файла или каталога
        Сервер действительно работает локально и принимает подключения через этот сокет?
```
Значит нужно подключаться через сокет
```bash
root@app ~ > find / -name ".s.PGSQL.5433" 2>/dev/null
/var/lib/postgresql/patroni/.s.PGSQL.5433
root@app ~ > psql -h /var/lib/postgresql/patroni -p 5433 -U postgres
psql (15.14 (Debian 15.14-0+deb12u1))
***
```



