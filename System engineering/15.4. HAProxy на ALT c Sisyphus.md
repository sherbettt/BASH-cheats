##  –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ –Ω–∞ ALT Linux —Å "–°–∏–∑–∏—Ñ–æ–º"

### **–¶–µ–ª—å:**
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HAProxy –∫–∞–∫ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –µ–≥–æ —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Å PostgreSQL



## **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è:**

### **1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HAProxy**
```bash
apt install -y haproxy haproxy-cmd hatop
```
- –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç + —É—Ç–∏–ª–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **2. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
cat /etc/haproxy/haproxy.cfg
```

<details>
<summary>‚ùó /etc/haproxy/haproxy.cfg ‚ùó</summary>
  
```cfg
#---------------------------------------------------------------------
# Global settings - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–ª–∏—è—é—Ç –Ω–∞ –≤–µ—Å—å HAProxy)
#---------------------------------------------------------------------
global
    # log to /dev/log
    log /dev/log daemon           # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π /dev/log —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "daemon"

    # –ü—Ä–∏–º–µ—Ä—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã):
    #log 127.0.0.1:514 local2     # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ syslog –ø–æ UDP
    #log tcp@127.0.0.1:514 local2 notice  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ syslog –ø–æ TCP

    chroot /var/lib/haproxy       # –ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ chroot-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
    pidfile /run/haproxy.pid      # –§–∞–π–ª –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è PID –ø—Ä–æ—Ü–µ—Å—Å–∞
    maxconn 4000                  # –ú–∞–∫—Å–∏–º—É–º 4000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    user _haproxy                 # –ó–∞–ø—É—Å–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è _haproxy (–±–µ–∑–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
    group _haproxy                # –ó–∞–ø—É—Å–∫ –æ—Ç –≥—Ä—É–ø–ø—ã _haproxy
    daemon                        # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–º–æ–Ω)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ Unix socket
    stats socket /var/lib/haproxy/stats  # Socket –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#---------------------------------------------------------------------
# defaults - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
#---------------------------------------------------------------------
defaults
    mode http                     # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å HTTP (–≤–º–µ—Å—Ç–æ TCP)
    log global                    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    option httplog                # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
    option dontlognull            # –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    option http-server-close      # –ó–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    option forwardfor except 127.0.0.0/8  # –î–æ–±–∞–≤–ª—è—Ç—å X-Forwarded-For header (–∫—Ä–æ–º–µ localhost)
    option redispatch             # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    retries 3                     # 3 –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    timeout http-request 10s      # –¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞ - 10 —Å–µ–∫—É–Ω–¥
    timeout queue 1m              # –¢–∞–π–º–∞—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ - 1 –º–∏–Ω—É—Ç–∞
    timeout connect 10s           # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É - 10 —Å–µ–∫—É–Ω–¥
    timeout client 1m             # –¢–∞–π–º–∞—É—Ç –∫–ª–∏–µ–Ω—Ç–∞ - 1 –º–∏–Ω—É—Ç–∞
    timeout server 1m             # –¢–∞–π–º–∞—É—Ç —Å–µ—Ä–≤–µ—Ä–∞ - 1 –º–∏–Ω—É—Ç–∞
    timeout http-keep-alive 10s   # –¢–∞–π–º–∞—É—Ç keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π - 10 —Å–µ–∫—É–Ω–¥
    timeout check 10s             # –¢–∞–π–º–∞—É—Ç health check - 10 —Å–µ–∫—É–Ω–¥
    maxconn 3000                  # –ú–∞–∫—Å–∏–º—É–º 3000 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –Ω–∞ —Å–µ–∫—Ü–∏—é

#---------------------------------------------------------------------
# frontend - "–í—Ö–æ–¥–Ω–∞—è –¥–≤–µ—Ä—å" –ø—Ä–∏–Ω–∏–º–∞—é—â–∞—è –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
#---------------------------------------------------------------------
frontend main
    bind *:5000                   # –°–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –ø–æ—Ä—Ç 5000
    
    # ACL (Access Control List) - –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
    acl url_static path_beg -i /static /images /javascript /stylesheets
    # –ï—Å–ª–∏ –ø—É—Ç—å –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø —Å /static, /images –∏ —Ç.–¥. ‚Üí –ø—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
    
    acl url_static path_end -i .jpg .gif .png .css .js
    # –ï—Å–ª–∏ –ø—É—Ç—å –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–¢–°–Ø –Ω–∞ .jpg, .gif –∏ —Ç.–¥. ‚Üí –ø—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

    use_backend static if url_static  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—ç–∫–µ–Ω–¥ "static" –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –ø—Ä–∞–≤–∏–ª–æ
    default_backend app               # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—ç–∫–µ–Ω–¥ "app"

#---------------------------------------------------------------------
# backend static - –ë—ç–∫–µ–Ω–¥ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
#---------------------------------------------------------------------
backend static
    balance roundrobin           # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥–æ–≤–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É
    server static 127.0.0.1:4331 check  # –û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–∞ localhost:4331 —Å health check

#---------------------------------------------------------------------
# backend app - –ë—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
#---------------------------------------------------------------------
backend app
    balance roundrobin           # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥–æ–≤–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É
    server app1 127.0.0.1:5001 check  # –°–µ—Ä–≤–µ—Ä 1 –Ω–∞ –ø–æ—Ä—Ç—É 5001
    server app2 127.0.0.1:5002 check  # –°–µ—Ä–≤–µ—Ä 2 –Ω–∞ –ø–æ—Ä—Ç—É 5002  
    server app3 127.0.0.1:5003 check  # –°–µ—Ä–≤–µ—Ä 3 –Ω–∞ –ø–æ—Ä—Ç—É 5003
    server app4 127.0.0.1:5004 check  # –°–µ—Ä–≤–µ—Ä 4 –Ω–∞ –ø–æ—Ä—Ç—É 5004

```
</details> 



## **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:**

```
–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç http://server:5000/image.jpg
    ‚Üì
Frontend main: –ø–æ—Ä—Ç 5000
    ‚Üì  
ACL: path_end .jpg ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç url_static
    ‚Üì
Backend static: 127.0.0.1:4331
    ‚Üì
Python —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 4331 –æ—Ç–¥–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
```

```
–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç http://server:5000/api/users
    ‚Üì
Frontend main: –ø–æ—Ä—Ç 5000
    ‚Üì
ACL: –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Üí default_backend
    ‚Üì  
Backend app: roundrobin –º–µ–∂–¥—É –ø–æ—Ä—Ç–∞–º–∏ 5001-5004
    ‚Üì
–û–¥–∏–Ω –∏–∑ Python —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
```
*–≠—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–µ—Ç **–ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏–∫–∏ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!*



### **3. –ó–∞–ø—É—Å–∫ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**
```bash
systemctl status haproxy
```
- –û–±–Ω–∞—Ä—É–∂–∏–ª–∏ —á—Ç–æ –±—ç–∫–µ–Ω–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ("Connection refused")

### **4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±—ç–∫–µ–Ω–¥–æ–≤**
```bash
# –ó–∞–ø—É—Å—Ç–∏–ª–∏ Python HTTP —Å–µ—Ä–≤–µ—Ä—ã –∫–∞–∫ –±—ç–∫–µ–Ω–¥—ã
python3 -m http.server 4331 --directory /var/www/html &
python3 -m http.server 5001 --directory /var/www/html &

ps aux | grep python
ss -tlnp | grep python

# –∞ —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–∏—Ç—å –¥–∂–æ–±—ã
jobs
fg %1  # –∞ –∑–∞—Ç–µ–º  Ctrl + C
kill %1 %2
killall %%
```

### **5. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**
```bash
mkdir -p /var/www/html
echo '<h1>Hello from HAProxy on ALT Sisyphus!</h1><p>Server: '$(hostname)'</p>' > /var/www/html/index.html
```

### **6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥–æ–≤
curl http://localhost:5000/

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
for i in {1..5}; do
  echo "Request $i:"
  curl -s http://localhost:5000/ | grep "Hello"
done
```

---

##  **–ß—Ç–æ –º—ã –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –∏ –∑–∞—á–µ–º:**

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞:**
```
–ö–ª–∏–µ–Ω—Ç—ã ‚Üí HAProxy:5000 ‚Üí Python HTTP —Å–µ—Ä–≤–µ—Ä—ã (4331, 5001-5004)
                    ‚Üì
            –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ roundrobin
```

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
```bash
frontend main
    bind *:5000                    # –°–ª—É—à–∞–µ–º –ø–æ—Ä—Ç 5000
    acl url_static path_beg -i /static  # –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
    use_backend static if url_static    # –°—Ç–∞—Ç–∏–∫–∞ ‚Üí –ø–æ—Ä—Ç 4331  
    default_backend app                 # –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –ø–æ—Ä—Ç—ã 5001-5004

backend static
    server static 127.0.0.1:4331 check  # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç

backend app  
    server app1 127.0.0.1:5001 check    # 4 –ø—Ä–∏–∫–ª–∞–¥–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
    server app2 127.0.0.1:5002 check
    server app3 127.0.0.1:5003 check  
    server app4 127.0.0.1:5004 check
```



## üîç **–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ–≤–µ—Ä—à–∏–ª–∏:**

1. **Health Checks** - HAProxy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–æ–≤
2. **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞** - –∑–∞–ø—Ä–æ—Å—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–∞—Ö –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
4. **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∑–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ HAProxy –∫ –±—ç–∫–µ–Ω–¥–∞–º
5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω



## **–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥?**

**–≠—Ç–æ —É—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ALT Linux**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞** - —Å—Ç–∞—Ç–∏–∫–∞ vs –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±—ç–∫–µ–Ω–¥—ã** - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é  
- **–ì–æ—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - timeout, retries, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏



## **–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—É—á–µ–Ω–∏—è:**

–¢–µ–ø–µ—Ä—å –º—ã –ø–æ–Ω–∏–º–∞–µ–º –∫–∞–∫ HAProxy:
-  **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã** —á–µ—Ä–µ–∑ health checks
-  **–ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É** –º–µ–∂–¥—É –±—ç–∫–µ–Ω–¥–∞–º–∏
-  **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏** (ACL)
-  **–†–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏** (HTTP –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ)

-----------------

—Å–º —Å—Ç–∞—Ç—å—é [15.5. ProxMox: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤.md](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/15.5.%20ProxMox:%20–ù–∞—Å—Ç—Ä–æ–π–∫–∞%20–ª–∏–º–∏—Ç–æ–≤%20—Ñ–∞–π–ª–æ–≤.md)

##  **–ó–∞—á–µ–º –º—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è HAProxy?**

### **–¶–µ–ª—å:**
HAProxy - —ç—Ç–æ **–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏**, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—ã—Å—è—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π. –ö–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ = 1 —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä (FD).

**–ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ:**
-  HAProxy –Ω–µ —Å–º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
-  –ü–æ—Ç–µ—Ä—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
-  –û—à–∏–±–∫–∏ "Too many open files"



##  **–ß—Ç–æ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º:**

### **1. –õ–∏–º–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ FD
cat /proc/1/limits | grep "Max open files"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `Max open files 65536 65536 files` 

### **2. –õ–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ HAProxy**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ HAProxy –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å–ª–µ–¥—É–µ—Ç –ª–∏–º–∏—Ç—ã
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `Max open files 65536 65536 files`

### **3. –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FD**
```bash
# –°–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HAProxy —Å–µ–π—á–∞—Å
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l
```



##  **–§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤:**
```bash
#!/bin/bash

echo "=== LXC Container Limits ==="
cat /proc/1/limits | grep "Max open files"

echo "=== HAProxy Process Limits ==="
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"

echo "=== Current HAProxy FD Usage ==="
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l

echo "=== HAProxy Status ==="
systemctl status haproxy --no-pager -l
```

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è HAProxy:**
```cfg
# –ù–∞–π—Ç–∏ —é–Ω–∏—Ç
systemctl show haproxy -p FragmentPath

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# FragmentPath=/usr/lib/systemd/system/haproxy.service

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é
mcedit /usr/lib/systemd/system/haproxy.service

# –ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
systemctl cat haproxy.service --no-pager

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è HAProxy –ø—Ä–æ—Ü–µ—Å—Å–∞
systemctl edit haproxy

# –î–æ–±–∞–≤–ª—è–µ–º:
[Service]
LimitNOFILE=65536

# –ü—Ä–∏–º–µ–Ω—è–µ–º
systemctl daemon-reload
systemctl restart haproxy
```


##  **–ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:**

### **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
-  **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:** 65536 FD
-  **HAProxy –ø—Ä–æ—Ü–µ—Å—Å:** 65536 FD  
-  **HAProxy –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å** ~60,000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
-  **–ì–æ—Ç–æ–≤ –∫ –≤—ã—Å–æ–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º** PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä–∞

### **–î–ª—è —á–µ–≥–æ —ç—Ç–æ –≤ PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä–µ:**
```
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí HAProxy (60K connections) ‚Üí PostgreSQL –Ω–æ–¥—ã
    ‚Üì
–ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É:
- 1 –º–∞—Å—Ç–µ—Ä (–∑–∞–ø–∏—Å—å) 
- N —Ä–µ–ø–ª–∏–∫ (—á—Ç–µ–Ω–∏–µ)
```



##  **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –Ω–∞–≥—Ä—É–∑–∫–∏:**

**–ë–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤:**
- –ú–∞–∫—Å–∏–º—É–º ~4000 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ - –æ—à–∏–±–∫–∏, –æ–±—Ä—ã–≤—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–° –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏:**
- –î–æ 65536 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞



##  **–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü–æ—Å–ª–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É
echo "=== FINAL VERIFICATION ==="
cat /proc/1/limits | grep "Max open files"
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
systemctl status haproxy --no-pager -l

# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# Max open files 65536 65536 files - –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# Max open files 65536 65536 files - –¥–ª—è HAProxy
# HAProxy: active (running) - —Å–ª—É–∂–±–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

**–¢–µ–ø–µ—Ä—å HAProxy –≥–æ—Ç–æ–≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ PostgreSQL üêò –∫–ª–∞—Å—Ç–µ—Ä–∞!** 
