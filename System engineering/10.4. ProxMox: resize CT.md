# Инструкция по увеличению диска в Proxmox для контейнера

## Исходная проблема
Контейнер имеет диск 30G, нужно увеличить до 42G. Команда `pct resize` изменяет только конфигурацию, но не физический размер диска.

## Важные моменты

1. **Всегда останавливайте контейнер** перед работой с raw-файлом
2. **Сделайте бэкап** перед изменением размера
3. **Используйте `rootfs`** как идентификатор диска в `pct resize`
4. **Физическое увеличение файла** обязательно после изменения конфигурации
5. **Расширение раздела** необходимо перед расширением файловой системы
<br/>


## Пошаговая инструкция

### 1. Проверка текущего состояния
```bash
# На хосте Proxmox посмотреть конфигурацию
cat /etc/pve/lxc/193.conf

# Внутри контейнера проверить размер диска
pct enter 193
df -h /
exit
```

### 2. Увеличение диска через Proxmox
```bash
# Увеличиваем диск в конфигурации
pct resize 193 rootfs 42G

# Проверяем изменение конфига
cat /etc/pve/lxc/193.conf | grep rootfs
```

### 3. Увеличение физического размера raw-файла
```bash
# Останавливаем контейнер
pct stop 193

# Увеличиваем raw-файл
qemu-img resize /stg/1tb/images/193/vm-193-disk-0.raw 42G

# более точное указание
qemu-img resize -f raw /stg/1tb/images/667/vm-667-disk-0.raw 42G

# Проверяем размер файла
ls -lh /stg/1tb/images/193/vm-193-disk-0.raw
```

### 4. Расширение раздела внутри образа
```bash
# Расширяем раздел до 100% доступного пространства
parted /stg/1tb/images/193/vm-193-disk-0.raw -- resizepart 1 100%

# Проверяем структуру разделов
parted /stg/1tb/images/193/vm-193-disk-0.raw print
```

### 5. Проверка и расширение файловой системы
```bash
# Проверяем файловую систему
e2fsck -f /stg/1tb/images/193/vm-193-disk-0.raw

# Расширяем файловую систему
resize2fs /stg/1tb/images/193/vm-193-disk-0.raw
```

### 6. Запуск и проверка
```bash
# Запускаем контейнер
pct start 193

# Проверяем результат
pct enter 193
df -h /
```

## Альтернативные методы

### Через веб-интерфейс Proxmox:
1. Остановить контейнер
2. В разделе "Resources" → "Root Disk" нажать "Resize disk"
3. Указать новый размер 42G
4. Запустить контейнер

### Если нужны loop-устройства внутри контейнера:
```bash
# Добавить в конфиг контейнера
echo "lxc.cgroup.devices.allow: c 7:* rwm" >> /etc/pve/lxc/193.conf
```

## Решение возможных проблем

### Если `resize2fs` не видит устройство:
```bash
# Внутри контейнера попробовать
resize2fs $(findmnt / -o SOURCE -n)
```

### Если файловая система XFS:
```bash
xfs_growfs /
```

### Если раздел не расширяется через parted:
```bash
# Использовать sfdisk
echo ", +" | sfdisk -N 1 /stg/1tb/images/193/vm-193-disk-0.raw --force
```

## Проверочные команды

**На хосте:**
```bash
# Размер raw-файла
ls -lh /stg/1tb/images/193/vm-193-disk-0.raw

# Структура разделов
parted /stg/1tb/images/193/vm-193-disk-0.raw print
```

**В контейнере:**
```bash
# Размер файловой системы
df -h /

# Информация о блочных устройствах
lsblk
```
<br/>


## Альтернативный способ (более простой):
```bash
# Остановить контейнер
pct stop 667

# Изменить размер через Proxmox
pct set 667 -rootfs 42G

# Запустить контейнер
pct start 667
```
