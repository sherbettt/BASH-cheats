## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∞—à–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–£ –Ω–∞—Å **unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** - —ç—Ç–æ –≤–∞–∂–Ω–æ! –ù—É–∂–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

## **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª-–≤–∞ –ª–∏–º–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
```bash
ulimit -H -n
ulimit -S -n
ccat /proc/1/limits | grep "Max open files"
```
```bash
Max open files            524288               524288               files 
```


## **–û–±—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
mcedit /etc/pve/lxc/199.conf
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü:**
```bash
# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
```
–∏–ª–∏
```bash
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (cgroup v1)
lxc.cgroup.devices.max: 65536

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (cgroup v2)
lxc.cgroup2.files.max = 65536
lxc.cgroup2.files.soft = 32768
```



## **–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –î–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 198 (Ubuntu)**

```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ub25
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:C1:17:70,ip=192.168.87.101/24,type=veth
ostype: ubuntu
rootfs: ssd_1tb:198/vm-198-disk-0.raw,size=34G
swap: 256
unprivileged: 1
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536 
```

## **–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –î–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 199 (ALT Linux)**

```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ALT11
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:48:36:3A,ip=192.168.87.100/24,type=veth
ostype: fedora
rootfs: ssd_1tb:199/vm-199-disk-0.raw,size=36G
swap: 256
unprivileged: 1
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536
```



## **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ features**

```bash
## –≤ /etc/pve/lxc/***.conf
# –í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö prlimit, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
features: nesting=1,fuse=1,keyctl=1,mount=nfs
lxc.cgroup2.files.max = 131072
```



## **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è**

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
pct reboot 198
pct reboot 199

# –ò–ª–∏ —á–µ—Ä–µ–∑ web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
```



## **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤**

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–ª—è init –ø—Ä–æ—Ü–µ—Å—Å–∞
cat /proc/1/limits | grep "Max open files"

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è unprivileged
cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep "0::" | cut -d: -f3)/pids.max
```



## **–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ unprivileged)**

–î–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ systemd –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**
```bash
# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–±—É HAProxy
systemctl edit haproxy

# –î–æ–±–∞–≤–ª—è–µ–º:
[Service]
LimitNOFILE=65536

# –ü—Ä–∏–º–µ–Ω—è–µ–º
systemctl daemon-reload
systemctl restart haproxy
```

### **–°–ø–æ—Å–æ–± 1.1: –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ systemd –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**
```bash
# –Ω–∞–π—Ç–∏ —é–Ω–∏—Ç
systemctl show haproxy -p FragmentPath
```
```bash
FragmentPath=/usr/lib/systemd/system/haproxy.service
root@file-ALT11 /etc/haproxy > mcedit /usr/lib/systemd/system/haproxy.service
```
–∏–ª–∏
```bash
systemctl cat haproxy.service --no-pager
```


### **–°–ø–æ—Å–æ–± 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ pam_limits**
```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
mcedit /etc/security/limits.conf

# –î–æ–±–∞–≤–ª—è–µ–º:
* soft nofile 32768
* hard nofile 65536
_haproxy soft nofile 65536
_haproxy hard nofile 65536
```



## **–§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:**

**–î–ª—è 199.conf:**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ALT11
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:48:36:3A,ip=192.168.87.100/24,type=veth
ostype: fedora
rootfs: ssd_1tb:199/vm-199-disk-0.raw,size=36G
swap: 256
unprivileged: 1

# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
lxc.cgroup2.files.max = 65536
```

**–î–ª—è 198.conf:**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ub25
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:C1:17:70,ip=192.168.87.101/24,type=veth
ostype: ubuntu
rootfs: ssd_1tb:198/vm-198-disk-0.raw,size=34G
swap: 256
unprivileged: 1

# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
lxc.cgroup2.files.max = 65536
```



## **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã HAProxy**

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:
```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º HAProxy
systemctl start haproxy

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ HAProxy
cat /proc/$(pidof haproxy)/limits | grep "Max open files"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
hatop -s /var/lib/haproxy/stats
```

**Unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ LXC –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã!** 

