#  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤ –¥–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ Proxmox

## **–í–∞–∂–Ω–æ: Unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**
–£ –Ω–∞—Å **unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** - —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫!

## **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–æ–≤
ulimit -H -n    # Hard limit
ulimit -S -n    # Soft limit
cat /proc/1/limits | grep "Max open files"

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# Max open files            524288               524288               files
```

## **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ LXC –∫–æ–Ω—Ñ–∏–≥**

### **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
mcedit /etc/pve/lxc/199.conf
```

### **–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:**
```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
```

### **‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ cgroup**
**–î–ª—è Proxmox (cgroup v1) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:**
```bash
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (cgroup v1)
lxc.cgroup.devices.max: 65536
```

**–î–ª—è —Å–∏—Å—Ç–µ–º —Å cgroup v2 (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è):**
```bash
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (cgroup v2)
lxc.cgroup2.files.max: 65536
lxc.cgroup2.files.soft: 32768
```

## **–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏**

### **–î–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 198 (Ubuntu):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ub25
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:C1:17:70,ip=192.168.87.101/24,type=veth
ostype: ubuntu
rootfs: ssd_1tb:198/vm-198-disk-0.raw,size=34G
swap: 256
unprivileged: 1

# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536 
```

### **–î–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 199 (ALT Linux):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ALT11
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:48:36:3A,ip=192.168.87.100/24,type=veth
ostype: fedora
rootfs: ssd_1tb:199/vm-199-disk-0.raw,size=36G
swap: 256
unprivileged: 1

# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536
```

## **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ features**
```bash
## –≤ /etc/pve/lxc/***.conf
# –í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö prlimit, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è cgroup v1:
features: nesting=1,fuse=1,keyctl=1,mount=nfs

# –î–ª—è cgroup v1 –∏—Å–ø–æ–ª—å–∑—É–µ–º:
lxc.cgroup.devices.max: 65536

# –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ cgroup2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Proxmox —Å cgroup v1!
# lxc.cgroup2.files.max: 131072  ‚Üê –≠–¢–û –ù–ï –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨!
```

## **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
pct reboot 198
pct reboot 199

# –ò–ª–∏ —á–µ—Ä–µ–∑ web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
```

## **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤**
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–ª—è init –ø—Ä–æ—Ü–µ—Å—Å–∞
cat /proc/1/limits | grep "Max open files"

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è unprivileged
cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep "0::" | cut -d: -f3)/pids.max
```

## **–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ unprivileged)**
–î–ª—è unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ systemd –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**
```bash
# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–±—É HAProxy
systemctl edit haproxy

# –î–æ–±–∞–≤–ª—è–µ–º:
[Service]
LimitNOFILE=65536

# –ü—Ä–∏–º–µ–Ω—è–µ–º
systemctl daemon-reload
systemctl restart haproxy
```

### **–°–ø–æ—Å–æ–± 1.1: –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ systemd –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**
```bash
# –ù–∞–π—Ç–∏ —é–Ω–∏—Ç
systemctl show haproxy -p FragmentPath

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# FragmentPath=/usr/lib/systemd/system/haproxy.service

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é
mcedit /usr/lib/systemd/system/haproxy.service

# –ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
systemctl cat haproxy.service --no-pager
```

### **–°–ø–æ—Å–æ–± 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ pam_limits**
```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
mcedit /etc/security/limits.conf

# –î–æ–±–∞–≤–ª—è–µ–º:
* soft nofile 32768
* hard nofile 65536
_haproxy soft nofile 65536
_haproxy hard nofile 65536
```

## **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã HAProxy**
–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:
```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º HAProxy
systemctl start haproxy

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ HAProxy
cat /proc/$(pidof haproxy)/limits | grep "Max open files"
ccat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"


# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
hatop -s /var/lib/haproxy/stats
```

## **‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è**
- **Proxmox –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç cgroup v1** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `lxc.cgroup.devices.max`
- **cgroup v2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (`lxc.cgroup2.*`) –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å** –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Proxmox
- **Unprivileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ LXC –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã!**
- **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–∏–º–∏—Ç—ã —á–µ—Ä–µ–∑ `/proc/1/limits`**, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ `ulimit -n`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–Ω–∏—Ç–µ —Å `lxc.prlimit.nofile` –∏ `lxc.cgroup.devices.max` - —ç—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Proxmox! 

-----------------------------------


##  **–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

### **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤:**
```bash
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
Max open files            8056                 65536                files
```

- **Soft limit: 8056** - —Ç–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç –¥–ª—è HAProxy –ø—Ä–æ—Ü–µ—Å—Å–∞
- **Hard limit: 65536** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π –ª–∏–º–∏—Ç (–Ω–∞—à LXC –ª–∏–º–∏—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!)



##  **–†–µ—à–µ–Ω–∏–µ: –£–≤–µ–ª–∏—á–∏—Ç—å soft limit –¥–ª—è HAProxy**

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ systemd (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–±—É HAProxy
systemctl edit haproxy

# –î–æ–±–∞–≤–ª—è–µ–º:
[Service]
LimitNOFILE=65536

# –ü—Ä–∏–º–µ–Ω—è–µ–º
systemctl daemon-reload
systemctl restart haproxy
```

### **–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ systemd –Ω–∞–ø—Ä—è–º—É—é**
```bash
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è override –∫–æ–Ω—Ñ–∏–≥–∞
mkdir -p /etc/systemd/system/haproxy.service.d/

# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
mcedit /etc/systemd/system/haproxy.service.d/override.conf
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
```ini
[Service]
LimitNOFILE=65536
```

### **–°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ pam_limits**
```bash
# –î–æ–±–∞–≤–ª—è–µ–º –≤ limits.conf
mcedit /etc/security/limits.conf

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫–∏:
* soft nofile 65536
* hard nofile 65536
_haproxy soft nofile 65536  
_haproxy hard nofile 65536
```



##  **–ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º HAProxy
systemctl daemon-reload
systemctl restart haproxy

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```bash
Max open files            65536                65536                files
```



##  **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1.  **LXC –ª–∏–º–∏—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç** - hard limit = 65536
2.  **Systemd –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç** HAProxy –¥–æ 8056 (soft limit)
3. üîß **–ù—É–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å soft limit** —á–µ—Ä–µ–∑ systemd –∫–æ–Ω—Ñ–∏–≥


##  **–ò—Ç–æ–≥:**
**LXC –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω—ã!** –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–Ω—è—Ç—å systemd –ª–∏–º–∏—Ç—ã –¥–ª—è HAProxy –ø—Ä–æ—Ü–µ—Å—Å–∞. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ HAProxy —Å–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ 65536 —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤! 
