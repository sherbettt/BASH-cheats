# Задание
Текущее задание является логическим продолжением: 
- [15. ProxMox: установка etcd, Patroni, Haproxy](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/15.%20ProxMox:%20установка%20etcd,%20Patroni,%20Haproxy.md),
- [16. PSQL dump: клон + восстановление](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/16.%20PSQL%20dump%3A%20клон%20%2B%20восстановление.md)

Задание:
1) настроить **nginx**: *sso.runtel.ru:8443* на **192.168.87.2** (в **`/etc/nginx/sites-enabled/`**);
2) продублировать ***Container 272 (keycloack)***, проверить что работает через nginx;
3) отключаешь ***Container 272 (keycloack)***, проверить что всё продолжает работать;

- [Модуль ngx_http_upstream_module](https://nginx.org/ru/docs/http/ngx_http_upstream_module.html)
- [Configuring Keycloak](https://www.keycloak.org/server/configuration)
- [Session storages in Keycloak 26 cheatsheet](https://www.keycloak.org/2024/12/storing-sessions-in-kc26)
<br/>

<details>
<summary>❗ псевдографика ❗</summary>

```text
+---------------------------------------------------------------+
|                     Кластер Proxmox                           |
|                                                               |
|  +---------------------+     +---------------------+          |
|  |       Узел pmx6     |     |      Узел prox4     |          |
|  | 192.168.87.6:8006   |     | 192.168.87.17:8006  |          |
|  |                     |     |                     |          |
|  |  +---------------+  |     |  +---------------+  |          |
|  |  | Container 102 |  |     |  | Container 172 |  |          |
|  |  | (dmzgateway)  |  |     |  | (keycloak)    |  |          |
|  |  |               |  |     |  | vmbr0         |  |          |
|  |  | vmbr0:        |  |     |  +---------------+  |          |
|  |  | 192.168.87.2  |  |     |                     |          |
|  |  | dmznet:       |  |     |  +---------------+  |          |
|  |  | 192.168.46.1  |  |     |  | Container 272 |  |          |
|  |  | pgnet:        |  |     |  | (keycloak)    |  |          |
|  |  | 192.168.45.1  |  |     |  | dmznet +      |  |          |
|  |  +---------------+  |     |  | pgnet(eth1):  |  |          |
|  |                     |     |  | 192.168.45.50 |  |          |
|  +---------------------+     +---------------------+          |
|                                                               |
+---------------------------------------------------------------+
```
</details>

<br/>



# Выполнение

## Определение 

### 1. Конфигурации.
Определим конфигурацию keyacloak на уже склоинрованной машине 192.168.46.16 (она же 192.168.45.50).
- основная конф. в **`/opt/keycloak/conf/keycloak.conf`**.
- не основная конф. в `/opt/keycloak-26.1.2/`.

Версия:
- `/opt/keycloak/version.txt` (*Keycloak - Version 26.1.2*)

Конфигурация systemd-юнита:
- **`/etc/systemd/system/keycloak.service`** (если параметры передаются через командную строку, а не через `keycloak.conf`);

Конфигурация Infinispan (кеширование):
- `/opt/keycloak/conf/cache-ispn.xml` (может потребоваться настройка, если используется распределённый кеш).

Проверить через web-интерфейс:
```c
https://192.168.46.16:8443
https://192.168.45.50:8443
https://sso.runtel.ru:8443
```
Проверить с помощью curl:
```c
curl -v https://192.168.46.16:8443 | jq
```

### 2. Keycloak: конфигурирование.

#### 1. Создать другую директорию для переменной **PIDFile** в `/etc/systemd/system/keycloak.service`:
```bash
mkdir -p /run/keycloak/
chown keycloak:keycloak /run/keycloak/
systemctl daemon-reload
systemctl restart keycloak.service
#---
chmod 600 /opt/keycloak/conf/runtel.key
chown keycloak:keycloak /opt/keycloak/conf/runtel.*
systemctl daemon-reload
systemctl restart keycloak.service
systemctl status keycloak.service -l --no-pager
```

#### 2. Поменять путь для **PIDFile** в `/etc/systemd/system/keycloak.service`:
```bash
#PIDFile=/var/run/keycloak/keycloak.pid
PIDFile=/run/keycloak/keycloak.pid
```
```bash
systemctl daemon-reload
systemctl restart keycloak.service
```

#### 3. cache-ispn
Т.к. наши keycloak машины не являются кластером, то рекомендуется в файле `/opt/keycloak/conf/cache-ispn.xml` закомментировать секции: `"sessions"`, `"offlineSessions"`, `"clientSessions"`.



### 3. NGINX: конфигурирование.
#### 1. Создать файл **`/etc/nginx/sites-enabled/sso.runtel.ru`**;

Использовать пример для задания конфигурации:
```c
upstream kc_servers {
  server 192.168.46.16:8443;
  server 192.168.46.17:8443 backup;
}

server {
  listen 8443 default_server;
  ssl_certificate /etc/nginx/runtel.pem;
  ssl_certificate_key /etc/nginx/runtel.pem;
  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers         HIGH:!aNULL:!MD5;  
  root /var/www/html;
  server_name sso.runtel.ru;
  location / {
          proxy_read_timeout 7200;
          proxy_connect_timeout 3;
          proxy_set_header Host $host;
          proxy_set_header Origin $server_name;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_http_version 1.1;
          proxy_next_upstream error timeout invalid_header http_500 http_502 http_403 http_404 non_idempotent;
          proxy_next_upstream_timeout 5;
          proxy_intercept_errors on;
  proxy_pass https://kc_servers;
  }
}
```


