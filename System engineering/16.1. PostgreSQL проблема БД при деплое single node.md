# Полная инструкция по решению проблемы с PostgreSQL для Ansible playbook

## Исходная проблема
Playbook падал с ошибкой:
```
unable to connect to database: подключиться к серверу через сокет "/var/lib/postgresql/patroni/.s.PGSQL.5433" не удалось: Нет такого файла или каталога
```

## Выполненные действия

### 1. Анализ текущего состояния
```bash
# Проверка работающего PostgreSQL
ss -tulpn | grep 5432
ss -tulpn | grep 5433
# Вывод: PostgreSQL слушал только на 127.0.0.1:5432

# Проверка существующих БД
sudo -u postgres psql -c "\l"
# Было только 3 системные БД: postgres, template0, template1
```

### 2. Анализ конфигурации PostgreSQL
```bash
# Проверка pg_hba.conf
cat /etc/postgresql/15/main/pg_hba.conf
# Были дублирующиеся строки для 127.0.0.1

# Проверка postgresql.conf
cat /etc/postgresql/15/main/postgresql.conf
# listen_addresses = '127.0.0.1'
# port = 5432
```

### 3. Исправление конфигурации pg_hba.conf
```bash
# Убрали дублирующиеся строки и добавили нужные IP-адреса
nano /etc/postgresql/15/main/pg_hba.conf

# Итоговый вид:
local   all             postgres                                peer
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             192.168.5.199/32        md5
host    all             all             10.252.1.100/32         md5
host    all             all             ::1/128                 md5
local   replication     all                                     peer
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5
```

### 4. Настройка подключения к внешним интерфейсам
```bash
# Редактирование postgresql.conf
nano /etc/postgresql/15/main/postgresql.conf

# Изменения:
listen_addresses = 'localhost,192.168.5.199,10.252.1.100'
```

### 5. Создание структуры директорий для Ansible
```bash
# Создание директории, которую ожидал playbook
mkdir -p /var/lib/postgresql/patroni/
chown postgres:postgres /var/lib/postgresql/patroni/
```

### 6. Создание символических ссылок для socket'ов
```bash
# Создание ссылки для порта 5432 (основной)
sudo -u postgres ln -s /var/run/postgresql/.s.PGSQL.5432 /var/lib/postgresql/patroni/.s.PGSQL.5432

# Создание ссылки для порта 5433 (который ожидал Ansible)
sudo -u postgres ln -s /var/run/postgresql/.s.PGSQL.5432 /var/lib/postgresql/patroni/.s.PGSQL.5433

# Проверка созданных ссылок
ls -la /var/lib/postgresql/patroni/
```

### 7. Настройка аутентификации .pgpass
```bash
# Создание .pgpass для пользователя postgres
sudo -u postgres cat > /var/lib/postgresql/.pgpass << 'EOF'
localhost:5432:*:postgres:Aidad0Hahghooyeew3
127.0.0.1:5432:*:postgres:Aidad0Hahghooyeew3
192.168.5.199:5432:*:postgres:Aidad0Hahghooyeew3
10.252.1.100:5432:*:postgres:Aidad0Hahghooyeew3
/var/lib/postgresql/patroni:5432:*:postgres:Aidad0Hahghooyeew3
/var/lib/postgresql/patroni:5433:*:postgres:Aidad0Hahghooyeew3
EOF

# Установка правильных прав
chmod 600 /var/lib/postgresql/.pgpass
chown postgres:postgres /var/lib/postgresql/.pgpass
```

### 8. Перезапуск и проверка PostgreSQL
```bash
# Перезапуск PostgreSQL
systemctl restart postgresql

# Проверка статуса
systemctl status postgresql@15-main.service

# Проверка подключения через оба пути
sudo -u postgres psql -h /var/lib/postgresql/patroni -p 5432 -c "SELECT version();"
sudo -u postgres psql -h /var/lib/postgresql/patroni -p 5433 -c "SELECT version();"
```

### 9. Ошибочная попытка настройки двух портов
```bash
# НЕПРАВИЛЬНО: попытка добавить второй порт через запятую
# В postgresql.conf: port = 5432,5433
# Результат: PostgreSQL не запустился с ошибкой синтаксиса

# ВОССТАНОВЛЕНИЕ: вернули обратно port = 5432
```

## Итоговое состояние
- **PostgreSQL слушает** на: 127.0.0.1:5432, 192.168.5.199:5432, 10.252.1.100:5432
- **Созданы символические ссылки** для обхода проблемы с путями Ansible
- **Настроена аутентификация** через .pgpass
- **Созданы пользователь и БД** для PBX системы

## Ключевое решение
**Символическая ссылка** `/var/lib/postgresql/patroni/.s.PGSQL.5433` → `/var/run/postgresql/.s.PGSQL.5432` позволила обойти проблему, когда Ansible ожидал подключение на порту 5433 через специфический путь, но PostgreSQL работал на порту 5432 в стандартной директории.

После этих действий playbook успешно создал пользователя `rt_pbx` и все необходимые базы данных для PBX системы.

-----


