Учитывая предыдущий шаг, когда у нас уже имеется подготовленная конфигурация `Grafana + Loki + LogCLI + Promtail`, требуется изменить конфиг на `Grafana + Prometheus`.


## Текущая система (оставить работающей):
- ✅ **Grafana** (порт 3000) - уже есть
- ✅ **Loki** (порт 3100) - уже есть, оставить для логов
- ✅ **Promtail** - уже есть, оставить для сбора логов
- ✅ **LogCLI** - уже есть, для запросов к Loki

## Добавить Prometheus для метрик:

### Шаг 1: Установите Prometheus на runelfrontdev

```bash
# Установите Prometheus
sudo apt update 
sudo apt install -y prometheus prometheus-alertmanager prometheus-bind-exporter prometheus-nginx-exporter

# Создайте пользователя (если не создан)
sudo useradd --no-create-home --shell /bin/false prometheus 2>/dev/null || true
```

### Шаг 2: Установите Node-exporter на ВСЕ серверы

#### На runelfrontdev (локальный):
```bash
sudo apt-get install -y prometheus-node-exporter prometheus-node-exporter-collectors
sudo systemctl enable --now prometheus-node-exporter
```

#### На starodubtcevs (удалённый):
```bash
ssh root@starodubtcevs.hlab.kz "
sudo apt-get update
sudo apt-get install -y prometheus-node-exporter
sudo systemctl enable --now prometheus-node-exporter
echo 'Node-exporter установлен на starodubtcevs'
"
```

### Шаг 3: Настройте конфигурацию Prometheus

```bash
# Создайте основной конфиг Prometheus
sudo tee /etc/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Правила алертов (пока пусто)
rule_files:
  # - "alert_rules.yml"

# Конфигурация алерт-менеджера (пока не используется)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - localhost:9093

# Цели для сбора метрик
scrape_configs:
  # Сам Prometheus
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    labels:
      service: 'prometheus'

  # Node-exporter на runelfrontdev (локально)
  - job_name: 'node-runelfrontdev'
    static_configs:
      - targets: ['localhost:9100']
    labels:
      host: 'runelfrontdev'
      location: 'local'
      service: 'node-exporter'

  # Node-exporter на starodubtcevs (через ZeroTier)
  - job_name: 'node-starodubtcevs'
    static_configs:
      - targets: ['192.168.195.122:9100']
    labels:
      host: 'starodubtcevs'
      location: 'remote'
      service: 'node-exporter'
    # Необязательно: увеличить таймаут для удалённого сервера
    scrape_timeout: 30s

  # Loki метрики (если хотите мониторить Loki)
  - job_name: 'loki-metrics'
    static_configs:
      - targets: ['localhost:3100']
    metrics_path: '/metrics'
    labels:
      service: 'loki'

  # Promtail метрики (если хотите мониторить Promtail)
  - job_name: 'promtail-metrics'
    static_configs:
      - targets: ['localhost:9080']
    metrics_path: '/metrics'
    labels:
      service: 'promtail'

  # Grafana метрики (если хотите мониторить Grafana)
  - job_name: 'grafana-metrics'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scheme: 'http'
    labels:
      service: 'grafana'

  # PostgreSQL метрики (нужно установить postgres_exporter отдельно)
  # - job_name: 'postgres'
  #   static_configs:
  #     - targets: ['localhost:9187']
EOF
```

### Шаг 4: Настройте systemd службу Prometheus

```bash
# Создайте или отредактируйте службу
sudo tee /etc/systemd/system/prometheus.service << 'EOF'
[Unit]
Description=Prometheus Monitoring
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/bin/prometheus \
    --config.file=/etc/prometheus/prometheus.yml \
    --storage.tsdb.path=/var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries \
    --web.listen-address=0.0.0.0:9090 \
    --web.enable-lifecycle \
    --storage.tsdb.retention.time=30d

Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
```

### Шаг 5: Настройте права и директории

```bash
# Создайте необходимые директории
sudo mkdir -p /var/lib/prometheus
sudo mkdir -p /etc/prometheus/consoles /etc/prometheus/console_libraries

# Настройте права
sudo chown -R prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
sudo chown prometheus:prometheus /usr/bin/prometheus 2>/dev/null || true

# Скопируйте консоли (если они есть)
sudo cp -r /usr/share/prometheus/consoles /etc/prometheus/ 2>/dev/null || true
sudo cp -r /usr/share/prometheus/console_libraries /etc/prometheus/ 2>/dev/null || true
```

### Шаг 6: Запустите Prometheus

```bash
# Обновите systemd
sudo systemctl daemon-reload

# Запустите Prometheus
sudo systemctl start prometheus
sudo systemctl enable prometheus

# Проверьте статус
sudo systemctl status prometheus --no-pager
```

### Шаг 7: Проверьте работу всех компонентов

```bash
# 1. Проверьте Prometheus
curl -v http://localhost:9090
curl http://localhost:9090/api/v1/targets | python3 -m json.tool

# 2. Проверьте локальный node-exporter
curl http://localhost:9100/metrics | head -20

# 3. Проверьте удалённый node-exporter
curl http://192.168.195.122:9100/metrics | head -20

# 4. Проверьте Loki метрики
curl http://localhost:3100/metrics | head -20

# 5. Проверьте Promtail метрики
curl http://localhost:9080/metrics | head -20
```

### Шаг 8: Откройте порты (если нужно)

```bash
# Для Prometheus
sudo ufw allow 9090/tcp comment 'Prometheus web UI'

# Для node-exporter
sudo ufw allow 9100/tcp comment 'Prometheus node-exporter'

# Или через iptables
sudo iptables -I INPUT -p tcp --dport 9090 -j ACCEPT
sudo iptables -I INPUT -p tcp --dport 9100 -j ACCEPT
```

### Шаг 9: Добавьте Prometheus в Grafana

1. Откройте Grafana: http://192.168.87.179:3000
2. Configuration → Data Sources → Add data source
3. Выберите **Prometheus**
4. Настройте:
   - **Name:** `Prometheus` (или `prometheus-metrics`)
   - **URL:** `http://localhost:9090`
   - **Access:** Server (default)
5. Нажмите **Save & Test** - должно быть "Data source is working"

### Шаг 10: Создайте/импортируйте дашборды

#### Вариант A: Импорт готовых дашбордов (рекомендуется):

1. В Grafana: Dashboards → New → Import
2. Введите ID дашборда:
   - **Node Exporter Full:** `1860`
   - **1 Node Exporter for Prometheus:** `11074`
   - **Prometheus 2.0 Stats:** `3662`
3. Выберите Prometheus как data source

#### Вариант B: Создайте простые панели:

**Панель 1: CPU использование**
```promql
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

**Панель 2: Память**
```promql
# Используемая память
node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes

# Или в процентах
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

**Панель 3: Дисковое пространство**
```promql
# Свободное место в процентах
(node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100
```

**Панель 4: Сеть**
```promql
# Входящий трафик
irate(node_network_receive_bytes_total[5m])

# Исходящий трафик
irate(node_network_transmit_bytes_total[5m])
```

### Шаг 11: Проверьте всю систему

```bash
# Команда для проверки всех компонентов
echo "=== ПРОВЕРКА ВСЕЙ СИСТЕМЫ ==="

echo "1. Prometheus:"
curl -s -o /dev/null -w "%{http_code}" http://localhost:9090 && echo " OK" || echo " FAILED"

echo "2. Node-exporter local:"
curl -s -o /dev/null -w "%{http_code}" http://localhost:9100/metrics && echo " OK" || echo " FAILED"

echo "3. Node-exporter remote:"
curl -s -o /dev/null -w "%{http_code}" http://192.168.195.122:9100/metrics && echo " OK" || echo " FAILED"

echo "4. Loki:"
curl -s -o /dev/null -w "%{http_code}" http://localhost:3100/ready && echo " OK" || echo " FAILED"

echo "5. Promtail:"
curl -s -o /dev/null -w "%{http_code}" http://localhost:9080/ready && echo " OK" || echo " FAILED"

echo "6. Grafana:"
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 && echo " OK" || echo " FAILED"

echo "=== КОНЕЦ ПРОВЕРКИ ==="
```

## Итоговая архитектура:

```
runelfrontdev (192.168.87.179)
├── Grafana (3000) ← визуализация
├── Loki (3100) ← логи (остаётся)
├── Promtail (9080) ← сбор логов (остаётся)
├── Prometheus (9090) ← метрики (новое!)
└── Node-exporter (9100) ← метрики сервера (новое!)

starodubtcevs (192.168.195.122)
├── Promtail (9080) ← сбор логов (остаётся)
└── Node-exporter (9100) ← метрики сервера (новое!)
```

## Что теперь у вас есть:

1. **Логи** → **Loki** (поиск через LogQL в Grafana)
2. **Метрики** → **Prometheus** (графики через PromQL в Grafana)
3. **Полный стек мониторинга** в одном Grafana

## Команды управления:

```bash
# Статус всех служб
sudo systemctl status prometheus prometheus-node-exporter loki promtail grafana-server

# Перезапуск Prometheus
sudo systemctl restart prometheus

# Просмотр логов Prometheus
sudo journalctl -u prometheus -f --no-pager

# Проверка targets в Prometheus
curl http://localhost:9090/api/v1/targets | python3 -m json.tool
```

**Всё готово!** Теперь у вас полноценная система мониторинга с логами (Loki) и метриками (Prometheus) в едином интерфейсе Grafana.
