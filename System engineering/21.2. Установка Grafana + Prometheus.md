Учитывая предыдущий шаг, когда у нас уже имеется подготовленная конфигурация `Grafana + Loki + LogCLI + Promtail`, требуется изменить конфиг на `Grafana + Prometheus`.

Ссылки с подсказками:
1. [Официальная документация Grafana для Prometheus](https://grafana.com/docs/grafana/latest/datasources/prometheus/)
2. [Руководство по установке Prometheus на Linux](https://www.dmosk.ru/instruktions.php?object=prometheus-linux)
3. [Настройка Prometheus и Grafana](https://redos.red-soft.ru/base/redos-7_3/7_3-administation/7_3-monitoring/7_3-prometheus-grafana/)



# Установка и настройка Prometheus в существующую систему Grafana + Loki

## Текущая система (работает, не трогать):
- ✅ **Grafana** (порт 3000) - визуализация
- ✅ **Loki** (порт 3100) - логирование (оставить)
- ✅ **Promtail** - сбор логов (оставить)
- ✅ **LogCLI** - CLI для запросов к Loki

## Цель:
Добавить **Prometheus** для сбора метрик, сохранив существующую систему логирования.
<br/>


## Шаг 1: Установка Prometheus на runelfrontdev

### Установите пакеты:
```bash
sudo apt update
sudo apt install -y prometheus prometheus-alertmanager prometheus-bind-exporter prometheus-nginx-exporter
```

### Проверьте установку:
```bash
prometheus --version

# Создайте пользователя (если не создан)
sudo useradd --no-create-home --shell /bin/false prometheus 2>/dev/null || true
```
<br/>



## Шаг 2: Установка Node-exporter на все серверы

### На runelfrontdev (локальный):
```bash
sudo apt install -y prometheus-node-exporter prometheus-node-exporter-collectors
sudo systemctl enable --now prometheus-node-exporter
```

### Проверка на runelfrontdev:
```bash
prometheus-node-exporter --version
systemctl status prometheus prometheus-node-exporter --no-pager
sudo ss -tulpn | grep -E ':9090|:9100'
```

### На starodubtcevs (удалённый):
```bash
# Подключитесь к удалённому серверу
ssh root@starodubtcevs.hlab.kz "
sudo apt update
sudo apt install -y prometheus-node-exporter
sudo systemctl enable --now prometheus-node-exporter

# Проверка
prometheus-node-exporter --version
systemctl status prometheus-node-exporter --no-pager
sudo ss -tulpn | grep -E ':9090|:9100'
"
```
<br/>


## Шаг 3: Настройка конфигурации Prometheus

### Создайте backup текущего конфига:
```bash
sudo cp /etc/prometheus/prometheus.yml /etc/prometheus/prometheus.yml.backup
```

### Установите новую конфигурацию:
```bash
sudo tee /etc/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - localhost:9093

rule_files:
  # - "alert_rules.yml"

scrape_configs:
  # Сам Prometheus
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    labels:
      service: 'prometheus'

  # Node-exporter на runelfrontdev (локально)
  - job_name: 'node-runelfrontdev'
    static_configs:
      - targets: ['localhost:9100']
    labels:
      host: 'runelfrontdev'
      location: 'local'
      service: 'node-exporter'

  # Node-exporter на starodubtcevs (через ZeroTier)
  - job_name: 'node-starodubtcevs'
    static_configs:
      - targets: ['192.168.195.122:9100']
    labels:
      host: 'starodubtcevs'
      location: 'remote'
      service: 'node-exporter'
    scrape_timeout: 30s

  # Loki метрики
  - job_name: 'loki-metrics'
    static_configs:
      - targets: ['localhost:3100']
    metrics_path: '/metrics'
    labels:
      service: 'loki'

  # Promtail метрики
  - job_name: 'promtail-metrics'
    static_configs:
      - targets: ['localhost:9080']
    metrics_path: '/metrics'
    labels:
      service: 'promtail'

  # Grafana метрики
  - job_name: 'grafana-metrics'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scheme: 'http'
    labels:
      service: 'grafana'
EOF
```
<br/>


## Шаг 4: Проверка доступности удалённого node-exporter

### Проверьте подключение:
```bash
curl -s --max-time 5 http://192.168.195.122:9100/metrics | head -5
```

### Если недоступен - настройте firewall на starodubtcevs:
```bash
ssh root@starodubtcevs.hlab.kz "
# Проверьте текущие правила
sudo ufw status
sudo iptables -L -n | grep 9100

# Откройте порт (выберите один вариант)
sudo ufw allow 9100/tcp comment 'Prometheus node-exporter'
# Или
sudo iptables -I INPUT -p tcp --dport 9100 -j ACCEPT
"
```
<br/>


## Шаг 5: Перезапуск и проверка Prometheus

### Перезапустите службу:
```bash
sudo systemctl restart prometheus
```

### Проверьте статус:
```bash
sudo systemctl status prometheus --no-pager
sudo journalctl -u prometheus -n 20 --no-pager
```
<br/>


## Шаг 6: Проверка targets в Prometheus

### Подождите запуска:
```bash
sleep 10
```

### Проверьте все цели:
```bash
curl -s http://localhost:9090/api/v1/targets | python3 -m json.tool | grep -A2 -B2 '"health"'
```

### Или используйте читаемый формат:
```bash
curl -s http://localhost:9090/api/v1/targets | python3 -c "
import json, sys
data = json.load(sys.stdin)
print('=== PROMETHEUS TARGETS ===')
for target in data['data']['activeTargets']:
    status = '✅' if target['health'] == 'up' else '❌'
    print(f'{status} {target[\"scrapeUrl\"]} - {target[\"health\"]}')
"
```
<br/>


## Шаг 7: Добавление Prometheus в Grafana

### Проверьте работу Grafana:
```bash
curl -s http://localhost:3000 | head -3
```

### Инструкция по добавлению в UI:
1. Откройте браузер: http://192.168.87.179:3000
2. Логин: `admin/admin` (или ваш пароль)
3. Перейдите: **Configuration** → **Data Sources**
4. Нажмите: **Add data source**
5. Выберите: **Prometheus**
6. Настройте:
   - **Name:** `Prometheus`
   - **URL:** `http://localhost:9090`
7. Нажмите: **Save & Test** (должно быть "Data source is working")
<br/>



## Шаг 8: Импорт готовых дашбордов

### Вариант A - Импорт через UI:
1. В Grafana: **Dashboards** → **New** → **Import**
2. Введите ID дашборда:
   - `1860` - Node Exporter Full
   - `11074` - 1 Node Exporter for Prometheus
   - `3662` - Prometheus 2.0 Stats
3. Выберите Prometheus как источник данных
4. Нажмите **Import**

### Вариант B - Создание простых панелей:
- CPU использование: `100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)`
- Память: `node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes`
- Диск: `node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} * 100`
<br/>



## Шаг 9: Комплексная проверка системы

### Создайте тестовый скрипт:
```bash
cat << 'EOF' > /tmp/test_prometheus.sh
#!/bin/bash
echo "=== КОМПЛЕКСНАЯ ПРОВЕРКА PROMETHEUS ==="
echo ""

echo "1. Prometheus API:"
curl -s -o /dev/null -w "HTTP: %{http_code}\n" http://localhost:9090

echo ""
echo "2. Локальный node-exporter:"
curl -s -o /dev/null -w "HTTP: %{http_code}\n" http://localhost:9100/metrics

echo ""
echo "3. Удалённый node-exporter:"
curl -s -o /dev/null -w "HTTP: %{http_code}\n" --max-time 5 http://192.168.195.122:9100/metrics

echo ""
echo "4. Состояние всех targets:"
curl -s http://localhost:9090/api/v1/targets 2>/dev/null | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    targets = data['data']['activeTargets']
    up = sum(1 for t in targets if t['health'] == 'up')
    print(f'Активных: {up}/{len(targets)}')
    for t in targets:
        status = '✅' if t['health'] == 'up' else '❌'
        print(f'  {status} {t[\"scrapeUrl\"]}')
except:
    print('Ошибка получения targets')
"

echo ""
echo "5. Доступные метрики (первые 5):"
curl -s http://localhost:9090/api/v1/label/__name__/values 2>/dev/null | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(f'Всего метрик: {len(data[\"data\"])}')
    for metric in data['data'][:5]:
        print(f'  - {metric}')
except:
    print('Ошибка получения метрик')
"
EOF

chmod +x /tmp/test_prometheus.sh
/tmp/test_prometheus.sh
```
<br/>


## Полезные команды для управления:

### Проверка конфигурации:
```bash
promtool check config /etc/prometheus/prometheus.yml
```

### Просмотр метрик в реальном времени:
```bash
curl -s http://localhost:9090/api/v1/query?query=up | python3 -m json.tool
```

### Проверка конкретных метрик:
```bash
curl -s "http://localhost:9090/api/v1/query?query=node_cpu_seconds_total" | python3 -m json.tool
```

### Веб-интерфейс Prometheus:
```bash
echo "Откройте в браузере: http://192.168.87.179:9090"
```

---

## Итоговая архитектура:

### runelfrontdev (192.168.87.179):
```
├── Grafana (3000)        - визуализация (логи + метрики)
├── Loki (3100)           - логирование (остаётся)
├── Promtail (9080)       - сбор логов (остаётся)
├── Prometheus (9090)     - сбор метрик (новое!)
└── Node-exporter (9100)  - метрики сервера (новое!)
```

### starodubtcevs (192.168.195.122):
```
├── Promtail (9080)       - сбор логов (остаётся)
└── Node-exporter (9100)  - метрики сервера (новое!)
```

---

## Что теперь у вас работает:

### ✅ Система логирования (осталась):
- **Логи** → Loki + Promtail
- **Поиск** → LogQL через Grafana или LogCLI
- **Сбор** → с обоих серверов

### ✅ Система мониторинга метрик (добавлена):
- **Метрики** → Prometheus + Node-exporter
- **Визуализация** → PromQL через Grafana
- **Сбор** → с обоих серверов

### ✅ Единый интерфейс:
- **Grafana** → для просмотра и логов, и метрик

---

