# Установка Grafana + Loki + LogCLI + Promtail

Статья для руководства [Установка и использование Grafana Loki на Linux](https://www.dmosk.ru/instruktions.php?object=grafana-loki)

## Установка необходимых компонент
```bash
apt install -y iptables-persistent
apt install -y wget curl git
```


## Правила iptables для портов
Забегая вперёд, есть смысл заранее разрешить правила для портов.
```bash
iptables -I INPUT 1 -p tcp --dport 3100 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 9080 -j ACCEPT
netfilter-persistent save
iptables -L -nv
iptables -L -nv | grep -E '(9080|3100)'
iptables -S

# Посмотреть правила для SSH порта (9080)
sudo iptables -L -n -v | grep -A5 -B5 ':9080'
```
```bash
# Проверить, есть ли правила для блокировки атакующих IP
sudo iptables -L -n -v | grep 94.182.95.185

# Посмотреть счетчики пакетов для INPUT цепочки
sudo iptables -L INPUT -n -v
```



## Установка Go
Смотрим [доступные версии GO](https://go.dev/dl/) и качаем.
```bash
cd /usr/local/
wget https://go.dev/dl/go1.25.1.linux-amd64.tar.gz
tar -xvf go1.25.1.linux-amd64.tar.gz
```
Редактируем **`/etc/profile`**, добавляя вниз:
```ini
export PATH=$PATH:/usr/local/go/bin
echo 'export PATH=$PATH:/usr/local/go/bin' | sudo tee -a /etc/profile
#echo 'export PATH=$PATH:/usr/local/go/bin' | sudo cat >> /etc/profile
#printf '\nexport PATH=$PATH:/usr/local/go/bin\n' | sudo tee -a /etc/profile
```
И один раз выполняем данную команду: ***`export PATH=$PATH:/usr/local/go/bin`***
```sh
root@app /usr/local/go
14:04:20 # go version
go version go1.25.1 linux/amd64
```


## Установка Grafana
Увы, но для РФ бинарники отсюда https://dl.grafana.com/grafana/release/12.1.1/grafana_12.1.1_16903967602_linux_amd64.deb недоступны.
<br/> Будем использовать ссылку https://dl.grafana.com/oss/release/grafana_12.1.1_amd64.deb

```
root@loki-grafana /etc/promtail
10:55:46 # ss -tlnp | grep 3000
LISTEN 0      4096               *:3000             *:*    users:(("grafana",pid=22100,fd=22))  
```

После установки отредактируем конфиг. файл **`/etc/grafana/grafana.ini`**:
```ini
### общие настройки пользователей

[users]
# Разрешить самостоятельную регистрацию
allow_sign_up = false

# Разрешить создание организаций
allow_org_create = false

# Автоматически назначать организацию для новых пользователей
auto_assign_org = true

# ID организации по умолчанию
auto_assign_org_id = 1

# Роль по умолчанию для новых пользователей (Viewer, Editor, Admin)
auto_assign_org_role = Viewer
```
```ini
### секции аутентификации - от них зависит, как создаются пользователи

[auth.anonymous]
# Анонимный доступ
enabled = false

[auth.basic]
# Базовая аутентификация
enabled = true
```
```ini
### Внешние провайдеры (LDAP, OAuth, SAML и др.)

[auth.ldap]
enabled = true
config_file = /etc/grafana/ldap.toml

[auth.github]
enabled = false
```


После чего можно в CLI создавать пользователей:
```bash
curl -X POST -H "Content-Type: application/json" \
-d '{"name":"User","email":"user@example.com","login":"user","password":"password"}' \
http://admin:admin@localhost:3000/api/admin/users
```
```bash
curl -X POST http://192.168.87.209:3000/api/admin/users \
  -H "Content-Type: application/json" \
  -d '{
    "name":"Kirill Korablin",
    "email":"k@runtel.ru",
    "login":"kkorablin",
    "password":"securepassword"
  }' \
  -u admin:admin_password
```


## Установка Loki
```bash
# Скачиваем последнюю версию Loki
wget https://github.com/grafana/loki/releases/download/v3.4.5/loki_3.4.5_amd64.deb

# Устанавливаем
sudo dpkg -i loki_3.4.5_amd64.deb
sudo apt --fix-broken install -y

loki --version
loki, version 3.4.5 (branch: release-3.4.x, revision: b2c87ba6)
```


## Установка Promtail
```bash
# Скачиваем последнюю версию Promtail
wget https://github.com/grafana/loki/releases/download/v2.9.5/promtail_2.9.5_amd64.deb

# Устанавливаем
sudo dpkg -i promtail_2.9.5_amd64.deb
sudo apt --fix-broken install -y

promtail --version
promtail, version 2.9.5 (branch: release-2.9.x, revision: eee3598)
```
Добавить пользователя promtail в группу adm:
```bash
sudo usermod -a -G adm promtail
```
Проверить/изменить права доступа к логам:
```bash
# Дайте права на чтение для группы
sudo chmod 644 /var/log/auth.log
sudo chmod 644 /var/log/cron.log
sudo chmod 644 /var/log/mail.log
sudo chmod 644 /var/log/user.log

# Для директории runtel
sudo chmod -R 644 /var/log/runtel/*
sudo chmod 755 /var/log/runtel/
```



## Установка logcli, проверка логов
Проверить **`/etc/resolv.conf`**, должно быть:
```ini
# --- BEGIN PVE ---
nameserver 8.8.8.8
nameserver 1.1.1.1
nameserver 77.88.8.8
# --- END PVE ---
```
Проверка сетевой доступности github:
```bash
ping -c 3 185.199.108.133
nslookup github.com 8.8.8.8
nslookup github.com 1.1.1.1
```

```bash
wget https://github.com/grafana/loki/releases/download/v3.5.3/logcli_3.5.3_amd64.deb
dpkg -i logcli_3.5.3_amd64.deb
logcli --version
```
Или прямое скачивание:
```bash
curl -L -o logcli.deb https://github.com/grafana/loki/releases/download/v3.5.3/logcli_3.5.3_arm64.deb
```

## Примеры использования Logcli на машине **`Loki+Promtail+Grafana`**:

[Читай LogCLI](https://grafana.com/docs/loki/latest/query/logcli/getting-started/), 
[Читай LogQL](https://grafana.com/docs/loki/latest/query/)

Можно задать переменную **`LOKI_ADDR=http://localhost:3100`** в `~/.profile`.

**Ключевое правило для Loki:** Всегда используйте:
- `=~".+"` вместо `=~".*"`
- `!=""` для неравенства
-  вместо оператора `or` может использоваться внутри запроса оператор `|` в зависимости от версии Logcli и Loki

### 1. Labels - Работа с метками
```bash
# Все метки
logcli labels --addr=http://localhost:3100
logcli labels --addr=http://localhost:3100 --since=24h

# Значения конкретных меток
logcli labels --addr=http://localhost:3100 job
logcli labels --addr=http://localhost:3100 service_name
logcli labels --addr=http://localhost:3100 level
logcli labels --addr=http://localhost:3100 daemon
logcli labels --addr=http://localhost:3100 instance
logcli labels --addr=http://localhost:3100 filename

# С фильтрацией по времени
logcli labels --addr=http://localhost:3100 job --since=7d

# Узнать, какие комбинации меток существуют
logcli series --addr=http://localhost:3100 '{}' | head -20
```

### 2.1. Query - Основные запросы логов
```bash

# Базовые запросы
logcli query --addr=http://localhost:3100 '{job="varlogs"}'
logcli query --addr=http://localhost:3100 '{service_name=~".*runtel.*"}' --limit=100
logcli query --addr=$LOKI_ADDR '{service_name=~".*runtel.*"}' --limit=10
logcli query --addr=http://localhost:3100 '{service_name!~"vps3"}' --since=24h

# С временными диапазонами
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --since=1h
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --from="2025-09-23T10:00:00Z" --to="2024-00-29T12:00:00Z"
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --last=30m

# С выводом дополнительной информации
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --limit=50 --output=default
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --limit=20 --output=jsonl
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --limit=10 --quiet --no-labels

# С фильтрацией по времени и лимитами
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --tail --delay-for=5s
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --forward
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --step=1m
```

### 2.2. Query - запросы логов со ВСЕХ источников
```bash
# Для объединения используй ','
logcli query --addr=http://localhost:3100 '{job=~".+",service_name=~".+",host=~".+"}' --limit=13
logcli query --addr=http://localhost:3100 '{job=~".+", service_name=~".+", host=~".+"}' --limit=13

# Через отдельные запросы можно сделать объединение
logcli query --addr=http://localhost:3100 '{service_name=~".+"}' --limit=12
logcli query --addr=http://localhost:3100 '{job=~".+"}' --limit=15
logcli query --addr=http://localhost:3100 '{filename=~".+"}' --limit=25

# Все логи без фильтров (может быть тяжело для Loki)
logcli query --addr=http://localhost:3100 '{}' --limit=50
logcli query --addr=http://localhost:3100 '{}' --since=1h --limit=70

# Все логи с ограничением по времени
logcli query --addr=http://localhost:3100 '{}' --last=15m --limit=20

# Все логи от всех jobs
logcli query --addr=http://localhost:3100 '{job!=""}' --limit=11

# Конкретные системные демоны
logcli query --addr=http://localhost:3100 '{job=~"systemd|docker|kube.*"}' --limit=20

# Исключая тестовые/временные jobs
logcli query --addr=http://localhost:3100 '{job!~"test|temp|debug"}' --since=1h --limit=50

# Все сервисы
logcli query --addr=http://localhost:3100 '{service_name!=""}' --limit=40

# Сервисы по паттерну
logcli query --addr=http://localhost:3100 '{service_name=~".*"}' --since=30m --limit=30

# Логи со всех инстансов
logcli query --addr=http://localhost:3100 '{instance!=""}' --limit=25

# Конкретные хосты по паттерну
logcli query --addr=http://localhost:3100 '{instance=~".*"}' --since=1h --limit=20

# Логи из всех файлов
logcli query --addr=http://localhost:3100 '{filename!=""}' --limit=30

# Системные логи
logcli query --addr=http://localhost:3100 '{filename=~"/var/log/.*"}' --since=2h --limit=25

# Логи приложений
logcli query --addr=http://localhost:3100 '{filename=~".*\\.log"}' --limit=20

# Логи от всех возможных источников
logcli query --addr=http://localhost:3100 '{job=~".*"}' --or '{service_name=~".*"}' --or '{instance=~".*"}' --limit=40

# Системные логи + логи приложений
logcli query --addr=http://localhost:3100 '{job=~"systemd|docker|kube.*"}' --or '{service_name=~".*"}' --since=1h --limit=50

# Все логи, кроме определенных
logcli query --addr=http://localhost:3100 '{job!~"test|temp"} != "debug"' --limit=30

# Только рабочие логи
logcli query --addr=http://localhost:3100 '{environment=~"prod|staging"}' --since=2h --limit=40
```

### 2.3. Аналитические запросы по всем источникам
```bash
# Объем логов со всех источников
logcli volume-range --addr=http://localhost:3100 '{}' --since=6h --step=15m
logcli volume_range --addr=http://localhost:3100 '{}' --since=50ь --step=10m

# Статистика запросов
logcli stats --addr=http://localhost:3100 '{}' --since=1h

# Какие поля есть во всех логах
logcli detected-fields --addr=http://localhost:3100 '{}' --since=3h

# Уровни логирования со всех источников
logcli detected-fields --addr=http://localhost:3100 '{}' 'level' --since=1h

# Ограниченные запросы с малыми лимитами
logcli query --addr=http://localhost:3100 '{}' --limit=10 --since=5m
logcli query --addr=http://localhost:3100 '{}' --last=2m --limit=5

# Использование агрегаций вместо сырых логов
logcli instant-query --addr=http://localhost:3100 'count_over_time({} [5m])'
logcli instant-query --addr=http://localhost:3100 'sum by (job) (count_over_time({} [10m]))'
```

### 3. Instant-Query - Мгновенные запросы
```bash
# Мгновенные запросы для метрик
logcli instant-query --addr=http://localhost:3100 'rate({job="varlogs"} |~ "error" [5m])'
logcli instant-query --addr=http://localhost:3100 'count_over_time({service_name=~"runtel.*"} [1h])'
logcli instant-query --addr=http://localhost:3100 'sum by (level) (count_over_time({job="varlogs"} | json | level != "" [15m]))'

# С временными параметрами
logcli instant-query --addr=http://localhost:3100 --time="2024-01-15T12:00:00Z" 'rate({job="varlogs"}[5m])'
```

### 4. Series - Поиск серий
```bash
# Все серии
logcli series --addr=http://localhost:3100 '{}' 
logcli series --addr=http://localhost:3100 '{}' --since=1h

# Фильтрация серий
logcli series --addr=http://localhost:3100 '{job=~".*"}'
logcli series --addr=http://localhost:3100 '{service_name=~"runtel.*"}'
logcli series --addr=http://localhost:3100 '{level="error"}'
logcli series --addr=http://localhost:3100 '{job!~"test"}'

# С временными диапазонами
logcli series --addr=http://localhost:3100 '{}' --from="2024-01-15T00:00:00Z" --to="2024-01-15T23:59:59Z"
```

### 5. Stats - Статистика запросов
```bash
# Статистика по запросам
logcli stats --addr=http://localhost:3100 '{job="varlogs"}' --since=1h
logcli stats --addr=http://localhost:3100 '{service_name=~"runtel.*"}' --from="2025-09-23T00:00:00Z" --to="2025-09-29T23:59:59Z"

# Детальная статистика
logcli stats --addr=http://localhost:3100 '{job="varlogs"}' --since=24h --quiet
```

### 6. Volume - Анализ объема логов
```bash
# Объем логов
logcli volume --addr=http://localhost:3100 '{job="varlogs"}'
logcli volume --addr=http://localhost:3100 '{service_name=~"runtel.*"}' --since=6h

# Volume range с агрегацией
logcli volume-range --addr=http://localhost:3100 '{job="varlogs"}' --since=24h
logcli volume-range --addr=http://localhost:3100 '{service_name=~".*"}' --from="2025-09-23T00:00:00Z" --to="2025-09-29T23:59:59Z" --step=1h

# С группировкой
logcli volume-range --addr=http://localhost:3100 '{job="varlogs"}' --since=24h --step=15m --limit=20
```

### 7. Detected Fields - Анализ полей
```bash
# Обнаружение полей
logcli detected-fields --addr=http://localhost:3100 '{job="varlogs"}' --since=1h
logcli detected-fields --addr=http://localhost:3100 '{service_name=~"runtel.*"}' --since=24h

# Конкретное поле
logcli detected-fields --addr=http://localhost:3100 '{job="varlogs"}' 'level'
logcli detected-fields --addr=http://localhost:3100 '{job="varlogs"}' 'method' --since=6h
```

### 8. Продвинутые примеры с флагами
```bash
# Отладка и повторные попытки
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --retries=5 --timeout=30s
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --stats --quiet

# Форматы вывода
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --output=raw
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --output=jsonl --no-labels

# Работа с файлами через stdin
echo '{job="varlogs"}' | logcli query --addr=http://localhost:3100 --stdin --since=1h
cat queries.txt | logcli query --addr=http://localhost:3100 --stdin

# Сложные LogQL запросы
logcli query --addr=http://localhost:3100 'rate({job="varlogs"} |~ "error" [5m])' --since=1h
logcli query --addr=http://localhost:3100 '{job="varlogs"} | json | level="error"' --limit=50
logcli query --addr=http://localhost:3100 '{job="varlogs"} | line_format "{{.timestamp}} {{.msg}}"' --since=30m
```

### 9. Мониторинг и анализ
```bash
# Мониторинг в реальном времени
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --tail --delay-for=2s

# Анализ производительности
logcli query --addr=http://localhost:3100 '{job="varlogs"}' --since=1h --step=5m --stats

# Сравнение объемов
logcli volume-range --addr=http://localhost:3100 '{service_name=~"runtel.*"}' --since=7d --step=1h --limit=50
```

### 10. Утилитарные команды
```bash
# Проверка подключения
logcli labels --addr=http://localhost:3100 --quiet

# Бенчмарк запросов
time logcli query --addr=http://localhost:3100 '{job="varlogs"}' --since=1h --limit=1000 --quiet > /dev/null

# Экспорт логов
logcli query --addr=http://localhost:3100 '{service_name=~"runtel.*"}' --since=24h --output=jsonl > logs_export.jsonl
```

### Пример скрипта для мониторинга:
```bash
#!/bin/bash
LOKI_ADDR="http://localhost:3100"

echo "=== Loki Monitoring Dashboard ==="
echo

echo "1. Available labels:"
logcli labels --addr=$LOKI_ADDR --quiet | head -10
echo

echo "2. Recent errors (last 30min):"
logcli query --addr=$LOKI_ADDR '{level="error"}' --since=30m --limit=5 --no-labels
echo

echo "3. Log volume by service (last 1h):"
logcli volume-range --addr=$LOKI_ADDR '{service_name=~".*"}' --since=1h --step=10m --quiet
echo

echo "4. Top fields detected:"
logcli detected-fields --addr=$LOKI_ADDR '{job="varlogs"}' --since=1h --quiet | head -5
```

<br/>



# Конфигурирование

## Создание конфигурационных файлов

Создаём файл **`/etc/loki/loki-config.yml`**
<details>
<summary>❗loki-config.yml❗</summary>

```yml
auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  path_prefix: /tmp/loki
  storage:
    filesystem:
      chunks_directory: /tmp/loki/chunks
      rules_directory: /tmp/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory

limits_config:
  allow_structured_metadata: false  # для отключения structured metadata

query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 100

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

analytics:
  reporting_enabled: false
```
</details>  


Создаём файл **`/etc/promtail/promtail-config.yml`**
<details>
<summary>❗promtail-config.yml❗</summary>

```yml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push
#  - url: http://192.168.87.60:3100/loki/api/v1/push
#  - url: http://192.168.87.209:3100/loki/api/vq/push


scrape_configs:
- job_name: system-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*.log

- job_name: grafana-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: grafana-209
      __path__: /var/log/grafana/*.log

- job_name: syslog-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog-209
      __path__: /var/log/syslog

- job_name: auth-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth-209
      __path__: /var/log/auth.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\w{3} \d{1,2} \d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<daemon>\S+)(?:\[(?P<pid>\d+)\])?: (?P<message>.*)'
    - labels:
        daemon:


- job_name: runtel-logs-209
  static_configs:
  - targets:
      - localhost
    labels:
      job: runtel-logs-209
      __path__: /var/log/runtel/*.log
  pipeline_stages:
    - regex:
        expression: '^\s*(?P<timestamp>\d{2}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \| (?P<pid>\d+) \| (?P<module>[^|]+) \| (?P<function>[^:]+):(?P<line>\d+) \| (?P<level>\w+) \| (?P<message>.*)'
    - labels:
        level:
        module:
```
</details> 




Создаём файл **`/etc/promtail/promtail-config.yml` на другой машине**
<details>
<summary>❗promtail-config.yml❗</summary>

```yml
server:
  http_listen_address: 127.0.0.1  # отключение web интерфейса
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
#  - url: http://localhost:3100/loki/api/v1/push
  - url: http://192.168.87.209:3100/loki/api/v1/push

scrape_configs:
- job_name: auth-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: auth-60
      __path__: /var/log/auth.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\w{3} \d{1,2} \d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<daemon>\S+)(?:\[(?P<pid>\d+)\])?: (?P<message>.*)'
    - labels:
        daemon:


- job_name: runtel-logs-60
  static_configs:
  - targets:
      - localhost
    labels:
      job: runtel-logs-60
      host: app-60
      __path__: /var/log/runtel/*.log
  pipeline_stages:
    - regex:
        expression: '^\s*(?P<timestamp>\d{2}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \| (?P<pid>\d+) \| (?P<module>[^|]+) \| (?P<function>[^:]+):(?P<line>\d+) \| (?P<level>\w+) \| (?P<message>.*)'
    - labels:
        level:
        module:
```
</details> 




## Редактирование systemd юнитов

```ini
### /etc/systemd/system/loki.service
[Unit]
Description=Grafana Loki service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=loki
ExecStart=/usr/bin/loki -config.file /etc/loki/loki-config.yml
# Give a reasonable amount of time for the server to start up/shut down
TimeoutSec = 120
Restart = on-failure
RestartSec = 2

[Install]
WantedBy=multi-user.target
```

```ini
### /etc/systemd/system/promtail.service
[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
User=promtail
Group=adm
#User=root
ExecStart=/usr/bin/promtail -config.file /etc/promtail/promtail-config.yml
# Give a reasonable amount of time for promtail to start up/shut down
TimeoutSec = 60
Restart = on-failure
RestartSec = 2

[Install]
WantedBy=multi-user.target
```
<br/>



# Запуск

Для проверка и запуска используем следующие команды:
```bash 
/usr/bin/loki -config.file /etc/loki/loki-config.yml -verify-config
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml --dry-run                # запуск Promtail
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml -check-syntax
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml -inspect
/usr/bin/promtail --config.file=/etc/promtail/promtail-config.yml --client.external-labels=hostname=$(hostname) -log.level=debug
```
Проверка с помощью curl
```bash
curl -s http://192.168.87.209:9080/targets | grep -iE job | sort
curl -s http://192.168.87.60:9080/targets | grep -iE job | sort | uniq
curl -s -o /dev/null -w "%{http_code}" http://192.168.87.60:9080/ready

curl -s http://192.168.87.60:9080/metrics
curl -s http://192.168.87.60:9080/metrics | grep promtail_target_entries
curl -s http://192.168.87.60:9080/metrics | grep promtail_target
curl -s http://192.168.87.60:9080/metrics | grep promtail_file

curl -s http://192.168.87.60:9080/api/v1/targets | jq .

curl -s http://192.168.87.60:9080/metrics | grep -E '(promtail_target_.*|promtail_file_.*)' | grep -v '#'
```

Проверяем в бразуере:
- http://192.168.87.209:3000 -> Grafana
- http://192.168.87.209:3100/metrics -> Loki
- http://192.168.87.209:9080/targets -> Promtail
- http://192.168.87.60:9080/targets -> Promtail на удалённой машине

текущая архитектура:
```
192.168.87.60 (app) 
    └── Promtail → логи runtel/*.log → 192.168.87.209:3100 (Loki)

192.168.87.209 (loki-grafana)
    └── Promtail → логи /var/log/*.log → localhost:3100 (Loki)
    └── Loki (порт 3100)
    └── Grafana (подключается к Loki)
```
<br/>



## скрипт для логов
Перейти в ~/scripts, создать check_logcli.sh:
```bash
LOKI_ADDR=http://localhost:3100

echo
echo "Все доступные label names"
logcli labels --addr=http://localhost:3100
echo
echo "Значения для конкретных меток job и level"
logcli labels --addr=http://localhost:3100 job
logcli labels --addr=http://localhost:3100 level
echo "--------------------"

echo "Проверка 10 последних логов с сервисов runtel-logs-msk-vps1/2/3"
logcli query --addr=$LOKI_ADDR '{service_name=~"runtel-logs-msk-vps.+"}' --limit=10
echo "--------------------"

# Проверка доступности меток
echo "Available labels count:"
logcli labels --addr=$LOKI_ADDR --quiet | wc -l

# Проверка объема данных (ИСПРАВЛЕНО - используем непустой матчер)
echo "Log volume last 15min:"
logcli volume-range --addr=$LOKI_ADDR '{job=~".+"}' --since=15m --step=5m --quiet

# Проверка ошибок со всех источников (ИСПРАВЛЕНО - используем непустой матчер)
echo "Recent errors from all sources:"
logcli query --addr=$LOKI_ADDR '{job=~".+"} |~ "error|Error|ERROR"' --since=10m --limit=5 --no-labels --quiet

# Проверки
echo "--------------------"
echo "Дополнительные проверки:"

echo "1. Всего серий с непустыми job:"
logcli series --addr=$LOKI_ADDR '{job=~".+"}' --since=1h | wc -l

echo "2. Логи с критическими уровнями:"
logcli query --addr=$LOKI_ADDR '{level=~"ERROR|CRITICAL|FATAL"}' --since=1h --limit=3 --no-labels

echo "3. Распределение по хостам:"
logcli query --addr=$LOKI_ADDR '{host=~".+"}' --limit=5 --no-labels --quiet

echo "--------------------"
echo "Читай LogCLI\ https://grafana.com/docs/loki/latest/query/logcli/getting-started/"
echo "Читай LogQL\ https://grafana.com/docs/loki/latest/query/"
echo "===================="
```

<br/>




## Рекомендация по защите SSH:

Учитывая, что с `94.182.95.185` приходят failed password attempts, рекомендую добавить правила:

```bash
# Блокировать IP после нескольких неудачных попыток
sudo iptables -A INPUT -s 94.182.95.185 -p tcp --dport 22 -j DROP

# Или использовать fail2ban для автоматической блокировки
sudo apt install fail2ban
```

Также можно проверить логи SSH для подробного анализа атак:
```bash
sudo tail -f /var/log/auth.log | grep ssh
```


## Проверка статуса fail2ban:

```bash
# Проверить статус службы
sudo systemctl status fail2ban

# Посмотреть какие jail активны
sudo fail2ban-client status

# Проверить конкретно для SSH
sudo fail2ban-client status sshd
```

## Проверка конфигурации:

Основные конфигурационные файлы обычно находятся в:
- `/etc/fail2ban/jail.conf` - основной файл (не редактировать)
- `/etc/fail2ban/jail.local` - пользовательские настройки (если есть)
- `/etc/fail2ban/jail.d/` - дополнительные конфигурации

## Проверка логов fail2ban:

```bash
# Логи fail2ban
sudo tail -f /var/log/fail2ban.log

# Проверить, блокирует ли fail2ban атакующие IP
sudo grep "94.182.95.185" /var/log/fail2ban.log
```

## Быстрая проверка iptables:

```bash
# Проверить, есть ли правила от fail2ban в iptables
sudo iptables -L -n -v | grep f2b

# Или посмотреть цепочку fail2ban
sudo iptables -L f2b-sshd -n -v
```

## Если нужно добавить блокировку вручную:

```bash
# Временная блокировка IP
sudo iptables -A INPUT -s 94.182.95.185 -j DROP

# Или более специфичная блокировка только SSH
sudo iptables -A INPUT -s 94.182.95.185 -p tcp --dport 22 -j DROP
```

## Рекомендации по настройке fail2ban:

Если fail2ban не блокирует атакующие IP, проверьте настройки в `/etc/fail2ban/jail.local` или создайте его:

```bash
sudo mcedit /etc/fail2ban/jail.local
```

Пример базовой конфигурации для SSH:
```ini
[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

После изменений перезапустите fail2ban:
```bash
sudo systemctl restart fail2ban
```
```bash
sudo fail2ban-client set sshd banip 94.182.95.185
sudo fail2ban-client get sshd maxretry
sudo fail2ban-client get sshd bantime
sudo fail2ban-client get sshd findtime
```
