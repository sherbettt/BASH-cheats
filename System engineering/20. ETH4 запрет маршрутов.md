### Требования:
1. Интерфейс isolated (192.168.189.1/24) должен:
- Иметь выход в интернет через vmbr0 (192.168.87.251).
- Не иметь доступа к сетям dmznet (192.168.46.0/24) и pgnet (192.168.45.0/24).

2. Машины в isolated должны:
- Использовать 192.168.189.1 как шлюз.
- Иметь доступ в интернет, но не иметь доступа к dmznet и pgnet.

машина **Container 187 (dmzgateway3) on node 'prox4'**, у которой три интерфейса с типом Bridge:
- vmbr0: 192.168.87.251/24 (шлюз 192.168.87.1) - внешка и-нет;
- dmznet: 192.168.46.251/24 - является шлюзом для других машин в этой сети;
- pgnet: 192.168.45.251/24 - является шлюзом для других машин в этой сети;
- *isolated: 192.168.189.1/24 - внешка и-нет через vmbr0, не связана с сетями dmznet и pgnet*

Создаём 4-й сеть с названием ***isolated*** по пути Datacenter -> SDN -> VNets, подтверждаем в SDN. Добавляем четвёртый интерфейс к dmzgateway3 и выдаём адрес **`192.168.189.1/24`**.

Если нужно **только запретить доступ** из сети `eth4 (192.168.189.0/24)` в `dmznet (192.168.46.0/24)` и `pgnet (192.168.45.0/24)`, но **оставить интернет-доступ**, то достаточно добавить **правила `iptables`**.  

### **1. Проверка правил
```bash
root@dmzgateway3 ~ # iptables -L -v -n
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
```

### **2. Блокируем доступ из eth4 в dmznet и pgnet**
```bash
# Запрещаем трафик с eth4 в dmznet (192.168.46.0/24)
iptables -A FORWARD -i eth4 -d 192.168.46.0/24 -j DROP

# Запрещаем трафик с eth4 в pgnet (192.168.45.0/24)
iptables -A FORWARD -i eth4 -d 192.168.45.0/24 -j DROP

# (Опционально) Если машина сама инициирует трафик с eth4 в эти сети:
iptables -A OUTPUT -o eth4 -d 192.168.46.0/24 -j DROP
iptables -A OUTPUT -o eth4 -d 192.168.45.0/24 -j DROP
```

### **3. Разрешаем интернет-доступ (если не настроен NAT)**
Если на `192.168.189.1` (шлюз для `eth4`) не включен NAT, его можно добавить:
```bash
iptables -t nat -A POSTROUTING -o eth4 -j MASQUERADE
iptables -A FORWARD -i eth4 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o eth4 -j ACCEPT
```

### **4. Проверяем правила**
```bash
iptables -L FORWARD -nv  # Проверяем блокировку
ping 192.168.46.1        # Должен не работать
ping 192.168.45.1        # Должен не работать
ping 8.8.8.8             # Должен работать (если настроен NAT)
```

### **5. Сохраняем правила (если нужно)**
```bash
iptables-save > /etc/iptables/rules.v4   # Debian/Ubuntu
iptables-save > /etc/sysconfig/iptables  # CentOS/RHEL
```

### **Итог:**
- **Доступ в `192.168.46.0/24` и `192.168.45.0/24` закрыт** для `eth4`.
- **Интернет работает** (если настроен NAT или шлюз `192.168.189.1` пропускает трафик).
- **Остальные сети (`192.168.87.0/24` и локальные интерфейсы) не затронуты**.  

Если нужно **полностью изолировать `eth4`** от всех внутренних сетей, кроме интернета, можно добавить:
```bash
iptables -A FORWARD -i eth4 -d 192.168.0.0/16 -j DROP
```
--------------------------

Похоже, что добавленные правила `iptables` не блокируют трафик, как ожидалось. Это может происходить по нескольким причинам:

### **Почему ping всё ещё работает?**
1. **Правила `FORWARD` применяются только к транзитному трафику**, но не к трафику, который генерируется самой машиной.
2. Ваш `ping` идет **с самой маршрутизатора**, а не через него, поэтому `FORWARD` не срабатывает.
3. Если машина сама является источником пакетов, нужно блокировать их в цепочке **`OUTPUT`**.



### **Как исправить?**
#### **1. Блокируем исходящий трафик с `eth4` в запрещённые сети**
```bash
iptables -A OUTPUT -o eth4 -d 192.168.46.0/24 -j DROP
iptables -A OUTPUT -o eth4 -d 192.168.45.0/24 -j DROP
```

#### **2. (Дополнительно) Блокируем входящий трафик с `dmznet` и `pgnet` на `eth4`**
```bash
iptables -A INPUT -i eth4 -s 192.168.46.0/24 -j DROP
iptables -A INPUT -i eth4 -s 192.168.45.0/24 -j DROP
```

#### **3. Проверяем правила**
```bash
iptables -L OUTPUT -nv
iptables -L INPUT -nv
```

#### **4. Проверяем ping (должен не работать)**
```bash
ping 192.168.46.1
ping 192.168.45.1
ping 8.8.8.8  # Интернет должен работать
```



### **Если проблема осталась**
1. **Проверьте, не переопределены ли правила где-то ещё:**
   ```bash
   iptables-save | grep -E "192.168.46|192.168.45"
   ```
2. **Убедитесь, что `eth4` действительно используется для этого трафика:**
   ```bash
   ip route get 192.168.46.1
   ip route get 192.168.45.1
   ```
3. **Если трафик идёт через другой интерфейс**, блокируйте его там:
   ```bash
   iptables -A OUTPUT -o eth0 -d 192.168.46.0/24 -j DROP
   iptables -A OUTPUT -o eth0 -d 192.168.45.0/24 -j DROP
   ```



### **Итоговый набор правил**
```bash
# Блокируем FORWARD (если это транзитный трафик)
iptables -A FORWARD -i eth4 -d 192.168.46.0/24 -j DROP
iptables -A FORWARD -i eth4 -d 192.168.45.0/24 -j DROP

# Блокируем OUTPUT (если трафик генерируется на самом маршрутизаторе)
iptables -A OUTPUT -o eth4 -d 192.168.46.0/24 -j DROP
iptables -A OUTPUT -o eth4 -d 192.168.45.0/24 -j DROP

# (Опционально) Блокируем INPUT (если нужно запретить ответы)
iptables -A INPUT -i eth4 -s 192.168.46.0/24 -j DROP
iptables -A INPUT -i eth4 -s 192.168.45.0/24 -j DROP
```

После этого:
- **`ping 192.168.46.1` и `ping 192.168.45.1` должны перестать работать**.
- **Доступ в интернет (`8.8.8.8`) останется**.



