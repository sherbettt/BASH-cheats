# üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ FreeSWITCH –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ FreeSWITCH**
```bash
systemctl status freeswitch
journalctl -u freeswitch -f
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**
```bash
tail -f /var/log/freeswitch/freeswitch.log
tail -f /var/log/freeswitch/freeswitch.log | grep -i error
```

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è fs_cli**
```bash
fs_cli
# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º:
netstat -tlnp | grep 8021
ss -tulpn | grep 8021
```

## üõ†Ô∏è –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Fail2ban –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º—ã:
```bash
fail2ban-client status runtel
iptables -L -n -v | grep 192.168.87.25
```

### –†–µ—à–µ–Ω–∏–µ:
**–§–∞–π–ª:** `/etc/fail2ban/jail.d/runtel.conf`

**–ë—ã–ª–æ:**
```ini
[runtel]
enabled = true
bantime = 365d
maxretry = 10
findtime = 10
protocol = all
banaction = iptables-allports
ignoreip = 185.23.82.153
```

**–°—Ç–∞–ª–æ:**
```ini
[runtel]
enabled = true
bantime = 365d
maxretry = 10
findtime = 10
protocol = all
banaction = iptables-allports
ignoreip = 185.23.82.153 127.0.0.1/8 192.168.87.0/24
port = all
logpath = /var/log/freeswitch/freeswitch.log
```

### –ö–æ–º–∞–Ω–¥—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
```bash
# –°–Ω—è—Ç—å —Ç–µ–∫—É—â—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
fail2ban-client set runtel unbanip 192.168.87.25

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å fail2ban
systemctl restart fail2ban

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
fail2ban-client status runtel
```

## üõ†Ô∏è –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö FreeSWITCH

### –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Runtel:

**–§–∞–π–ª:** `/etc/freeswitch/runtel.xml`

```xml
<include>
          <X-PRE-PROCESS cmd="set" data="runtel_switch_name=floatip1.runtel.ru"/>
          <X-PRE-PROCESS cmd="set" data="runtel_max_sessions=1000"/>
          <X-PRE-PROCESS cmd="set" data="runtel_max_cps=500"/>
          <X-PRE-PROCESS cmd="set" data="runtel_proxy_host=127.0.0.1"/>
          <X-PRE-PROCESS cmd="set" data="runtel_core=4001"/>
          <X-PRE-PROCESS cmd="set" data="runtel_core_esl=4002"/>
          <X-PRE-PROCESS cmd="set" data="runtel_cdr=4003"/>
          <X-PRE-PROCESS cmd="set" data="default_hold=local_stream://default"/>
          <X-PRE-PROCESS cmd="set" data="fs_base_dir=/fs/"/>
          <X-PRE-PROCESS cmd="set" data="fs_log_dir=/fs/log/"/>
          <X-PRE-PROCESS cmd="set" data="fs_recording_dir=/fs/recordings/"/>
          <X-PRE-PROCESS cmd="set" data="fs_fax_dir=/fs/fax/"/>
          <X-PRE-PROCESS cmd="set" data="fs_voice_mail_dir=/fs/voice_mail/"/>
          <X-PRE-PROCESS cmd="set" data="fs_conference_dir=/fs/conference/"/>
</include>

```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

**–§–∞–π–ª:** `/etc/freeswitch/autoload_configs/switch.conf.xml`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è:**
```xml
<settings>
    <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π -->
    <param name="max-sessions" value="$${runtel_max_sessions}"/>
    
    <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π –≤ —Å–µ–∫—É–Ω–¥—É -->
    <param name="sessions-per-second" value="$${runtel_max_cps}"/>
    
    <!-- –î—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <param name="min-idle-cpu" value="0.00"/>
    <param name="colorize-console" value="true"/>
</settings>
```

## üõ†Ô∏è –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Event Socket

**–§–∞–π–ª:** `/etc/freeswitch/autoload_configs/event_socket.conf.xml`

```xml
<configuration name="event_socket.conf" description="Socket Client">
    <settings>
        <param name="nat-map" value="false"/>
        <param name="listen-ip" value="192.168.87.25"/>
        <param name="listen-port" value="8021"/>
        <param name="password" value="RuntelSecter2020"/>
        <param name="apply-inbound-acl" value="acl3"/>
    </settings>
</configuration>
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π:
```bash
# –ü–∞—Ä–æ–ª—å event_socket
cat /etc/freeswitch/autoload_configs/event_socket.conf.xml | grep password

# –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Runtel
grep -r "Runtel" /etc/freeswitch/
```

## üõ†Ô∏è –®–∞–≥ 4: –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã

**–§–∞–π–ª:** `/etc/security/limits.conf`

```bash
# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
* soft nofile 300090
* hard nofile 300090

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
_haproxy soft nofile 65536
_haproxy hard nofile 65536
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–æ–≤:
```bash
ulimit -n
cat /proc/1/limits | grep "Max open files"
```

## üõ†Ô∏è –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ACL

**–§–∞–π–ª:** `/etc/freeswitch/autoload_configs/acl.conf.xml`

```xml
<configuration name="acl.conf" description="acl.conf">
    <network-lists>
        <list name="acl3" default="deny">
            <node cidr="127.0.0.1/8" type="allow"/>
            <node cidr="192.168.87.0/24" type="allow"/>
            <node cidr="172.16.15.0/24" type="allow"/>
        </list>
    </network-lists>
</configuration>
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å XML
/usr/bin/freeswitch -nf

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
fs_cli -H 192.168.87.25 -p RuntelSecter2020 -x "global_getvar"
```

### 2. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±**
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å FreeSWITCH
systemctl restart freeswitch

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
systemctl status freeswitch
```

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏**
```bash
fs_cli -H 192.168.87.25 -p RuntelSecter2020

# –í fs_cli –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
global_getvar runtel_max_sessions
global_getvar runtel_max_cps
global_getvar max_sessions
status
show channels count
```

## üìä –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –û–∂–∏–¥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```bash
# –í fs_cli:
runtel_max_sessions = 1000
runtel_max_cps = 300
max_sessions = 1000
status ‚Üí "1000 session(s) max"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```bash
# –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
./load_test.sh start 192.168.87.30:15284 100 9795
sleep 30
./load_test.sh start 192.168.87.30:15284 115 9795
sleep 30
./load_test.sh start 192.168.87.30:15284 120 9795
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Runtel –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|----------|------------|
| `runtel_max_sessions` | 1000 | –ú–∞–∫—Å. –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ |
| `runtel_max_cps` | 300 | –ú–∞–∫—Å. –Ω–æ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É |
| `runtel_switch_name` | floatip1.runtel.ru | –ò–º—è —Å–µ—Ä–≤–µ—Ä–∞ |
| `RuntelSecter2020` | –ü–∞—Ä–æ–ª—å | Event socket –ø–∞—Ä–æ–ª—å |
| `runtel_proxy_host` | 127.0.0.1 | –ü—Ä–æ–∫—Å–∏ —Ö–æ—Å—Ç |

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞–≥—Ä—É–∑–∫–∏
fs_cli -x "show channels count; status"

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
htop
free -h

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–∏
ss -tn | grep :5060 | wc -l
ss -tn | grep :5100 | wc -l
```

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ú–∞–∫—Å–∏–º—É–º: ~90 —É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏: NO_ROUTE_DESTINATION
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ: **119 –≤—ã–∑–æ–≤–æ–≤**
- ‚úÖ –ü–∏–∫–æ–≤–æ: **120 –≤—ã–∑–æ–≤–æ–≤** 
- ‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ: **+32% –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏

