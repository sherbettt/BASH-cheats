<details>
<summary>/etc/haproxy/haproxy.cfg</summary>

```cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE

backend postgres_master
    mode tcp
    balance roundrobin
    option httpchk GET /master
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg1 192.168.45.201:5432 check port 8008 inter 5s rise 2 fall 3
    server pg2 192.168.45.202:5432 check port 8008 inter 5s rise 2 fall 3
    server pg3 192.168.45.204:5432 check port 8008 inter 5s rise 2 fall 3

backend postgres_replica
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg1 192.168.45.201:5432 check port 8008 inter 5s rise 2 fall 3
    server pg2 192.168.45.202:5432 check port 8008 inter 5s rise 2 fall 3
    server pg3 192.168.45.204:5432 check port 8008 inter 5s rise 2 fall 3

frontend postgres_frontend
    bind *:5000
    mode tcp
    default_backend postgres_master

frontend postgres_readonly
    bind *:5001
    mode tcp
    default_backend postgres_replica

```
</details>

В конце файла должна быть пустая строка обязательно.

--------------
Это конфигурационный файл HAProxy, который используется для балансировки нагрузки и управления подключениями к кластеру PostgreSQL с Patroni.

### Глобальные настройки (global)
```cfg
log /dev/log local0          # Логирование в syslog с уровнем local0
log /dev/log local1 notice  # Доп. логирование с уровнем local1 и выше notice
chroot /var/lib/haproxy     # Изоляция процесса в chroot
stats socket /run/haproxy/admin.sock mode 660 level admin  # Сокет для управления
stats timeout 30s           # Таймаут для stats
user haproxy                # Запуск от пользователя haproxy
group haproxy               # и группы haproxy
daemon                      # Запуск в фоновом режиме
```

### Настройки по умолчанию (defaults)
```cfg
log global                   # Использовать глобальные настройки логирования
mode tcp                     # Режим работы с TCP (не HTTP)
option tcplog                # Логировать TCP-соединения
option dontlognull           # Не логировать пустые соединения
timeout connect 5000         # Таймаут подключения 5 сек
timeout client 50000         # Таймаут клиента 50 сек
timeout server 50000         # Таймаут сервера 50 сек
```

### Статистика (listen stats)
```cfg
bind *:7000                  # Слушать порт 7000 для статистики
mode http                    # Режим HTTP для статистики
stats enable                 # Включить веб-интерфейс статистики
stats uri /                  # URL для статистики - корень
stats refresh 10s            # Автообновление каждые 10 сек
stats admin if TRUE          # Разрешить администрирование через веб
```

### Бэкенд для мастера (backend postgres_master)
```cfg
mode tcp                     # TCP-режим
balance roundrobin           # Алгоритм балансировки - round-robin
option httpchk GET /master   # Проверка здоровья через HTTP GET /master
http-check expect status 200 # Ожидать HTTP 200 OK
default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
server pg1 192.168.45.201:5432 check port 8008 inter 5s rise 2 fall 3
server pg2 192.168.45.202:5432 check port 8008 inter 5s rise 2 fall 3
server pg3 192.168.45.204:5432 check port 8008 inter 5s rise 2 fall 3
```
(Проверяет Patroni API на порту 8008, чтобы определить мастер-ноду)

### Бэкенд для реплик (backend postgres_replica)
```cfg
mode tcp                     # TCP-режим
balance roundrobin           # Алгоритм балансировки - round-robin
option httpchk GET /replica  # Проверка здоровья через HTTP GET /replica
http-check expect status 200 # Ожидать HTTP 200 OK
default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
server pg1 192.168.45.201:5432 check port 8008 inter 5s rise 2 fall 3
server pg2 192.168.45.202:5432 check port 8008 inter 5s rise 2 fall 3
server pg3 192.168.45.204:5432 check port 8008 inter 5s rise 2 fall 3
```
(Проверяет Patroni API на порту 8008, чтобы определить работоспособные реплики)


### **Строка `default-server` (настройки по умолчанию для всех серверов в бэкенде)**
```plaintext
default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
```
- **`inter 3s`** (interval)  
  → Интервал между проверками здоровья (health checks) — **3 секунды**.
  
- **`fall 3`**  
  → Сервер считается "нерабочим" (down), если **3 проверки подряд завершились неудачно**.  
  → Это защита от ложных срабатываний (например, из-за кратковременной сетевой проблемы).

- **`rise 2`**  
  → Сервер снова считается "рабочим" (up), если **2 проверки подряд прошли успешно**.  
  → Это предотвращает слишком быстрое возвращение в строй, если сервер ещё не стабилен.

- **`on-marked-down shutdown-sessions`**  
  → Если сервер помечен как `down`, HAProxy **немедленно разрывает все активные соединения** к нему.  
  → Это важно для PostgreSQL, чтобы клиенты не пытались писать в отключённый мастер.



### **Строки `server` (настройки для каждого конкретного сервера PostgreSQL)**
```plaintext
server pg1 192.168.45.201:5432 check port 8008 inter 5s rise 2 fall 3
```
- **`server pg1 192.168.45.201:5432`**  
  → Определяет сервер с именем `pg1`, доступный по адресу `192.168.45.201:5432` (PostgreSQL).

- **`check`**  
  → Включает **проверку здоровья** (health check) для этого сервера.

- **`port 8008`**  
  → Проверка здоровья выполняется **не на порту 5432 (PostgreSQL), а на 8008** (Patroni REST API).  
  → Patroni предоставляет `/master` и `/replica` эндпоинты для определения роли сервера.

- **`inter 5s`**  
  → Интервал проверок здоровья — **5 секунд** (переопределяет `default-server inter 3s`).  
  → Более редкие проверки, чем в `default-server`, чтобы снизить нагрузку.

- **`rise 2`**  
  → Как и в `default-server`, но явно указано для ясности.  
  → 2 успешные проверки, чтобы сервер снова стал `active`.

- **`fall 3`**  
  → 3 неудачные проверки, чтобы сервер помечался как `down`.  
  → Согласовано с `default-server`, но можно изменить для отдельных серверов.


### **Как это работает в связке с Patroni?**
1. **HAProxy проверяет Patroni API (`:8008`)**:
   - Для мастера: `GET /master` → должен вернуть `HTTP 200`.
   - Для реплики: `GET /replica` → должен вернуть `HTTP 200`.
2. **Если мастер падает**:
   - Patroni автоматически переключает роль на другую ноду.
   - HAProxy обнаруживает это через `check port 8008` и перенаправляет трафик на новый мастер.
3. **Если реплика отстаёт или недоступна**:
   - HAProxy исключает её из балансировки (`fall 3`), пока она не восстановится (`rise 2`).


### Фронтенд для записи (frontend postgres_frontend)
```cfg
bind *:5000                  # Слушать порт 5000
mode tcp                     # TCP-режим
default_backend postgres_master # По умолчанию перенаправлять на мастер-бэкенд
```

### Фронтенд для чтения (frontend postgres_readonly)
```cfg
bind *:5001                  # Слушать порт 5001
mode tcp                     # TCP-режим
default_backend postgres_replica # По умолчанию перенаправлять на реплика-бэкенд
```

Эта конфигурация обеспечивает:
1. Автоматическое определение мастера через Patroni API
2. Балансировку нагрузки на реплики для read-only запросов
3. Мониторинг состояния всех узлов
4. Веб-интерфейс статистики на порту 7000
5. Раздельные порты для записи (5000) и чтения (5001)


--------------

### Проверка файл на наличие скрытых символов:
```bash
cat -A /etc/haproxy/haproxy.cfg
```
### Проверка валидности
```bash
ls -alF /etc/haproxy/haproxy.cfg
haproxy -c -f /etc/haproxy/haproxy.cfg
```
### HAProxy в режиме отладки прямо в терминале:
```bash
haproxy -f /etc/haproxy/haproxy.cfg -d
```

-------------------------

Отличный вопрос! Я допустил ошибку в объяснении. 

## 🎯 **`daemon` - это не уровень логирования, а facility (категория) в syslog!**

### **Правильный синтаксис:**
```bash
log /dev/log daemon    # Логировать в /dev/log с категорией "daemon"
```

## 📊 **Что такое facility (категории) в syslog:**

### **Основные категории:**
```bash
auth       # Аутентификация/безопасность
authpriv   # Приватные аутентификационные сообщения
cron       # Демоны cron
daemon     # Системные демоны (включая HAProxy)
ftp        # FTP демон
kern       # Ядро системы
local0..7  # Локальные категории (0-7)
lpr        # Система печати
mail       # Почтовые системы
news       # Новостные системы
syslog     # Сообщения самого syslog
user       # Пользовательские процессы
uucp       # UUCP система
```

### **Примеры использования:**
```bash
log /dev/log local0     # Логировать в локальную категорию 0
log /dev.log local1     # Логировать в локальную категорию 1  
log /dev/log user       # Логировать как пользовательский процесс
log /dev/log daemon     # Логировать как системный демон (по умолчанию для HAProxy)
```

## 🔧 **Полный правильный синтаксис:**

```bash
# Полный формат: log <адрес> [facility] [level] [minlevel]
log /dev/log daemon info          # Категория daemon, уровень info и выше
log /dev/log local0 notice        # Категория local0, уровень notice и выше
log /dev/log local1 debug         # Категория local1, все сообщения (debug)
```


## 🎯 **Зачем нужны facility (категории):**

### **Разделение логов по службам:**
```
/var/log/syslog       # Все логи
/var/log/auth.log     # Только auth facility
/var/log/daemon.log   # Только daemon facility (где будет HAProxy)
```

### **Гибкая настройка в rsyslog:**
```bash
# В /etc/rsyslog.conf можно настроить:
daemon.*    /var/log/daemon.log    # Все логи демонов в отдельный файл
local0.*    /var/log/haproxy.log   # HAProxy логи в отдельный файл
```


## ⚡ **Правильная настройка для HAProxy:**

```bash
global
    # Логировать в syslog с категорией daemon, уровень notice
    log /dev/log daemon notice
    
    # Или использовать локальную категорию для изоляции
    log /dev/log local0 info
```

**Итог:** `daemon` указывает syslog'у к какой категории служб относятся логи HAProxy, чтобы их можно было правильно фильтровать и направлять в отдельные файлы! 📊

-------------

## 📊 Уровни логирования в HAProxy

### **Основные уровни логирования:**

```bash
# Примеры использования разных уровней
log /dev/log emerg      # Система неработоспособна
log /dev/log alert      # Требуется немедленное действие
log /dev/log crit       # Критические условия
log /dev/log err        # Ошибки
log /dev/log warning    # Предупреждения
log /dev/log notice     # Нормальные, но значимые события
log /dev/log info       # Информационные сообщения
log /dev/log debug      # Отладочная информация
```

### **Что означают уровни (в порядке важности):**

#### **1. `emerg` (0) - Чрезвычайная ситуация**
```
Система неработоспособна. Пример: не может запуститься, нет памяти.
```

#### **2. `alert` (1) - Тревога**
```
Требуется немедленное действие. Пример: конфигурация содержит критические ошибки.
```

#### **3. `crit` (2) - Критический**
```
Критические условия. Пример: не может подключиться к бэкендам.
```

#### **4. `err` (3) - Ошибка**
```
Ошибки, требующие внимания. Пример: таймауты соединений, отказ бэкенда.
```

#### **5. `warning` (4) - Предупреждение**
```
Предупреждения. Пример: сервер в бэкенде временно недоступен.
```

#### **6. `notice` (5) - Уведомление**
```
Нормальные, но значимые события. Пример: сервер вернулся в работу.
```

#### **7. `info` (6) - Информация**
```
Информационные сообщения. Пример: запуск/остановка HAProxy.
```

#### **8. `debug` (7) - Отладка**
```
Подробная отладочная информация. Пример: детали обработки запросов.
```



## 🎯 **Практические примеры для HAProxy:**

### **Для продакшена:**
```bash
log /dev/log info        # Только важная информация и выше
# или
log /dev.log notice      # Более детально, но без отладки
```

### **Для разработки/отладки:**
```bash
log /dev/log debug       # Максимальная детализация
```

### **Минимальное логирование:**
```bash
log /dev/log warning     # Только ошибки и предупреждения
```



## 🔍 **Что логирует HAProxy на разных уровнях:**

### **`warning` и выше:**
```bash
[WARNING] Server app/app1 is DOWN, reason: Connection refused
[ALERT] backend 'static' has no server available!
```

### **`notice` и выше:**
```bash
[NOTICE] haproxy version is 2.8.0
[NOTICE] Server app/app1 is UP
```

### **`info` и выше:**
```bash
[INFO] New worker #1 forked
```

### **`debug` (все сообщения):**
```bash
[DEBUG] Processing ACL 'url_static'
[DEBUG] Selected server 'app1' for request
```


## ⚡ **Рекомендации по использованию:**

- **Продакшен**: `notice` или `info`
- **Тестирование**: `info` 
- **Отладка проблем**: `debug`
- **Минимальный трафик**: `warning`

**В нашем конфиге `daemon` - это не уровень, а facility в syslog!** Правильно будет указывать уровень явно, например: `log /dev/log notice` 🎯

--------------------------

## 🔒 **Chroot изоляция в HAProxy**

### **Что такое chroot:**
```bash
chroot /var/lib/haproxy  # "Заточаем" HAProxy в директорию /var/lib/haproxy
```
**Простыми словами:** После chroot процесс "видит" `/var/lib/haproxy` как корневую директорию `/`



## 🎯 **Для чего нужна chroot изоляция:**

### **1. Безопасность (основная причина)**
```
Без chroot:   HAProxy → /etc/passwd → Утечка системной информации
С chroot:     HAProxy → /etc/passwd → Файл не существует (в его мире)
```

### **2. Ограничение доступа к файловой системе**
- ❌ **Не может** читать `/etc/shadow`, `/etc/passwd`
- ❌ **Не может** модифицировать системные конфиги
- ❌ **Не может** получить доступ к чувствительным данным

### **3. Сдерживание последствий уязвимостей**
Если HAProxy будет скомпрометирован, злоумышленник ограничен песочницей.


## 🔧 **Что находится в chroot окружении:**

```bash
/var/lib/haproxy/
├── dev/           # Виртуальные устройства (нужны для работы)
│   ├── log        # Для логирования
│   ├── null       # /dev/null
│   └── zero       # /dev/zero
├── etc/           # Локальные конфиги (если нужны)
└── tmp/           # Временные файлы
```


## ⚡ **Когда chroot КРИТИЧЕСКИ важен:**

### **1. Публичные балансировщики**
- Балансировщики в DMZ зоне
- Доступные из интернета

### **2. Мультитенантные среды**
- Разные клиенты на одном HAProxy
- Предотвращение горизонтального перемещения

### **3. Высокие требования безопасности**
- PCI DSS, HIPAA, GDPR compliance
- Государственные и финансовые системы



## 🚨 **Когда можно отключить chroot:**

### **1. Разработка и тестирование**
```bash
# В конфиге закомментировать:
# chroot /var/lib/haproxy
```

### **2. Проблемы с совместимостью**
- Некоторые проверки здоровья (health checks)
- Сложные сценарии SSL/TLS

### **3. Внутренние trusted сети**
- Балансировщики внутри защищенного периметра
- Когда риски минимальны


## 🔍 **Проблемы которые мы видели из-за chroot:**

```bash
[ALERT] sendmsg()/writev() failed in logger #1: No such file or directory
```
**Причина:** В chroot окружении нет `/dev/log` для syslog

**Решение:**
```bash
mkdir -p /var/lib/haproxy/dev
touch /var/lib/haproxy/dev/log
```


## 📊 **Баланс безопасности и функциональности:**

| **Без chroot** | **С chroot** |
|----------------|--------------|
| ✅ Проще отладка | ✅ Безопасность |
| ✅ Все функции | ❌ Ограничения доступа |
| ❌ Риски безопасности | ✅ Compliance |

**Рекомендация:** Всегда использовать chroot в продакшене, отключать только при веских причинах! 🔒

--------------------------


