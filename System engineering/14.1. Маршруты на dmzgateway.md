- **MASTER GATEWAY** : **[(dmzgateway)](https://192.168.87.20:8006/#v1:0:=lxc%2F102:4::::::11:)**
- **MASTER GATEWAY1** : **[(dmzgateway1)](https://192.168.87.20:8006/#v1:0:=lxc%2F117:4::::::11:)**
- **MASTER GATEWAY2** : **[(dmzgateway2)](https://192.168.87.20:8006/#v1:0:=lxc%2F186:4::::::11:)**
- **MASTER GATEWAY3** : **[(dmzgateway3)](https://192.168.87.20:8006/#v1:0:=lxc%2F187:4::::::11:)**
<br/> [17.2. iptables.md](https://github.com/sherbettt/BASH-cheats/blob/main/17.2.%20iptables.md)
<br/>


# –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ —à–ª—é–∑–æ–≤ dmzgateway

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±—â–∞—è —Å—Ö–µ–º–∞ —Å–µ—Ç–∏](#—Å—Ö–µ–º–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–ª—é–∑–æ–≤](#—à–ª—é–∑—ã)
4. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏](#–º–∞—Ä—à—Ä—É—Ç—ã)
5. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ NAT –∏ MASQUERADE](#nat)
6. [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏](#–ø—Ä–æ–≤–µ—Ä–∫–∞)

---

## üèóÔ∏è –û–±—â–∞—è —Å—Ö–µ–º–∞ —Å–µ—Ç–∏ {#—Å—Ö–µ–º–∞}

```text
+------------------------------------------------------------------------------------+
|                               –ù–æ—É—Ç–±—É–∫                                              |
|                       192.168.87.151/24 (wlp1s0)                                  |
|                                     |                                              |
|                                     |                                              |
|                           +-------------------+                                    |
|                           |  –û—Å–Ω–æ–≤–Ω–æ–π —à–ª—é–∑    |                                    |
|                           |  192.168.87.1     |                                    |
|                           |    (–≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç)   |                                    |
|                           +-------------------+                                    |
|                                     |                                              |
|                           +-------------------+                                    |
|   üü¢ –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –ê–î–†–ï–°    |   dmzgateway      |  (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 102)               |
|   üü¢ (–ü–ª–∞–≤–∞—é—â–∏–π IP)       | 192.168.87.2/24   |  üü¢ MASTER/ACTIVE                  |
|                           |     (eth0)        |                                    |
|                           |                   |                                    |
|                           | 192.168.46.1/24   |                                    |
|                           |     (eth1)        |                                    |
|                           |                   |                                    |
|                           | 192.168.45.1/24   |                                    |
|                           |     (eth2)        |                                    |
|                           +-------------------+                                    |
|                                     |                                              |
|              +-----------------------+----------------------+                      |
|              |                                              |                      |
|      +----------------+                            +----------------+              |
|      |   –°–µ—Ç—å dmznet  |                            |   –°–µ—Ç—å pgnet   |              |
|      | 192.168.46.0/24|                            | 192.168.45.0/24|              |
|      |                |                            |                |              |
|      | 192.168.46.4   |                            | 192.168.45.50  |              |
|      | 192.168.46.16  |                            | 192.168.45.51  |              |
|      +----------------+                            +----------------+              |
|                                                                                    |
|------------------------------------------------------------------------------------|
|                                                                                    |
|                     üü† –†–ï–ó–ï–†–í–ù–´–ï –®–õ–Æ–ó–´ (–ö–õ–ê–°–¢–ï–†)                                   |
|                                                                                    |
|        +-------------------------+    +-------------------------+                  |
|        |     dmzgateway1         |    |     dmzgateway2         |                  |
|        | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 117)     |    | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 186)     |                  |
|        | 192.168.87.253/24 (eth0)|    | 192.168.87.252/24 (eth0)|                  |
|        | 192.168.46.253/24 (eth1)|    | 192.168.46.252/24 (eth1)|                  |
|        | 192.168.45.253/24 (eth2)|    | 192.168.45.252/24 (eth2)|                  |
|        |       üü† BACKUP         |    |       üü† BACKUP         |                  |
|        +-------------------------+    +-------------------------+                  |
|                                                                                    |
|        +-------------------------+                                                 |
|        |     dmzgateway3         |                                                 |
|        | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 187)     |                                                 |
|        | 192.168.87.251/24 (eth0)|                                                 |
|        | 192.168.46.251/24 (eth1)|                                                 |
|        | 192.168.45.251/24 (eth2)|                                                 |
|        |       üü† BACKUP         |                                                 |
|        +-------------------------+                                                 |
+------------------------------------------------------------------------------------+
```

---

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ {#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞}

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:**
- **üü¢ dmzgateway** (192.168.87.2) - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP (VIP)
- **üü† dmzgateway1** (192.168.87.253) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 1
- **üü† dmzgateway2** (192.168.87.252) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 2  
- **üü† dmzgateway3** (192.168.87.251) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 3

### **–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
- –í—Å–µ –Ω–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–µ–∂–∏–º–µ **BACKUP** —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
- **–ü–µ—Ä–≤–∞—è –∑–∞–ø—É—â–µ–Ω–Ω–∞—è –Ω–æ–¥–∞** —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è MASTER
- –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ MASTER - —Å–ª–µ–¥—É—é—â–∞—è –Ω–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å
- **Keepalived** —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ IP –∞–¥—Ä–µ—Å–∞–º–∏

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–ª—é–∑–æ–≤ {#—à–ª—é–∑—ã}

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —à–ª—é–∑–∞–º
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É IP (–∞–∫—Ç–∏–≤–Ω–æ–º—É MASTER)
ssh root@192.168.87.2

# –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –Ω–æ–¥–∞–º
ssh root@192.168.87.253  # dmzgateway1
ssh root@192.168.87.252  # dmzgateway2  
ssh root@192.168.87.251  # dmzgateway3
```

### 2. –í–∫–ª—é—á–µ–Ω–∏–µ IP forwarding –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
```bash
# –í–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
echo 1 > /proc/sys/net/ipv4/ip_forward

# –î–µ–ª–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
sysctl -p

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1)
cat /proc/sys/net/ipv4/ip_forward
```

### 3. –ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ iptables –¥–ª—è –≤—Å–µ—Ö –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
#!/bin/bash
# apply-unified-rules.sh - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –í–°–ï–• –Ω–æ–¥–∞—Ö dmzgateway1, dmzgateway2, dmzgateway3

echo "=== Applying unified iptables rules ==="

# 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª
iptables -F                          # –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ FILTER —Ç–∞–±–ª–∏—Ü—ã
iptables -t nat -F                   # –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ NAT —Ç–∞–±–ª–∏—Ü—ã

# 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫)
iptables -P INPUT ACCEPT             # –í—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ - —Ä–∞–∑—Ä–µ—à–∏—Ç—å
iptables -P FORWARD ACCEPT           # –§–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥ - —Ä–∞–∑—Ä–µ—à–∏—Ç—å  
iptables -P OUTPUT ACCEPT            # –ò—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ - —Ä–∞–∑—Ä–µ—à–∏—Ç—å

# 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ FORWARD (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏)
# –†–∞–∑—Ä–µ—à–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ç–µ–π –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Ç—å
iptables -A FORWARD -s 192.168.45.0/24 -d 192.168.87.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.46.0/24 -d 192.168.87.0/24 -j ACCEPT

# –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–≤–µ—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∏ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ
iptables -A FORWARD -s 192.168.87.0/24 -d 192.168.45.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.87.0/24 -d 192.168.46.0/24 -j ACCEPT

# 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º NAT (MASQUERADE) –¥–ª—è –≤—ã—Ö–æ–¥–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.46.0/24 -o eth0 -j MASQUERADE

# 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
netfilter-persistent save

echo "=== Rules applied successfully ==="
echo "Current FORWARD rules:"
iptables -L FORWARD -nv
echo ""
echo "Current NAT rules:"
iptables -t nat -L -nv
```

---

## üó∫Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ {#–º–∞—Ä—à—Ä—É—Ç—ã}

### **–ù–∞ —à–ª—é–∑–µ (dmzgateway):**

#### 1. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip route show

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç—ã –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Ç–∏
ip route show 192.168.45.0/24
ip route show 192.168.46.0/24

# –£–∑–Ω–∞—Ç—å, —á–µ—Ä–µ–∑ –∫–∞–∫–æ–π –º–∞—Ä—à—Ä—É—Ç –ø–æ–π–¥–µ—Ç –ø–∞–∫–µ—Ç –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞
ip route get 192.168.45.50
ip route get 192.168.46.4
```

#### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
```bash
# –ë–∞–∑–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ç–µ–π (—É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
ip route add 192.168.45.0/24 dev eth2    # –ú–∞—Ä—à—Ä—É—Ç –∫ —Å–µ—Ç–∏ 45.x —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å eth2
ip route add 192.168.46.0/24 dev eth1    # –ú–∞—Ä—à—Ä—É—Ç –∫ —Å–µ—Ç–∏ 46.x —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å eth1

# –ú–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ —à–ª—é–∑ (–¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π)
ip route add 192.168.189.0/24 via 192.168.87.1 dev eth0

# –ú–∞—Ä—à—Ä—É—Ç —Å –º–µ—Ç—Ä–∏–∫–æ–π (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º) - —á–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
ip route add 192.168.45.0/24 dev eth2 metric 100
```

#### 3. –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
ip route del 192.168.45.0/24 dev eth2
ip route del 192.168.46.0/24 dev eth1

# –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (—É–¥–∞–ª–∏—Ç –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π)
ip route del 192.168.45.0/24
ip route del 192.168.46.0/24

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö)
ip route flush cache
```

#### 4. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ systemd networkd (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º)**
```bash
# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ eth2
nano /etc/systemd/network/10-eth2.network

# –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
[Match]
Name=eth2                    # –ü—Ä–∏–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É eth2

[Network]
Address=192.168.45.1/24      # –ù–∞–∑–Ω–∞—á–∞–µ–º IP –∞–¥—Ä–µ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

[Route]
Destination=192.168.45.0/24  # –¶–µ–ª–µ–≤–∞—è —Å–µ—Ç—å
Gateway=192.168.45.1         # –®–ª—é–∑ –¥–ª—è —ç—Ç–æ–π —Å–µ—Ç–∏ (–æ–±—ã—á–Ω–æ —Å–∞–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è eth1
nano /etc/systemd/network/10-eth1.network
[Match]
Name=eth1
[Network]
Address=192.168.46.1/24
[Route]
Destination=192.168.46.0/24
Gateway=192.168.46.1

# –í–∫–ª—é—á–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º systemd-networkd
systemctl enable systemd-networkd
systemctl restart systemd-networkd
```

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ /etc/network/interfaces (–¥–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º)**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
nano /etc/network/interfaces

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
auto eth2
iface eth2 inet static
    address 192.168.45.1/24
    # –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –ø—Ä–∏ –ø–æ–¥–Ω—è—Ç–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    post-up ip route add 192.168.45.0/24 dev eth2
    # –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞  
    pre-down ip route del 192.168.45.0/24 dev eth2

auto eth1  
iface eth1 inet static
    address 192.168.46.1/24
    post-up ip route add 192.168.46.0/24 dev eth1
    pre-down ip route del 192.168.46.0/24 dev eth1

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ç—å
systemctl restart networking
```

**–°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –≤ rc.local (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±)**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏
nano /etc/rc.local

# –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 'exit 0':
#!/bin/bash
# –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã
ip route add 192.168.45.0/24 dev eth2
ip route add 192.168.46.0/24 dev eth1
# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
# ip route add 192.168.189.0/24 via 192.168.87.1 dev eth0
exit 0

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
chmod +x /etc/rc.local
```

### **–ù–∞ –Ω–æ—É—Ç–±—É–∫–µ (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º):**

#### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
```bash
# –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —à–ª—é–∑
sudo ip route add 192.168.45.0/24 via 192.168.87.2 dev wlp1s0
sudo ip route add 192.168.46.0/24 via 192.168.87.2 dev wlp1s0

# –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
sudo ip route del 192.168.45.0/24
sudo ip route del 192.168.46.0/24

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
ip route show
```

#### –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (Netplan - –¥–ª—è Ubuntu)
```yaml
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ç–∏
sudo nano /etc/netplan/01-network-manager-all.yaml

# –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    wlp1s0:
      dhcp4: yes
      routes:
        - to: 192.168.45.0/24    # –¶–µ–ª–µ–≤–∞—è —Å–µ—Ç—å
          via: 192.168.87.2      # –®–ª—é–∑ (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP dmzgateway)
          metric: 100            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞
        - to: 192.168.46.0/24
          via: 192.168.87.2
          metric: 100

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
sudo netplan apply
```

---

## üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ NAT –∏ MASQUERADE {#nat}

### **–ß—Ç–æ —Ç–∞–∫–æ–µ MASQUERADE?**
**MASQUERADE** - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø Source NAT (SNAT), –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π IP-–∞–¥—Ä–µ—Å –Ω–∞ IP –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç MASQUERADE:**
```bash
# –ò—Å—Ö–æ–¥–Ω—ã–π –ø–∞–∫–µ—Ç –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏:
192.168.45.10:12345 ‚Üí 8.8.8.8:80

# –ü–æ—Å–ª–µ MASQUERADE –Ω–∞ —à–ª—é–∑–µ:
192.168.87.251:54321 ‚Üí 8.8.8.8:80

# –û—Ç–≤–µ—Ç–Ω—ã–π –ø–∞–∫–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:
8.8.8.8:80 ‚Üí 192.168.87.251:54321

# –®–ª—é–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞–∫–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å:
8.8.8.8:80 ‚Üí 192.168.45.10:12345
```

### **–°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–∞–≤–∏–ª MASQUERADE:**
```bash
# –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
iptables -t nat -A POSTROUTING -s <–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è_—Å–µ—Ç—å> -o <–≤—ã—Ö–æ–¥–Ω–æ–π_–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å> -j MASQUERADE

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –Ω–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞:
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.46.0/24 -o eth0 -j MASQUERADE
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- `-t nat` - —Ä–∞–±–æ—Ç–∞–µ–º —Å —Ç–∞–±–ª–∏—Ü–µ–π NAT (–ø–æ–¥–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–æ–≤)
- `-A POSTROUTING` - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –≤ —Ü–µ–ø–æ—á–∫—É POSTROUTING (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏)
- `-s 192.168.45.0/24` - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ç—Ä–∞—Ñ–∏–∫—É –ò–ó —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å–µ—Ç–∏
- `-o eth0` - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ç—Ä–∞—Ñ–∏–∫—É, –≤—ã—Ö–æ–¥—è—â–µ–º—É —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å eth0
- `-j MASQUERADE` - –¥–µ–π—Å—Ç–≤–∏–µ: –≤—ã–ø–æ–ª–Ω–∏—Ç—å MASQUERADE (–ø–æ–¥–º–µ–Ω–∞ source IP)

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - SNAT (–¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö IP):**
```bash
# SNAT —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è IP –∞–¥—Ä–µ—Å–∞
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j SNAT --to-source 192.168.87.251

# –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ MASQUERADE –ø–µ—Ä–µ–¥ SNAT:
# - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç IP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
# - –†–∞–±–æ—Ç–∞–µ—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ IP (DHCP)
# - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ IP
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ {#–ø—Ä–æ–≤–µ—Ä–∫–∞}

### 1. –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–Ω–æ—Å—Ç–∏
```bash
# –° –Ω–æ—É—Ç–±—É–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫:

echo "=== Testing Virtual Gateway ==="
ping -c 3 192.168.87.2        # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP —à–ª—é–∑–∞

echo "=== Testing Physical Nodes ==="  
ping -c 2 192.168.87.253      # dmzgateway1
ping -c 2 192.168.87.252      # dmzgateway2
ping -c 2 192.168.87.251      # dmzgateway3

echo "=== Testing Internal Networks ==="
ping -c 2 192.168.46.1        # –®–ª—é–∑ —Å–µ—Ç–∏ dmznet
ping -c 2 192.168.45.1        # –®–ª—é–∑ —Å–µ—Ç–∏ pgnet
ping -c 2 192.168.46.4        # –•–æ—Å—Ç –≤ dmznet
ping -c 2 192.168.45.50       # –•–æ—Å—Ç –≤ pgnet

echo "=== Testing Internet Access ==="
ping -c 2 8.8.8.8             # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã—Ö source IP
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ –º–æ–∂–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫

# –° dmzgateway3 —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
ping -I 192.168.45.251 8.8.8.8    # –ß–µ—Ä–µ–∑ —Å–µ—Ç—å 45.x —Å IP .251
ping -I 192.168.46.251 8.8.8.8    # –ß–µ—Ä–µ–∑ —Å–µ—Ç—å 46.x —Å IP .251

# –° dmzgateway2:
ping -I 192.168.45.252 8.8.8.8    # –ß–µ—Ä–µ–∑ —Å–µ—Ç—å 45.x —Å IP .252
ping -I 192.168.46.252 8.8.8.8    # –ß–µ—Ä–µ–∑ —Å–µ—Ç—å 46.x —Å IP .252
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã NAT
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—á–µ—Ç—á–∏–∫–æ–≤ MASQUERADE –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
watch -n 1 'iptables -t nat -L POSTROUTING -nv'

# –ò–ª–∏ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∏–∫ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
while true; do clear; date; echo "=== NAT Counters ==="; iptables -t nat -L POSTROUTING -nv; sleep 2; done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –ª–∏ —Å—á–µ—Ç—á–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ NAT —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Keepalived
```bash
# –ù–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å keepalived
systemctl status keepalived

# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -u keepalived -f

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è –Ω–æ–¥–∞ –¥–µ—Ä–∂–∏—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ IP
ip addr show | grep -E "192.168.(87|46|45)\.(2|1)"
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- [ ] **–í—Å–µ –Ω–æ–¥—ã**: IP forwarding = 1
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: –ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ iptables –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: MASQUERADE –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- [ ] **MASTER –Ω–æ–¥–∞**: –î–µ—Ä–∂–∏—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ IP (.2, .1)
- [ ] **–ù–æ—É—Ç–±—É–∫**: –ú–∞—Ä—à—Ä—É—Ç—ã —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP 192.168.87.2
- [ ] **–ü–∏–Ω–≥**: –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- [ ] **NAT**: –°—á–µ—Ç—á–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è



–≠—Ç–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∞—é—Ç –≤–∞—à—É —Å–µ—Ç–µ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —É–¥–æ–±–Ω–æ–π –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.
