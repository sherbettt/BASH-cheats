- **MASTER GATEWAY** : **[(dmzgateway)](https://192.168.87.20:8006/#v1:0:=lxc%2F102:4::::::11:)**
- **MASTER GATEWAY1** : **[(dmzgateway1)](https://192.168.87.20:8006/#v1:0:=lxc%2F117:4::::::11:)**
- **MASTER GATEWAY2** : **[(dmzgateway2)](https://192.168.87.20:8006/#v1:0:=lxc%2F186:4::::::11:)**
- **MASTER GATEWAY3** : **[(dmzgateway3)](https://192.168.87.20:8006/#v1:0:=lxc%2F187:4::::::11:)**
<br/> [17.2. iptables.md](https://github.com/sherbettt/BASH-cheats/blob/main/17.2.%20iptables.md)
<br/>


# –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ —à–ª—é–∑–æ–≤ dmzgateway

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±—â–∞—è —Å—Ö–µ–º–∞ —Å–µ—Ç–∏](#—Å—Ö–µ–º–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–ª—é–∑–æ–≤](#—à–ª—é–∑—ã)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ—É—Ç–±—É–∫–∞](#–Ω–æ—É—Ç–±—É–∫)
5. [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏](#–ø—Ä–æ–≤–µ—Ä–∫–∞)
6. [–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º](#–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
7. [–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫](#—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)

---

## üèóÔ∏è –û–±—â–∞—è —Å—Ö–µ–º–∞ —Å–µ—Ç–∏ {#—Å—Ö–µ–º–∞}

```text
+------------------------------------------------------------------------------------+
|                               –ù–æ—É—Ç–±—É–∫                                              |
|                       192.168.87.151/24 (wlp1s0)                                  |
|                                     |                                              |
|                                     |                                              |
|                           +-------------------+                                    |
|                           |  –û—Å–Ω–æ–≤–Ω–æ–π —à–ª—é–∑    |                                    |
|                           |  192.168.87.1     |                                    |
|                           |    (–≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç)   |                                    |
|                           +-------------------+                                    |
|                                     |                                              |
|                           +-------------------+                                    |
|   üü¢ –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –ê–î–†–ï–°    |   dmzgateway      |  (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 102)               |
|   üü¢ (–ü–ª–∞–≤–∞—é—â–∏–π IP)       | 192.168.87.2/24   |  üü¢ MASTER/ACTIVE                  |
|                           |     (eth0)        |                                    |
|                           |                   |                                    |
|                           | 192.168.46.1/24   |                                    |
|                           |     (eth1)        |                                    |
|                           |                   |                                    |
|                           | 192.168.45.1/24   |                                    |
|                           |     (eth2)        |                                    |
|                           +-------------------+                                    |
|                                     |                                              |
|              +-----------------------+----------------------+                      |
|              |                                              |                      |
|      +----------------+                            +----------------+              |
|      |   –°–µ—Ç—å dmznet  |                            |   –°–µ—Ç—å pgnet   |              |
|      | 192.168.46.0/24|                            | 192.168.45.0/24|              |
|      |   –í–ù–£–¢–†–ï–ù–ù–Ø–Ø   |                            |   –í–ù–£–¢–†–ï–ù–ù–Ø–Ø   |              |
|      |   (—Å–≤—è–∑–∞–Ω–∞ —Å   |                            |   (—Å–≤—è–∑–∞–Ω–∞ —Å   |              |
|      |   87.0 —Å–µ—Ç—å—é)  |                            |   87.0 —Å–µ—Ç—å—é)  |              |
|      |                |                            |                |              |
|      | 192.168.46.4   |                            | 192.168.45.50  |              |
|      | 192.168.46.16  |                            | 192.168.45.51  |              |
|      +----------------+                            +----------------+              |
|                                                                                    |
|------------------------------------------------------------------------------------|
|                                                                                    |
|                     üü† –†–ï–ó–ï–†–í–ù–´–ï –®–õ–Æ–ó–´ (–ö–õ–ê–°–¢–ï–†)                                   |
|                                                                                    |
|        +-------------------------+    +-------------------------+                  |
|        |     dmzgateway1         |    |     dmzgateway2         |                  |
|        | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 117)     |    | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 186)     |                  |
|        | 192.168.87.253/24 (eth0)|    | 192.168.87.252/24 (eth0)|                  |
|        | 192.168.46.253/24 (eth1)|    | 192.168.46.252/24 (eth1)|                  |
|        | 192.168.45.253/24 (eth2)|    | 192.168.45.252/24 (eth2)|                  |
|        |       üü† BACKUP         |    |       üü† BACKUP         |                  |
|        +-------------------------+    +-------------------------+                  |
|                                                                                    |
|        +-------------------------+                                                 |
|        |     dmzgateway3         |                                                 |
|        | (LXC –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 187)     |                                                 |
|        | 192.168.87.251/24 (eth0)|                                                 |
|        | 192.168.46.251/24 (eth1)|                                                 |
|        | 192.168.45.251/24 (eth2)|                                                 |
|        |       üü† BACKUP         |                                                 |
|        +-------------------------+                                                 |
+------------------------------------------------------------------------------------+
```

---

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ {#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞}

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:**
- **üü¢ dmzgateway** (192.168.87.2) - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP (VIP)
- **üü† dmzgateway1** (192.168.87.253) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 1
- **üü† dmzgateway2** (192.168.87.252) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 2  
- **üü† dmzgateway3** (192.168.87.251) - —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–æ–¥–∞ 3

### **–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
- –í—Å–µ –Ω–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–µ–∂–∏–º–µ **BACKUP** —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
- **–ü–µ—Ä–≤–∞—è –∑–∞–ø—É—â–µ–Ω–Ω–∞—è –Ω–æ–¥–∞** —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è MASTER
- –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ MASTER - —Å–ª–µ–¥—É—é—â–∞—è –Ω–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å
- **Keepalived** —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ IP –∞–¥—Ä–µ—Å–∞–º–∏

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–ª—é–∑–æ–≤ {#—à–ª—é–∑—ã}

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —à–ª—é–∑–∞–º
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É IP (–∞–∫—Ç–∏–≤–Ω–æ–º—É MASTER)
ssh root@192.168.87.2

# –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –Ω–æ–¥–∞–º
ssh root@192.168.87.253  # dmzgateway1
ssh root@192.168.87.252  # dmzgateway2  
ssh root@192.168.87.251  # dmzgateway3
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –Ω–∞ MASTER –Ω–æ–¥–µ:**
```bash
root@dmzgateway ~ # ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0@if36: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether bc:24:11:66:e1:0d brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.87.253/24 brd 192.168.87.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.87.2/24 scope global secondary eth0    # üü¢ –í–ò–†–¢–£–ê–õ–¨–ù–´–ô IP
       valid_lft forever preferred_lft forever
3: eth1@if40: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether bc:24:11:c4:8a:b7 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.46.253/24 brd 192.168.46.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet 192.168.46.1/24 scope global secondary eth1    # üü¢ –í–ò–†–¢–£–ê–õ–¨–ù–´–ô IP
       valid_lft forever preferred_lft forever
4: eth2@if41: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether bc:24:11:a9:de:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.45.253/24 brd 192.168.45.255 scope global eth2
       valid_lft forever preferred_lft forever
    inet 192.168.45.1/24 scope global secondary eth2    # üü¢ –í–ò–†–¢–£–ê–õ–¨–ù–´–ô IP
       valid_lft forever preferred_lft forever
```

### 3. –í–∫–ª—é—á–µ–Ω–∏–µ IP forwarding –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
cat /proc/sys/net/ipv4/ip_forward

# –í–∫–ª—é—á–∞–µ–º –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
echo 1 > /proc/sys/net/ipv4/ip_forward

# –î–µ–ª–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# –ü—Ä–æ–≤–µ—Ä—è–µ–º
cat /proc/sys/net/ipv4/ip_forward
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 1
```

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ MASQUERADE –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö iptables? {#masquerade}

### **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
**MASQUERADE** - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–ª—å –≤ —Ç–∞–±–ª–∏—Ü–µ `nat` –¥–ª—è **Source NAT (SNAT)**, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π IP-–∞–¥—Ä–µ—Å –Ω–∞ IP –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç MASQUERADE:**
```bash
# –ò—Å—Ö–æ–¥–Ω—ã–π –ø–∞–∫–µ—Ç –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏:
192.168.45.10:12345 ‚Üí 8.8.8.8:80

# –ü–æ—Å–ª–µ MASQUERADE –Ω–∞ —à–ª—é–∑–µ:
192.168.87.251:54321 ‚Üí 8.8.8.8:80

# –û—Ç–≤–µ—Ç–Ω—ã–π –ø–∞–∫–µ—Ç:
8.8.8.8:80 ‚Üí 192.168.87.251:54321

# –®–ª—é–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ:
8.8.8.8:80 ‚Üí 192.168.45.10:12345
```

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ MASQUERADE:**
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç IP** –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ IP** (DHCP)
- ‚úÖ **–ü—Ä–æ—â–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ** —á–µ–º SNAT

### **–°–∏–Ω—Ç–∞–∫—Å–∏—Å:**
```bash
iptables -t nat -A POSTROUTING -s <–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è_—Å–µ—Ç—å> -o <–≤—ã—Ö–æ–¥–Ω–æ–π_–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å> -j MASQUERADE
```

### **–ü—Ä–∏–º–µ—Ä—ã:**
```bash
# NAT –¥–ª—è —Å–µ—Ç–∏ 45.x
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j MASQUERADE

# NAT –¥–ª—è —Å–µ—Ç–∏ 46.x
iptables -t nat -A POSTROUTING -s 192.168.46.0/24 -o eth0 -j MASQUERADE
```

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - SNAT:**
```bash
# –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ source IP (–¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö IP)
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j SNAT --to-source 192.168.87.251
```

---

## üîß –ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ iptables –¥–ª—è –≤—Å–µ—Ö –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ {#–µ–¥–∏–Ω—ã–µ-–ø—Ä–∞–≤–∏–ª–∞}

### **–¶–µ–ª—å:** –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ dmzgateway1, dmzgateway2, dmzgateway3

### **–ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –í–°–ï–• –Ω–æ–¥–∞—Ö:**
```bash
#!/bin/bash
# apply-unified-rules.sh
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ dmzgateway1, dmzgateway2, dmzgateway3

echo "=== Applying unified iptables rules ==="

# 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª
echo "1. Cleaning old rules..."
iptables -F
iptables -t nat -F
iptables -X
iptables -t nat -X

# 2. –ü–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
echo "2. Setting default policies..."
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# 3. FORWARD –ø—Ä–∞–≤–∏–ª–∞ (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏)
echo "3. Setting FORWARD rules..."

# –†–∞–∑—Ä–µ—à–∏—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏
iptables -A FORWARD -s 192.168.45.0/24 -d 192.168.87.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.87.0/24 -d 192.168.45.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.46.0/24 -d 192.168.87.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.87.0/24 -d 192.168.46.0/24 -j ACCEPT

# –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–±–º–µ–Ω –º–µ–∂–¥—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —Å–µ—Ç—è–º–∏
iptables -A FORWARD -s 192.168.45.0/24 -d 192.168.46.0/24 -j ACCEPT
iptables -A FORWARD -s 192.168.46.0/24 -d 192.168.45.0/24 -j ACCEPT

# –†–∞–∑—Ä–µ—à–∏—Ç—å established/related —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# 4. NAT –ø—Ä–∞–≤–∏–ª–∞ (MASQUERADE)
echo "4. Setting NAT rules..."
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.46.0/24 -o eth0 -j MASQUERADE

# 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
echo "5. Saving rules..."
netfilter-persistent save

echo "=== Rules applied successfully ==="
echo "Current FORWARD rules:"
iptables -L FORWARD -nv
echo ""
echo "Current NAT rules:"
iptables -t nat -L -nv
```

### **–ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ:
wget -O /tmp/apply-rules.sh https://raw.githubusercontent.com/your-repo/apply-unified-rules.sh
chmod +x /tmp/apply-rules.sh
/tmp/apply-rules.sh
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª:**
```bash
# –ù–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–≤–æ–¥:
echo "=== Checking rules consistency ==="
iptables-save | md5sum
iptables -L FORWARD -nv
iptables -t nat -L -nv
```

### **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
```bash
# FORWARD –ø—Ä–∞–≤–∏–ª–∞:
Chain FORWARD (policy ACCEPT)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     all  --  *      *       192.168.45.0/24      192.168.87.0/24     
    0     0 ACCEPT     all  --  *      *       192.168.87.0/24      192.168.45.0/24     
    0     0 ACCEPT     all  --  *      *       192.168.46.0/24      192.168.87.0/24     
    0     0 ACCEPT     all  --  *      *       192.168.87.0/24      192.168.46.0/24     
    0     0 ACCEPT     all  --  *      *       192.168.45.0/24      192.168.46.0/24     
    0     0 ACCEPT     all  --  *      *       192.168.46.0/24      192.168.45.0/24     
    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED

# NAT –ø—Ä–∞–≤–∏–ª–∞:
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  192.168.45.0/24      0.0.0.0/0           
MASQUERADE  all  --  192.168.46.0/24      0.0.0.0/0
```

---

## üíª –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ—É—Ç–±—É–∫–∞ {#–Ω–æ—É—Ç–±—É–∫}

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
```bash
# –°–º–æ—Ç—Ä–∏–º —Ç–µ–∫—É—â–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã
ip route show

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
ip addr show wlp1s0

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —à–ª—é–∑–∞
ping -c 3 192.168.87.2
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
```bash
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
sudo ip route del 192.168.45.0/24 2>/dev/null || true
sudo ip route del 192.168.46.0/24 2>/dev/null || true

# –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP
sudo ip route add 192.168.45.0/24 via 192.168.87.2 dev wlp1s0
sudo ip route add 192.168.46.0/24 via 192.168.87.2 dev wlp1s0

# –ü—Ä–æ–≤–µ—Ä—è–µ–º
ip route show
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
default via 192.168.87.1 dev wlp1s0 proto dhcp metric 600 
192.168.45.0/24 via 192.168.87.2 dev wlp1s0 
192.168.46.0/24 via 192.168.87.2 dev wlp1s0 
192.168.87.0/24 dev wlp1s0 proto kernel scope link src 192.168.87.151 metric 600 
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ {#–ø—Ä–æ–≤–µ—Ä–∫–∞}

### 1. –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–Ω–æ—Å—Ç–∏
```bash
# –° –Ω–æ—É—Ç–±—É–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
echo "=== Basic connectivity check ==="

echo "1. Virtual gateway:"
ping -c 2 192.168.87.2

echo "2. Physical nodes:"
ping -c 2 192.168.87.253
ping -c 2 192.168.87.252  
ping -c 2 192.168.87.251

echo "3. Internal network gateways:"
ping -c 2 192.168.46.1
ping -c 2 192.168.45.1

echo "4. Hosts in internal networks:"
ping -c 2 192.168.46.4
ping -c 2 192.168.45.50

echo "5. Internet access:"
ping -c 2 8.8.8.8
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–∞–∑–Ω—ã—Ö source IP
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö IP
ping -I 192.168.45.251 8.8.8.8    # —Å dmzgateway3
ping -I 192.168.46.251 8.8.8.8    # —Å dmzgateway3
ping -I 192.168.45.252 8.8.8.8    # —Å dmzgateway2
ping -I 192.168.46.252 8.8.8.8    # —Å dmzgateway2
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã NAT
```bash
# –ù–∞ —à–ª—é–∑–µ —Å–º–æ—Ç—Ä–∏–º —Å—á–µ—Ç—á–∏–∫–∏ MASQUERADE
watch -n 1 'iptables -t nat -L POSTROUTING -nv'

# –ò–ª–∏ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∏–∫
while true; do clear; date; echo "=== NAT Counters ==="; iptables -t nat -L POSTROUTING -nv; sleep 2; done
```

---

## üêõ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞ {#–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞}

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Keepalived
```bash
# –ù–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º:
systemctl status keepalived
journalctl -u keepalived -f

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ IP
ip addr show | grep -E "192.168.(87|46|45)\.(2|1)"
```

### 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ source IP
ip route get to 8.8.8.8 from 192.168.45.251
ip route get to 8.8.8.8 from 192.168.46.251

# Traceroute –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
traceroute -s 192.168.45.251 8.8.8.8
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª iptables
```bash
# –°–º–æ—Ç—Ä–∏–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
iptables -L FORWARD -nv
iptables -t nat -L -nv

# –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫–∏ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è - —Ç—Ä–∞—Ñ–∏–∫ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
# –ù–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ–¥–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º keepalived
systemctl stop keepalived

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π —É–∑–µ–ª
ssh root@192.168.87.2
ip addr show | grep "192.168.87.2"

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
systemctl start keepalived
```

---

## üíæ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ {#—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ}

### –ù–∞ —à–ª—é–∑–∞—Ö (–≤—Å–µ –Ω–æ–¥—ã –∫–ª–∞—Å—Ç–µ—Ä–∞):

#### –°–ø–æ—Å–æ–± 1: iptables-persistent
```bash
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
apt-get update
apt-get install iptables-persistent

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞
netfilter-persistent save

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
systemctl enable netfilter-persistent
```

#### –°–ø–æ—Å–æ–± 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keepalived
```bash
# –í /etc/keepalived/keepalived.conf –¥–æ–±–∞–≤–ª—è–µ–º:
vrrp_instance VI_VMBR0 {
    ...
    notify_master "/etc/keepalived/scripts/notify_master.sh"
    notify_backup "/etc/keepalived/scripts/notify_backup.sh"
}

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
mkdir -p /etc/keepalived/scripts
```

### –ù–∞ –Ω–æ—É—Ç–±—É–∫–µ:

#### Netplan (Ubuntu):
```yaml
# /etc/netplan/01-network-manager-all.yaml
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    wlp1s0:
      dhcp4: yes
      routes:
        - to: 192.168.45.0/24
          via: 192.168.87.2
          metric: 100
        - to: 192.168.46.0/24
          via: 192.168.87.2
          metric: 100
```

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞

- [ ] **–í—Å–µ –Ω–æ–¥—ã**: IP forwarding = 1
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: –ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ iptables –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: MASQUERADE –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] **–í—Å–µ –Ω–æ–¥—ã**: Keepalived —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] **MASTER –Ω–æ–¥–∞**: –î–µ—Ä–∂–∏—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ IP (.2, .1)
- [ ] **BACKUP –Ω–æ–¥—ã**: –ì–æ—Ç–æ–≤—ã –∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é
- [ ] **–ù–æ—É—Ç–±—É–∫**: –ú–∞—Ä—à—Ä—É—Ç—ã —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP 192.168.87.2
- [ ] **–ü–∏–Ω–≥**: –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —à–ª—é–∑ (192.168.87.2) –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] **–ü–∏–Ω–≥**: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ VIP
- [ ] **–ü–∏–Ω–≥**: –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ç–µ–π
- [ ] **–°—á–µ—Ç—á–∏–∫–∏**: iptables –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ–¥–µ

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –Ω–æ–¥—ã
2. **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞**: –ö–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IP
3. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–¥—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä
5. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è**: –ü—Ä–∞–≤–∏–ª–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ


–≠—Ç–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∞—é—Ç –≤–∞—à—É —Å–µ—Ç–µ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —É–¥–æ–±–Ω–æ–π –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.
