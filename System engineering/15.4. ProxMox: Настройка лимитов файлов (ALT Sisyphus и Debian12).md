# Настройка HAProxy и лимитов файловых дескрипторов в Proxmox LXC контейнерах (Debian 12)

## Цель
Настроить HAProxy как балансировщик нагрузки для PostgreSQL с правильными лимитами файловых дескрипторов в unprivileged LXC контейнерах Proxmox.

---

## 1. Настройка лимитов файлов в Proxmox для unprivileged контейнеров

### **Важно: Unprivileged контейнеры**
У нас **unprivileged контейнеры** - это требует специальных настроек!

### **Проверка текущих лимитов файлов внутри контейнера**
```bash
# Проверка текущих лимитов
ulimit -H -n    # Hard limit
ulimit -S -n    # Soft limit
cat /proc/1/limits | grep "Max open files"

# Пример вывода:
# Max open files            524288               524288               files
```

### **Настройка лимитов через LXC конфиг**

#### **Редактирование конфигурации:**
```bash
# Редактируем конфиг контейнера на хосте Proxmox
mcedit /etc/pve/lxc/199.conf
```

#### **Добавить в конец файла:**
```bash
# Основной лимит файловых дескрипторов
lxc.prlimit.nofile: 65536
```

#### **Внимание: Выбор правильного cgroup**
**Для Proxmox (cgroup v1) используйте:**
```bash
# Дополнительные настройки для unprivileged контейнеров (cgroup v1)
lxc.cgroup.devices.max: 65536
```

**Для систем с cgroup v2 (если поддерживается):**
```bash
# Дополнительные настройки для unprivileged контейнеров (cgroup v2)
lxc.cgroup2.files.max: 65536
lxc.cgroup2.files.soft: 32768
```

#### **Итоговые правильные конфиги**

##### **Для контейнера 198 (Ubuntu):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ub25
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:C1:17:70,ip=192.168.87.101/24,type=veth
ostype: ubuntu
rootfs: ssd_1tb:198/vm-198-disk-0.raw,size=34G
swap: 256
unprivileged: 1

# Лимиты файловых дескрипторов
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536 
```

##### **Для контейнера 199 (ALT Linux):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ALT11
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:48:36:3A,ip=192.168.87.100/24,type=veth
ostype: fedora
rootfs: ssd_1tb:199/vm-199-disk-0.raw,size=36G
swap: 256
unprivileged: 1

# Лимиты файловых дескрипторов
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536
```

#### **Альтернативный способ через features**
```bash
## в /etc/pve/lxc/***.conf
# Вместо отдельных prlimit, можно использовать ТОЛЬКО для cgroup v1:
features: nesting=1,fuse=1,keyctl=1,mount=nfs

# Для cgroup v1 используем:
lxc.cgroup.devices.max: 65536

# НЕ ИСПОЛЬЗОВАТЬ cgroup2 настройки в Proxmox с cgroup v1!
# lxc.cgroup2.files.max: 131072  ← ЭТО НЕ БУДЕТ РАБОТАТЬ!
```

#### **Применение изменений**
```bash
# Перезапускаем контейнеры
pct reboot 198
pct reboot 199

# Или через web-интерфейс
```

#### **Проверка внутри контейнеров**
После перезагрузки, внутри каждого контейнера:
```bash
# Проверить лимиты для init процесса
cat /proc/1/limits | grep "Max open files"

# Дополнительные проверки для unprivileged
cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep "0::" | cut -d: -f3)/pids.max
```

#### **Если не работает (особенности unprivileged)**
Для unprivileged контейнеров иногда требуется дополнительная настройка внутри контейнера:

##### **Способ 1: Через systemd в контейнере**
```bash
# Внутри контейнера редактируем службу HAProxy
systemctl edit haproxy

# Добавляем:
[Service]
LimitNOFILE=65536

# Применяем
systemctl daemon-reload
systemctl restart haproxy.service
```

##### **Способ 1.1: Непосредственное редактирование systemd в контейнере**
```bash
# Найти юнит
systemctl show haproxy -p FragmentPath
systemctl show haproxy -p FragmentPath,DropInPaths
systemctl show haproxy -p LimitNOFILE

# Пример вывода:
# FragmentPath=/usr/lib/systemd/system/haproxy.service

# Редактировать напрямую
mcedit /usr/lib/systemd/system/haproxy.service

# Или посмотреть текущую конфигурацию
systemctl cat haproxy.service --no-pager
```

##### **Способ 2: Настройка через pam_limits**
```bash
# В контейнере редактируем
mcedit /etc/security/limits.conf

# Добавляем:
* soft nofile 32768
* hard nofile 65536
_haproxy soft nofile 65536
_haproxy hard nofile 65536
```

---

## 2. Установка и базовая настройка HAProxy в Debian 12

### **Установка HAProxy**
```bash
# Обновляем систему и устанавливаем HAProxy
apt update && apt upgrade -y
apt install -y haproxy haproxy-cmd hatop
```

### **Базовая конфигурация HAProxy**
```bash
# Создаем резервную копию оригинального конфига
cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.backup

# Редактируем конфигурационный файл
mcedit /etc/haproxy/haproxy.cfg
```

#### **Пример конфигурации для тестирования (балансировка HTTP)**
```cfg
#---------------------------------------------------------------------
# Global settings - Глобальные настройки (влияют на весь HAProxy)
#---------------------------------------------------------------------
global
    # log to /dev/log
    log /dev/log daemon           # Логирование в системный /dev/log с категорией "daemon"

    # Примеры альтернативного логирования (закомментированы):
    #log 127.0.0.1:514 local2     # Логирование в syslog по UDP
    #log tcp@127.0.0.1:514 local2 notice  # Логирование в syslog по TCP

    chroot /var/lib/haproxy       # Изоляция процесса в chroot-окружении
    pidfile /run/haproxy.pid      # Файл где хранится PID процесса
    maxconn 4000                  # Максимум 4000 одновременных подключений
    user _haproxy                 # Запуск от пользователя _haproxy (безпривилегированный)
    group _haproxy                # Запуск от группы _haproxy
    daemon                        # Запуск в фоновом режиме (демон)

    # Статистика через Unix socket
    stats socket /var/lib/haproxy/stats  # Socket для управления и мониторинга

#---------------------------------------------------------------------
# defaults - Настройки по умолчанию для всех секций
#---------------------------------------------------------------------
defaults
    mode http                     # Режим работы с HTTP (вместо TCP)
    log global                    # Использовать глобальные настройки логирования
    option httplog                # Расширенное логирование HTTP запросов
    option dontlognull            # Не логировать пустые соединения
    option http-server-close      # Закрывать соединения с сервером для экономии ресурсов
    option forwardfor except 127.0.0.0/8  # Добавлять X-Forwarded-For header (кроме localhost)
    option redispatch             # Перенаправлять запросы если сервер недоступен
    retries 3                     # 3 попытки переподключения при ошибке
    timeout http-request 10s      # Таймаут получения HTTP запроса - 10 секунд
    timeout queue 1m              # Таймаут в очереди - 1 минута
    timeout connect 10s           # Таймаут подключения к бэкенду - 10 секунд
    timeout client 1m             # Таймаут клиента - 1 минута
    timeout server 1m             # Таймаут сервера - 1 минута
    timeout http-keep-alive 10s   # Таймаут keep-alive соединений - 10 секунд
    timeout check 10s             # Таймаут health check - 10 секунд
    maxconn 3000                  # Максимум 3000 подключений на секцию

#---------------------------------------------------------------------
# frontend - "Входная дверь" принимающая входящие соединения
#---------------------------------------------------------------------
frontend main
    bind *:5000                   # Слушать на всех интерфейсах порт 5000
    
    # ACL (Access Control List) - правила для маршрутизации
    acl url_static path_beg -i /static /images /javascript /stylesheets
    # Если путь НАЧИНАЕТСЯ с /static, /images и т.д. → правило срабатывает
    
    acl url_static path_end -i .jpg .gif .png .css .js
    # Если путь ЗАКАНЧИВАЕТСЯ на .jpg, .gif и т.д. → правило срабатывает

    use_backend static if url_static  # Использовать бэкенд "static" если сработало правило
    default_backend app               # По умолчанию использовать бэкенд "app"

#---------------------------------------------------------------------
# backend static - Бэкенд для статического контента
#---------------------------------------------------------------------
backend static
    balance roundrobin           # Балансировка по круговому алгоритму
    server static 127.0.0.1:4331 check  # Один сервер на localhost:4331 с health check

#---------------------------------------------------------------------
# backend app - Бэкенд для приложений
#---------------------------------------------------------------------
backend app
    balance roundrobin           # Балансировка по круговому алгоритму
    server app1 127.0.0.1:5001 check  # Сервер 1 на порту 5001
    server app2 127.0.0.1:5002 check  # Сервер 2 на порту 5002  
    server app3 127.0.0.1:5003 check  # Сервер 3 на порту 5003
    server app4 127.0.0.1:5004 check  # Сервер 4 на порту 5004
```

### **Запуск и тестирование базовой конфигурации**

#### **Запуск тестовых бэкендов**
```bash
# Создаем тестовый контент
mkdir -p /var/www/html
echo '<h1>Hello from HAProxy on Debian 12!</h1><p>Server: '$(hostname)'</p>' > /var/www/html/index.html

# Запускаем Python HTTP серверы как бэкенды
python3 -m http.server 4331 --directory /var/www/html &
python3 -m http.server 5001 --directory /var/www/html &
python3 -m http.server 5002 --directory /var/www/html &
python3 -m http.server 5003 --directory /var/www/html &
python3 -m http.server 5004 --directory /var/www/html &

# Проверяем запущенные процессы
ps aux | grep python
ss -tlnp | grep python
```

#### **Запуск HAProxy**
```bash
# Проверяем конфигурацию
haproxy -c -f /etc/haproxy/haproxy.cfg

# Запускаем HAProxy через systemd
systemctl start haproxy
systemctl status haproxy

# Или напрямую (если нужно отладить)
/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -D
```

#### **Тестирование работы**
```bash
# Проверка доступности бэкендов
curl http://localhost:5000/

# Тестирование балансировки
for i in {1..5}; do
  echo "Request $i:"
  curl -s http://localhost:5000/ | grep "Hello"
done
```

---

## 3. Настройка лимитов файловых дескрипторов для HAProxy в Debian 12

### **Зачем настраивать лимиты файлов для HAProxy?**
HAProxy - это **балансировщик нагрузки**, который обрабатывает тысячи одновременных подключений. Каждое подключение = 1 файловый дескриптор (FD).

**Если лимиты слишком низкие:**
- HAProxy не сможет обрабатывать много клиентов
- Потеря подключений при высокой нагрузке
- Ошибки "Too many open files"

### **Диагностика текущих лимитов**

#### **Проверка лимитов на уровне LXC контейнера**
```bash
# Проверяем что контейнер может использовать много FD
cat /proc/1/limits | grep "Max open files"
```
**Результат:** `Max open files 65536 65536 files` 

#### **Проверка лимитов для процесса HAProxy**
```bash
# Проверяем что HAProxy процесс наследует лимиты
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```
**Ожидаемый результат:** `Max open files 65536 65536 files`

#### **Проверка текущего использования FD**
```bash
# Сколько файловых дескрипторов использует HAProxy сейчас
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l
```

### **Настройка лимитов для HAProxy**

#### **Способ 1: Через systemd (рекомендуется)**
```bash
# Редактируем службу HAProxy
systemctl edit haproxy

# Добавляем:
[Service]
LimitNOFILE=65536

# Применяем
systemctl daemon-reload
systemctl restart haproxy.service
```

#### **Способ 2: Через systemd напрямую**
```bash
# Создаем директорию для override конфига
mkdir -p /etc/systemd/system/haproxy.service.d/

# Создаем конфиг
mcedit /etc/systemd/system/haproxy.service.d/override.conf
```

**Содержимое:**
```ini
[Service]
LimitNOFILE=65536
```

#### **Способ 3: Через pam_limits**
```bash
# Добавляем в limits.conf
mcedit /etc/security/limits.conf

# Добавить строки:
* soft nofile 65536
* hard nofile 65536
_haproxy soft nofile 65536  
_haproxy hard nofile 65536
```

### **Оптимизация maxconn в конфигурации HAProxy**

**Принцип:** HAProxy рассчитывает общий лимит как сумму всех maxconn + буферы

#### **Проверка текущих настроек maxconn**
```bash
# Ищем настройки maxconn в конфигурации
grep -r "maxconn" /etc/haproxy/haproxy.cfg

# Показать глобальную секцию
head -20 /etc/haproxy/haproxy.cfg
```

#### **Оптимизация значений maxconn**

**Исходная проблемная конфигурация:**
- Глобальный: 150000
- core: 50000
- core_esl: 50000
- cdr: 150000 (глобальный)
- **Итого:** ~300066 (выше лимита)

**Рабочая оптимизированная конфигурация:**
```bash
# Редактируем конфигурацию
mcedit /etc/haproxy/haproxy.cfg

# Устанавливаем значения:
global
    maxconn 25000           # Уменьшено с 150000
    tune.maxrewrite 1024    # Оптимизация буферов
    tune.bufsize 16384

listen core
    maxconn 35000           # Увеличено для этой секции
    server ... maxconn 20000

listen core_esl  
    maxconn 35000           # Увеличено для этой секции

listen cdr
    # использует глобальный 25000
```

**Итого:** ~65000 (в пределах лимита 65536)

#### **Проверка и применение изменений**
```bash
# Проверить конфигурацию
haproxy -c -f /etc/haproxy/haproxy.cfg

# Перезапустить службу
systemctl restart haproxy

# Проверить статус
systemctl status haproxy

# Проверить лимиты запущенного процесса
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```

### **Финальные команды для проверки**

#### **Проверка всех лимитов:**
```bash
#!/bin/bash

echo "=== LXC Container Limits ==="
cat /proc/1/limits | grep "Max open files"

echo "=== HAProxy Process Limits ==="
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"

echo "=== Current HAProxy FD Usage ==="
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l

echo "=== HAProxy Status ==="
systemctl status haproxy --no-pager -l
```

---

## 4. Тестирование HAProxy с PostgreSQL

### **Цель тестирования**
Проверить, что HAProxy может обрабатывать тысячи одновременных подключений к PostgreSQL, используя настроенные лимиты файловых дескрипторов (65536 FD).

### **Предварительная настройка**

#### **Конфигурация HAProxy для PostgreSQL**
```bash
# Создаем чистый конфиг HAProxy
mcedit /etc/haproxy/haproxy.cfg
```

**Содержимое конфига:**

**Вариант 1: Только LISTEN:**
```cfg
# Статистика HAProxy - веб-интерфейс для мониторинга
listen postgres_stats
    bind *:7001                   # Слушать порт 7001 на всех интерфейсах
    mode http                     # Режим HTTP для веб-интерфейса
    stats enable                  # Включить статистику
    stats uri /                   # URL по умолчанию - корень
    stats refresh 10s             # Автообновление страницы каждые 10 секунд

# PostgreSQL TCP балансировка - основной сервис
listen postgresql
    bind *:5000                   # Слушать порт 5000 для PostgreSQL подключений
    mode tcp                      # TCP режим (не HTTP!) для работы с PostgreSQL
    option tcplog                 # Включить логирование TCP-соединений
    balance roundrobin            # Алгоритм балансировки - по очереди
    timeout client 50000          # Таймаут клиента 50 секунд
    timeout server 50000          # Таймаут сервера 50 секунд  
    timeout connect 5000          # Таймаут подключения 5 секунд
    # Бэкенд сервер PostgreSQL
    server postgres_local 127.0.0.1:5432 check port 5432 inter 5s rise 2 fall 3
    #        имя_сервера  адрес:порт        проверка здоровья на порту 5432
    #        inter 5s     - интервал проверок 5 секунд
    #        rise 2       - 2 успешные проверки чтобы сервер стал активным
    #        fall 3       - 3 неудачные проверки чтобы сервер отключить
```

**Вариант 2: Только FRONTEND+BACKEND:**
```cfg
# Статистика HAProxy
listen postgres_stats
    bind *:7001
    mode http
    stats enable
    stats uri /
    stats refresh 10s

# PostgreSQL балансировка - РАЗДЕЛЕННАЯ
frontend pg_frontend
    bind *:5000
    mode tcp
    default_backend server_PostgreSQL

backend server_PostgreSQL
    mode tcp
    option tcplog
    balance roundrobin
    timeout client 50000
    timeout server 50000
    timeout connect 5000
    server postgres_local 127.0.0.1:5432 check port 5432 inter 5s rise 2 fall 3
```

#### **Настройка аутентификации PostgreSQL**
```bash
# Создаем .pgpass для автоматической аутентификации
echo "localhost:*:*:postgres:runtelorg" > ~/.pgpass
chmod 600 ~/.pgpass  # Критически важно: только владелец может читать
```

### **Запуск HAProxy**

#### **Проверка конфигурации**
```bash
# Проверяем синтаксис конфига
haproxy -c -f /etc/haproxy/haproxy.cfg

# Должны быть только предупреждения (не ошибки):
# [WARNING] config : log format ignored for proxy 'postgresql' since it has no log address.
```

#### **Запуск HAProxy**
```bash
# Убиваем старые процессы (если есть)
pkill -9 haproxy
sleep 2

# Запускаем HAProxy в фоновом режиме
/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -D
```

#### **Проверка запуска**
```bash
# Проверяем процессы HAProxy
ps aux | grep haproxy
# Должен быть процесс: /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -D

# Проверяем прослушиваемые порты
ss -tlnp | grep haproxy
# Должны быть:
# LISTEN 0 4096 0.0.0.0:5000  # PostgreSQL
# LISTEN 0 4096 0.0.0.0:7001  # Статистика
```

### **Подготовка тестового окружения**

#### **Проверка подключения к PostgreSQL**
```bash
# Тестируем прямое подключение к PostgreSQL
psql -h localhost -p 5432 -U postgres -c "SELECT version();"

# Тестируем подключение через HAProxy
psql -h localhost -p 5000 -U postgres -c "SELECT version();"
# Должен вернуть версию PostgreSQL без запроса пароля
```

#### **Создание тестовой базы данных**
```bash
# Создаем базу для тестов (если не существует)
psql -h localhost -p 5000 -U postgres -c "CREATE DATABASE load_test;"

# Проверяем создание
psql -h localhost -p 5000 -U postgres -d load_test -c "SELECT current_database();"
```

### **Тестирование FD лимитов**

#### **Подготовка тестового скрипта**
```bash
# Создаем скрипт тестирования подключений
cd /var/lib/pgsql
mcedit pg_connection_test.sh
```

**Содержимое скрипта:**
```bash
#!/bin/bash

echo "=== HAProxy PostgreSQL Load Test ==="
echo "Testing FD limits with multiple connections through HAProxy..."

# Параметры
CONNECTION_STRING="postgresql://postgres:runtelorg@localhost:5000/postgres"
TOTAL_CONNECTIONS=100
BATCH_SIZE=10

# Функция для создания подключения через HAProxy
create_connection() {
    local conn_id=$1
    psql "$CONNECTION_STRING" -c "SELECT pg_sleep(0.5);" -t > /dev/null 2>&1 &
}

# Проверяем начальное состояние
echo "Initial state:"
./pg_connection_test3.sh

echo ""
echo "Starting load test with $TOTAL_CONNECTIONS connections through HAProxy port 5000..."
echo ""

# Создаем подключения батчами
for ((i=1; i<=$TOTAL_CONNECTIONS; i++)); do
    create_connection $i
    
    # Каждые BATCH_SIZE подключений показываем статистику
    if [ $((i % BATCH_SIZE)) -eq 0 ]; then
        HAPROXY_PID=$(cat /run/haproxy.pid 2>/dev/null)
        if [ -n "$HAPROXY_PID" ]; then
            FD_COUNT=$(ls -la /proc/$HAPROXY_PID/fd/ 2>/dev/null | wc -l)
            echo "Created $i connections - HAProxy FD count: $FD_COUNT"
        fi
        sleep 0.1
    fi
done

echo ""
echo "Waiting for all connections to complete..."
wait

echo ""
echo "Final state:"
./pg_connection_test3.sh
```

#### **Делаем скрипт исполняемым**
```bash
chmod +x pg_connection_test.sh
```

#### **Мониторинг в реальном времени**

##### **Запускаем во ВТОРОМ терминале:**
```bash
# Мониторим FD использование в реальном времени
watch -n 1 "echo '=== HAProxy FD Monitoring ==='; \
echo 'FD Count:'; ls -la /proc/\$(pgrep haproxy | head -1)/fd/ 2>/dev/null | wc -l; \
echo 'Memory:'; ps aux | grep haproxy | grep -v grep | awk '{print \$4,\$5,\$6}'; \
echo 'Connections:'; ss -tn | grep :5000 | wc -l"
```

#### **Запуск теста и наблюдение**

##### **В ПЕРВОМ терминале запускаем тест:**
```bash
# Переходим в директорию со скриптом
cd /var/lib/pgsql

# Запускаем тест
./pg_connection_test.sh
```

##### **Что наблюдать во время теста:**

###### **В первом термине (тест):**
```
=== PostgreSQL Connection Stress Test ===
Testing HAProxy FD limits with PostgreSQL connections...
Initial FD count: 13
Started 10 connections. Current FD: 23
Started 20 connections. Current FD: 33
Started 30 connections. Current FD: 43
...
Started 100 connections. Current FD: 113
Waiting for all connections to complete...
=== Test Complete ===
Initial FD: 13
Final FD: 13
Peak connections: 100
```

###### **Во втором терминале (мониторинг):**
```
=== HAProxy FD Monitoring ===
FD Count: 67
Memory: 0.3 103404 10984
Connections: 45
```

### **Анализ результатов**

#### **Успешный тест показывает:**
- **FD count увеличивается** во время теста (с 13 до 100+)
- **FD count возвращается** к исходному после завершения
- **Нет ошибок** "Too many open files"
- **HAProxy остается стабильным**
- **Все подключения обрабатываются**

#### **Проверка лимитов после теста:**
```bash
# Проверяем что лимиты остались 65536
cat /proc/$(pgrep haproxy | head -1)/limits | grep "Max open files"
# Должно быть: Max open files 65536 65536 files

# Проверяем статистику HAProxy
curl http://localhost:7001/
```

### **Возможные проблемы и решения**

#### **Проблема 1: Запрос пароля**
```bash
# Решение: Проверить права .pgpass
ls -la ~/.pgpass  # Должно быть -rw-------
chmod 600 ~/.pgpass
```

#### **Проблема 2: HAProxy не запускается**
```bash
# Решение: Проверить конфиг и убить старые процессы
haproxy -c -f /etc/haproxy/haproxy.cfg
pkill -9 haproxy
```

#### **Проблема 3: Нет увеличения FD**
```bash
# Решение: Проверить что подключения идут через HAProxy
ss -tn | grep :5000  # Должны быть подключения
```

---

Вы правы! Я забыл включить финальную инструкцию по настройке лимитов для HAProxy в Debian 12. Вот она:

---

## 5. Детальная инструкция по настройке лимитов файлов для HAProxy в Debian 12

### **Проблема, с которой мы столкнулись**
HAProxy не запускался с ошибкой:
```
[ALERT] : Cannot raise FD limit to 300066, limit is 1024.
```
HAProxy пытался установить лимит файловых дескрипторов 300066, но системный лимит был всего 1024.

### **Пошаговое решение**

#### **Шаг 1: Диагностика текущих лимитов**

```bash
# Проверка лимитов текущей оболочки
ulimit -n          # текущий мягкий лимит (было: 1024)
ulimit -H -n       # жесткий лимит (было: 65536)
ulimit -S -n       # мягкий лимит (было: 1024)

# Проверка лимитов процесса systemd (максимум системы)
cat /proc/1/limits | grep "Max open files"

# Проверка лимитов для HAProxy процесса (если запущен)
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```

#### **Шаг 2: Анализ конфигурации HAProxy**

```bash
# Найти настройки maxconn в конфигурации
grep -r "maxconn" /etc/haproxy/haproxy.cfg

# Показать глобальную секцию
head -20 /etc/haproxy/haproxy.cfg
```

**Обнаружено:** В глобальной секции `maxconn 150000` + дополнительные maxconn в listen секциях.

#### **Шаг 3: Увеличение лимитов через systemd**

```bash
# Создать override директорию и конфиг
mkdir -p /etc/systemd/system/haproxy.service.d/

# Создать файл override.conf
cat > /etc/systemd/system/haproxy.service.d/override.conf << EOF
[Service]
LimitNOFILE=65536
EOF

# Применить изменения
systemctl daemon-reload
```

#### **Шаг 4: Настройка лимитов в HAProxy**

```bash
# Добавить в /etc/default/haproxy
echo 'ULIMIT="-n 65536"' >> /etc/default/haproxy
```

#### **Шаг 5: Оптимизация maxconn в конфигурации HAProxy**

**Принцип:** HAProxy рассчитывает общий лимит как сумму всех maxconn + буферы

**Исходная проблемная конфигурация:**
- Глобальный: 150000
- core: 50000
- core_esl: 50000  
- cdr: 150000 (глобальный)
- **Итого:** ~300066 (выше лимита)

**Оптимизация значений:**

```bash
# Создаем резервную копию
cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.backup

# Редактируем конфигурацию
mcedit /etc/haproxy/haproxy.cfg
```

**Устанавливаем оптимальные значения:**
```cfg
global
    maxconn 32000           # Уменьшено с 150000
    tune.maxrewrite 1024    # Оптимизация буферов
    tune.bufsize 16384

defaults
    log global
    mode tcp
    retries 2
    timeout client 30m
    timeout connect 1s
    timeout server 30m
    timeout check 2s

listen stats
    mode http
    bind 127.0.0.1:7000
    stats enable
    stats uri /

listen core
    mode http
    bind 127.0.0.1:4001
    maxconn 30000
    option httpchk GET /ping/
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server 192.168.87.71 192.168.87.71:4001 maxconn 20000 check port 4006

listen core_esl
    bind 127.0.0.1:4002
    maxconn 30000
    option httpchk GET /ping/
    option tcp-check
    tcp-check connect
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server 192.168.87.71 192.168.87.71:4002 check port 4006

listen cdr
    bind 127.0.0.1:4003
    mode http
    option httpchk GET /ping/
    balance roundrobin
    server 192.168.87.71 192.168.87.71:4003 check port 4008
```

**Итого:** ~65000 (в пределах лимита 65536)

#### **Шаг 6: Проверка и применение изменений**

```bash
# Проверить конфигурацию
haproxy -c -f /etc/haproxy/haproxy.cfg

# Перезапустить службу
systemctl restart haproxy

# Проверить статус
systemctl status haproxy

# Проверить лимиты запущенного процесса
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```

#### **Шаг 7: Тестирование различных значений maxconn**

**Если 32000 работает, пробуем оптимизировать дальше:**

```bash
# Пробуем увеличить listen секции, уменьшив глобальный
mcedit /etc/haproxy/haproxy.cfg
```

**Оптимизированная конфигурация:**
```cfg
global
    maxconn 25000           # Уменьшаем глобальный

listen core
    maxconn 35000           # Увеличиваем для этой секции
    mode http
    bind 127.0.0.1:4001
    option httpchk GET /ping/
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server 192.168.87.71 192.168.87.71:4001 maxconn 20000 check port 4006

listen core_esl
    maxconn 35000           # Увеличиваем для этой секции
    bind 127.0.0.1:4002
    option httpchk GET /ping/
    option tcp-check
    tcp-check connect
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server 192.168.87.71 192.168.87.71:4002 check port 4006

listen cdr
    bind 127.0.0.1:4003
    mode http
    option httpchk GET /ping/
    balance roundrobin
    server 192.168.87.71 192.168.87.71:4003 check port 4008
```

**Проверяем:**
```bash
systemctl restart haproxy
systemctl status haproxy
```

### **Финальная проверка всех лимитов**

```bash
#!/bin/bash

echo "1. Лимиты LXC контейнеров:"
cat /proc/1/limits | grep "Max open files"

echo ""
echo "2. Лимиты процессов haproxy:"
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"

echo ""
echo "3. текущее использование ФД haproxy:"
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l

echo ""
echo "4. HAProxy статус:"
systemctl status haproxy --no-pager -l

echo ""
echo "5. Порты:"
ss -tlnp | grep haproxy
```

### **Итоговые рабочие параметры**
- **Systemd лимит:** 65536
- **HAProxy глобальный maxconn:** 25000  
- **HAProxy listen секции:** 35000
- **Общий расчетный лимит:** ~65000

### **Важные моменты для Debian 12**
1. **Systemd override** должен быть в `/etc/systemd/system/`, не в `/lib/`
2. **Ручной запуск** имеет лимит 1024, тестировать через systemd
3. **maxconn в listen** переопределяет глобальный для этой секции
4. **Сумма всех maxconn** + буферы не должна превышать системный лимит
5. **В Debian 12** используется cgroup v2, но Proxmox LXC обычно работает с cgroup v1

---

