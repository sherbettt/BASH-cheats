##  –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ –Ω–∞ ALT Linux —Å "–°–∏–∑–∏—Ñ–æ–º"

### **–¶–µ–ª—å:**
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HAProxy –∫–∞–∫ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –µ–≥–æ —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Å PostgreSQL



## **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è:**

### **1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HAProxy**
```bash
apt install -y haproxy haproxy-cmd hatop
```
- –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç + —É—Ç–∏–ª–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **2. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
cat /etc/haproxy/haproxy.cfg
```

<details>
<summary>‚ùó /etc/haproxy/haproxy.cfg ‚ùó</summary>
  
```cfg
#---------------------------------------------------------------------
# Global settings - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–ª–∏—è—é—Ç –Ω–∞ –≤–µ—Å—å HAProxy)
#---------------------------------------------------------------------
global
    # log to /dev/log
    log /dev/log daemon           # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π /dev/log —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "daemon"

    # –ü—Ä–∏–º–µ—Ä—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã):
    #log 127.0.0.1:514 local2     # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ syslog –ø–æ UDP
    #log tcp@127.0.0.1:514 local2 notice  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ syslog –ø–æ TCP

    chroot /var/lib/haproxy       # –ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ chroot-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
    pidfile /run/haproxy.pid      # –§–∞–π–ª –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è PID –ø—Ä–æ—Ü–µ—Å—Å–∞
    maxconn 4000                  # –ú–∞–∫—Å–∏–º—É–º 4000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    user _haproxy                 # –ó–∞–ø—É—Å–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è _haproxy (–±–µ–∑–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
    group _haproxy                # –ó–∞–ø—É—Å–∫ –æ—Ç –≥—Ä—É–ø–ø—ã _haproxy
    daemon                        # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–º–æ–Ω)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ Unix socket
    stats socket /var/lib/haproxy/stats  # Socket –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#---------------------------------------------------------------------
# defaults - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
#---------------------------------------------------------------------
defaults
    mode http                     # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å HTTP (–≤–º–µ—Å—Ç–æ TCP)
    log global                    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    option httplog                # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
    option dontlognull            # –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    option http-server-close      # –ó–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    option forwardfor except 127.0.0.0/8  # –î–æ–±–∞–≤–ª—è—Ç—å X-Forwarded-For header (–∫—Ä–æ–º–µ localhost)
    option redispatch             # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    retries 3                     # 3 –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    timeout http-request 10s      # –¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞ - 10 —Å–µ–∫—É–Ω–¥
    timeout queue 1m              # –¢–∞–π–º–∞—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ - 1 –º–∏–Ω—É—Ç–∞
    timeout connect 10s           # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É - 10 —Å–µ–∫—É–Ω–¥
    timeout client 1m             # –¢–∞–π–º–∞—É—Ç –∫–ª–∏–µ–Ω—Ç–∞ - 1 –º–∏–Ω—É—Ç–∞
    timeout server 1m             # –¢–∞–π–º–∞—É—Ç —Å–µ—Ä–≤–µ—Ä–∞ - 1 –º–∏–Ω—É—Ç–∞
    timeout http-keep-alive 10s   # –¢–∞–π–º–∞—É—Ç keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π - 10 —Å–µ–∫—É–Ω–¥
    timeout check 10s             # –¢–∞–π–º–∞—É—Ç health check - 10 —Å–µ–∫—É–Ω–¥
    maxconn 3000                  # –ú–∞–∫—Å–∏–º—É–º 3000 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –Ω–∞ —Å–µ–∫—Ü–∏—é

#---------------------------------------------------------------------
# frontend - "–í—Ö–æ–¥–Ω–∞—è –¥–≤–µ—Ä—å" –ø—Ä–∏–Ω–∏–º–∞—é—â–∞—è –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
#---------------------------------------------------------------------
frontend main
    bind *:5000                   # –°–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –ø–æ—Ä—Ç 5000
    
    # ACL (Access Control List) - –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
    acl url_static path_beg -i /static /images /javascript /stylesheets
    # –ï—Å–ª–∏ –ø—É—Ç—å –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø —Å /static, /images –∏ —Ç.–¥. ‚Üí –ø—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
    
    acl url_static path_end -i .jpg .gif .png .css .js
    # –ï—Å–ª–∏ –ø—É—Ç—å –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–¢–°–Ø –Ω–∞ .jpg, .gif –∏ —Ç.–¥. ‚Üí –ø—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

    use_backend static if url_static  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—ç–∫–µ–Ω–¥ "static" –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –ø—Ä–∞–≤–∏–ª–æ
    default_backend app               # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—ç–∫–µ–Ω–¥ "app"

#---------------------------------------------------------------------
# backend static - –ë—ç–∫–µ–Ω–¥ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
#---------------------------------------------------------------------
backend static
    balance roundrobin           # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥–æ–≤–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É
    server static 127.0.0.1:4331 check  # –û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–∞ localhost:4331 —Å health check

#---------------------------------------------------------------------
# backend app - –ë—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
#---------------------------------------------------------------------
backend app
    balance roundrobin           # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥–æ–≤–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É
    server app1 127.0.0.1:5001 check  # –°–µ—Ä–≤–µ—Ä 1 –Ω–∞ –ø–æ—Ä—Ç—É 5001
    server app2 127.0.0.1:5002 check  # –°–µ—Ä–≤–µ—Ä 2 –Ω–∞ –ø–æ—Ä—Ç—É 5002  
    server app3 127.0.0.1:5003 check  # –°–µ—Ä–≤–µ—Ä 3 –Ω–∞ –ø–æ—Ä—Ç—É 5003
    server app4 127.0.0.1:5004 check  # –°–µ—Ä–≤–µ—Ä 4 –Ω–∞ –ø–æ—Ä—Ç—É 5004

```
</details> 



## **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:**

```
–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç http://server:5000/image.jpg
    ‚Üì
Frontend main: –ø–æ—Ä—Ç 5000
    ‚Üì  
ACL: path_end .jpg ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç url_static
    ‚Üì
Backend static: 127.0.0.1:4331
    ‚Üì
Python —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 4331 –æ—Ç–¥–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
```

```
–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç http://server:5000/api/users
    ‚Üì
Frontend main: –ø–æ—Ä—Ç 5000
    ‚Üì
ACL: –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Üí default_backend
    ‚Üì  
Backend app: roundrobin –º–µ–∂–¥—É –ø–æ—Ä—Ç–∞–º–∏ 5001-5004
    ‚Üì
–û–¥–∏–Ω –∏–∑ Python —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
```
*–≠—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–µ—Ç **–ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏–∫–∏ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!*



### **3. –ó–∞–ø—É—Å–∫ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**
```bash
systemctl status haproxy
```
- –û–±–Ω–∞—Ä—É–∂–∏–ª–∏ —á—Ç–æ –±—ç–∫–µ–Ω–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ("Connection refused")

### **4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±—ç–∫–µ–Ω–¥–æ–≤**
```bash
# –ó–∞–ø—É—Å—Ç–∏–ª–∏ Python HTTP —Å–µ—Ä–≤–µ—Ä—ã –∫–∞–∫ –±—ç–∫–µ–Ω–¥—ã
python3 -m http.server 4331 --directory /var/www/html &
python3 -m http.server 5001 --directory /var/www/html &

ps aux | grep python
ss -tlnp | grep python

# –∞ —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–∏—Ç—å –¥–∂–æ–±—ã
jobs
fg %1  # –∞ –∑–∞—Ç–µ–º  Ctrl + C
kill %1 %2
killall %%
```

### **5. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**
```bash
mkdir -p /var/www/html
echo '<h1>Hello from HAProxy on ALT Sisyphus!</h1><p>Server: '$(hostname)'</p>' > /var/www/html/index.html
```

### **6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥–æ–≤
curl http://localhost:5000/

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
for i in {1..5}; do
  echo "Request $i:"
  curl -s http://localhost:5000/ | grep "Hello"
done
```

---

##  **–ß—Ç–æ –º—ã –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –∏ –∑–∞—á–µ–º:**

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞:**
```
–ö–ª–∏–µ–Ω—Ç—ã ‚Üí HAProxy:5000 ‚Üí Python HTTP —Å–µ—Ä–≤–µ—Ä—ã (4331, 5001-5004)
                    ‚Üì
            –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ roundrobin
```

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
```bash
frontend main
    bind *:5000                    # –°–ª—É—à–∞–µ–º –ø–æ—Ä—Ç 5000
    acl url_static path_beg -i /static  # –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
    use_backend static if url_static    # –°—Ç–∞—Ç–∏–∫–∞ ‚Üí –ø–æ—Ä—Ç 4331  
    default_backend app                 # –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –ø–æ—Ä—Ç—ã 5001-5004

backend static
    server static 127.0.0.1:4331 check  # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç

backend app  
    server app1 127.0.0.1:5001 check    # 4 –ø—Ä–∏–∫–ª–∞–¥–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
    server app2 127.0.0.1:5002 check
    server app3 127.0.0.1:5003 check  
    server app4 127.0.0.1:5004 check
```



## üîç **–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ–≤–µ—Ä—à–∏–ª–∏:**

1. **Health Checks** - HAProxy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–æ–≤
2. **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞** - –∑–∞–ø—Ä–æ—Å—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–∞—Ö –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
4. **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∑–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ HAProxy –∫ –±—ç–∫–µ–Ω–¥–∞–º
5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω



## **–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥?**

**–≠—Ç–æ —É—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ALT Linux**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞** - —Å—Ç–∞—Ç–∏–∫–∞ vs –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±—ç–∫–µ–Ω–¥—ã** - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é  
- **–ì–æ—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - timeout, retries, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏



## **–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—É—á–µ–Ω–∏—è:**

–¢–µ–ø–µ—Ä—å –º—ã –ø–æ–Ω–∏–º–∞–µ–º –∫–∞–∫ HAProxy:
-  **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã** —á–µ—Ä–µ–∑ health checks
-  **–ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É** –º–µ–∂–¥—É –±—ç–∫–µ–Ω–¥–∞–º–∏
-  **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏** (ACL)
-  **–†–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏** (HTTP –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ)

-----------------

—Å–º —Å—Ç–∞—Ç—å—é [System engineering/15.4. ProxMox: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤.md](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/15.4.%20ProxMox%3A%20–ù–∞—Å—Ç—Ä–æ–π–∫–∞%20–ª–∏–º–∏—Ç–æ–≤%20—Ñ–∞–π–ª–æ–≤.md)

##  **–ó–∞—á–µ–º –º—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è HAProxy?**

### **–¶–µ–ª—å:**
HAProxy - —ç—Ç–æ **–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏**, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—ã—Å—è—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π. –ö–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ = 1 —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä (FD).

**–ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ:**
-  HAProxy –Ω–µ —Å–º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
-  –ü–æ—Ç–µ—Ä—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
-  –û—à–∏–±–∫–∏ "Too many open files"



##  **–ß—Ç–æ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º:**

### **1. –õ–∏–º–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ FD
cat /proc/1/limits | grep "Max open files"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `Max open files 65536 65536 files` 

### **2. –õ–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ HAProxy**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ HAProxy –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å–ª–µ–¥—É–µ—Ç –ª–∏–º–∏—Ç—ã
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `Max open files 65536 65536 files`

### **3. –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FD**
```bash
# –°–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HAProxy —Å–µ–π—á–∞—Å
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l
```



##  **–§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤:**
```bash
#!/bin/bash

echo "=== LXC Container Limits ==="
cat /proc/1/limits | grep "Max open files"

echo "=== HAProxy Process Limits ==="
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"

echo "=== Current HAProxy FD Usage ==="
ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ | wc -l

echo "=== HAProxy Status ==="
systemctl status haproxy --no-pager -l
```

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è HAProxy:**
```cfg
# –ù–∞–π—Ç–∏ —é–Ω–∏—Ç
systemctl show haproxy -p FragmentPath

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# FragmentPath=/usr/lib/systemd/system/haproxy.service

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é
mcedit /usr/lib/systemd/system/haproxy.service

# –ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
systemctl cat haproxy.service --no-pager

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è HAProxy –ø—Ä–æ—Ü–µ—Å—Å–∞
systemctl edit haproxy

# –î–æ–±–∞–≤–ª—è–µ–º:
[Service]
LimitNOFILE=65536

# –ü—Ä–∏–º–µ–Ω—è–µ–º
systemctl daemon-reload
systemctl restart haproxy
```


##  **–ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:**

### **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
-  **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:** 65536 FD
-  **HAProxy –ø—Ä–æ—Ü–µ—Å—Å:** 65536 FD  
-  **HAProxy –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å** ~60,000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
-  **–ì–æ—Ç–æ–≤ –∫ –≤—ã—Å–æ–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º** PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä–∞

### **–î–ª—è —á–µ–≥–æ —ç—Ç–æ –≤ PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä–µ:**
```
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí HAProxy (60K connections) ‚Üí PostgreSQL –Ω–æ–¥—ã
    ‚Üì
–ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É:
- 1 –º–∞—Å—Ç–µ—Ä (–∑–∞–ø–∏—Å—å) 
- N —Ä–µ–ø–ª–∏–∫ (—á—Ç–µ–Ω–∏–µ)
```

---------------------------------------

##  **–¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ HAProxy –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ PostgreSQL, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ (65536 FD).


##  **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**

### **1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ FD –≤ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Proxmox
mcedit /etc/pve/lxc/199.conf

# –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü:
lxc.prlimit.nofile: 65536          # –õ–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
lxc.cgroup.devices.max: 65536      # –î–ª—è cgroup v1 –≤ Proxmox
```

### **2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HAProxy –¥–ª—è PostgreSQL**
```bash
# –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ñ–∏–≥ HAProxy
mcedit /etc/haproxy/haproxy.cfg
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ñ–∏–≥–∞:**

–í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–ª—å–∫–æ LISTEN:
```cfg
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ HAProxy - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
listen postgres_stats
    bind *:7001                   # –°–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 7001 –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
    mode http                     # –†–µ–∂–∏–º HTTP –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    stats enable                  # –í–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats uri /                   # URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ—Ä–µ–Ω—å
    stats refresh 10s             # –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

# PostgreSQL TCP –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
listen postgresql
    bind *:5000                   # –°–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 5000 –¥–ª—è PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    mode tcp                      # TCP —Ä–µ–∂–∏–º (–Ω–µ HTTP!) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
    option tcplog                 # –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    balance roundrobin            # –ê–ª–≥–æ—Ä–∏—Ç–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ - –ø–æ –æ—á–µ—Ä–µ–¥–∏
    timeout client 50000          # –¢–∞–π–º–∞—É—Ç –∫–ª–∏–µ–Ω—Ç–∞ 50 —Å–µ–∫—É–Ω–¥
    timeout server 50000          # –¢–∞–π–º–∞—É—Ç —Å–µ—Ä–≤–µ—Ä–∞ 50 —Å–µ–∫—É–Ω–¥  
    timeout connect 5000          # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è 5 —Å–µ–∫—É–Ω–¥
    # –ë—ç–∫–µ–Ω–¥ —Å–µ—Ä–≤–µ—Ä PostgreSQL
    server postgres_local 127.0.0.1:5432 check port 5432 inter 5s rise 2 fall 3
    #        –∏–º—è_—Å–µ—Ä–≤–µ—Ä–∞  –∞–¥—Ä–µ—Å:–ø–æ—Ä—Ç        –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –Ω–∞ –ø–æ—Ä—Ç—É 5432
    #        inter 5s     - –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ 5 —Å–µ–∫—É–Ω–¥
    #        rise 2       - 2 —É—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞–ª –∞–∫—Ç–∏–≤–Ω—ã–º
    #        fall 3       - 3 –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á–∏—Ç—å

```

–í–∞—Ä–∏–∞–Ω—Ç 2: –¢–æ–ª—å–∫–æ FRONTEND+BACKEND:
```cfg
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ HAProxy
listen postgres_stats
    bind *:7001
    mode http
    stats enable
    stats uri /
    stats refresh 10s

# PostgreSQL –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ - –†–ê–ó–î–ï–õ–ï–ù–ù–ê–Ø
frontend pg_frontend
    bind *:5000
    mode tcp
    default_backend server_PostgreSQL

backend server_PostgreSQL
    mode tcp
    option tcplog
    balance roundrobin
    timeout client 50000
    timeout server 50000
    timeout connect 5000
    server postgres_local 127.0.0.1:5432 check port 5432 inter 5s rise 2 fall 3

```

### **3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ PostgreSQL**
```bash
# –°–æ–∑–¥–∞–µ–º .pgpass –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
echo "localhost:*:*:postgres:runtelorg" > ~/.pgpass
chmod 600 ~/.pgpass  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å
```



##  **–ó–∞–ø—É—Å–∫ HAProxy**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–∞
haproxy -c -f /etc/haproxy/haproxy.cfg

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ –æ—à–∏–±–∫–∏):
# [WARNING] config : log format ignored for proxy 'postgresql' since it has no log address.
```

### **2. –ó–∞–ø—É—Å–∫ HAProxy**
```bash
# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
pkill -9 haproxy
sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º HAProxy –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -D
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã HAProxy
ps aux | grep haproxy
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å: /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -D

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä—Ç—ã
ss -tlnp | grep haproxy
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# LISTEN 0 4096 0.0.0.0:5000  # PostgreSQL
# LISTEN 0 4096 0.0.0.0:7001  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```



##  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL**
```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
psql -h localhost -p 5432 -U postgres -c "SELECT version();"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HAProxy
psql -h localhost -p 5000 -U postgres -c "SELECT version();"
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ä—Å–∏—é PostgreSQL –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
```

### **2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
```bash
# –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
psql -h localhost -p 5000 -U postgres -c "CREATE DATABASE load_test;"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
psql -h localhost -p 5000 -U postgres -d load_test -c "SELECT current_database();"
```



##  **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FD –ª–∏–º–∏—Ç–æ–≤**

### **1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞**
```bash
# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
cd /var/lib/pgsql
mcedit pg_connection_test{1..3}.sh
```

<details>
<summary>‚ùó pg_connection_test1.sh ‚ùó</summary>

```bash
#!/bin/bash

echo "=== HAProxy PostgreSQL Load Test ==="
echo "Testing FD limits with multiple connections through HAProxy..."

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
CONNECTION_STRING="postgresql://postgres:runtelorg@localhost:5000/postgres"
TOTAL_CONNECTIONS=100
BATCH_SIZE=10

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ HAProxy
create_connection() {
    local conn_id=$1
    psql "$CONNECTION_STRING" -c "SELECT pg_sleep(0.5);" -t > /dev/null 2>&1 &
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
echo "Initial state:"
./pg_connection_test3.sh

echo ""
echo "Starting load test with $TOTAL_CONNECTIONS connections through HAProxy port 5000..."
echo ""

# –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∞—Ç—á–∞–º–∏
for ((i=1; i<=$TOTAL_CONNECTIONS; i++)); do
    create_connection $i
    
    # –ö–∞–∂–¥—ã–µ BATCH_SIZE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if [ $((i % BATCH_SIZE)) -eq 0 ]; then
        HAPROXY_PID=$(cat /run/haproxy.pid 2>/dev/null)
        if [ -n "$HAPROXY_PID" ]; then
            FD_COUNT=$(ls -la /proc/$HAPROXY_PID/fd/ 2>/dev/null | wc -l)
            echo "Created $i connections - HAProxy FD count: $FD_COUNT"
        fi
        sleep 0.1
    fi
done

echo ""
echo "Waiting for all connections to complete..."
wait

echo ""
echo "Final state:"
./pg_connection_test3.sh
```

</details> 

<details>
<summary>‚ùó pg_connection_test2.sh ‚ùó</summary>

```bash
#!/bin/bash

echo "=== Simple PostgreSQL Connection Test ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤
echo "Checking ports..."
ss -tln | grep -E "(5000|5001|5002|5003|5432)"

# –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "Testing direct PostgreSQL connection..."
psql -h localhost -p 5432 -U postgres -c "SELECT 'Direct connection OK' as status;" 2>/dev/null || echo "Direct connection FAILED"

# –¢–µ—Å—Ç —á–µ—Ä–µ–∑ HAProxy
echo "Testing HAProxy connection..."
psql -h localhost -p 5000 -U postgres -c "SELECT 'HAProxy connection OK' as status;" 2>/dev/null || echo "HAProxy connection FAILED"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º FD –¥–æ —Ç–µ—Å—Ç–∞ (systemd —é–Ω–∏—Ç)
INITIAL_FD=$(ls -la /proc/$(systemctl show haproxy -p MainPID --value)/fd/ 2>/dev/null | wc -l)
echo "Initial FD count: $INITIAL_FD"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º FD (–ø—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫)
INITIAL_FD=$(ls -la /proc/$(pgrep haproxy | head -1)/fd/ 2>/dev/null | wc -l)
```

</details> 


<details>
<summary>‚ùó pg_connection_test3.sh ‚ùó</summary>

```bash
#!/bin/bash

echo "=== PostgreSQL Connection Test ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
echo "Ports:"
ss -tln | grep -E "(5000|5432)"

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
echo "Testing connections..."
psql -h localhost -p 5432 -U postgres -c "SELECT 'Direct OK' as status;"
psql -h localhost -p 5000 -U postgres -c "SELECT 'HAProxy OK' as status;"

# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê FD
echo "=== FD Check ==="

# –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ systemd (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ systemd)
SYSTEMD_PID=$(systemctl show haproxy -p MainPID --value 2>/dev/null)
if [ "$SYSTEMD_PID" -ne 0 ] 2>/dev/null && [ -d "/proc/$SYSTEMD_PID" ]; then
    FD_COUNT=$(ls -la /proc/$SYSTEMD_PID/fd/ 2>/dev/null | wc -l)
    echo "Systemd mode: PID $SYSTEMD_PID, FD count: $FD_COUNT"

# –°–ø–æ—Å–æ–± 2: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ (—á–µ—Ä–µ–∑ PID —Ñ–∞–π–ª)
elif [ -f "/run/haproxy.pid" ]; then
    DIRECT_PID=$(cat /run/haproxy.pid 2>/dev/null)
    if [ -n "$DIRECT_PID" ] && [ -d "/proc/$DIRECT_PID" ]; then
        FD_COUNT=$(ls -la /proc/$DIRECT_PID/fd/ 2>/dev/null | wc -l)
        echo "Direct mode: PID $DIRECT_PID, FD count: $FD_COUNT"
    else
        echo "PID file exists but process not found"
    fi

# –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ pgrep (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)
else
    PGREP_PID=$(pgrep haproxy | head -1)
    if [ -n "$PGREP_PID" ]; then
        FD_COUNT=$(ls -la /proc/$PGREP_PID/fd/ 2>/dev/null | wc -l)
        echo "Pgrep mode: PID $PGREP_PID, FD count: $FD_COUNT"
    else
        echo "HAProxy not running"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã (–µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–π–¥–µ–Ω)
if [ -n "$SYSTEMD_PID" ] && [ "$SYSTEMD_PID" -ne 0 ]; then
    cat /proc/$SYSTEMD_PID/limits 2>/dev/null | grep "Max open files"
elif [ -n "$DIRECT_PID" ]; then
    cat /proc/$DIRECT_PID/limits 2>/dev/null | grep "Max open files"
elif [ -n "$PGREP_PID" ]; then
    cat /proc/$PGREP_PID/limits 2>/dev/null | grep "Max open files"
fi
```

</details> 


<br/>


## **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –∑–∞–ø—É—Å–∫–∞ HAProxy**
```
–ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫:   /usr/sbin/haproxy -f config.cfg -p pidfile -D
Systemd –∑–∞–ø—É—Å–∫:  /usr/sbin/haproxy -Ws -f config.cfg -S socket

–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è:
- -D = –¥–µ–º–æ–Ω (–ø—Ä—è–º–æ–π)
- -Ws = systemd mode  
- -S socket = systemd socket
```

HAProxy –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é:
- `/run/haproxy.pid` = **10969** - PID —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
- `systemctl show haproxy -p MainPID --value` = 0 - systemd –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ö–æ–º–∞–Ω–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç `-D` - —Ñ–ª–∞–≥ –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏ (–ø—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫)
- –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ systemctl status: failed

–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd:
- –ï—Å—Ç—å `-Ws` - systemd mode
- –ï—Å—Ç—å `-S socket` - systemd notification socket
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤ (`-f /etc/haproxy/conf.d`)


### **–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# 1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞
ps aux | grep haproxy

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å systemd —Å—Ç–∞—Ç—É—Å
systemctl status haproxy

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PID
systemctl show haproxy -p MainPID --value   # –µ—Å–ª–∏ 0, —Ç–æ systemd –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º
cat /run/haproxy.pid
```
<br/>



### **2. –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º**
```bash
chmod +x pg_connection_test.sh
chmod +x pg_connection_test2.sh
```



##  **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**

### **–ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ –í–¢–û–†–û–ú —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:**
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–º FD –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
watch -n 1 "echo '=== HAProxy FD Monitoring ==='; \
echo 'FD Count:'; ls -la /proc/\$(pgrep haproxy | head -1)/fd/ 2>/dev/null | wc -l; \
echo 'Memory:'; ps aux | grep haproxy | grep -v grep | awk '{print \$4,\$5,\$6}'; \
echo 'Connections:'; ss -tn | grep :5000 | wc -l"
```



##  **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ**

### **–í –ü–ï–†–í–û–ú —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç:**
```bash
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º
cd /var/lib/pgsql

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
./pg_connection_test.sh
```

### **–ß—Ç–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞:**

#### **–í –ø–µ—Ä–≤–æ–º —Ç–µ—Ä–º–∏–Ω–µ (—Ç–µ—Å—Ç):**
```
=== PostgreSQL Connection Stress Test ===
Testing HAProxy FD limits with PostgreSQL connections...
Initial FD count: 13
Started 10 connections. Current FD: 23
Started 20 connections. Current FD: 33
Started 30 connections. Current FD: 43
...
Started 100 connections. Current FD: 113
Waiting for all connections to complete...
=== Test Complete ===
Initial FD: 13
Final FD: 13
Peak connections: 100
```

#### **–í–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥):**
```
=== HAProxy FD Monitoring ===
FD Count: 67
Memory: 0.3 103404 10984
Connections: 45
```


##  **–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**

### **–£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
-  **FD count —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è** –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (—Å 13 –¥–æ 100+)
-  **FD count –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è** –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
-  **–ù–µ—Ç –æ—à–∏–±–æ–∫** "Too many open files"
-  **HAProxy –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º**
-  **–í—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ª–∏–º–∏—Ç—ã –æ—Å—Ç–∞–ª–∏—Å—å 65536
cat /proc/$(pgrep haproxy | head -1)/limits | grep "Max open files"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: Max open files 65536 65536 files

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É HAProxy
curl http://localhost:7001/
```


##  **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è**

### **–ü—Ä–æ–±–ª–µ–º–∞ 1: –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ .pgpass
ls -la ~/.pgpass  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å -rw-------
chmod 600 ~/.pgpass
```

### **–ü—Ä–æ–±–ª–µ–º–∞ 2: HAProxy –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ —É–±–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
haproxy -c -f /etc/haproxy/haproxy.cfg
pkill -9 haproxy
```

### **–ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è FD**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ HAProxy
ss -tn | grep :5000  # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```


