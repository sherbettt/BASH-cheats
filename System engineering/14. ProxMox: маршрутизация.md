Пример маршрутизации:
<br/> [17.2. iptables.md](https://github.com/sherbettt/BASH-cheats/blob/main/17.2.%20iptables.md)
<br/> [System engineering/03. Настройка NAT на роутере с Ubuntu.md](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/03.%20Настройка%20NAT%20на%20роутере%20с%20Ubuntu.md)

## Маршруты от pgnet до нод.

Для организации связи между машинами в разных подсетях (192.168.87.0/24 и 192.168.45.0/24) вам нужно настроить маршрутизацию и правила iptables.

### 1. Настройка маршрутизации на Proxmox (192.168.87.20):

Proxmox должен выступать в качестве шлюза для подсети 192.168.45.0/24.

```bash
# Добавить маршрут (временно)
ip route add 192.168.45.0/24 dev pgnet

# Для постоянного сохранения (Debian-based системы):
echo "192.168.45.0/24 dev pgnet" >> /etc/network/interfaces.d/pgnet
```
- **`ip route add`** – добавляет новый маршрут в таблицу маршрутизации.
- **`192.168.45.0/24`** – указывает целевую подсеть, для которой настраивается маршрут (все IP-адреса от `192.168.45.1` до `192.168.45.254`).
- **`dev pgnet`** – указывает, что трафик для этой подсети должен направляться через интерфейс `pgnet` (это имя сетевого интерфейса в Proxmox).

- **Интерфейс `pgnet`** – это пользовательское имя, которое должно быть заранее создано в Proxmox (например, через `/etc/network/interfaces`). Оно может быть bridge, VLAN или другим типом интерфейса.
- **Постоянность** – такая команда добавляет маршрут временно (до перезагрузки). Для постоянного добавления нужно прописать маршрут в конфигурации сети (например, в файле `/etc/network/interfaces` или через `/etc/rc.local`).


### 2. Настройка iptables на Proxmox для NAT (если нужно):

Если вам нужен доступ из 192.168.87.0/24 в 192.168.45.0/24, включите форвардинг и настройте NAT:

```bash
# Включить IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# Добавить правила iptables
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o vmbr0 -j MASQUERADE
iptables -A FORWARD -i pgnet -o vmbr0 -j ACCEPT
iptables -A FORWARD -i vmbr0 -o pgnet -m state --state RELATED,ESTABLISHED -j ACCEPT

# Сохранить правила (для Debian-based)
apt install iptables-persistent
netfilter-persistent save
```


### 4. Настройка виртуальной машины (192.168.45.201):

Убедитесь, что у VM правильный шлюз:
```bash
ip route show
# Должно быть что-то вроде:
# default via 192.168.45.1 dev eth0
# 192.168.45.0/24 dev eth0 proto kernel scope link src 192.168.45.201
```

### 4. Проверка связи:

С ноутбука попробуйте:
```bash
ping 192.168.45.201
```
---------------------

### 1. Проверка текущих маршрутов на ноуте
```bash
ip route show
```
Вывод корректный:
```
default via 192.168.87.1 dev wlp1s0 proto dhcp src 192.168.87.135 metric 600 
192.168.87.0/24 dev wlp1s0 proto kernel scope link src 192.168.87.135 metric 600 
192.168.45.0/24 via 192.168.87.20 dev wlp1s0
```

### 2. Настройка постоянного маршрута ноуте (Ximper Linux)

#### Вариант A: Через NetworkManager (если используется)
```bash
# Узнаём имя подключения:
nmcli connection show

# Добавляем маршрут (пример для подключения 'Wired connection 1'):
sudo nmcli connection modify "Wired connection 1" ipv4.routes "192.168.45.0/24 192.168.87.20"

# Применяем изменения:
sudo nmcli connection down "Wired connection 1" && sudo nmcli connection up "Wired connection 1"
```

#### Вариант B: Через конфигурационные файлы (если NetworkManager не используется)
Создаём файл маршрутов:
```bash
sudo nano /etc/sysconfig/network-scripts/route-wlp1s0
```
Добавляем строку:
```
192.168.45.0/24 via 192.168.87.20 dev wlp1s0
```

Или альтернативно (для systemd-networkd):
```bash
sudo mkdir -p /etc/systemd/network
sudo nano /etc/systemd/network/50-wireless.network
```
Добавьте в секцию `[Route]`:
```
[Route]
Destination=192.168.45.0/24
Gateway=192.168.87.20
```

### 3. Проверка связи
```bash
ping 192.168.45.201 -c 4
traceroute 192.168.45.201
```

### 4. Если ping не работает - диагностика:

На Proxmox проверьте:
```bash
# Проверка форвардинга:
sudo sysctl net.ipv4.ip_forward

# Временное включение если выключен:
sudo sysctl -w net.ipv4.ip_forward=1

# Проверка iptables:
sudo iptables -L -n -v
sudo iptables -t nat -L -n -v

# Добавление правил если нужно:
sudo iptables -A FORWARD -i pgnet -o vmbr0 -j ACCEPT
sudo iptables -A FORWARD -i vmbr0 -o pgnet -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -t nat -A POSTROUTING -o vmbr0 -j MASQUERADE
```

### 5. Для полной очистки и перезагрузки сети:
```bash
sudo systemctl restart NetworkManager  # или network.service
sudo ip route flush cache
```

Для Ximper Linux также можно проверить наличие специфичных сетевых утилит:
```bash
cat /etc/ximper-release  # или аналогичный файл для определения точной версии
```
---------------------

## Маршруты от нод в интернет через pgnet.


1. **Шлюз `192.168.45.1` не отвечает за NAT.**  
   - Вы добавили IP `192.168.45.1/24` на `pgnet`, но **не проверили, работает ли маршрутизация**.  
   - NAT (`MASQUERADE`) настроен, но **трафик не проходит** между `pgnet` и `vmbr0`.  

2. **Проблема с интерфейсами Proxmox:**  
   - `pgnet` — это **L2-сеть (VXLAN)**, а не обычный L3-интерфейс.  
   - NAT работает только если трафик действительно проходит через `vmbr0`.  

3. **Возможные причины:**  
   - **Нет маршрута** от `pgnet` к `vmbr0`.  
   - **Firewall блокирует** трафик.  
   - **Неверная привязка интерфейсов** в Proxmox.  



### **Чтобы исправить, надо:**  

### **1. Проверить маршрутизацию на Proxmox**  
Выполните:  
```bash
ip route show
```  
Убедитесь, что есть маршрут для `192.168.45.0/24` через `pgnet`.  

Если его нет, добавьте:  
```bash
ip route add 192.168.45.0/24 dev pgnet
```



### **2. Проверить, что `pgnet` связан с `vmbr0`**  
Ваш `pgnet` — это **VXLAN-сеть**, которая должна быть связана с `vmbr0`. Проверьте:  
```bash
bridge link show
```  
Если `pgnet` не связан с `vmbr0`, нужно настроить мост.  



### **3. Проверить FORWARD и NAT-правила**  
Вы добавили правила, но они могут конфликтовать с другими. Проверьте:  
```bash
iptables -t nat -L -n -v
iptables -L FORWARD -n -v
```  
Убедитесь, что:  
- Для `pgnet → vmbr0` есть `ACCEPT` в `FORWARD`.  
- В `nat` есть `MASQUERADE` для `192.168.45.0/24`.  

Если правил нет, добавьте их снова:  
```bash
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o vmbr0 -j MASQUERADE
iptables -A FORWARD -i pgnet -o vmbr0 -j ACCEPT
iptables -A FORWARD -i vmbr0 -o pgnet -m state --state RELATED,ESTABLISHED -j ACCEPT
```



### **4. Проверить доступность шлюза (`192.168.45.1`) с `pg3`**  
На `pg3` выполните:  
```bash
ping 192.168.45.1
```  
Если **не пингуется**, значит:  
- Либо `192.168.45.1` не назначен на `pgnet`.  
- Либо `pgnet` не связан с `pg3`.  

Попробуйте добавить IP на `pgnet` явно:  
```bash
ip addr add 192.168.45.1/24 dev pgnet
```  
И проверьте связь снова.  



### **5. Проверить DNS (если ping 8.8.8.8 не работает, но ping 192.168.87.20 работает)**  
Если `ping 8.8.8.8` не работает, но `ping 192.168.87.20` (Proxmox) работает, значит:  
- **NAT настроен, но DNS не работает.**  
- Попробуйте:  
  ```bash
  curl -v http://google.com
  ```  
  Если выдаёт ошибку DNS, настройте `/etc/resolv.conf` на `pg3`:  
  ```bash
  echo "nameserver 8.8.8.8" > /etc/resolv.conf
  ```  





