```bash
## /etc/default/etcd 
ETCD_NAME="pg3"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_CLIENT_URLS="http://192.168.45.204:2379,http://127.0.0.1:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.45.204:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.45.204:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER="pg1=http://192.168.45.201:2380,pg2=http://192.168.45.202:2380,pg3=http://192.168.45.204:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"
```

Это конфигурационный файл для etcd — распределённого key-value хранилища, часто используемого в кластерах для хранения конфигураций и обеспечения распределённого доступа к данным.  


### 1. **`ETCD_NAME="pg3"`**  
   - Задаёт имя текущего узла etcd в кластере. Здесь узел называется `pg3`.  

### 2. **`ETCD_DATA_DIR="/var/lib/etcd"`**  
   - Указывает директорию, где etcd хранит свои данные (состояние кластера, ключи и т. д.).  

### 3. **`ETCD_LISTEN_CLIENT_URLS="http://192.168.45.204:2379,http://127.0.0.1:2379"`**  
   - Адреса и порты, на которых etcd принимает клиентские подключения (например, от Patroni или других сервисов).  
   - Здесь etcd слушает на локальном IP (`127.0.0.1`) и на конкретном сетевом интерфейсе (`192.168.45.204`) по порту `2379` (стандартный порт для клиентских соединений).  

### 4. **`ETCD_ADVERTISE_CLIENT_URLS="http://192.168.45.204:2379"`**  
   - Адрес, который etcd сообщает клиентам для подключения. Обычно это внешний (доступный из сети) IP или DNS-имя.  

### 5. **`ETCD_LISTEN_PEER_URLS="http://192.168.45.204:2380"`**  
   - Адрес и порт, на котором etcd принимает соединения от других узлов кластера (для репликации данных).  
   - Стандартный порт для peer-соединений — `2380`.  

### 6. **`ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.45.204:2380"`**  
   - Адрес, который текущий узел сообщает другим участникам кластера для peer-коммуникации.  

### 7. **`ETCD_INITIAL_CLUSTER="pg1=http://192.168.45.201:2380,pg2=http://192.168.45.202:2380,pg3=http://192.168.45.204:2380"`**  
   - Список всех узлов в кластере в формате `имя=URL`.  
   - Здесь кластер состоит из трёх узлов: `pg1`, `pg2` и текущего (`pg3`).  

### 8. **`ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"`**  
   - Уникальный идентификатор кластера, чтобы узлы могли обнаружить друг друга.  
   - Должен быть одинаковым на всех узлах.  

### 9. **`ETCD_INITIAL_CLUSTER_STATE="new"`****  
   - Указывает, что это новый кластер.  
   - Если кластер уже существует (например, при перезапуске), нужно использовать `existing`.  

-----------------
Параметр **`ETCD_INITIAL_CLUSTER_STATE`** определяет, как etcd должен инициализироваться при запуске. После перезагрузки сервера возможны два варианта:  

### **1. `ETCD_INITIAL_CLUSTER_STATE="existing"`**  
   - **Используется**, когда кластер уже был создан ранее, и текущий узел является его частью.  
   - **Когда применять?**  
     - После первой инициализации кластера (`new`).  
     - При перезапуске etcd (например, после перезагрузки сервера).  
     - При добавлении нового узла в уже работающий кластер.  
   - **Что делает etcd?**  
     - Подключается к существующему кластеру, используя данные из `ETCD_INITIAL_CLUSTER`.  
     - Восстанавливает состояние из данных на диске (`ETCD_DATA_DIR`).  

### **2. `ETCD_INITIAL_CLUSTER_STATE="new"`**  
   - **Используется только при первом запуске кластера.**  
   - **Когда применять?**  
     - Только при самом первом развёртывании кластера.  
     - Если все узлы новые, и данных в `ETCD_DATA_DIR` нет.  
   - **Что делает etcd?**  
     - Создаёт новый кластер с нуля.  
     - Если данные уже есть (например, после перезагрузки), но стоит `new`, etcd может отказаться запускаться (ошибка `"member has been permanently removed from the cluster"`).  


### **Что будет, если после перезагрузки оставить `new`?**  
- Если кластер уже существует, но в конфиге стоит `new`, etcd попытается создать новый кластер с тем же именем.  
- Это может привести к ошибкам, например:  
  ```
  etcdserver: member has been permanently removed from the cluster
  ```  
- **Решение:** После первого запуска всегда менять на `existing`.  

### **Вывод**  
После перезагрузки сервера **всегда** используйте:  
```ini
ETCD_INITIAL_CLUSTER_STATE="existing"
```  
(если только вы не разворачиваете кластер заново с чистого листа).  

Если оставить `new`, etcd может не запуститься или создать конфликт в кластере.

Основаня статья [System engineering/15. ProxMox: установка etcd, Patroni](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/15.%20ProxMox:%20установка%20etcd,%20Patroni.md)

-------------------
Параметр **`ETCD_INITIAL_CLUSTER_TOKEN`** — это уникальный идентификатор кластера etcd, который помогает узлам безопасно обнаруживать друг друга при старте.  

### **Где его взять?**  
1. **При первом создании кластера**  
   - Вы **придумываете его сами** (например, `etcd-cluster-1`, `my-postgres-cluster`).  
   - Главное, чтобы он:  
     - Был **уникальным** (не совпадал с другими кластерами в той же сети).  
     - **Одинаковым на всех узлах** кластера.  

2. **При добавлении нового узла в существующий кластер**  
   - Нужно **использовать тот же токен**, что и у других узлов.  
   - Его можно посмотреть:  
     - В конфигурации etcd на любом из работающих узлов (`/etc/etcd/etcd.conf`).  
     - Через API etcd (если кластер жив):  
       ```bash
       etcdctl member list
       ```  
       (токен будет в метаданных кластера).  


### **Пример генерации (если нужен случайный токен)**  
Можно сгенерировать случайную строку:  
```bash
openssl rand -hex 8
# Пример вывода: 5a3f1d8c9e2b7a6d
```
И использовать её:  
```ini
ETCD_INITIAL_CLUSTER_TOKEN="5a3f1d8c9e2b7a6d"
```


### **Важно!**  
- Токен **должен совпадать на всех узлах** кластера.  
- Если токен неверный, узлы не смогут соединиться, и кластер не запустится.  
- После первого запуска кластера **менять токен нельзя** (нужно пересоздавать кластер).  



### **Где хранится токен?**  
- В конфигурационном файле etcd (например, `/etc/etcd/etcd.conf`).  
- В данных etcd (в `ETCD_DATA_DIR`), но редактировать их вручную **нельзя**.  

Если токен утерян, но кластер работает — его можно найти в конфигурации любого узла.

-------------------------------------


