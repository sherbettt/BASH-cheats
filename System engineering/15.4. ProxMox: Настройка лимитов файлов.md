#  Настройка лимитов файлов для unprivileged контейнеров в Proxmox

## **Важно: Unprivileged контейнеры**
У нас **unprivileged контейнеры** - это требует специальных настроек!

## **Проверка текущих лимитов файлов внутри контейнера**
```bash
# Проверка текущих лимитов
ulimit -H -n    # Hard limit
ulimit -S -n    # Soft limit
cat /proc/1/limits | grep "Max open files"

# Пример вывода:
# Max open files            524288               524288               files
```

## **Настройка лимитов через LXC конфиг**

### **Редактирование конфигурации:**
```bash
# Редактируем конфиг контейнера
mcedit /etc/pve/lxc/199.conf
```

### **Добавить в конец файла:**
```bash
# Основной лимит файловых дескрипторов
lxc.prlimit.nofile: 65536
```

### **Внимание: Выбор правильного cgroup**
**Для Proxmox (cgroup v1) используйте:**
```bash
# Дополнительные настройки для unprivileged контейнеров (cgroup v1)
lxc.cgroup.devices.max: 65536
```

**Для систем с cgroup v2 (если поддерживается):**
```bash
# Дополнительные настройки для unprivileged контейнеров (cgroup v2)
lxc.cgroup2.files.max: 65536
lxc.cgroup2.files.soft: 32768
```

## **Итоговые правильные конфиги**

### **Для контейнера 198 (Ubuntu):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ub25
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:C1:17:70,ip=192.168.87.101/24,type=veth
ostype: ubuntu
rootfs: ssd_1tb:198/vm-198-disk-0.raw,size=34G
swap: 256
unprivileged: 1

# Лимиты файловых дескрипторов
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536 
```

### **Для контейнера 199 (ALT Linux):**
```bash
arch: amd64
cores: 2
features: nesting=1
hostname: file-ALT11
memory: 4096
net0: name=eth0,bridge=vmbr0,firewall=1,gw=192.168.87.1,hwaddr=BC:24:11:48:36:3A,ip=192.168.87.100/24,type=veth
ostype: fedora
rootfs: ssd_1tb:199/vm-199-disk-0.raw,size=36G
swap: 256
unprivileged: 1

# Лимиты файловых дескрипторов
lxc.prlimit.nofile: 65536
lxc.cgroup.devices.max: 65536
```

## **Альтернативный способ через features**
```bash
## в /etc/pve/lxc/***.conf
# Вместо отдельных prlimit, можно использовать ТОЛЬКО для cgroup v1:
features: nesting=1,fuse=1,keyctl=1,mount=nfs

# Для cgroup v1 используем:
lxc.cgroup.devices.max: 65536

# НЕ ИСПОЛЬЗОВАТЬ cgroup2 настройки в Proxmox с cgroup v1!
# lxc.cgroup2.files.max: 131072  ← ЭТО НЕ БУДЕТ РАБОТАТЬ!
```

## **Применение изменений**
```bash
# Перезапускаем контейнеры
pct reboot 198
pct reboot 199

# Или через web-интерфейс
```

## **Проверка внутри контейнеров**
После перезагрузки, внутри каждого контейнера:
```bash
# Проверить лимиты для init процесса
cat /proc/1/limits | grep "Max open files"

# Дополнительные проверки для unprivileged
cat /sys/fs/cgroup/$(cat /proc/self/cgroup | grep "0::" | cut -d: -f3)/pids.max
```

## **Если не работает (особенности unprivileged)**
Для unprivileged контейнеров иногда требуется дополнительная настройка внутри контейнера:

### **Способ 1: Через systemd в контейнере**
```bash
# Внутри контейнера редактируем службу HAProxy
systemctl edit haproxy

# Добавляем:
[Service]
LimitNOFILE=65536

# Применяем
systemctl daemon-reload
systemctl restart haproxy
```

### **Способ 1.1: Непосредственное редактирование systemd в контейнере**
```bash
# Найти юнит
systemctl show haproxy -p FragmentPath

# Пример вывода:
# FragmentPath=/usr/lib/systemd/system/haproxy.service

# Редактировать напрямую
mcedit /usr/lib/systemd/system/haproxy.service

# Или посмотреть текущую конфигурацию
systemctl cat haproxy.service --no-pager
```

### **Способ 2: Настройка через pam_limits**
```bash
# В контейнере редактируем
mcedit /etc/security/limits.conf

# Добавляем:
* soft nofile 32768
* hard nofile 65536
_haproxy soft nofile 65536
_haproxy hard nofile 65536
```

## **Проверка работы HAProxy**
После настройки в контейнере:
```bash
# Запускаем HAProxy
systemctl start haproxy

# Проверяем лимиты для процесса HAProxy
cat /proc/$(pidof haproxy)/limits | grep "Max open files"
ccat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"


# Тестируем подключения
hatop -s /var/lib/haproxy/stats
```

## **Важные замечания**
- **Proxmox обычно использует cgroup v1** - используйте `lxc.cgroup.devices.max`
- **cgroup v2 настройки (`lxc.cgroup2.*`) могут не работать** в старых версиях Proxmox
- **Unprivileged контейнеры требуют комбинации настроек LXC и внутренней настройки системы!**
- **Всегда проверяйте лимиты через `/proc/1/limits`**, а не только `ulimit -n`

-----------------------------------


##  **Анализ результатов:**

### **Текущее состояние лимитов HAProxy:**
```bash
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
Max open files            8056                 65536                files
```

- **Soft limit: 8056** - текущий лимит для HAProxy процесса
- **Hard limit: 65536** - максимально возможный лимит (наш LXC лимит работает!)



##  **Решение: Увеличить soft limit для HAProxy**

### **Способ 1: Через systemd (рекомендуется)**
```bash
# Редактируем службу HAProxy
systemctl edit haproxy

# Добавляем:
[Service]
LimitNOFILE=65536

# Применяем
systemctl daemon-reload
systemctl restart haproxy
```

### **Способ 2: Через systemd напрямую**
```bash
# Создаем директорию для override конфига
mkdir -p /etc/systemd/system/haproxy.service.d/

# Создаем конфиг
mcedit /etc/systemd/system/haproxy.service.d/override.conf
```

**Содержимое:**
```ini
[Service]
LimitNOFILE=65536
```

### **Способ 3: Через pam_limits**
```bash
# Добавляем в limits.conf
mcedit /etc/security/limits.conf

# Добавить строки:
* soft nofile 65536
* hard nofile 65536
_haproxy soft nofile 65536  
_haproxy hard nofile 65536
```



##  **Применяем изменения:**

```bash
# Перезапускаем HAProxy
systemctl daemon-reload
systemctl restart haproxy

# Проверяем результат
cat /proc/$(systemctl show haproxy -p MainPID --value)/limits | grep "Max open files"
```

**Ожидаемый результат:**
```bash
Max open files            65536                65536                files
```



##  **Что происходит:**

1.  **LXC лимиты работают** - hard limit = 65536
2.  **Systemd ограничивает** HAProxy до 8056 (soft limit)
3.  **Нужно поднять soft limit** через systemd конфиг


##  **Итог:**
**LXC настройки успешны!** Осталось только поднять systemd лимиты для HAProxy процесса. После этого HAProxy сможет использовать все 65536 файловых дескрипторов! 
