**Читай статью с оф. сайта: [Set up a Jira Data Center cluster](https://confluence.atlassian.com/adminjiraserver/set-up-a-jira-data-center-cluster-993929600.html)**

## 1. Клонирование LXC с Jira

**Через GUI.**
Как всегда заходим в [ProxMox](https://192.168.87.6:8006/#v1:0:=lxc%2F169:4::=contentIso:::8:11:), 
ищем контейнер ***Container 169 (jira-new) on node 'prox4'***, в браузере по F12 определяем  IP адрес Jira (192.168.87.219:443), проверяем с помощью nmap. 
Создаём снепшот и после - клонируем машину, присваивая ей новое имя.

<details>
<summary>❗ Через pvesh, Через pct ❗</summary>
  
**Через pvesh.**
  <br/> Проверяем на всякий случай:
```bash
# зайти
ssh root@192.168.87.17  # prox4
# утилита и команды
pvesh get /nodes/prox4/lxc/169/config
pvesh get /nodes/prox4/lxc/169/interfaces  # 192.168.87.219/24
pvesh get /nodes/prox4/storage  # проверить все места хранения
```

Создаём снепшот:
```bash
# Создаём там же, где и контейнер, на ssd_1tb
# pvesh
pvesh create /nodes/prox4/lxc/169/snapshot \
    --snapname "before-update" \
    --description "Снэпшот перед обновлением Jira"

# pct
pct snapshot 169 "backup-2024" --description "Резервная копия на 2024 год" --vmstate --live
```

Клонируем:
```bash
pvesh create /nodes/prox4/lxc/169/clone \
    --newid 181 \
    --storage ssd_1tb \
    --hostname jira-cluster
```

**Через pct.**
  <br/> Если `pvesh` не работает, можно использовать `pct` (Proxmox Container Toolkit):
```bash
pct clone 169 181 \
    --storage ssd_1tb \
    --hostname jira-cluster
```
</details>


В результате получаем ***Container 181 (jira-cluster) on node 'prox4'*** c IP = 192.168.87.140/24 (желательно выдать static IP). 
<br/> Т.к. сеть 192.168.87.0/24 предназначена в рамках RunTel для выхода в и-нет, то созданного контейнера важно поменять интерфейс **`eth0`** на **`192.168.46.0/24`** сеть, выбрав свободный IP. Проверяй нашу машину **[102 (dmzgateway)](https://192.168.87.6:8006/#v1:0:=lxc%2F102:4::::::11:2)** на шлюзы.
<br/>
<br/>


## 2. Сопряжение с S3
**ВАЖНО! все машины используют ядро ProxMox - "6.8.12-9-pve", из-за чего работа `nfs-kernel-server` будет поломана**
Проверка конфигурации контейнеров в pvesh
```
ccat /etc/pve/lxc/181.conf ; ccat /etc/pve/lxc/169.conf
```

Вводные данные:
- **/opt/atlassian/jira/shared** (если используется кластер)
- **/var/atlassian/application-data/jira** (обычно здесь лежат данные)
- **/opt/atlassian/jira/conf/dbconfig.xml**  (конф. файлик для Jira БД PSQL)

### 1. Создать файл `/opt/atlassian/jira/conf/cluster.properties` на машине jira-cluster (192.168.*.*)
```ini
# jira-cluster
jira.node.id=node1
jira.shared.home=/var/atlassian/application-data/jira
#jira.shared.home=/opt/atlassian/jira/shared
jira.lb.enabled=true
jira.lb.https=false
jira.lb.hostname=192.168.87.140  # или DNS имя
jira.lb.port=8080
```

### 2. Создать/проверить файл `/var/atlassian/application-data/jira/filestore-config.xml` на jira-* маншинах
```ini
<?xml version="1.1" ?>
<filestore-config>
  <filestores>
    <s3-filestore id="attachmentBucket">
      <config> 
        <bucket-name>jira-attachments</bucket-name> 
        <region>ru-runtel1</region>
        <endpoint-override>http://192.168.87.242:9000</endpoint-override>
#       <endpoint-override>https://s3.runtel.org</endpoint-override>
#       <endpoint-override>https://s3-2.runtel.org</endpoint-override>
      </config>
    </s3-filestore>
  </filestores>
  <associations>
    <association target="attachments" file-store="attachmentBucket" />
  </associations>
</filestore-config>
```

### 3. Создать файл `/var/atlassian/application-data/jira/hazelcast.properties` на машинах jira-cluster и jira-new
```ini
hazelcast.network.tcpip.members=192.168.87.140,192.168.87.219
hazelcast.group.name=jira-cluster
hazelcast.group.password=securepassword
hazelcast.interface=192.168.87.140 # на первой ноде
# hazelcast.interface=192.168.87.219 # на второй ноде
```





<br/>
<br/>

## 3. Проверка БД PostgreSQL на всех машинах




