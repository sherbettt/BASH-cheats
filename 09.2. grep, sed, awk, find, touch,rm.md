# Регулярные выражения и утилиты обработки текста

## Регулярные выражения
- `.` - любой один символ, кроме символа новой строки
- `.*` - любое количество любых символов
- `^` - начало строки (`^cat`)
- `$` - конец строки (`cat$`)
- `c[qwerty]t` - поиск по набору символов
- `c\*t` - предыдущий символ встречается ноль или более раз
- `c.*t` - любое количество символов между 'c' и 't'

## grep - поиск по шаблону
**Синтаксис:** `grep [опции] "шаблон" файл`

### Основные опции:
- `-i` - игнорировать регистр
- `-r`, `-R` - рекурсивный поиск
- `-n` - показывать номера строк
- `-v` - инвертировать поиск
- `-c` - подсчет совпадений
- `-A N` - показать N строк после совпадения
- `-B N` - показать N строк до совпадения
- `-C N` - показать N строк вокруг совпадения
- `--color=always` - подсветка результатов

### Примеры:
```bash
# Рекурсивный поиск в директории
grep -rnw /etc/ -e "PermitRoot"

# Исключение строк с комментариями и пустых строк
grep -v "^#" /etc/ssh/sshd_config | grep -v "^$"

# Поиск с контекстом
grep -i -A2 -B2 "runtel" /etc/ansible/hosts

# Поиск точной строки (без regex)
grep --fixed-strings "exact_string" file.txt
```

## sed - потоковый редактор
**Синтаксис:** `sed [опции] 'команды' файл`

### Основные команды:
- `s/шаблон/замена/флаги` - замена
- `d` - удаление строк
- `p` - печать
- `i\текст` - вставка перед строкой
- `a\текст` - вставка после строки

### Примеры:
```bash
# Вставка в начало файла
sed --in-place '1i\новая стрка\' file.txt

# Удаление строк
sed --in-place '1d' file.txt          # первая строка
sed '5d' filename.txt                 # пятая строка
sed '12,$d' filename.txt              # с 12-й до конца

# Замена текста
echo 'It is daytime' | sed 's/day/night/g'
sed --in-place 's/apple/mango/g' path/to/file

# Расширенные замены с regex
<command> | sed --regexp-extended 's/(apple)/\U\1/g'

# Извлечение блока текста
sed -n '/\[runtel_hosts\]/,/^$/p' /etc/ansible/hosts
```

## awk - обработка данных
**Синтаксис:** `awk 'условие {действие}' файл`

### Встроенные переменные:
- `NR` - номер текущей строки
- `NF` - количество полей в строке
- `$0` - вся строка
- `$1, $2...` - отдельные поля

### Примеры:
```bash
# Фильтрация строк
awk 'NF > 0' file.txt                    # удалить пустые строки
awk '!seen[$0]++' file.txt              # удалить дубликаты
awk 'NR%3==1' path/to/file              # каждая третья строка
awk '($10 == "value")'                  # по значению столбца

# Арифметические операции
printf '1\n2\n3\n' | awk '{sum += $1} END {print sum}'
printf '1:2:3' | awk -F ":" '{print $1+$2+$3}'

# Работа со столбцами
awk '{print $5}' path/to/file           # пятый столбец
awk '/foo/ {print $2}' path/to/file     # второй столбец при наличии "foo"

# Условные операции
awk '{
  if ($1 == "foo") print "Exact match foo"
  else if ($1 ~ "bar") print "Partial match bar" 
  else print "Baz"
}' path/to/file
```

## find - поиск файлов
**Синтаксис:** `find путь критерии действие`

### Критерии поиска:
- `-name "шаблон"` - по имени (обязательно в кавычках!)
- `-type f/d` - файлы/директории
- `-size +N` - размер больше N
- `-mtime +N` - модифицировано более N дней назад
- `-user имя` - по владельцу
- `-perm режим` - по правам доступа

### Примеры:
```bash
# Поиск по различным критериям
find . -type f -mtime +7 -ls
find . -type f -size +20000k -exec ls -lh {} \;
find /usr/bin/ -user root -perm /2000 2>/dev/null

# Hard links
find . -samefile /path/to/file
find . -xdev -samefile file1 -print0 | xargs -I {} -0 rm -v {}

# Анализ дискового пространства
find / -type f -size +100M -exec du -sh {} ';' 2>/dev/null | sort -rh
du -h --max-depth=1 / 2>/dev/null | sort -hr | head -10

# Файлы больше 500МБ с детальной информацией
find / -type f -size +500M -exec ls -lh {} + 2>/dev/null | awk '{print $5, $9}' | sort -hr
```

## Управление файлами

### touch - управление временными метками
```bash
# Изменение времени
touch -d "12am" file
touch -d "yesterday 6am" file
touch -d "2 days ago 10:00" file
touch -r reference-file target-file

# Создание файлов с особыми именами
touch "file_$(date +%F)"
touch ./-file.doc
touch -- -file.doc
touch \"\\\?\$\*\'KwaMe\'\*\$\?\\\"
```

### Удаление файлов по шаблону
```bash
# Безопасное удаление с предпросмотром
ls -d 2025-0[1-4]-* && rm -rf 2025-0[1-4]-*

# Точное удаление по датам
rm -rf 2025-01-0[6-9] 2025-01-[1-3][0-9] 2025-0[2-4]-*

# Использование find для сложных условий
find . -maxdepth 1 -type d -name "2025-*" -exec rm -rf {} \;
```

## Подсчет и анализ

### Количество строк:
```bash
wc -l file.txt
grep -c $ file.txt
sed -n '$=' file.txt
awk 'END{print NR}' file.txt

# С фильтрацией
grep -c 'текст' file.txt
sed -r '/^.{,3}$/d' file.txt | wc -l          # строки длиннее 3 символов
awk 'length > 3' file.txt | wc -l
awk '$2+0 > 50' file.txt | wc -l             # числовые значения во 2-м столбце > 50
```

### Поиск пустых файлов и директорий:
```bash
find . -type f -empty
find . -type f -empty -exec rm {} \;
find . -type d -empty
find . -type d -empty -exec rmdir {} \;
```

## Важные нюансы

1. **Экранирование спецсимволов** в find:
   ```bash
   find /etc/ -name "*passwd*"    # правильно
   find /etc/ -name \*passwd\*    # правильно
   find /etc/ -name *passwd*      # может работать некорректно
   ```

2. **Обработка ошибок**:
   ```bash
   command 2>/dev/null           # скрыть stderr
   find /path 2>/dev/null        # скрыть ошибки доступа
   ```

3. **Безопасное удаление** - всегда проверяйте что удаляете:
   ```bash
   ls -d шаблон*                 # посмотреть что попадает под шаблон
   find . -name "шаблон" -print  # проверить перед удалением
   ```

------------------

# Анализ дискового пространства: расширенные команды

## Комбинации find + du

```bash
# Топ-20 самых больших файлов
find / -type f -size +100M -exec du -sh {} + 2>/dev/null | sort -hr | head -20

# Файлы больше 500МБ с детальной информацией
find / -type f -size +500M -exec ls -lh {} + 2>/dev/null | awk '{print $5, $9}' | sort -hr

# Анализ по типам файлов
find /home -type f -name "*.log" -exec du -ch {} + 2>/dev/null | tail -1
find /var -type f -name "*.sql" -exec du -sh {} + 2>/dev/null | sort -hr

# Файлы измененные за последние 7 дней
find / -type f -mtime -7 -exec du -sh {} + 2>/dev/null | sort -hr
```

## Комбинации find + df

```bash
# Анализ использования inodes по файловым системам
find / -xdev -type f 2>/dev/null | cut -d "/" -f 2 | sort | uniq -c | sort -rn

# Поиск больших файлов с указанием файловой системы
find / -type f -size +1G -exec df -h {} \; 2>/dev/null | awk '!seen[$1]++'

# Мониторинг заполнения inodes
df -i | awk '{if(NR>1) print $5 " " $1}' | sort -hr | head -10
```

## Расширенные команды du

```bash
# Детальный анализ вложенных директорий
du -h --max-depth=2 / 2>/dev/null | sort -hr | head -20

# Только суммарный размер без деталей
du -sh /home/* /var/* /opt/* 2>/dev/null | sort -hr

# Анализ с фильтрацией по времени
find /var/log -type f -mtime +30 -exec du -ch {} + 2>/dev/null | tail -1

# Размер кэша пакетов
du -sh /var/cache/apt/archives /var/cache/dnf 2>/dev/null
```

## Комбинации df + awk для мониторинга

```bash
# Файловые системы с использованием >80%
df -h | awk '$5+0 > 80 {print "ВНИМАНИЕ: " $6 " - " $5 " заполнено"}'

# Сортировка по использованию
df -h | awk 'NR>1 {print $5 " " $6}' | sort -hr

# Анализ только смонтированных FS
df -h -x tmpfs -x devtmpfs | sort -hr -k5

# Inodes с использованием >90%
df -i | awk '$5+0 > 90 {print "INODES: " $6 " - " $5 " использовано"}'
```

## Специализированные сценарии

```bash
# Поиск логов занимающих много места
find /var/log -type f -name "*.log" -size +100M -exec ls -lh {} \; 2>/dev/null

# Анализ Docker контейнеров
docker system df
du -sh /var/lib/docker/containers/* /var/lib/docker/volumes/* 2>/dev/null

# Поиск временных файлов
find /tmp /var/tmp -type f -mtime +7 -exec du -sh {} + 2>/dev/null | sort -hr

# Анализ пользовательских домашних директорий
for user in /home/*; do
    echo -n "$user: "
    du -sh "$user" 2>/dev/null
done | sort -hr
```

## Автоматизированные отчеты

```bash
# Полный отчет о дисковом пространстве
echo "=== ТОП-10 самых больших директорий ==="
du -h --max-depth=1 / 2>/dev/null | sort -hr | head -10

echo -e "\n=== ТОП-15 самых больших файлов ==="
find / -type f -size +100M -exec du -sh {} + 2>/dev/null | sort -hr | head -15

echo -e "\n=== Использование файловых систем ==="
df -h | awk 'NR==1 || $5+0 > 70'

echo -e "\n=== Inodes использование ==="
df -i | awk 'NR==1 || $5+0 > 70'
```

## Оптимизированные команды для продакшена

```bash
# Быстрый поиск без деталей (только размеры)
find / -type f -size +500M -printf '%s %p\n' 2>/dev/null | sort -nr | head -10

# Анализ с исключением системных FS
find / -type f -size +100M ! -path "/proc/*" ! -path "/sys/*" -exec du -sh {} + 2>/dev/null

# Периодический мониторинг с логированием
df -h | grep -v tmpfs > /var/log/disk_usage_$(date +%Y%m%d).log
du -sh /home/* /var/* >> /var/log/disk_usage_$(date +%Y%m%d).log
```

## Полезные алиасы для .bashrc

```bash
alias disk-usage='df -h | grep -v tmpfs'
alias big-files='find / -type f -size +100M -exec du -sh {} + 2>/dev/null | sort -hr | head -20'
alias big-dirs='du -h --max-depth=1 2>/dev/null | sort -hr | head -10'
alias disk-report='df -h; echo "---"; du -sh /home/* /var/* /opt/* 2>/dev/null | sort -hr'
```

