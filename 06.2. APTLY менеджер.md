Основные команды Aptly:

## **Работа с локальными репозиториями**

```bash
# Список локальных репозиториев
aptly repo list

# Создать новый репозиторий
aptly repo create имя-репозитория

# Показать информацию о репозитории
aptly repo show имя-репозитория
aptly publish show bookworm
aptly publish show bookworm-dev

# Добавить пакеты в репозиторий
aptly repo add имя-репозитория /путь/к/пакетам/

# Добавить пакеты и удалить исходные файлы
aptly repo add -remove-files имя-репозитория /путь/к/пакетам/

# Удалить пакеты из репозитория
aptly repo remove имя-репозитория "пакет(=версия)"

# Поиск пакетов в репозитории
aptly repo search имя-репозитория "запрос"

# Очистить репозиторий
aptly repo cleanup имя-репозитория
```

## **Публикация репозиториев**

```bash
# Список опубликованных репозиториев
aptly publish list

# Опубликовать локальный репозиторий
aptly publish repo имя-локального-репозитория дистрибутив

# Пример: опубликовать репозиторий runtel-bookworm как bookworm
aptly publish repo runtel-bookworm bookworm

# Обновить опубликованный репозиторий
aptly publish update дистрибутив

# Пример: обновить published репозиторий bookworm
aptly publish update bookworm

# Удалить опубликованный репозиторий
aptly publish drop дистрибутив

# Переместить опубликованный репозиторий
aptly publish switch дистрибутив новый-репозиторий
```

## **Снимки (снапшоты)**

```bash
# Создать снимок репозитория
aptly snapshot create имя-снимка from repo имя-репозитория

# Список снимков
aptly snapshot list

# Опубликовать снимок
aptly publish snapshot имя-снимка дистрибутив

# Объединить снимки
aptly snapshot merge имя-нового-снимка снимок1 снимок2
```

## **Отображение и поиск**

```bash
# Поиск пакетов во всех репозиториях
aptly package search "запрос"

# Показать детали пакета
aptly package show имя-пакета

# Отобразить зависимости пакета
aptly package depends имя-пакета
```

## **Экспорт/Импорт**

```bash
# Экспорт репозитория или снимка
aptly repo export имя-репозитория файл.json

# Импорт репозитория
aptly repo import файл.json имя-нового-репозитория
```

## **Очистка и обслуживание**

```bash
# Очистить кэш
aptly db cleanup

# Проверить целостность базы данных
aptly db recover

# Показать статистику
aptly db stats
```

## **Полезные комбинации**

```bash
# Добавить все DEB файлы из директории и опубликовать
aptly repo add -remove-files runtel-bookworm /tmp/debs/ && aptly publish update bookworm

# Посмотреть все пакеты в репозитории
aptly repo show -with-packages имя-репозитория

# В dev репозитории (runtel-bookworm-dev)
aptly repo show -with-packages runtel-bookworm-dev | tail -20

# В main репозитории (runtel-bookworm)  
aptly repo show -with-packages runtel-bookworm | tail -20

# Проверить наличие конкретного пакета
aptly repo search имя-репозитория "пакет"

# Искать в dev
aptly repo search runtel-bookworm-dev "runtel-web-v2"

# Искать в main
aptly repo search runtel-bookworm "runtel-web-v2"

# Посмотреть, есть ли наш пакет 2.22.3 в DEV репозитории
aptly repo search runtel-bookworm-dev "2.22.3"

# Удалить старые версии пакета
aptly repo remove имя-репозитория "пакет (<< версия)"

# Создать и опубликовать снимок для бэкапа
aptly snapshot create backup-$(date +%Y%m%d) from repo имя-репозитория
aptly publish snapshot backup-$(date +%Y%m%d) дистрибутив-backup
```

## **Проверка состояния**

```bash
# Проверить все опубликованные репозитории
aptly publish list

# Проверить все локальные репозитории
aptly repo list

# Проверить конкретный репозиторий
aptly repo show имя-репозитория

# Проверить наличие пакета
aptly package show имя-пакета
```

## **Ваши текущие репозитории:**
```bash
# PROD репозитории
aptly repo show runtel-bookworm      # Debian 12 PROD
aptly repo show runtel-bullseye      # Debian 11 PROD  
aptly repo show runtel-astra         # Astra PROD

# DEV репозитории
aptly repo show runtel-bookworm-dev  # Debian 12 DEV
aptly repo show runtel-bullseye-dev  # Debian 11 DEV
aptly repo show runtel-astra-dev     # Astra DEV
```



------------------------
Вводные данные 
```bash
www-data@a60:/root$ aptly repo list
List of local repos:
 * [runtel-astra-dev] (packages: 0)
 * [runtel-astra] (packages: 428)
 * [runtel-bookworm-dev] (packages: 11)
 * [runtel-bookworm] (packages: 471)
 * [runtel-bullseye-dev] (packages: 0)
 * [runtel-bullseye] (packages: 489)
 * [runtel] (packages: 28)

To get more information about local repository, run `aptly repo show <name>`.

www-data@a60:/root$ aptly repo show runtel-bookworm-dev
Name: runtel-bookworm-dev
Comment: 
Default Distribution: 
Default Component: main
Number of packages: 11

www-data@a60:/root$ aptly repo show runtel-bookworm
Name: runtel-bookworm
Comment: 
Default Distribution: 
Default Component: main
Number of packages: 471
```

Видно, что:
1. **`runtel-bookworm-dev`** существует и содержит 11 пакетов ✓
2. **`runtel-bookworm`** существует и содержит 471 пакет ✓

**Проблема:** Опубликованный репозиторий `bookworm-dev` не создан!

**Проверьте опубликованные репозитории:**
```bash
aptly publish list

www-data@a60:/root$ aptly publish list
Published repositories:
  * ./1.7_x86-64 [amd64] publishes {main: [runtel-astra]}
  * ./bookworm [amd64] publishes {main: [runtel-bookworm]}
  * ./bullseye [amd64] publishes {main: [runtel-bullseye]}
  * ./buster [amd64] publishes {main: [runtel]}
```

**Решения:**

**Вариант 1: Создать опубликованный DEV репозиторий:**
```bash
aptly publish repo runtel-bookworm-dev bookworm-dev
```

**Проверьте сейчас:** выполните первый вариант (создать вручную), чтобы DEV сборки сразу заработали:
```bash
aptly publish repo runtel-bookworm-dev bookworm-dev
```

**После этого проверьте:**
```bash
aptly publish list
```

Должно появиться:
```
...
* bookworm [amd64] publishes {runtel-bookworm: [bookworm]}
* bookworm-dev [amd64] publishes {runtel-bookworm-dev: [bookworm-dev]}
...
```

**Также проверьте другие репозитории:** возможно у `runtel-astra-dev`, `runtel-bullseye-dev` та же проблема.

--------------

## **1. Локальные репозитории vs Опубликованные репозитории**

**Локальные репозитории** (`aptly repo list`):
- Это "сырые" хранилища пакетов
- Примеры: `runtel-bookworm`, `runtel-bookworm-dev`
- Они только для хранения, не доступны клиентам напрямую

**Опубликованные репозитории** (`aptly publish list`):
- Это "готовые" репозитории, доступные клиентам по HTTP/APT
- Примеры: `bookworm`, `bookworm-dev`
- Они ссылаются на локальные репозитории

## **2. Как работает связь:**

```
Локальный репозиторий       →       Опубликованный репозиторий
runtel-bookworm            →       bookworm
runtel-bookworm-dev        →       bookworm-dev
```

**Команда связывания:**
```bash
# Связать локальный с опубликованным
aptly publish repo runtel-bookworm bookworm
#          локальный─────┘        └────опубликованный
```

## **3. Что делает каждая команда в вашем playbook:**

```yaml
# 1. Добавить пакеты в ЛОКАЛЬНЫЙ репозиторий "runtel-bookworm"
aptly repo add -remove-files runtel-bookworm /tmp/debs/deb12/

# 2. ОБНОВИТЬ ОПУБЛИКОВАННЫЙ репозиторий "bookworm" 
#    (чтобы изменения из локального стали видны клиентам)
aptly publish update bookworm
```

## **4. Аналогия с Git:**

```
Локальный репозиторий  →  Опубликованный репозиторий
git add & commit       →  git push
(изменения локально)      (публикуем изменения)
```

## **5. Текущая проблема:**

У вас есть локальные репозитории:
- ✅ `runtel-bookworm-dev` (локальный, 11 пакетов)
- ✅ `runtel-bookworm` (локальный, 471 пакет)

Но опубликован только один:
- ✅ `bookworm` (опубликованный, ссылается на `runtel-bookworm`)
- ❌ `bookworm-dev` (отсутствует! нужно создать)

## **6. Решение:**

```bash
# Создать связь: локальный → опубликованный
aptly publish repo runtel-bookworm-dev bookworm-dev

# Проверить
aptly publish list
```

**После этого будет:**
```
Локальные (aptly repo list):          Опубликованные (aptly publish list):
[runtel-bookworm-dev] (11 пакетов)    → [bookworm-dev] (ссылается на runtel-bookworm-dev)
[runtel-bookworm] (471 пакет)         → [bookworm] (ссылается на runtel-bookworm)
```

## **7. Как клиенты будут использовать:**

```bash
# PROD клиенты:
deb http://ваш-сервер/debian/ bookworm main

# DEV клиенты:
deb http://ваш-сервер/debian/ bookworm-dev main
```

**В вашем playbook:**
- `bookworm` в команде `aptly publish update` — это имя **опубликованного** репозитория
- `runtel-bookworm` в команде `aptly repo add` — это имя **локального** репозитория

**Теперь понятнее?** Нужно создать связь между локальным `runtel-bookworm-dev` и опубликованным `bookworm-dev`.
