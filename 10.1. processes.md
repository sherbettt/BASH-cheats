### § Управление процессами
```c
ps -p $$   #инфо о командой оболочке
ps -e | head
ps -ef
ps lax
ps aux --sort=%mem
ps aux --sort=%cpu
pstree -p <PID>
- изменить время логирования:
	(для CentOS будет /etc/sysconfig/atop)
	• для Ubuntu: sudo sed -i 's/600/10/' /etc/default/atop
	• sudo systemctl restart atop
	• ls -lh /var/log/atop/
	• atop -r /var/log/atop/atop_20241130 -b 21:43
		t и Shift+t для перемещения
```

- USER — учетная запись пользователя, от которой запущен процесс.
- PID — идентификатор процесса.
- %CPU — потребление процессорного времени в процентном эквиваленте.
- %MEM — использование памяти в процентах.
- VSZ — Virtual Set Size. Виртуальный размер процесса (в килобайтах).
- RSS — Resident Set Size. Размер резидентного набора (количество 1K-страниц в памяти).
- TTY — терминал, из под которого был запущен процесс.
- STAT — текущее состояние процесса. Могут принимать значения:
	- R — TASK_RUNNING Процесс либо выполняется на ЦП, либо ожидает запуска;
	- S — TASK_INTERRUPTIBLE спящий;
 	- I — TASK_REPORT_IDLE (innactive), не активен;
	- D — TASK_UNINTERRUPTIBLE в состоянии подкачки на диске; Это состояние используется, только если прерывание процесса может привести к непредсказуемому состоянию устройства
	- T — TASK_STOPPED остановлен;
	- Z — EXIT_ZOMBIE зомби; Дочерний процесс отправляет сигнал родительскому процессу при завершении работы. Освобождаются все ресурсы, за исключением идентификатора процесса (PID).
	- W — не имеет резидентных страниц;
	- < — высоко-приоритетный;
	- N — низко-приоритетный;
 	- X — EXIT_DEAD родительский процесс очищает (убирает) оставшуюся структуру дочернего процесса;
	- L — имеет страницы, заблокированные в памяти.
- START — дата запуска процесса.
- TIME — время запуска процесса.
- COMMAND — команда, запустившая процесс.

**определить число логичкских ЦПУ**
<br/> `grep "model name" /proc/cpuinfo | wc -l` 

В **/proc/sys/kernel/pid_max**  хранится макс. значение процессов, когда заканчивается PID, новые процессы не запустятся.
<br/>См. **/etc/security/limits.conf**

**Изменение приоритета процессов**
<br/> `jobs -l`  см. запущенные джобы
<br/> `Ctrl+Z` сигнал СТОП процессу, фоновый режим
<br/> `Ctrl+\` сохранить дамп ядра
<br/> ` <Ps_name> & ` - выполнение на фоне
<br/> `bg %<Ps_name> ` - вернуть из бэкграунда
<br/> `fg %<Ps_name> ` - вернуть на передний план




**Изменение приоритета процессов**
<br/> Приоритет процесса linux означает, насколько больше процессорного времени будет отдано этому процессу по сравнению с другими. Так мы можем очень тонко настроить какая программа будет работать быстрее, а какая медленнее. Значение приоритета может колебаться от 19 (минимальный приоритет) до -20 - максимальный приоритет процесса linux. Причем, уменьшать приоритет можно с правами обычного пользователя, но чтобы его увеличить нужны права суперпользователя.
<br/> `nice -n 10 apt-get upgrade`

**просмотр лимитов**
<br/> `sudo bcat /proc/<PID>/limits`

**10 самых загруженных и более процессов по CPU.**
<br/> `ps -eo pcpu,pid,user,args | tail -n +2 | sort -k1 -r -n | head -10`
```bash
ps aux --sort=-%cpu | head -20
ps -eo pid,ppid,%cpu,%mem,cmd --sort=-%cpu | head -15
top -b -n 1 | head -20
ps -eo pid,ppid,%cpu,%mem,cmd --sort=-%cpu | grep java
ps -eo pid,ppid,pgid,sid,%cpu,%mem,cmd --sort=-%cpu | head -15
```

**zombie процесс**
<br/> достаточно воспользоваться командой top
```console
top - 20:29:31 up  8:33,  1 user,  load average: 0.21, 0.27, 0.31
Tasks: 163 total,   1 running, 162 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   3910.4 total,   3423.6 free,    338.4 used,    148.4 buff/cache
MiB Swap:      0.0 total,      0.0 free,      0.0 used.   3371.5 avail Mem
```
а также поиск осуществить с помощью *ps*:
<br/> `ps ux`
<br/> `ps ux | awk '{if($8=="Z") print}'`
<br/> `ps aux | grep 'Z'`
<br/> поиск parent для zombie
<br/> `pstree -p -s <PID>`

Мы можем вручную отправитьсигнал SIGCHLD родителю процесса-зомби. Следовательно, он будет имитировать родителя, чтобы вызвать системный вызов wait(), который удалит неработающий дочерний процесс из таблицы процессов.
<br/> `ps -A -ostat,pid,ppid | grep -e '[zZ]'`

```
nice - фактор уступчивости
man -K nice
ps axo pid,comm,nice,cls --sort=-nice
nice от -20 до 19
меньше nice - выше приоритет и наоборот.
непривлегировнный пользователь может только для своих процессов увеличивать nice, поижать не может
nice -n 15 sha1sum &
ps -o pid,comm,nice <id_проц>
renice -n 19 <id_проц>
chrt - Show or change the real-time scheduling attributes of a process
ps -o pid,pcpu,nice,comm $(pgrep <id_проц>;pgrep <id_проц>)
```

Сигналы - это основной механизм межпроцессного взаимодействия в Unix/Linux для управления процессами.

## **Ключевые сигналы (наиболее используемые):**

### 1. **Основные сигналы управления процессами:**
- **1) SIGHUP** - Hangup (перезапуск, часто используется для перечитывания конфигураций)
- **2) SIGINT** - Interrupt (Ctrl+C в терминале)
- **3) SIGQUIT** - Quit (Ctrl+\ в терминале, с дампом памяти)
- **9) SIGKILL** - Немедленное уничтожение процесса (нельзя перехватить или игнорировать)
- **15) SIGTERM** - Graceful termination (вежливое завершение)
- **19) SIGSTOP** - Остановка процесса (приостановка выполнения)
- **18) SIGCONT** - Продолжить выполнение остановленного процесса

### 2. **Сигналы ошибок:**
- **4) SIGILL** - Illegal instruction (недопустимая инструкция)
- **5) SIGTRAP** - Trap (отладочный трап)
- **6) SIGABRT** - Abort (аварийное завершение, обычно от abort())
- **7) SIGBUS** - Bus error (ошибка шины)
- **8) SIGFPE** - Floating point exception (ошибка вычислений с плавающей точкой)
- **11) SIGSEGV** - Segmentation fault (нарушение сегментации)

### 3. **Сигналы ввода/вывода и событий:**
- **13) SIGPIPE** - Broken pipe (разрыв канала)
- **14) SIGALRM** - Alarm clock (сигнал таймера)
- **17) SIGCHLD** - Child status changed (изменение статуса дочернего процесса)

### 4. **Пользовательские сигналы:**
- **10) SIGUSR1** - User-defined signal 1
- **12) SIGUSR2** - User-defined signal 2

### 5. **Сигналы реального времени (34-64):**
Сигналы с 34 по 64 - это **сигналы реального времени (real-time signals)**, которые имеют приоритет и могут быть поставлены в очередь.

## **Как использовать сигналы:**

### Отправка сигнала процессу:
```bash
# По номеру сигнала
kill -9 PID          # SIGKILL
kill -15 PID         # SIGTERM

# По имени сигнала
kill -SIGTERM PID
kill -TERM PID       # Тоже SIGTERM
```

### Просмотр информации о сигналах:
```bash
# Список всех сигналов с номерами
kill -L

# Список всех сигналов с именами
kill -l

# Описание сигналов
man 7 signal
```

### Распространенные сценарии:
```bash
# Вежливое завершение процесса
kill -TERM PID       # или kill -15 PID

# Принудительное завершение
kill -KILL PID       # или kill -9 PID

# Перезапуск демона (перечитать конфиг)
kill -HUP PID        # или kill -1 PID

# Приостановить процесс
kill -STOP PID       # или kill -19 PID

# Возобновить процесс
kill -CONT PID       # или kill -18 PID
```

## **Важные особенности:**

1. **SIGKILL (9)** и **SIGSTOP (19)** нельзя перехватить, игнорировать или заблокировать
2. **SIGTERM (15)** - стандартный сигнал для "вежливого" завершения
3. Процессы могут:
   - Обрабатывать сигналы (установить свой обработчик)
   - Игнорировать большинство сигналов
   - Использовать сигналы по умолчанию

## **Примеры в скриптах:**
```bash
#!/bin/bash
# Перехват SIGTERM
trap "echo 'Получен SIGTERM, завершаюсь...'; exit 0" SIGTERM

# Бесконечный цикл
while true; do
    sleep 1
done
```

## **Как проверить, какие сигналы обрабатывает процесс:**
```bash
# Посмотреть маску сигналов процесса
grep Sig /proc/PID/status

# Или через strace
strace -p PID -e trace=signal
```
