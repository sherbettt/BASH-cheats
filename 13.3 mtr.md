Команда `mtr` — это мощная утилита диагностики сетевых маршрутов, объединяющая функциональность команд `ping` и `traceroute`. Она позволяет одновременно отслеживать путь пакетов от локального компьютера до удалённого узла, измеряя задержку и потерю пакетов между промежуточными узлами сети. Вот подробное описание работы команды и некоторые интересные примеры её использования.

### Как работает команда `mtr`

При запуске `mtr`, программа отправляет ICMP-пакеты (или UDP/TCP пакеты, если явно указан другой протокол), используя технику TTL ("Time To Live"), аналогично команде traceroute. Каждый раз значение TTL увеличивается на единицу, пока пакет не достигнет целевого хоста. Одновременно утилита отслеживает задержки и потери пакетов на каждом маршруте.

### Простые примеры

#### 1. Базовая проверка маршрута к хосту Google.com
```bash
sudo mtr runtel.ru
```
Результат покажет список всех узлов пути и статистику потерь/задержек.

#### 2. Запуск трассировки без постоянного обновления экрана
```bash
sudo mtr --report runtel.ru
```
Этот режим выводит одну страницу отчёта и завершается автоматически.

#### 3. Использование протокола TCP для проверки
```bash
sudo mtr --tcp yandex.ru
```
Это полезно, если ваш узел фильтрует ICMP-запросы.

---

### Продвинутые примеры

#### 1. Проверка доступности DNS-серверов провайдера с отображением статистики
Иногда интересно проверить доступность конкретных DNS-серверов вашего провайдера:
```bash
sudo mtr --interval=1s --psize=84 dns.yandex.net
```
Здесь используется интервал отправки пакета в 1 секунду (`--interval`) и размер пакета 84 байта (`--psize`), подходящий для небольших запросов.

#### 2. Трассировка до определённой точки остановки (неполная трасса)
Иногда вам нужно посмотреть лишь первые N шагов трассы до конечного хоста:
```bash
sudo mtr --max-ttl=7 example.com
```
Эта команда остановит трассировку после достижения седьмого хопа (промежуточного узла).

#### 3. Сохранение результатов трассировки в файл для дальнейшего анализа
Вы можете сохранить данные трассировки в виде файла формата HTML или JSON для последующего изучения:
```bash
sudo mtr --raw --html > report.html
```
Файл `report.html` можно легко просмотреть в браузере, предоставляя визуализацию путей и проблем.

#### 4. Работа с IPv6-трассировкой
Чтобы проследить маршруты IPv6, достаточно добавить соответствующий аргумент:
```bash
sudo mtr -6 ipv6.google.com
```
Полезно, если ваша сеть поддерживает оба стека протоколов (IPv4 и IPv6).

#### 5. Построение карты сетей AS (Autonomous System) для целей мониторинга
Для понимания географического распределения ваших серверов и инфраструктуры полезно построить карту автономных систем (AS):
```bash
sudo mtr --aslookup example.com
```
Утилита попытается показать номера автономных систем для каждого узла.

---

### Редкие и специфические сценарии

#### 1. Тестирование межконтинентальных соединений
Иногда возникает необходимость проверить стабильность соединения через континенты, например, Европа-Азия:
```bash
sudo mtr -c 100 --report-wide europe.pool.ntp.org
```
Параметр `-c 100` задаёт количество циклов измерений (100), позволяя собрать больше статистической информации.

#### 2. Поиск причины медленной загрузки файлов
Используя увеличенный размер пакета, можно увидеть влияние перегрузки каналов связи на больших файлах:
```bash
sudo mtr --psize=1472 ftp.server.ru
```
Размер пакета 1472 байта выбран специально, чтобы проверить пропускную способность канала на большом объёме трафика.

#### 3. Определение влияния шифрования VPN
Допустим, вас интересует влияние туннеля OpenVPN на производительность:
```bash
sudo mtr --udp --report-wide vpn-server.example.com
```
Использование UDP-протокола позволит оценить возможные проблемы именно в туннелировании.

---

Запустить команду `mtr` с пакетом размером 1 килобайт (1 KB = 1024 байта) можно следующим образом:

```bash
sudo mtr --psize=1024 your_hostname_or_ip
```

Например, если хотите запустить проверку для сайта **yandex.ru**:

```bash
sudo mtr --psize=1024 yandex.ru
```

Обратите внимание, что аргумент `--psize` определяет именно размер полезного содержимого пакета, который отправляется в каждый хоп (маршрут). Это может помочь выявить проблемы, возникающие только при передаче крупных объёмов данных.

---

Отчёт трассировки командой `mtr` можно вывести в удобочитаемом HTML-формате. Для этого воспользуйтесь следующей командой:

```bash
sudo mtr --report --html your_hostname_or_ip > output.html
```

Где:
- `your_hostname_or_ip` — имя домена или IP адрес целевой машины,
- `output.html` — название выходного файла, куда сохранится отчет.

Пример использования:

```bash
sudo mtr --report --html yandex.ru > trace_report.html
```

После выполнения команды в директории появится файл `trace_report.html`, который можно открыть любым веб-браузером и удобно изучить результат трассировки.


