См. на robotmoon.com: [A visual guide to SSH tunnels](https://robotmoon.com/ssh-tunnels/)
<br/> Начало в ст.: [Настройка NAT на роутере](https://github.com/sherbettt/BASH-cheats/blob/main/Настройка%20NAT%20на%20роутере%20с%20Ubuntu.md)

Есть Ubuntu подобный роутер. На нём три интерфейса:
<br/> eth0 - 192.168.87.112 (смотрит в интернет), шлюз: 192.168.87.1;
<br/> eth1 - 192.168.56.1 (не смотрит в интернет, для связи с машинами);
<br/> eth2 - 192.168.96.113 (смотрит в интернет), шлюз: 192.168.96.1
<br/> Также есть две другие Ubuntu машины, подключённые к выше указанном роутеру с адресами:192.168.56.2/24; 192.168.56.3/24
<br/> SSH ключи от 192.168.87.136, с которой будем делать соединение, лежат на 192.168.56.2.
<br/> Требуется сделать SSH туннелирование от машины 192.168.87.136 до машины 192.168.56.2, т.е.Local port forwarding.
<br/> Требуется сделать соединение от машины 192.168.87.136 до машины 192.168.56.2 с помощью sshuttle.



### Структура сети:
```
Internet ────── eth0:192.168.87.112/24, eth2:192.168.96.113/24 ───┐
                              │           │
                              ↓           ↓
                         Router ┌─┬───────────┐
                          eth1:192.168.56.1   │
                          ------------ ---  --│
                           Host1:192.168.56.2 ├── Internal network (no Internet)
                           Host2:192.168.56.3 │── Internal network (no Internet)
                                              │
                         └────────────────────┘
```

#### Шаги для реализации Local Port Forwarding:

### Предположим:
- Ваша машина имеет IP **192.168.87.136** (за пределами внутренней сети).
- Вы хотите установить соединение с сервером **192.168.56.2**, находящимся внутри защищённой сети.
- Интерфейсом для подключения к Интернету является интерфейс eth0 роутера.

### Инструкция:

1. Установите SSH-доступ на ваш роутер, убедитесь, что он доступен извне по адресу **192.168.87.112**. Для безопасности настройте аутентификацию с использованием ключей SSH (оптимально).

2. Затем выполните следующую команду на машине **192.168.87.136** (или любой другой машине с доступом к вашему роутеру):
   
```bash
ssh -L 2222:192.168.56.2:22 root@192.168.87.112
```

Что означает эта команда?
- **-L**: Определяем local port forwarding.
- **2222**: Локальный порт на вашей машине (можете выбрать другой свободный порт).
- **192.168.56.2:22**: Адрес целевого сервера и удалённый порт SSH (обычно стандартный — 22).
- **root@192.168.87.112**: Ваш SSH-аккаунт на роутере и его внешний IP.

Теперь вы можете обращаться к машине `192.168.56.2` изнутри своей внешней машины через созданный туннель:

```bash
ssh -p 2222 localhost
```

Или же с любого другого хоста, где открыт доступ к вашей основной машине по этому туннелю.

Таким образом, вся связь проходит следующим маршрутом:
```
External machine → Router → Target internal server
```







### Метод установки SSH-туннеля (Local port forwarding)

Этот метод полезен, если у вас есть доступ к обоим устройствам через SSH и вам нужно временно настроить туннелирование.
Так как обе указанные вами машины находятся в разных сетях, и одна из машин (192.168.56.2) находится за NAT роутером (192.168.56.1), прямая связь невозможна без помощи промежуточного устройства — вашего роутера с тремя интерфейсами.

#### Шаг 1: Предварительный
1. Проверить строку в файле `/etc/ssh/sshd_config`, должно быть: `AllowTcpForwarding yes`
2. Если делаем форвардинг на другие хосты, отличные от 127.0.0.1, проверяем файл `/etc/ssh/ssh_config`, строка `GatewayPorts yes`
3. Сбросить все демоны: `systemctl daemon-reload` , `systemctl status sshd.service`
4. На соответствующих машинах сгенерировать ssh ключи и обменяться - публичными.

#### Шаг 2: создаём SSH-туннель  
   Теперь организуем SSH-туннель от вашей внешней машины (192.168.87.136) к внутренней (192.168.56.2). Мы воспользуемся роутером (192.168.56.1) как транзитным пунктом.

   Команда SSH выглядит следующим образом:

   ```bash
   ssh -L 2222:192.168.56.2:22 root@192.168.56.1
   или
   ssh -L 8080:192.168.56.1:80 root@192.168.87.136
   ```
   Где:
   - `2222`: Порт на вашем внешнем компьютере (192.168.87.136), который теперь переадресуется внутрь.
   - `192.168.56.2:22`: Адрес и порт целевой машины внутри частной/локальной сети.
   - `root@192.168.56.1`: Ваш роутер, к которому вы подключаетесь, чтобы создать туннель.

   Аналогично: 
   ```bash
   ssh -L 4443:192.168.56.2:443 -L 2222:192.168.56.2:22 root@192.168.56.1
   ```
   Где:
  - подключаемся по SSH к узлу 192.168.56.1 пользователем root.
  - локальный компьютер начинает слушать на портах 4443 и 2222.
  - если подключиться к локальному хосту по порту 4443 нас кинет на 192.168.56.2 порт 443, который находится за узлом 192.168.56.1.
  - если подключиться к локальному хосту по порту 2222 нас кинет на 192.168.56.2 порт 22, который находится за узлом 192.168.56.1.


#### Шаг 3: Проверяем работу SSH-туннеля
   После установления туннельного соединения вы можете проверить работоспособность подключения к целевой машине изнутри внешнего компьютера:

   ```bash
   ssh localhost -p 2222{4443|<любой_другой>}
   ```

   Эта команда должна установить соединение с машиной 192.168.56.2 через открытый туннель.

### Важно!
- Убедитесь, что на всех устройствах открыты необходимые порты (например, TCP 22 для SSH).
- Проверьте настройки безопасности роутера и брандмауэра на обеих машинах, чтобы исключить блокировки соединений.

---

### Что такое `sshuttle`
`sshuttle` — утилита, позволяющая быстро развернуть VPN поверх SSH. Она создает виртуальные интерфейсы и прокси-пакеты через SSH-туннель, предоставляя простое решение для безопасного доступа к внутренним ресурсам, минуя ограничения фаерволлов и ограничений доступа.
<br/> Команду `sshuttle` можно использовать для упрощённого VPN-подобного подключения, которое позволяет прозрачно направлять трафик через SSH-туннель. 
<br/> Вместо ручного конфигурирования отдельных маршрутов, `sshuttle` автоматически настраивает правила iptables и iproute таким образом, чтобы весь нужный трафик проходил через туннель.

### Установка `sshuttle`
Установите `sshuttle` на машину 192.168.87.136 (клиент):

```bash
epmi pip;
pip install sshuttle;
curl cht.sh/sshuttle;
```

### Использование `sshuttle`
Используя ваш роутер (192.168.56.1) как точку выхода, запустите `sshuttle`. Таким образом, вся ваша сессия, включая HTTPS, DNS-запросы и другие типы трафика, будет проходить через этот SSH-туннель.

Запустите следующее на клиентском устройстве (192.168.87.136):

```bash
sshuttle -r root@192.168.87.112 192.168.56.0/24
```

Здесь:
- `-r root@192.168.87.112`: Роутер (eth0), через который создается туннель.
- `192.168.56.0/24`: Диапазон сети, который будет доступен через туннель.

Эта команда создаст виртуальный интерфейс и отправит весь трафик к указанной сети через роутер.

### Как всё работает вместе?

1. Вы запускаете обычный SSH-туннель между вашим внешним компьютером (192.168.87.136) и роутером (192.168.56.1).
2. Запускаете `sshuttle`, который создаёт виртуальную сеть и перенаправляет весь трафик для выбранной сети (192.168.56.0/24) через этот SSH-туннель.
3. Все запросы к сети 192.168.56.x проходят через SSH-шлюз, позволяя вам видеть внутренние ресурсы сети, как будто вы находитесь внутри неё.

### Полезные опции для тонкой настройки:
- **Автоматическое определение маршрута:** Используйте ключ `--auto-routes`, чтобы автоматически определять маршруты для конкретных целей.

  ```bash
  sshuttle -r root@192.168.56.1 --auto-routes
  ```

- **Выбор конкретного порта SSH:** Можно указать другой порт SSH, если стандартный порт закрыт или занят другим сервисом.

  ```bash
  sshuttle -r root@192.168.56.1:PORT 192.168.56.0/24
  ```

- **Только передача DNS запросов:** Иногда достаточно передать только DNS-запросы через туннель.

  ```bash
  sshuttle -D -r root@192.168.56.1
  ```

### Резюме:

Использование `sshuttle` значительно упрощает организацию тоннелей, особенно когда нужно прозрачно передавать весь трафик определённой сети через одно SSH-соединение. Этот инструмент удобен, гибок и обеспечивает лёгкое управление маршрутизацией через шифрованный канал.
