### **`sngrep -I <Name_of>.pcap`**

```c
                                                                                                                        
             10.190.9.11:5060            10.240.251.218:5060         10.240.251.218:5202             10.190.9.11:5060 
          ──────────┬─────────          ──────────┬─────────        ──────────┬─────────          ──────────┬─────────
                    │     INV (10.190.24.40)      │                           │                             │         
  15:06:41.474593   │     audio 10006 (g711u)     │                           │                             │         
        +0.000910   │ ──────────────────────────> │                           │                             │         
  15:06:41.475503   │         100 Trying          │                           │                             │         
                    │ <────────────────────────── │                           │                             │         
        +0.014839   │                             │                           │    INV (10.240.251.218)     │         
  15:06:41.490342   │                             │                           │     audio 32206 (g711a)     │         
                    │                             │                           │ ──────────────────────────> │         
        +0.002924   │    183 (10.240.251.218)     │                           │                             │         
  15:06:41.493266   │     audio 17954 (g711a)     │                           │                             │         
                    │ <────────────────────────── │                           │                             │         
        +0.997144   │                             │                           │    INV (10.240.251.218)     │         
  15:06:42.490410   │                             │                           │     audio 32206 (g711a)     │         
                    │                             │                           │ ────────────────────────>>> │         
        +1.999988   │                             │                           │    INV (10.240.251.218)     │         
  15:06:44.490398   │                             │                           │     audio 32206 (g711a)     │         
                    │                             │                           │ ────────────────────────>>> │         
        +4.000001   │                             │                           │    INV (10.240.251.218)     │         
  15:06:48.490399   │                             │                           │     audio 32206 (g711a)     │         
                    │                             │                           │ ────────────────────────>>> │         
        +8.000003   │                             │                           │    INV (10.240.251.218)     │         
  15:06:56.490402   │                             │                           │     audio 32206 (g711a)     │         
                    │                             │                           │ ────────────────────────>>> │         
       +16.000003   │                             │                           │    INV (10.240.251.218)     │         
  15:07:12.490405   │                             │                           │     audio 32206 (g711a)     │         
        +1.002061   │                             │                           │ ────────────────────────>>> │         
  15:07:13.492466   │     408 Request Timeout     │                           │                             │         
        +0.008808   │ <────────────────────────── │                           │                             │         
  15:07:13.501274   │             ACK             │                           │                             │         
                    │ ──────────────────────────> │                           │                             │         
                    │                             │                           │                             │         
```
----------------------------------------------------------------------------------------------------------------

- **10.190.9.11:5060** (источник/получатель)  
- **10.240.251.218:5060** (прокси/сервер)  
- **10.240.251.218:5202** (возможно, внутренний компонент)  

### Краткий анализ текущей последовательности:  
1. **INVITE (SDP)** отправлен от `10.190.9.11:5060` к `10.240.251.218:5060`.  
2. Сервер отвечает **100 Trying**, затем пересылает `INVITE` на `10.240.251.218:5202`.  
3. После этого `10.190.9.11` получает **183 Session Progress**, но `INVITE` продолжает переотправляться на `5202` (возможно, из-за отсутствия ответа).  
4. Через несколько таймаутов (`INVITE` повторяется с экспоненциальными интервалами: 2, 4, 8, 16 сек) `10.190.9.11` получает **408 Request Timeout** и отправляет **ACK**.  

### Проблемы:  
- **5202 порт не отвечает** на `INVITE`, что приводит к таймауту.  
- **408 Request Timeout** указывает на недоступность сервиса на `5202` или потерю пакетов.  

----------------------------------------------------------------------------------------------------------------


```ini
│INVITE sip:989163640234@10.240.251.218:5060;user=phone SIP/2.0
│Via: SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp
│Call-ID: wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11
│From: "6899"<sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r
│To: 989163640234 <sip:989163640234@10.240.251.218;user=phone>
│CSeq: 1 INVITE
│Contact: <sip:6899@10.190.9.11:5060;user=phone>;CallLocation=EXTERNAL
│Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,REGISTER,INFO,PRACK,SUBSCRIBE,NOTIFY,UPDATE,
│PUBLISH
│Max-Forwards: 70
│Content-Length: 576
│Content-Type: application/sdp
│
│v=0
│o=HuaweieSpaceV200R003C50SPC900 918742 918742 IN IP4 10.190.9.11
│s=A conversation
│c=IN IP4 10.190.24.40
│t=0 0
│m=audio 10006 RTP/AVP 0 8 102 18 4 97 108 9 109 101
│a=rtpmap:0 PCMU/8000
│a=rtpmap:8 PCMA/8000
│a=rtpmap:102 G726-32/8000
│a=rtpmap:18 G729/8000
│a=fmtp:18 annexb=no
│a=rtpmap:4 G723/8000
│a=fmtp:4 bitrate=6.3;annexa=no
│a=rtpmap:97 iLBC/8000
│a=fmtp:97 mode=20
│a=rtpmap:108 AMR/8000
│a=fmtp:108 mode-set=7;octet-align=0
│a=rtpmap:9 G722/8000
│a=rtpmap:109 AMR-WB/16000
│a=fmtp:109 mode-set=8;octet-align=0
│a=rtpmap:101 telephone-event/8000
│a=sendrecv
```

## **1. Заголовки SIP**  

### **стандартный SIP `INVITE`-запрос, инициирующий сеанс связи**  
### **1.1. Основные поля**  
| Поле | Значение | Описание |
|------|---------|----------|
| **Request-Line** | `INVITE sip:989163640234@10.240.251.218:5060;user=phone SIP/2.0` | Запрос на установление сеанса с абонентом `989163640234` на сервере `10.240.251.218:5060`. Параметр `user=phone` указывает, что это телефонный номер. |
| **Via** | `SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp` | Указывает маршрут ответа (через `10.190.9.11:5060` по UDP). `branch` — уникальный идентификатор транзакции. |
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11` | Уникальный идентификатор вызова. |
| **From** | `"6899"<sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r` | Инициатор вызова (`6899`), `tag` — идентификатор стороны. |
| **To** | `989163640234 <sip:989163640234@10.240.251.218;user=phone>` | Целевой абонент (`989163640234`). |
| **CSeq** | `1 INVITE` | Номер последовательности (1 — первый запрос). |
| **Contact** | `<sip:6899@10.190.9.11:5060;user=phone>;CallLocation=EXTERNAL` | Адрес для ответов. `CallLocation=EXTERNAL` может означать внешний вызов. |
| **Allow** | `INVITE,ACK,OPTIONS,BYE,CANCEL,REGISTER,INFO,PRACK,SUBSCRIBE,NOTIFY,UPDATE,PUBLISH` | Поддерживаемые методы SIP. |
| **Max-Forwards** | `70` | Максимальное число прокси-переходов (уменьшается на 1 при каждом форвардинге). |
| **Content-Length** | `576` | Размер SDP-тела (576 байт). |
| **Content-Type** | `application/sdp` | Тип содержимого (SDP — описание медиа-сессии). |



## **2. SDP (Session Description Protocol)**  
SDP описывает параметры медиа-потока (аудио, видео).  

### **2.1. Основные поля SDP**  
| Поле | Значение | Описание |
|------|---------|----------|
| **v=0** | `0` | Версия SDP. |
| **o=** | `HuaweieSpaceV200R003C50SPC900 918742 918742 IN IP4 10.190.9.11` | Идентификатор сессии (`HuaweieSpaceV200R003C50SPC900` — Huawei eSpace, IP `10.190.9.11`). |
| **s=** | `A conversation` | Название сессии. |
| **c=** | `IN IP4 10.190.24.40` | IP-адрес для медиа-потока (`10.190.24.40`). |
| **t=** | `0 0` | Время активности (0 0 — бесконечная сессия). |

### **2.2. Аудио-поток (`m=audio`)**  
```sdp
m=audio 10006 RTP/AVP 0 8 102 18 4 97 108 9 109 101
```  
- **Порт RTP:** `10006`  
- **Кодеки:**  
  - `0` — PCMU (G.711 μ-law)  
  - `8` — PCMA (G.711 A-law)  
  - `102` — G.726-32  
  - `18` — G.729  
  - `4` — G.723.1  
  - `97` — iLBC  
  - `108` — AMR  
  - `9` — G.722  
  - `109` — AMR-WB  
  - `101` — DTMF (RFC 2833)  

**Дополнительные атрибуты (`a=`):**  
- `a=rtpmap:X CODEC/CLOCKRATE` — сопоставление RTP-полезной нагрузки с кодеком.  
- `a=fmtp` — параметры кодеков (например, `mode=20` для iLBC означает 20 мс фреймы).  
- `a=sendrecv` — двусторонний поток (можно и `sendonly`/`recvonly`).  



## **3. Проблемы в этом `INVITE`**  
1. **Проблемы с ответом (`5202` порт):**  
   - В предыдущем логе видно, что `INVITE` пересылается на `10.240.251.218:5202`, но ответа нет.  
   - Возможные причины:  
     - Сервис на `5202` не запущен.  
     - NAT/Firewall блокирует трафик.  
     - Неправильная маршрутизация внутри сервера.  

2. **Возможные ошибки в SDP:**  
   - Если `10.190.24.40` недоступен для медиа-потока, вызов не установится.  
   - Некоторые кодеки (например, G.723.1) могут не поддерживаться удаленной стороной.  

----------------------------------------------------------------------------------------------------------------

```
SIP/2.0 100 Trying
Via: SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp
From: "6899" <sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r
To: 989163640234 <sip:989163640234@10.240.251.218;user=phone>
Call-ID: wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11
CSeq: 1 INVITE
User-Agent: FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~
64bit
Content-Length: 0
```


### **Разбор SIP-ответа `100 Trying`**  

Это промежуточный ответ, указывающий, что запрос `INVITE` получен и обрабатывается, но окончательный ответ (например, `180 Ringing` или `200 OK`) еще не готов.  


## **1. Основные поля заголовка**  

| Поле | Значение | Описание |
|------|---------|----------|
| **Status-Line** | `SIP/2.0 100 Trying` | Временный ответ, означающий "запрос в обработке". |
| **Via** | `SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp` | Копия из исходного `INVITE`, чтобы ответ вернулся по тому же пути. |
| **From** | `"6899" <sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r` | Инициатор вызова (`6899`), `tag` идентифицирует сторону. |
| **To** | `989163640234 <sip:989163640234@10.240.251.218;user=phone>` | Получатель вызова (`989163640234`). |
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11` | Уникальный идентификатор вызова (совпадает с `INVITE`). |
| **CSeq** | `1 INVITE` | Номер последовательности (должен совпадать с `INVITE`). |
| **User-Agent** | `FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~64bit` | Указывает, что ответ отправлен **FreeSWITCH** (SIP-сервер). |
| **Content-Length** | `0` | Пустое тело ответа. |



## **2. Назначение `100 Trying`**  
- **Предотвращает таймауты** на стороне инициатора (`10.190.9.11`), сообщая, что запрос принят и обрабатывается.  
- **Не требует подтверждения (ACK)** — в отличие от `18x`/`2xx` ответов.  
- **Не несет SDP** — только сигнальный ответ.  



## **3. Контекст в текущем логе**  
1. **Инициатор (`10.190.9.11`)** отправил `INVITE` → **FreeSWITCH (`10.240.251.218:5060`)** ответил `100 Trying`.  
2. Далее сервер попытался переслать `INVITE` на `10.240.251.218:5202`, но **не получил ответа**, что привело к `408 Request Timeout`.  



## **4. Возможные проблемы**  
- **5202 порт не отвечает**:  
  - Сервис на `5202` не запущен.  
  - Ошибка маршрутизации внутри FreeSWITCH.  
  - NAT/Firewall блокирует трафик.  
- **FreeSWITCH не смог завершить обработку**:  
  - Нет настроенного диалплана для номера `989163640234`.  
  - Ошибка в конфигурации модуля `mod_sofia`.  

----------------------------------------------------------------------------------------------------------------


### **Разбор SIP-сообщения `INVITE` (второй запрос, от FreeSWITCH к получателю)**

Этот `INVITE` отправлен **с FreeSWITCH (`10.240.251.218:5202`)** на **целевой сервер (`10.190.9.11`)**.  
Рассмотрим его структуру и ключевые отличия от первого `INVITE`.



## **1. Заголовки SIP**
| Поле | Значение | Описание |
|------|---------|----------|
| **Request-Line** | `INVITE sip:09163640234@10.190.9.11 SIP/2.0` | Запрос на вызов номера `09163640234` на сервере `10.190.9.11`. |
| **Via** | `SIP/2.0/UDP 10.240.251.218:5202;rport;branch=z9hG4bKKt5eK3rt157jK` | Указывает, что запрос идет от `10.240.251.218:5202` (UDP). `rport` — для NAT-обхода. |
| **Max-Forwards** | `68` | Уменьшено на 2 (было 70 в исходном `INVITE`). |
| **From** | `"6899" <sip:6899@10.240.251.218>;tag=p2Ua0XBKgmKHp` | Инициатор (`6899`), но теперь отображается как исходящий от FreeSWITCH. |
| **To** | `<sip:09163640234@10.190.9.11>` | Получатель (`09163640234`). |
| **Call-ID** | `f97b2d9d-7393-123e-d88a-005056011a34` | Новый Call-ID (FreeSWITCH генерирует свой). |
| **CSeq** | `95991208 INVITE` | Уникальный номер последовательности (не связан с исходным `INVITE`). |
| **Contact** | `<sip:NO_USER@10.240.251.218:5202;transport=udp;gw=4__4>` | Адрес для ответов (`NO_USER` — возможно, временный маршрут). |
| **User-Agent** | `FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~64bit` | Указывает, что запрос отправлен FreeSWITCH. |
| **Remote-Party-ID** | `"6899" <sip:6899@10.240.251.218>;party=calling;screen=yes;privacy=off` | Идентификация звонящего (`6899`). |



## **2. SDP (Session Description Protocol)**
```sdp
v=0
o=RUNTEL 1741057718 1741057719 IN IP4 10.240.251.218
s=RUNTEL
c=IN IP4 10.240.251.218
t=0 0
m=audio 32206 RTP/AVP 8 101
a=rtpmap:8 PCMA/8000
a=rtpmap:101 telephone-event/8000
a=fmtp:101 0-15
a=ptime:20
```

### **Ключевые параметры:**
- **IP-адрес медиа (`c=IN IP4`):** `10.240.251.218` (FreeSWITCH).  
- **Аудио-порт (`m=audio`):** `32206` (RTP будет идти на этот порт).  
- **Кодеки:**  
  - `8` — PCMA (G.711 A-law)  
  - `101` — DTMF (RFC 2833)  
- **ptime:** `20` (длительность пакета в мс).  



## **3. Отличия от первого `INVITE`**
| Параметр | Первый `INVITE` (от `10.190.9.11`) | Второй `INVITE` (от FreeSWITCH) |
|----------|--------------------------------|--------------------------------|
| **From** | `sip:6899@10.190.9.11` | `sip:6899@10.240.251.218` |
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11` | `f97b2d9d-7393-123e-d88a-005056011a34` |
| **CSeq** | `1` | `95991208` |
| **Contact** | `sip:6899@10.190.9.11:5060` | `sip:NO_USER@10.240.251.218:5202` |
| **SDP (IP)** | `10.190.24.40` | `10.240.251.218` |
| **Кодеки** | `PCMU, PCMA, G.729, G.723, iLBC, AMR, G.722` | Только `PCMA (8)` и `DTMF (101)` |


## **4. Проблемы в этом `INVITE`**
1. **`NO_USER` в Contact**  
   - Может указывать на временную маршрутизацию или ошибку в настройках FreeSWITCH.  

2. **Упрощенный набор кодеков**  
   - FreeSWITCH оставил только `PCMA` и `DTMF`, отфильтровав остальные. Возможно, это настройка сервера.  

3. **Проблемы с `10.190.9.11`**  
   - В логах видно, что этот `INVITE` не получил ответа (`408 Timeout`). Возможные причины:  
     - `10.190.9.11` не принимает вызовы на номер `09163640234`.  
     - NAT/Firewall блокирует RTP (`10.240.251.218:32206`).  


## **Вывод**
FreeSWITCH переслал `INVITE` на `10.190.9.11`, но не получил ответа.  
**Основные гипотезы:**  
- `10.190.9.11` не зарегистрирован/недоступен.  
- Ошибка в маршрутизации (`NO_USER` в Contact).  
- Блокировка RTP (`32206` порт).  

**Дальнейшие шаги:**  
1. Проверить, есть ли регистрация `09163640234` на `10.190.9.11`.  
2. Убедиться, что `10.190.9.11` принимает вызовы на этот номер.  
3. Проверить NAT/Firewall между серверами.  
----------------------------------------------------------------------------------------------------------------

### **Разбор SIP-ответа `183 Session Progress`**

Это промежуточный ответ, указывающий на прогресс установления сеанса. Включает SDP для раннего медиа-обмена (например, проигрывания ringback tone или обработки сигналов до ответа абонента).


## **1. Заголовки SIP**
| Поле | Значение | Описание |
|------|---------|----------|
| **Status-Line** | `SIP/2.0 183 Session Progress` | Указывает, что вызов обрабатывается, но еще не завершен. |
| **Via** | `SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp` | Маршрут ответа (обратно к `10.190.9.11:5060`). |
| **From** | `"6899" <sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r` | Инициатор вызова (`6899`). |
| **To** | `989163640234 <sip:989163640234@10.240.251.218;user=phone>;tag=re6rQmm0Hr3cp` | Получатель (`989163640234`), `tag` добавлен сервером. |
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11` | Совпадает с исходным `INVITE`. |
| **CSeq** | `1 INVITE` | Соответствует первому `INVITE`. |
| **Contact** | `<sip:989163640234@10.240.251.218:5060;transport=udp>` | Адрес для дальнейших запросов (например, `ACK`). |
| **User-Agent** | `FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~64bit` | Ответ от FreeSWITCH. |
| **Remote-Party-ID** | `"989163640234" <sip:989163640234@10.240.251.218>;party=calling;privacy=off;screen=no` | Идентификация вызываемого номера. |



## **2. SDP (Session Description Protocol)**
```sdp
v=0
o=RUNTEL 1741071970 1741071971 IN IP4 10.240.251.218
s=RUNTEL
c=IN IP4 10.240.251.218
t=0 0
m=audio 17954 RTP/AVP 8 101
a=rtpmap:8 PCMA/8000
a=rtpmap:101 telephone-event/8000
a=fmtp:101 0-15
a=ptime:20
```

### **Ключевые параметры:**
- **IP/RTP-адрес:** `10.240.251.218:17954` (FreeSWITCH).  
- **Кодеки:**  
  - `8` — PCMA (G.711 A-law)  
  - `101` — DTMF (RFC 2833)  
- **ptime:** `20` мс (длительность аудио-пакетов).  



## **3. Назначение `183 Session Progress`**
1. **Ранний медиа-поток**:  
   - Позволяет передавать аудио (например, ringback tone) до ответа абонента (`200 OK`).  
2. **Подтверждение обработки вызова**:  
   - Сервер (`10.240.251.218`) сообщает, что запрос принят и маршрутизируется.  



## **4. Контекст в текущем логе**
1. После `183` FreeSWITCH пытался доставить `INVITE` на `5202`, но не получил ответа → `408 Timeout`.  
2. **Проблема:**  
   - `183` был отправлен, но дальнейшая маршрутизация на `5202` не сработала.  
   - Возможно, `5202` порт не обрабатывает `INVITE`.  
----------------------------------------------------------------------------------------------------------------

### **Разбор повторного `INVITE` (от FreeSWITCH к получателю)**

Этот запрос является **повторной попыткой** установить вызов после получения `183 Session Progress`. Анализируем его особенности и возможные проблемы.



## **1. Ключевые изменения в запросе**
| Параметр | Первый `INVITE` (из лога) | Этот `INVITE` | Различия |
|----------|--------------------------|--------------|----------|
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag` | `f97b2d9d-7393-123e-d88a-005056011a34` | Новый идентификатор |
| **CSeq** | `1` | `95991208` | Увеличенный номер |
| **Contact** | `sip:6899@10.190.9.11:5060` | `sip:NO_USER@10.240.251.218:5202` | Подмена контакта |
| **SDP (IP)** | `10.190.24.40` | `10.240.251.218` | Изменен медиа-адрес |
| **Кодеки** | Множество (PCMU, G.729 и др.) | Только `PCMA` и `DTMF` | Фильтрация кодеков |



## **2. Проблемные моменты**
### **(1) Подозрительный Contact: `NO_USER`**
- **Что не так?**  
  Поле `Contact` содержит `NO_USER`, что нетипично для корректной SIP-маршрутизации.  
  - Может указывать на:  
    - Ошибку в настройках FreeSWITCH (например, неверный gateway).  
    - Проблему с диалпланом (не найден маршрут для номера `09163640234`).  

- **Как проверить?**  
  ```xml
  <!-- Проверка диалплана FreeSWITCH -->
  <extension name="09163640234">
    <condition field="destination_number" expression="^09163640234$">
      <action application="bridge" data="sofia/gateway/your_gw/$1"/>
    </condition>
  </extension>
  ```

### **(2) Упрощенный SDP (только PCMA)**
- FreeSWITCH отфильтровал все кодеки, кроме `PCMA/8000` и `telephone-event`.  
  - **Причина:**  
    - Настройки кодеков в FreeSWITCH (`mod_sofia`) ограничивают список.  
    - Удаленная сторона (`10.190.9.11`) в предыдущих ответах поддерживала только PCMA.  

- **Как проверить?**  
  ```bash
  # В CLI FreeSWITCH:
  sofia global codec
  ```

### **(3) Повторные отправки `INVITE`**
- В логах видно, что запрос переотправлялся 4 раза с интервалами (2, 4, 8, 16 сек).  
  - **Проблема:** Нет ответа от `10.190.9.11`.  
  - **Возможные причины:**  
    1. `10.190.9.11` не зарегистрирован или недоступен.  
    2. NAT/Firewall блокирует SIP/RTP.  
    3. Ошибка в настройках номера `09163640234` на `10.190.9.11`.  



## **3. Рекомендации по диагностике**
### **1. Проверить доступность `10.190.9.11`**
```bash
# Проверка ping:
ping 10.190.9.11

# Проверка SIP-порта (5060):
nc -zv 10.190.9.11 5060
```

### **2. Анализ логов FreeSWITCH**
```bash
# Поиск по Call-ID:
grep "f97b2d9d-7393-123e-d88a-005056011a34" /var/log/freeswitch/freeswitch.log

# Проверка ошибок маршрутизации:
grep "09163640234" /var/log/freeswitch/freeswitch.log | grep -i "fail\|error"
```

### **3. Проверка NAT/Firewall**
- Убедиться, что порты `5060` (SIP) и `32206` (RTP) открыты между серверами.  
- Если используется NAT, проверить настройки `external_rtp_ip` в FreeSWITCH:  
  ```xml
  <param name="external_rtp_ip" value="ваш_публичный_IP"/>
  ```

### **4. Проверка регистрации номера**
- Убедиться, что номер `09163640234` зарегистрирован на `10.190.9.11`:  
  ```bash
  # Для Asterisk:
  sip show peers | grep 09163640234

  # Для FreeSWITCH:
  sofia status profile internal reg
  ```
----------------------------------------------------------------------------------------------------------------

### **Разбор SIP-ответа `408 Request Timeout`**

Этот ответ указывает, что сервер (`10.240.251.218`) не получил своевременного ответа на `INVITE` от следующего узла в цепочке (вероятно, от `10.240.251.218:5202`).


## **1. Ключевые поля заголовка**
| Поле | Значение | Описание |
|------|---------|----------|
| **Status-Line** | `SIP/2.0 408 Request Timeout` | Сервер не дождался ответа на `INVITE` в течение таймаута. |
| **Via** | `SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp` | Ответ вернется к инициатору (`10.190.9.11`). |
| **From/To** | `"6899" <sip:6899@10.190.9.11>`, `989163640234 <sip:989163640234@10.240.251.218>` | Инициатор и получатель вызова. |
| **Call-ID** | `wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11` | Совпадает с исходным `INVITE`. |
| **CSeq** | `1 INVITE` | Соответствует первому `INVITE`. |
| **User-Agent** | `FreeSWITCH-mod_sofia/1.10.11-release+...` | Ответ от FreeSWITCH. |
| **Reason** | `Q.850;cause=16;text="NORMAL_CLEARING"` | Формальная причина: "нормальное завершение" (но на самом деле — таймаут). |
| **Remote-Party-ID** | `"989163640234" <sip:989163640234@10.240.251.218>` | Идентификация вызываемого номера. |



## **2. Причины `408 Request Timeout`**
1. **Нет ответа от `10.240.251.218:5202`**  
   - FreeSWITCH переслал `INVITE` на внутренний порт `5202`, но тот не ответил.  
   - Возможные причины:  
     - Сервис на `5202` не запущен.  
     - Ошибка в маршрутизации FreeSWITCH (неверный диалплан).  
     - Проблемы с NAT/Firewall.  

2. **Таймаут SIP-транзакции**  
   - FreeSWITCH ожидал ответа (например, `200 OK` или `4xx/6xx`) слишком долго.  
   - Стандартный таймаут: 32 сек (T1 × 64), но в логе видно повторные попытки через 2, 4, 8, 16 сек.  

3. **Некорректный Reason: `NORMAL_CLEARING`**  
   - Поле `Reason` содержит `cause=16` ("нормальное завершение"), но это не соответствует действительности.  
   - **Ожидалось:** `cause=102` ("таймаут") или аналогичное.  



## **3. Контекст в логе**
1. **Цепочка событий:**  
   - `INVITE` → `100 Trying` → `183 Session Progress` → Повторные `INVITE` на `5202` → `408 Timeout`.  
2. **Критическая проблема:**  
   - FreeSWITCH не смог доставить вызов на `5202`, но не смог корректно обработать ошибку.  



## **4. Рекомендации по устранению**
### **1. Проверить порт `5202`**
```bash
# Проверка, слушает ли порт:
netstat -tuln | grep 5202

# Проверка доступности:
nc -zv 10.240.251.218 5202
```

### **2. Анализ диалплана FreeSWITCH**
```xml
<!-- Пример проблемного маршрута: -->
<extension name="989163640234">
  <condition field="destination_number" expression="^989163640234$">
    <action application="bridge" data="sofia/internal/$1@10.240.251.218:5202"/>
  </condition>
</extension>
```
- **Проблема:** Возможно, указан неверный профиль (`internal`) или gateway.  

### **3. Проверить логи FreeSWITCH**
```bash
grep "wgwxpcb3brca6wg34agx9xgg9x7ab6ag" /var/log/freeswitch/freeswitch.log
```
- Ищите ошибки типа:  
  `Timeout after no final response`, `Can't find destination`, `No route to host`.  

### **4. Настройка таймеров**
- Увеличить таймауты в `sofia.conf`:  
  ```xml
  <param name="sip-timeout" value="60"/>
  ```
----------------------------------------------------------------------------------------------------------------

### **Разбор SIP-пакета ACK**  

**Строка ACK**:  
```
ACK sip:989163640234@10.240.251.218:5060;user=phone SIP/2.0
```  
Это стандартный SIP-запрос **ACK** (подтверждение), который отправлен в ответ на предыдущий SIP-диалог.  



### **Назначение ACK в данном контексте**  
1. **Подтверждение получения финального ответа (408 Request Timeout)**  
   - После серии ретрансляций `INVITE` без ответа, SIP-сервер (`10.240.251.218`) отправил **408 Request Timeout**, что означает:  
     *Сервер не получил ответа на свои `INVITE` и прекращает попытки.*  
   - В ответ на это `10.190.9.11` отправляет **ACK**, чтобы подтвердить, что `408` был получен.  

2. **Завершение SIP-транзакции**  
   - В SIP **ACK** обязателен после финального ответа (3xx, 4xx, 5xx, 6xx), но не требует ответа сам.  
   - После `ACK` сессия считается завершённой.  



### **Заголовки ACK** (из лога):  
```
Via: SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6d...  
Call-ID: wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11  
From: "6899"<sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r  
To: 989163640234 <sip:989163640234@10.240.251.218;user=phone>;tag=re6rQmm0Hr3cp  
CSeq: 1 ACK  
Max-Forwards: 70  
Content-Length: 0  
```  

#### **Ключевые моменты**:  
- **`CSeq: 1 ACK`** – подтверждение относится к той же последовательности, что и исходный `INVITE`.  
- **`Call-ID`**, **`From`**, **`To`** – совпадают с начальным запросом, что связывает `ACK` с этой сессией.  
- **`tag` в `To`** – означает, что удалённая сторона (`10.240.251.218`) участвовала в диалоге.  
- **`Content-Length: 0`** – тело сообщения пустое (в `ACK` SDP обычно не передаётся).  



### **Вывод**  
Этот **ACK** – техническое подтверждение таймаута (`408`), завершающее неудачную попытку звонка.  
**Проблема не в `ACK`**, а в том, что:  
- `INVITE` не дошли/не были обработаны (`408` = таймаут),  
- Возможные причины: **NAT, firewall, недоступность абонента, неправильная маршрутизация**.  

Если бы звонок установился, `ACK` был бы отправлен после `200 OK` (в данном случае его нет).

----------------------------------------------------------------------------------------------------------------








