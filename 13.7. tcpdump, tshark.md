### Примеры сложных команд `tcpdump` и `tshark`, использующих Berkeley Packet Filter (BPF)

#### Основные принципы фильтрации с использованием BPF:
- Фильтрация осуществляется непосредственно на уровне ядра ОС.
- Позволяет отбирать пакеты на основе множества критериев (IP адрес, порт, протокол, длина пакета и др.).
- Значительно повышает производительность захвата пакетов по сравнению с пост-фильтрацией.

---

## Примеры использования `tcpdump`

### 0. Частные случаи
```bash
sudo tcpdump -i any -A host 192.168.87.112 or host 192.168.87.113 -n
tcpdump -v -i eth2 src 192.168.56.3 and dst 192.168.96.113
tcpdump -i any -A host 192.168.96.113 or host 192.168.87.113 -n
tcpdump 'host ( 192.168.96.1 or 192.168.96.113 )' -i any
tcpdump -nn -i any host 192.168.56.3
```

### 1. Захват всех HTTP-запросов и TCP-пакетов к серверу с IP 192.168.1.10
```bash
sudo tcpdump 'tcp port http or ip host 192.168.1.10'
```
**Что делает эта команда:**  
Захватываются пакеты HTTP-трафика (`tcp port http`) и все TCP/IP-пакеты, отправленные/полученные хостом с IP 192.168.1.10.

---

### 2. Захват DNS-запросов и ответов с фильтрацией ICMP ошибок
```bash
sudo tcpdump '(udp port domain) and not icmp'
```
**Что делает эта команда:**  
Фиксируются DNS запросы и ответы (UDP-порт 53), исключаются любые ICMP-сообщения.

---

### 3. Захват UDP трафика размером больше 512 байтов между двумя серверами
```bash
sudo tcpdump 'udp and ((ip[2:2] > 512) && src host 192.168.1.100 and dst host 192.168.1.200)'
```
**Что делает эта команда:**  
Отбираются большие UDP-пакеты (размер больше 512 байт), исходящие от хоста 192.168.1.100 и направленные на хост 192.168.1.200.

---

### 4. Анализ ARP запросов на интерфейсе eth0 с указанием MAC адреса
```bash
sudo tcpdump -i eth0 arp and ether src aa:bb:cc:dd:ee:ff
```
**Что делает эта команда:**  
Анализирует ARP-запросы на сетевом интерфейсе eth0, инициированные устройством с указанным MAC-адресом.

---

### 5. Изоляция NTP-запросов на конкретной машине с фиксированным TTL
```bash
sudo tcpdump 'udp port ntp and ip[8] = 64' 
```
**Что делает эта команда:**  
Фиксируется трафик протокола NTP (порт 123), имеющий заданный TTL равный 64.

---

## Примеры использования `tshark`

### 1. Отбор пакетов с SMTP авторизацией (SMTP AUTH)
```bash
tshark -Y 'smtp.auth'
```
**Что делает эта команда:**  
Показывает только те SMTP-пакеты, которые содержат данные аутентификации пользователей (SMTP AUTH).

---

### 2. Изучение размера фрагментов IPv6
```bash
tshark -T fields -E header=y -E separator=',' -e frame.number -e ipv6.fragment_offset 'ipv6'
```
**Что делает эта команда:**  
Выдает список номеров кадров и смещения фрагмента IPv6 заголовка каждого захваченного пакета.

---

### 3. Поиск SSL/TLS handshake сообщений с фильтрацией нулевых записей сертификата
```bash
tshark -Y 'ssl.handshake.type==1 || ssl.handshake.certificate_length==0'
```
**Что делает эта команду:**  
Ищет SSL/TLS Handshake-пакеты типа Client Hello либо те, где сертификат имеет длину ноль.

---

### 4. Обнаружение подозрительных DNS запросов (например, редкие домены)
```bash
tshark -Y 'dns.flags.response==0 and dns.qry.name contains ".ru"'
```
**Что делает эта команда:**  
Ищет DNS-запросы (.ru зоны), которые являются вопросами (не ответами), потенциально помогая выявить подозрительные активности.

---

Эти команды демонстрируют возможности тонкой настройки захватов сетевого трафика с применением мощных фильтров на уровне ядра Linux/BSD. Для полного понимания рекомендуется углубленное изучение синтаксиса BPF и мануалов по использованию инструментов `tcpdump` и `tshark`.



