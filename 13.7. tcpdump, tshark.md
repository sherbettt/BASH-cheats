### Примеры сложных команд `tcpdump` и `tshark`, использующих Berkeley Packet Filter (BPF)

#### Основные принципы фильтрации с использованием BPF:
- Фильтрация осуществляется непосредственно на уровне ядра ОС.
- Позволяет отбирать пакеты на основе множества критериев (IP адрес, порт, протокол, длина пакета и др.).
- Значительно повышает производительность захвата пакетов по сравнению с пост-фильтрацией.

---

## Примеры использования `tcpdump`

### 0. Частные случаи
```bash
sudo tcpdump -i any -A host 192.168.87.112 or host 192.168.87.113 -n
tcpdump -v -i eth2 src 192.168.56.3 and dst 192.168.96.113
tcpdump -i any -A host 192.168.96.113 or host 192.168.87.113 -n
tcpdump 'host ( 192.168.96.1 or 192.168.96.113 )' -i any
tcpdump -nn -i any host 192.168.56.3
```
На машине 192.168.87.112 запускаем ping на 192.168.87.136 обязательно и смотрим лог tcpdump в реальном времени
```bash
sudo tcpdump -i any -A host 192.168.87.112 or host 192.168.87.113 -n


..	G!Ph............................ !"#$%&'()*+,-./01234567
16:51:03.239050 wlp1s0 Out IP (tos 0x0, ttl 64, id 60762, offset 0, flags [none], proto ICMP (1), length 84)
    kiko0217 > 192.168.87.112: ICMP echo reply, id 2721, seq 9, length 64
E..T.Z..@.]...W...Wp...b

```

## Подробности каждого параметра:

- **`sudo`**: запуск программы с правами суперпользователя (root), что позволяет захватывать пакеты на интерфейсах системы.
  
- **`tcpdump`**: утилита для захвата и анализа сетевых пакетов.

- **`-i any`**: означает прослушивание всех доступных сетевых интерфейсов одновременно («any»).

- **`-A`**: выводит содержимое захваченных пакетов в удобочитаемом виде ASCII, показывая весь пакет целиком (полезно для просмотра текста).

- **`host 192.168.87.112 or host 192.168.87.113`**: фильтр, задающий условие выбора пакетов — будут захваченны все пакеты, отправленные или полученные хостами с IP адресами 192.168.87.112 или 192.168.87.113.

- **`-n`**: отключает преобразование численных IP-адресов и номеров портов в имена доменов и сервисы соответственно, ускоряя обработку вывода и предотвращая дополнительные запросы DNS.

Таким образом, команда осуществляет мониторинг всех интерфейсов сети и показывает полный контент пакетов, связанных с указанными двумя хоста́ми (IP адреса).


### 1. Захват всех HTTP-запросов и TCP-пакетов к серверу с IP 192.168.1.10
```bash
sudo tcpdump 'tcp port http or ip host 192.168.1.10'
```
**Что делает эта команда:**  
Захватываются пакеты HTTP-трафика (`tcp port http`) и все TCP/IP-пакеты, отправленные/полученные хостом с IP 192.168.1.10.

---

### 2. Захват DNS-запросов и ответов с фильтрацией ICMP ошибок
```bash
sudo tcpdump '(udp port domain) and not icmp'
```
**Что делает эта команда:**  
Фиксируются DNS запросы и ответы (UDP-порт 53), исключаются любые ICMP-сообщения.

---

### 3. Захват UDP трафика размером больше 512 байтов между двумя серверами
```bash
sudo tcpdump 'udp and ((ip[2:2] > 512) && src host 192.168.1.100 and dst host 192.168.1.200)'
```
**Что делает эта команда:**  
Отбираются большие UDP-пакеты (размер больше 512 байт), исходящие от хоста 192.168.1.100 и направленные на хост 192.168.1.200.

---

### 4. Анализ ARP запросов на интерфейсе eth0 с указанием MAC адреса
```bash
sudo tcpdump -i eth0 arp and ether src aa:bb:cc:dd:ee:ff
```
**Что делает эта команда:**  
Анализирует ARP-запросы на сетевом интерфейсе eth0, инициированные устройством с указанным MAC-адресом.

---

### 5. Изоляция NTP-запросов на конкретной машине с фиксированным TTL
```bash
sudo tcpdump 'udp port ntp and ip[8] = 64' 
```
**Что делает эта команда:**  
Фиксируется трафик протокола NTP (порт 123), имеющий заданный TTL равный 64.

---

## Примеры использования `tshark`

### 1. Отбор пакетов с SMTP авторизацией (SMTP AUTH)
```bash
tshark -Y 'smtp.auth'
```
**Что делает эта команда:**  
Показывает только те SMTP-пакеты, которые содержат данные аутентификации пользователей (SMTP AUTH).

---

### 2. Изучение размера фрагментов IPv6
```bash
tshark -T fields -E header=y -E separator=',' -e frame.number -e ipv6.fragment_offset 'ipv6'
```
**Что делает эта команда:**  
Выдает список номеров кадров и смещения фрагмента IPv6 заголовка каждого захваченного пакета.

---

### 3. Поиск SSL/TLS handshake сообщений с фильтрацией нулевых записей сертификата
```bash
tshark -Y 'ssl.handshake.type==1 || ssl.handshake.certificate_length==0'
```
**Что делает эта команду:**  
Ищет SSL/TLS Handshake-пакеты типа Client Hello либо те, где сертификат имеет длину ноль.

---

### 4. Обнаружение подозрительных DNS запросов (например, редкие домены)
```bash
tshark -Y 'dns.flags.response==0 and dns.qry.name contains ".ru"'
```
**Что делает эта команда:**  
Ищет DNS-запросы (.ru зоны), которые являются вопросами (не ответами), потенциально помогая выявить подозрительные активности.

---

Для выделения и анализа ICMP-трафика используются фильтры BPF в инструментах вроде `tcpdump` и `tshark`. Ниже приведены практические примеры для извлечения и детального изучения различных видов ICMP-трафика.

### Использование **tcpdump**

#### 1. Простое отображение всего ICMP-трафика
Эта команда показывает весь ICMP-трафик, проходящий через интерфейс:
```bash
sudo tcpdump icmp
```

#### 2. Выделение ICMP Echo Request ("ping")
ICMP Echo Requests — это запросы ping, используемые для проверки доступности узла сети:
```bash
sudo tcpdump 'icmp[icmptype] == icmp-echo'
```

#### 3. Перехват ICMP Destination Unreachable сообщений
Это сообщение отправляется источником, когда узел не доступен или пакет отброшен:
```bash
sudo tcpdump 'icmp[icmptype] == icmp-unreach'
```

#### 4. Анализ больших ICMP-пакетов (PING flood)
Иногда злоумышленники используют PING-флуд атаки большими ICMP-пакетами. Эта команда позволяет увидеть такие пакеты:
```bash
sudo tcpdump 'icmp and greater 1000'
```

#### 5. Изоляция определенных типов ICMP сообщений
Например, выделяем Time Exceeded (переполнение таймера):
```bash
sudo tcpdump 'icmp[icmptype] == icmp-time-exceeded'
```

#### 6. Определение исходящих ICMP сообщений с конкретного хоста
Допустим, мы хотим видеть только исходящие ICMP от сервера с IP 192.168.1.100:
```bash
sudo tcpdump 'src host 192.168.1.100 and icmp'
```

#### 7. Показ всех входящих ICMP сообщений с определенного внешнего IP
Например, видим входящие ICMP с публичного IP:
```bash
sudo tcpdump 'dst host 192.168.1.100 and icmp'
```

#### 8. Детализация маршрута трассировки ICMP (TTL-ответы)
Команда показывает промежуточные узлы маршрутов при трассировке:
```bash
sudo tcpdump 'icmp[icmptype] == icmp-timestamp-reply'
```

### Использование **tshark**

#### 1. Общий вывод ICMP-пакетов
Простейший способ показать ICMP пакеты в удобочитаемом виде:
```bash
tshark -f 'icmp'
```

#### 2. Выделять только типы сообщений Ping request (Echo Request)
Подобная команда покажет только ICMP-пакеты типа "Ping":
```bash
tshark -Y 'icmp.type == 8'
```

#### 3. Просмотр сообщений Destination Unreachable
```bash
tshark -Y 'icmp.type == 3'
```

#### 4. Разбиение пакетов по типу
Просмотреть пакеты разных типов отдельно:
```bash
tshark -T fields -e _ws.col.Info -Y 'icmp.type in {8, 0}'
```

#### 5. Исследование большого количества ICMP echo requests (DDoS атаки)
Посмотрим количество повторяющихся эхо-запросов с одного IP:
```bash
tshark -R 'icmp.type == 8' | grep -c 'Source Address: '
```

#### 6. Подсчет числа уникальных ICMP источников
Определим число уникальных узлов, генерирующих ICMP traffic:
```bash
tshark -n -z conv,icmp
```

#### 7. Выявление возможных атак Smurf
Обнаруживаем пакеты ICMP, поступающие от широковещательных адресов (признак DDoS атака Smurf):
```bash
tshark -Y 'icmp.src == 255.255.255.255'
```
---

### Использование **wireshark**
- на роутере запустить ping на ноут 192.168.87.136;
- на ноуте запустить wireshark c фильтром `ip.addr == 192.168.87.136 && icmp` или `ip.src_host == 192.168.87.136 && icmp && ip.dst_host == 192.168.87.112`


