# Полная инструкция по установке и работе с ifupdown2

## Установка ifupdown2

```bash
# Обновление списков пакетов
epm update
# или
apt-get update

# Установка ifupdown2
epmi ifupdown2
# или
apt-get install ifupdown2 --fix-missing
```

## Проверка установки

```bash
# Проверить версию
dpkg -l ifupdown2

# Проверить доступность команд
which ifup
which ifdown
which ifquery

# Проверить версию
ifup --version
```

## Базовое использование

### Просмотр интерфейсов
```bash
# Список всех интерфейсов из конфигурации
ifquery --list

# Детальная информация о конфигурации интерфейса
ifquery vmbr0

# Проверка синтаксиса конфигурации
ifquery -a
```

### Управление интерфейсами
```bash
# Поднять интерфейс
ifup vmbr0

# Опустить интерфейс
ifdown vmbr0

# Перезагрузить интерфейс
ifreload vmbr0

# Перезагрузить все интерфейсы
ifreload -a
```

## Конфигурация сети

### Ваш текущий конфиг (/etc/network/interfaces)
```bash
# interfaces(5) file used by ifup(8) and ifdown(8)
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

auto vmbr0
iface vmbr0 inet static
    address 192.168.87.100/24
    gateway 192.168.87.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0
```

### Дополнительные полезные конфигурации

#### VLAN интерфейс
```bash
auto eth0.100
iface eth0.100 inet static
    address 192.168.100.100/24
    vlan-raw-device eth0
```

#### Bonding интерфейс
```bash
auto bond0
iface bond0 inet static
    address 192.168.87.101/24
    bond-slaves eth0 eth1
    bond-mode 802.3ad
    bond-miimon 100
```

#### DHCP клиент
```bash
auto eth1
iface eth1 inet dhcp
```

## Продвинутые команды ifupdown2

### Отладка и диагностика
```bash
# Подробный вывод
ifup -v vmbr0
ifdown -v vmbr0

# Только показать что будет сделано (не выполнять)
ifup --dry-run vmbr0

# Отладочный режим
ifup --debug vmbr0
```

### Проверка конфигурации
```bash
# Проверить все интерфейсы
ifquery -a

# Проверить конкретный интерфейс
ifquery vmbr0

# Показать конфигурацию в JSON
ifquery -t json vmbr0

# Проверить зависимости интерфейсов
ifquery -p dot vmbr0
```

### Мониторинг состояния
```bash
# Показать состояние всех интерфейсов
ip addr show

# Показать bridge
brctl show

# Показать таблицу маршрутизации
ip route show

# Показать ARP таблицу
ip neigh show
```

## Управление службой

```bash
# Включить автозагрузку
systemctl enable networking.service

# Запустить службу
systemctl start networking.service

# Перезапустить службу
systemctl restart networking.service

# Проверить статус
systemctl status networking.service

# Просмотр логов
journalctl -u networking.service
```

## Решение проблем

### Если интерфейс не поднимается
```bash
# Принудительно опустить интерфейс
ifdown --force vmbr0

# Затем поднять
ifup vmbr0

# Проверить блокировки
ps aux | grep ifup
```

### Проверка синтаксиса конфигурации
```bash
# Проверить весь файл
ifquery -a

# Проверить конкретный интерфейс
ifquery vmbr0
```

### Сброс сети
```bash
# Полный сброс всех интерфейсов
ifreload -a

# Или по отдельности
ifdown -a
ifup -a
```

## Полезные скрипты

### Автоматическая проверка сети
```bash
#!/bin/bash
# check-network.sh
echo "=== Network Interfaces ==="
ifquery --list
echo "=== IP Addresses ==="
ip addr show
echo "=== Routing Table ==="
ip route show
echo "=== Bridge Status ==="
brctl show 2>/dev/null || echo "brctl not available"
```

### Мониторинг изменений
```bash
# Следить за логами сети
journalctl -f -u networking.service

# Мониторинг состояния интерфейсов
watch -n 5 'ip addr show; echo "---"; ip route show'
```

## Важные замечания

1. **Всегда проверяйте конфигурацию** перед применением:
   ```bash
   ifquery --list
   ifquery vmbr0
   ```

2. **При работе через SSH** будьте осторожны с опусканием интерфейсов - можно потерять соединение.

3. **Используйте `--dry-run`** для тестирования изменений:
   ```bash
   ifup --dry-run vmbr0
   ```

4. **Резервное копирование** конфигурации:
   ```bash
   cp /etc/network/interfaces /etc/network/interfaces.backup
   ```

Ваша текущая конфигурация с bridge `vmbr0` выглядит корректной и служба networking работает правильно.
