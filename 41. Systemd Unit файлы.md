# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å Systemd Unit —Ñ–∞–π–ª–∞–º–∏

## –ò–µ—Ä–∞—Ä—Ö–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ systemd

```
/etc/systemd/system/    ‚Üê ü•á –í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
/run/systemd/system/    ‚Üê ü•à –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)  
/lib/systemd/system/    ‚Üê ü•â –ù–ò–ó–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã)
```

## –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è unit —Ñ–∞–π–ª–æ–≤

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ `systemctl edit` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**
```bash
# –°–æ–∑–¥–∞–µ—Ç override –∫–æ–Ω—Ñ–∏–≥ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
systemctl edit haproxy

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç:
# /etc/systemd/system/haproxy.service.d/override.conf
```

### **–°–ø–æ—Å–æ–± 2: –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ override**
```bash
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è override
mkdir -p /etc/systemd/system/haproxy.service.d/

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª override
mcedit /etc/systemd/system/haproxy.service.d/override.conf
```

### **–°–ø–æ—Å–æ–± 3: –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ unit (—Ä–µ–¥–∫–∏–µ —Å–ª—É—á–∞–∏)**
```bash
# –ö–æ–ø–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π unit –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
cp /lib/systemd/system/haproxy.service /etc/systemd/system/haproxy.service

# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é
mcedit /etc/systemd/system/haproxy.service
```

## –ß—Ç–æ –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤ override

### **‚úÖ –ú–û–ñ–ù–û –∏ –ù–£–ñ–ù–û –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å:**

#### **1. –õ–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤**
```ini
[Service]
LimitNOFILE=65536
LimitNPROC=4096
LimitMEMLOCK=infinity
```

#### **2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```ini
[Service]
Environment=CONFIG=/etc/haproxy/haproxy.cfg
Environment=PIDFILE=/run/haproxy.pid
Environment=EXTRAOPTS="-S /run/haproxy-master.sock"
```

#### **3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
```ini
[Service]
NoNewPrivileges=true
ProtectHome=true
ProtectSystem=strict
```

#### **4. –¢–∞–π–º–∞—É—Ç—ã –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏**
```ini
[Service]
TimeoutStartSec=300
TimeoutStopSec=30
Restart=always
RestartSec=5
```

#### **5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –≥—Ä—É–ø–ø–∞**
```ini
[Service]
User=_haproxy
Group=_haproxy
```

### **‚ùå –ù–ï–õ–¨–ó–Ø –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å (–∏–ª–∏ –Ω—É–∂–Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ):**

#### **1. –ò–º—è —Å–ª—É–∂–±—ã –∏ –æ–ø–∏—Å–∞–Ω–∏–µ**
```ini
# ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ override:
[Unit]
Description=My Custom HAProxy  # ‚Üê –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
```

#### **2. –û—Å–Ω–æ–≤–Ω—ã–µ Exec –∫–æ–º–∞–Ω–¥—ã (–ª—É—á—à–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)**
```ini
# ‚ùå –ü–õ–û–•–û - –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É:
ExecStart=/usr/local/sbin/haproxy -my-custom-flags  # ‚Üê –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

# ‚úÖ –•–û–†–û–®–û - —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
Environment=EXTRAOPTS="-my-custom-flags"
ExecStart=/usr/sbin/haproxy -Ws -f $CONFIG -p $PIDFILE $EXTRAOPTS
```

#### **3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —é–Ω–∏—Ç–∞–º–∏**
```ini
# ‚ùå –ú–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
[Unit]
Wants=network-online.target
After=network.target
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö override

### **–ü—Ä–∏–º–µ—Ä 1: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è HAProxy**
```ini
[Service]
# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
LimitNOFILE=65536

# –õ–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏
LimitMEMLOCK=infinity

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
Environment=EXTRAOPTS="-S /run/haproxy-master.sock"
```

### **–ü—Ä–∏–º–µ—Ä 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤**
```ini
[Service]
# –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
Restart=always
RestartSec=5

# –¢–∞–π–º–∞—É—Ç—ã
TimeoutStartSec=300
TimeoutStopSec=30

# –õ–∏–º–∏—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
LimitNPROC=4096
```

### **–ü—Ä–∏–º–µ—Ä 3: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∏–∑–æ–ª—è—Ü–∏—è**
```ini
[Service]
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
NoNewPrivileges=true
ProtectHome=true
ProtectSystem=strict

# –§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã
ReadWritePaths=/var/lib/haproxy
ReadOnlyPaths=/etc/haproxy
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞ unit —Ñ–∞–π–ª–æ–≤

### **–ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Ç–æ–≥–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
systemctl cat haproxy.service

# –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç–∏ –∫ –∫–æ–Ω—Ñ–∏–≥–∞–º
systemctl show haproxy -p FragmentPath,DropInPaths

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
systemctl show haproxy -p LimitNOFILE,Restart,Environment
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å unit —Ñ–∞–π–ª–∞
systemd-analyze verify /etc/systemd/system/haproxy.service.d/override.conf

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ unit —Ñ–∞–π–ª—ã —Å–ª—É–∂–±—ã
systemd-analyze verify /lib/systemd/system/haproxy.service /etc/systemd/system/haproxy.service.d/override.conf
```

### **–û—Ç–ª–∞–¥–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
systemctl list-dependencies haproxy.service

# –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫
systemctl --failed
```

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

### **‚ùå –û–®–ò–ë–ö–ê: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /lib/systemd/system/**
```bash
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
mcedit /lib/systemd/system/haproxy.service

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
systemctl edit haproxy
```

### **‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**
```bash
# ‚ùå –ò–ó–ë–´–¢–û–ß–ù–û
cp /lib/systemd/system/haproxy.service /etc/systemd/system/haproxy.service

# ‚úÖ –î–û–°–¢–ê–¢–û–ß–ù–û
systemctl edit haproxy  # —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

### **‚ùå –û–®–ò–ë–ö–ê: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –≤ override**
```ini
# ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ override:
[Unit]
Description=My Service  # ‚Üê –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è

[Install]  
WantedBy=multi-user.target  # ‚Üê –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è

# ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ override:
[Service]
LimitNOFILE=65536  # ‚Üê –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
Environment=DEBUG=1  # ‚Üê –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
```

## Best Practices

### **1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `systemctl edit`**
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
systemctl edit service-name
```

### **2. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**
```ini
# –ò–∑–º–µ–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ
[Service]
LimitNOFILE=65536
# –û—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º unit
```

### **3. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
```ini
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –∂–µ—Å—Ç–∫–∏—Ö –ø—É—Ç–µ–π
Environment=CONFIG=/etc/haproxy/haproxy.cfg
ExecStart=/usr/sbin/haproxy -Ws -f $CONFIG
```

### **4. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**
```ini
# Custom limits for high-load PostgreSQL
[Service]
LimitNOFILE=65536    # Allow 65k concurrent connections
LimitMEMLOCK=infinity # Required for large buffers
```

### **5. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
systemctl daemon-reload

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ª—É–∂–±—É
systemctl status service-name

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫—É
systemctl restart service-name
```

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `/etc/systemd/system/` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ **–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ** `systemctl edit` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è override
- ‚úÖ **–ò–∑–º–µ–Ω—è–π—Ç–µ** —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `[Service]` –≤ override
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ** —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º unit
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤ production
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ** –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚ùå **–ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ** —Ñ–∞–π–ª—ã –≤ `/lib/systemd/system/`
- ‚ùå **–ù–µ –∫–æ–ø–∏—Ä—É–π—Ç–µ** –ø–æ–ª–Ω—ã–µ unit —Ñ–∞–π–ª—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚ùå **–ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ** —Å–µ–∫—Ü–∏–∏ `[Unit]` –∏ `[Install]` –≤ override

------------------------------------------------------------------------

