### Использование утилиты `mount` в Linux
Утилита `mount` используется для подключения файловых систем (разделов дисков, сетевых ресурсов и т.д.) к каталогу в файловой системе Linux.

#### Основные команды:
1. **Просмотр всех смонтированных файловых систем**  
   ```bash
   mount
   ```
   - **Фильтрация вывода** (например, только ext4):  
     ```bash
     mount -t ext4
     ```
     ```bash
     # фильтрация по типу файловой системы
     mount | grep -E '^/dev'
     ```

2. **Монтирование устройства**  
   ```bash
   mount /dev/sdX# /путь/к/точке_монтирования
   ```
   - Пример:  
     ```bash
     mount /dev/sdb1 /mnt/mydrive
     ```

3. **Монтирование с указанием типа файловой системы**  
   ```bash
   mount -t тип_фс /dev/sdX# /точка_монтирования
   ```
   - Пример (для NTFS):  
     ```bash
     mount -t ntfs /dev/sdc1 /mnt/win
     ```

4. **Монтирование с опциями**  
   ```bash
   mount -o опции /dev/sdX# /точка_монтирования
   ```
   - Примеры опций:  
     ```bash
     mount -o ro /dev/sdb1 /mnt/readonly  # только для чтения
     mount -o remount,rw /                 # перемонтировать корень в режиме записи
     ```

5. **Монтирование всех файловых систем из `/etc/fstab`**  
   ```bash
   mount -a
   ```

6. **Размонтирование**  
   ```bash
   umount /точка_монтирования  # или
   umount /dev/sdX#
   ```

---

### Использование утилиты `findmnt` в Linux
Утилита `findmnt` отображает информацию о смонтированных файловых системах в удобном формате (в виде дерева или списка).

#### Основные команды:
1. **Вывод всех смонтированных ФС в виде дерева**  
   ```bash
   findmnt
   ```

2. **Вывод в виде списка**  
   ```bash
   findmnt -l
   ```

3. **Поиск по точке монтирования**  
   ```bash
   findmnt /точка_монтирования
   ```
   - Пример:  
     ```bash
     findmnt /mnt/mydrive
     ```

4. **Поиск по устройству**  
   ```bash
   findmnt /dev/sdX#
   ```
   - Пример:  
     ```bash
     findmnt /dev/sdb1
     ```

5. **Фильтрация по типу файловой системы**  
   ```bash
   findmnt -t тип_фс
   ```
   - Пример (показать все NFS):  
     ```bash
     findmnt -t nfs
     ```

6. **Вывод информации в JSON**  
   ```bash
   findmnt --json
   ```

7. **Поиск в `/etc/fstab`** (не смонтированные ресурсы)  
   ```bash
   findmnt --fstab
   ```

---

### Примеры совместного использования:
1. **Монтирование и проверка**  
   ```bash
   mount /dev/sdb1 /mnt/data && findmnt /mnt/data
   ```

2. **Поиск всех смонтированных ext4-разделов**  
   ```bash
   findmnt -t ext4
   ```

3. **Проверка занятости точки монтирования перед размонтированием**  
   ```bash
   findmnt /mnt/data  # Проверяем, смонтировано ли устройство
   umount /mnt/data   # Размонтируем, если нет активности
   ```
----------------------------------

Конкретный пример с Jira кластером из статьи [Настройка Jira Data Center cluster](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/18.%20Настройка%20Jira%20Data%20Center%20cluster.md)

### Анализ текущего состояния NFS-монтирований:

**На всех узлах (prox4, pmx5, pmx6) наблюдаются следующие проблемы:**

1. **Дублирование монтирований**:
   - На prox4 и pmx6 есть несколько монтирований одной и той же NFS-шары в одни и те же точки:
     - `/mnt/pve/nfs_storage` монтируется и с 192.168.87.17, и с 192.168.87.3
     - `/mnt/share` на pmx6 монтируется и с 192.168.87.17, и с 192.168.87.3

2. **Несогласованность параметров**:
   - На prox4 и pmx5 `/mnt/share` использует `soft` монтирование
   - На pmx6 `/mnt/share` использует `hard` монтирование
   - Разные узлы используют разные IP для монтирования (17, 3)

3. **Смешанное использование IP**:
   - Используется как прямой IP (192.168.87.17), так и плавающий (192.168.87.3)

### Рекомендуемые исправления:

1. **Для всех узлов**:
   ```bash
   umount /mnt/pve/nfs_storage
   umount /mnt/pve/nfs-storage  # только на prox4
   umount /mnt/share
   ```

2. **Изменить /etc/fstab** на всех узлах для единообразия:

   Рекомендуемый вариант (используя плавающий IP):
   ```
   192.168.87.3:/stg/8tb/share  /mnt/pve/nfs_storage  nfs  rw,hard,intr,noatime,vers=4.2,timeo=600,retrans=2  0 0
   192.168.87.3:/stg/8tb/share  /mnt/share            nfs  rw,hard,intr,noatime,vers=4.2,timeo=600,retrans=2  0 0
   ```

   ИЛИ (если предпочитаете прямой доступ):
   ```
   # Для prox4:
   192.168.87.17:/stg/8tb/share  /mnt/pve/nfs_storage  nfs  rw,hard,intr,noatime,vers=4.2  0 0
   
   # Для pmx5:
   192.168.87.20:/stg/8tb/share  /mnt/pve/nfs_storage  nfs  rw,hard,intr,noatime,vers=4.2  0 0
   
   # Для pmx6:
   192.168.87.6:/stg/8tb/share   /mnt/pve/nfs_storage  nfs  rw,hard,intr,noatime,vers=4.2  0 0
   ```

3. **После правки fstab** выполнить:
   ```bash
   systemctl daemon-reload
   mount -a
   ```

### Почему такие рекомендации:

1. **Только один источник монтирования** для каждой точки - либо плавающий IP, либо конкретный узел.

2. **Единые параметры** на всех узлах:
   - `hard` - более надежный вариант для NFS
   - `intr` - позволяет прервать зависшие операции
   - `noatime` - уменьшает нагрузку

3. **Удаление дубликатов** - предотвращает возможные конфликты и путаницу.

4. **Согласованность** - все узлы работают по одной схеме.

Для Proxmox кластера лучше использовать вариант с плавающим IP (192.168.87.3), так как это обеспечит автоматическое переключение при сбоях.
