### Использование утилиты `mount` в Linux
Утилита `mount` используется для подключения файловых систем (разделов дисков, сетевых ресурсов и т.д.) к каталогу в файловой системе Linux.

#### Основные команды:
1. **Просмотр всех смонтированных файловых систем**  
   ```bash
   mount
   ```
   - **Фильтрация вывода** (например, только ext4):  
     ```bash
     mount -t ext4
     ```
     ```bash
     # фильтрация по типу файловой системы
     mount | grep -E '^/dev'
     ```

2. **Монтирование устройства**  
   ```bash
   mount /dev/sdX# /путь/к/точке_монтирования
   ```
   - Пример:  
     ```bash
     mount /dev/sdb1 /mnt/mydrive
     ```

3. **Монтирование с указанием типа файловой системы**  
   ```bash
   mount -t тип_фс /dev/sdX# /точка_монтирования
   ```
   - Пример (для NTFS):  
     ```bash
     mount -t ntfs /dev/sdc1 /mnt/win
     ```

4. **Монтирование с опциями**  
   ```bash
   mount -o опции /dev/sdX# /точка_монтирования
   ```
   - Примеры опций:  
     ```bash
     mount -o ro /dev/sdb1 /mnt/readonly  # только для чтения
     mount -o remount,rw /                 # перемонтировать корень в режиме записи
     ```

5. **Монтирование всех файловых систем из `/etc/fstab`**  
   ```bash
   mount -a
   ```

6. **Размонтирование**  
   ```bash
   umount /точка_монтирования  # или
   umount /dev/sdX#
   ```

---

### Использование утилиты `findmnt` в Linux
Утилита `findmnt` отображает информацию о смонтированных файловых системах в удобном формате (в виде дерева или списка).

#### Основные команды:
1. **Вывод всех смонтированных ФС в виде дерева**  
   ```bash
   findmnt
   ```

2. **Вывод в виде списка**  
   ```bash
   findmnt -l
   ```

3. **Поиск по точке монтирования**  
   ```bash
   findmnt /точка_монтирования
   ```
   - Пример:  
     ```bash
     findmnt /mnt/mydrive
     ```

4. **Поиск по устройству**  
   ```bash
   findmnt /dev/sdX#
   ```
   - Пример:  
     ```bash
     findmnt /dev/sdb1
     ```

5. **Фильтрация по типу файловой системы**  
   ```bash
   findmnt -t тип_фс
   ```
   - Пример (показать все NFS):  
     ```bash
     findmnt -t nfs
     ```

6. **Вывод информации в JSON**  
   ```bash
   findmnt --json
   ```

7. **Поиск в `/etc/fstab`** (не смонтированные ресурсы)  
   ```bash
   findmnt --fstab
   ```

---

### Примеры совместного использования:
1. **Монтирование и проверка**  
   ```bash
   mount /dev/sdb1 /mnt/data && findmnt /mnt/data
   ```

2. **Поиск всех смонтированных ext4-разделов**  
   ```bash
   findmnt -t ext4
   ```

3. **Проверка занятости точки монтирования перед размонтированием**  
   ```bash
   findmnt /mnt/data  # Проверяем, смонтировано ли устройство
   umount /mnt/data   # Размонтируем, если нет активности
   ```
----------------------------------

Конкретный пример с Jira кластером из статьи [Настройка Jira Data Center cluster](https://github.com/sherbettt/BASH-cheats/blob/main/System%20engineering/18.%20Настройка%20Jira%20Data%20Center%20cluster.md)

### Полная последовательность настройки отказоустойчивого NFS-кластера с плавающим IP

#### 1. Подготовка всех узлов (prox4, pmx5, pmx6)

**На всех серверах выполнить:**

```bash
# Остановить все NFS-монтирования
umount /mnt/share 2>/dev/null
umount /mnt/pve/nfs_storage 2>/dev/null
umount /mnt/pve/nfs-storage 2>/dev/null

# Установить необходимые пакеты
apt update && apt install -y nfs-kernel-server keepalived
```

#### 2. Настройка NFS-сервера

**На всех узлах редактируем `/etc/exports`:**

```bash
cat > /etc/exports <<EOF
/stg/8tb/share 192.168.87.0/24(rw,sync,no_subtree_check,no_root_squash)
EOF

# Применяем изменения
exportfs -ra
systemctl restart nfs-kernel-server
```

#### 3. Настройка Keepalived для плавающего IP

**На prox4 (основной узел) `/etc/keepalived/keepalived.conf`:**

```bash
cat > /etc/keepalived/keepalived.conf <<EOF
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass secret_password
    }
    virtual_ipaddress {
        192.168.87.3/24
    }
}
EOF
```

**На pmx5 (резервный узел) `/etc/keepalived/keepalived.conf`:**

```bash
cat > /etc/keepalived/keepalived.conf <<EOF
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass secret_password
    }
    virtual_ipaddress {
        192.168.87.3/24
    }
}
EOF
```

**На pmx6 (резервный узел) `/etc/keepalived/keepalived.conf`:**

```bash
cat > /etc/keepalived/keepalived.conf <<EOF
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 80
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass secret_password
    }
    virtual_ipaddress {
        192.168.87.3/24
    }
}
EOF
```

**Запускаем Keepalived на всех узлах:**

```bash
systemctl enable --now keepalived
systemctl status keepalived
```

#### 4. Настройка монтирования NFS

**На всех узлах правим `/etc/fstab`:**

```bash
# Резервное копирование текущего fstab
cp /etc/fstab /etc/fstab.bak

# Записываем новые параметры
cat >> /etc/fstab <<EOF
192.168.87.3:/stg/8tb/share /mnt/share nfs rw,hard,intr,noatime,vers=4.2,_netdev,timeo=300,retrans=3 0 0
192.168.87.3:/stg/8tb/share /mnt/pve/nfs_storage nfs rw,hard,intr,noatime,vers=4.2,_netdev,timeo=300,retrans=3 0 0
EOF

# Применяем изменения
systemctl daemon-reload
mount -a
```

#### 5. Проверка работы

**На всех узлах выполняем проверки:**

```bash
# Проверка плавающего IP
ip addr show eth0 | grep 192.168.87.3

# Проверка NFS-экспортов
showmount -e localhost

# Проверка монтирований
mount | grep nfs
df -h /mnt/share /mnt/pve/nfs_storage

# Тест записи
touch /mnt/share/test_file && rm -f /mnt/share/test_file
```

#### 6. Настройка мониторинга

**Создаем скрипт для проверки `/usr/local/bin/check_nfs.sh`:**

```bash
cat > /usr/local/bin/check_nfs.sh <<'EOF'
#!/bin/bash
if ! mountpoint -q /mnt/share; then
    systemctl restart nfs-client.target
    mount -a
fi
EOF

chmod +x /usr/local/bin/check_nfs.sh
```

**Добавляем в cron (на всех узлах):**

```bash
(crontab -l 2>/dev/null; echo "*/5 * * * * /usr/local/bin/check_nfs.sh") | crontab -
```

#### 7. Тестирование отказоустойчивости

1. На активном узле (где висит 192.168.87.3):
```bash
systemctl stop keepalived
```
2. Проверить переход IP на другой узел (должно занять 1-3 секунды)
3. Проверить доступность NFS:
```bash
ls /mnt/share
```

#### 8. Финализация

**На всех узлах:**
```bash
# Перезагружаем серверы по очереди для проверки автоматического поднятия
reboot
```

