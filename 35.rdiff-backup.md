## Установка и проверка
1. Установить rdiff-backup на все машины, которые должны "общаться" друг с другом.
2. На машинах серверах rdiff-backup создать директорию /backups/jira-data.
3. Проверить права и доступ директорий.
4. Создать ключи и раскидать по машинам:
   ```bash
   ssh-keygen -t rsa -b 4096 -f ~/.ssh/jira_backup_key
   ssh-copy-id -i ~/.ssh/jira_backup_key.pub root@192.168.46.2  # jira-cluster
   ssh-copy-id -i ~/.ssh/jira_backup_key.pub root@192.168.46.3  # jira-node
   ssh-copy-id -i ~/.ssh/jira_backup_key.pub root@192.168.46.4  # jira-node2
   ```
<br/>


## BackUP на удалённую машину
Бэкап делается на удалённый хост с "железной" машины ProxMox:
```bash
# на prox4 выполняем
rdiff-backup --new backup  /stg/8tb/share/ root@192.168.87.99::/usr/local/runtel/storage_files/rdiff/jira/
```
<br/>


## BackUP на машину Container 101 (backup) (192.168.87.99)
Учитывая, что у нас есть плавающий IP=192.168.87.99, прикреплённый к "железным" машинам (pmx5, pmx6, prox4), требуется делать бэкап с них на машину backup.
<details>
<summary>❗ 192.168.87.20{17|6}:/etc/fstab и /etc/crontab ❗</summary>
   
```bash
UUID=acdede8e-da58-46a5-9a3a-b688ad784f48 /               ext4    errors=remount-ro 0       1
# /boot/efi was on /dev/nvme1n1p1 during installation
UUID=D369-7F43  /boot/efi       vfat    umask=0077      0       1
# /home was on /dev/nvme1n1p2 during installation
UUID=b4b6b626-038a-4608-bc96-5e891c3afe94 /home           ext4    defaults        0       2
# /stg/8tb was on /dev/md0 during instalation
UUID=10575088-4877-46f2-b52e-c7a8f015bfe4 /stg/8tb        ext4    defaults        0       2
UUID=f67bed35-dbb5-4fca-bee6-69a22ef9ae6d /stg/1tb   ext4   defaults    0   0
192.168.87.3:/stg/8tb/share/    /mnt/share/    nfs    rw,bg,soft,intr,nosuid    0 0
```
```bash
*/5 *   * * *   root rsync -avP root@192.168.87.3:/stg/8tb/share/ /stg/8tb/share/
```
</details>

Делаем бекап:
```bash

```






<br/>


## Если нужно сделать бэкап только каталога `/var/atlassian/application-data/jira` с сервера `jira-cluster` (192.168.46.2), на pmx*, prox*
### Базовая команда для бэкапа только данных Jira:
```bash
rdiff-backup --remote-schema 'ssh -i /root/.ssh/jira_backup_key -C %s rdiff-backup --server' \
root@192.168.46.2::/var/atlassian/application-data/jira /backups/jira-data
```

### Оптимизированная версия с исключением временных файлов:
```bash
rdiff-backup -v5 \
 --remote-schema 'ssh -i /root/.ssh/jira_backup_key -C %s rdiff-backup --server' \
 --exclude '**/tmp' \
 --exclude '**/cache' \
 --exclude '**/logs' \
 root@192.168.46.2::/var/atlassian/application-data/jira /backups/jira-data
```
```bash
rdiff-backup -v5 \
--remote-schema 'ssh -i /root/.ssh/jira_backup_key -C %s rdiff-backup --server' \
--exclude '**/tmp' \
--exclude '**/cache' \
--exclude '**/logs' \
root@192.168.46.2::/var/atlassian/application-data/jira/monitor /backups/jira-data/monitor
```


### Ключевые моменты:
1. **Источник**: `root@192.168.46.2::/var/atlassian/application-data/jira`
2. **Цель**: `/backups/jira-data` на локальном сервере (prox4)
3. **SSH-ключ**: Должен быть заранее настроен и проверен

### Дополнительные рекомендации:

1. **Проверьте доступ к каталогу** на jira-cluster:
```bash
ssh root@192.168.46.2 "ls -ld /var/atlassian/application-data/jira"
ssh -i /root/.ssh/jira_backup_key root@192.168.46.2 "ls -la /var/atlassian/application-data/jira/monitor"
```

2. **Для автоматизации** добавьте в cron (ежедневно в 2:00):
```bash
0 2 * * * /usr/bin/rdiff-backup --remote-schema 'ssh -i /root/.ssh/jira_backup_key -C %s rdiff-backup --server' root@192.168.46.2::/var/atlassian/application-data/jira /backups/jira-data >> /var/log/jira_backup.log 2>&1
```
```bash
# Ежедневный бэкап в 3:00
0 3 * * * /usr/bin/rdiff-backup --exclude /tmp --exclude /proc --exclude /sys --exclude /dev \
--remote-schema 'ssh -i /root/.ssh/jira_backup_key %s rdiff-backup --server' \
root@192.168.46.2::/ /backups/jira/cluster >> /var/log/jira_backup.log 2>&1
```

3. **Для восстановления** данных:
```bash
rdiff-backup -r now /backups/jira-data /path/to/restore
rdiff-backup root@192.168.46.2::/var/atlassian /backups/jira-data
```

4. **Если Jira работает**, рассмотрите:
- Остановку службы перед бэкапом
- Использование `--exclude '**/data'` для исключения томных файлов данных
- Отдельный бэкап базы данных

5. **Управление бэкапами** данных:
```bash
rdiff-backup --list-increments /backups/jira/cluster
```

----------------------------------------------------------

Вот оптимальная конфигурация для `/etc/crontab` для автоматического бэкапа Jira через `rdiff-backup`:

```bash
# /etc/crontab - автоматические бэкапы Jira
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Бэкап данных Jira ежедневно в 2:30 ночи
30 2 * * * root /usr/bin/rdiff-backup \
    --remote-schema 'ssh -i /root/.ssh/jira_backup_key -C %s rdiff-backup --server' \
    --exclude '**/tmp' \
    --exclude '**/cache' \
    --exclude '**/logs' \
    root@192.168.46.2::/var/atlassian/application-data/jira \
    /backups/jira-data \
    >> /var/log/jira_backup.log 2>&1

# Очистка старых бэкапов (старше 30 дней) по воскресеньям в 3:00
0 3 * * 0 root /usr/bin/rdiff-backup --remove-older-than 30D --force /backups/jira-data \
    >> /var/log/jira_backup_clean.log 2>&1
```

### Ключевые элементы:

1. **Расписание**:
   - Основной бэкап: ежедневно в 2:30
   - Очистка: каждое воскресенье в 3:00

2. **Параметры**:
   - `ssh -i` - использует SSH-ключ для аутентификации
   - `--exclude` - исключает временные файлы
   - `>> /var/log/...` - логирование

3. **Дополнительные рекомендации**:

Добавьте в начало скрипта проверку места на диске:
```bash
#!/bin/bash
MIN_SPACE=10 # Минимум 10GB свободного места
AVAIL=$(df -BG /backups | awk 'NR==2 {print $4}' | tr -d 'G')

if [ "$AVAIL" -lt "$MIN_SPACE" ]; then
    echo "Ошибка: Недостаточно места на диске ($AVAIL GB)" >> /var/log/jira_backup.log
    exit 1
fi
```

Для мониторинга добавьте проверку статуса в cron:
```bash
# Проверка успешности бэкапа ежедневно в 6:00
0 6 * * * root /usr/local/bin/check_jira_backup.sh
```

Где `check_jira_backup.sh`:
```bash
#!/bin/bash
LOG=/var/log/jira_backup.log
ERROR_MSG="ERROR|WARNING"

if grep -qE "$ERROR_MSG" "$LOG"; then
    echo "Обнаружены ошибки в последнем бэкапе Jira" | mail -s "Jira Backup Alert" admin@example.com
fi
```

Эта конфигурация обеспечит:
- Регулярные бэкапы без перезаписи
- Автоматическую очистку старых данных
- Логирование и мониторинг ошибок
- Проверку свободного места
