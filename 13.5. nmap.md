Утилита `nmap` — это мощный инструмент сетевого сканирования и аудита безопасности, используемый преимущественно в Linux системах, хотя доступна также версия для Windows. Она позволяет находить активные устройства, определяя открытые порты, версии сервисов, операционные системы и даже обнаруживать уязвимости на удалённых хостах.

### Основные цели использования `nmap`

- **Сканирование сети**: проверка активных устройств и открытых портов.
- **Определение ОС**: попытка определить версию операционной системы удалённого хоста.
- **Обнаружение служб**: определение запущенных сервисов и версий программного обеспечения.
- **Проверка безопасности**: выявление потенциальных уязвимостей путём анализа полученных результатов.

---

## Примеры использования

### Простые команды:

1. **Базовое сканирование сети**  
   Сканы одного конкретного IP адреса или диапазона адресов:
   
```bash
nmap 192.168.1.1
```

Или диапазон адресов:

```bash
nmap 192.168.1.1-254
```

2. **Сканирование всех открытых TCP-портов**  
   По умолчанию Nmap проверяет около тысячи наиболее популярных портов. Для полного списка используется ключ `-p-`.

```bash
nmap -sT -p- 192.168.1.1
```

3. **Определение версии службы**  
   Определение конкретных версий сервисов на открытых портах:

```bash
nmap -sV 192.168.1.1
```

4. **Определить операционную систему**  
   Пытаемся определить операционную систему удаленного хоста:

```bash
nmap -O 192.168.1.1
```

5. **Быстрое сканирование**  
   Если скорость важна больше точности, можно воспользоваться режимом быстрого сканирования (`-F`) и ограничением количества пакетов (`--min-rate`), ускоряя процесс:

```bash
nmap -F --min-rate=1000 192.168.1.1
```

---

### Более продвинутые команды:

1. **Использование скриптов NSE (Nmap Script Engine)**  
   Включаем использование встроенных сценариев для проверки уязвимостей и сбора дополнительной информации:

```bash
nmap --script vuln 192.168.1.1
```

Это запускает сценарии для обнаружения известных уязвимостей.

2. **Интерактивная трассировка маршрута**  
   Трассируем путь пакета от текущего узла до целевого хоста, используя ICMP эхо-запросы:

```bash
nmap --traceroute 192.168.1.1
```

3. **Полный SYN scan + OS detection + service version discovery**  
   Запускаем полный SYN scan с определением версии сервиса и ОС одновременно:

```bash
nmap -sS -A 192.168.1.1
```

4. **Скрытое сканирование**  
   Использование флага ACK, позволяющего обойти некоторые брандмауэры:

```bash
nmap -sA 192.168.1.1
```

5. **UDP scanning**  
   UDP-порты сложнее проверять, поскольку большинство запросов остаются без ответа. Но вот пример, как проверить первые 1000 UDP-портов:

```bash
nmap -sU -p1-1000 192.168.1.1
```

6. **Выделение целей по имени домена**  
   Вместо простого IP-адреса можно указывать DNS имя хоста:

```bash
nmap example.com
```

7. **Отчётность и сохранение результата**  
   Сохраняем вывод в удобочитаемом виде в файл:

```bash
nmap -oN output.txt 192.168.1.1
```

или XML формат для последующей обработки автоматизированными инструментами:

```bash
nmap -oX output.xml 192.168.1.1
```

---

Вот дополнительные сложные примеры использования утилиты `nmap`, демонстрирующие её возможности и гибкость конфигурации:

## Сложные примеры команд Nmap

### 1. Комбинированное сканирование SYN+ACK
Этот метод сочетает два типа сканирования: SYN и ACK. Это помогает обходить определённые виды фильтрации пакетов и улучшает шансы на успешное обнаружение порта:

```bash
nmap -sSA 192.168.1.1
```

### 2. Рандомизация порядка сканируемых портов
Чтобы затруднить распознавание сканера защитными механизмами, можно рандомизировать порядок проверок портов:

```bash
nmap -f --randomize-hosts 192.168.1.1
```

### 3. Параллельное сканирование нескольких сетей
Иногда полезно провести быстрое массовое сканирование сразу нескольких сетей или отдельных узлов:

```bash
nmap -iL targets.txt
```

Здесь `targets.txt` — это список IP адресов или диапазонов адресов.

### 4. Детектирование особенностей оборудования
Используя Nmap можно попытаться выявить аппаратные характеристики удалённой машины, такие как производитель железа, CPU и другие низкоуровневые данные:

```bash
nmap -O --osscan-guess 192.168.1.1
```

### 5. Медленное сканирование (для предотвращения блокировки)
Если цель имеет защиту против массовых сканирований, можно замедлить процесс отправки пакетов, делая менее заметным атаку:

```bash
nmap --max-retries 10 --host-timeout 1h --max-rtt-timeout 1m --initial-rtt-timeout 10ms --min-hostgroup 5 --min-parallelism 5 192.168.1.1
```

Эта команда уменьшает количество повторений попыток подключения и растягивает выполнение операции на длительное время.

### 6. Фрагментация пакетов
Некоторые файрволлы плохо обрабатывают фрагментированные пакеты, что даёт возможность проникнуть внутрь защищенной сети:

```bash
nmap -f -MTU 16 192.168.1.1
```

Флаг `-f` включает фрагментацию, а аргумент `-MTU` задаёт размер MTU каждого фрагмента.

### 7. Обход защиты файрволлов с использованием FTP bounce attack
FTP bounce атака возможна благодаря специфической особенности протокола FTP. Она позволяет пробовать обойти ограничения файрволла:

```bash
nmap -b ftp.example.com 192.168.1.1
```

### 8. Ограниченный временной интервал для выполнения задания
Можно задать жёсткое ограничение по времени, отведённому на завершение сканирования. Например, завершить операцию через 3 минуты независимо от статуса завершения:

```bash
nmap --timings 3m 192.168.1.1
```

### 9. Отключение механизма DNS разрешения имен
Иногда DNS запросы замедляют процесс сканирования или раскрывают личность атакующего. Можно отключить этот механизм, увеличив производительность:

```bash
nmap -n 192.168.1.1
```

### 10. Имитация легитимного трафика
Имитация трафика популярного браузера или другого приложения делает вашу активность похожей на обычный трафик:

```bash
nmap --spoof-mac="Microsoft" --data-length=500 --badsum 192.168.1.1
```

### 11. Выявление медленных машин и неполадок сети
Можно быстро обнаружить проблемы с оборудованием или качеством соединения:

```bash
nmap --packet-trace --reason --version-all 192.168.1.1
```

Команда показывает детальную информацию о каждом пакете и причинах его прохождения или отбрасывания.

---

Использование `nmap` для скрытого сканирования требует понимания механизмов работы сетевых фильтров и способов их обхода.

## Методы повышения скрытности сканирования с помощью `nmap`

### 1. Медленное сканирование
При помощи опции `--min-rate` и `--max-retries` можно снизить интенсивность сканирования, минимизируя риск блокировок:

```bash
nmap --min-rate 10 --max-retries 5 target_ip
```

### 2. Фрагментирование пакетов
Разбиение отправляемых пакетов снижает вероятность того, что сканер будет распознан:

```bash
nmap -f target_ip
```

Также можно дополнительно настроить максимальный размер сегмента MTU:

```bash
nmap -f --mtu 16 target_ip
```

### 3. Изменение исходящего MAC-адреса
Подмена MAC-адреса может усложнить идентификацию источника атаки:

```bash
nmap --spoof-mac Apple target_ip
```

Заменив `"Apple"` на другой известный бренд (например, Microsoft), можно имитировать поведение известного устройства.

### 4. Режим псевдорандомизации
Позволяет случайным образом менять порядок сканируемых портов, затрудняя фильтрацию сканеров по последовательности запросов:

```bash
nmap --randomize-hosts target_ip
```

### 5. Отключить DNS разрешение
Запросы DNS могут привлечь внимание администратора сети. Их отключение сделает ваш трафик менее подозрительным:

```bash
nmap -n target_ip
```

### 6. Работа через прокси-серверы
Если доступ осуществляется через прокси, вы можете скрываться за ним:

```bash
nmap --proxy socks5://localhost:9050 target_ip
```

### 7. Исключение часто используемых портов
У некоторых файрволлов есть защита от сканирования стандартных портов (например, HTTP/HTTPS). Чтобы избежать обнаружения, исключайте стандартные порты:

```bash
nmap -Pn -pT:1-65535,U:1-65535 --exclude-ports 80,443 target_ip
```

### 8. SYN Scanning
Метод полуоткрытого (SYN) сканирования сокращает количество инициируемых соединений, уменьшая шанс попасть в журналы регистрации:

```bash
nmap -sS target_ip
```

### 9. Использование IDLE Scans
IDLE сканирование маскирует ваше присутствие, пользуясь сторонним компьютером («zombie») в качестве посредника:

```bash
nmap -sI zombie_host target_ip
```

Важно выбрать неактивный компьютер-зомби для лучшей эффективности метода.

### 10. Задержка между пакетами
Интервал между посылкой пакетов снижает нагрузку на сеть и повышает шансы остаться незамеченным:
```bash
nmap --delay 5s target_ip
```

### 11. Поддельные данные в заголовке
Изменяйте TTL, IP ID и другие поля заголовков, создавая впечатление обычного сетевого траффика:
```bash
nmap --ttl 64 --ip-id 12345 target_ip
```

### 12. Вывление активных у-в в сети
```bash
sudo nmap -sP 192.168.56.0/24
```

### 13. Подробное исследование
```bash
sudo nmap -A 192.168.87.112
```

### 14. Установить точные версии приложений, работающих на каждом открытом порту
```bash
sudo nmap -sV 192.168.87.112
```
