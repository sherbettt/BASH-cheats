Утилита `nmap` — это мощный инструмент сетевого сканирования и аудита безопасности, используемый преимущественно в Linux системах, хотя доступна также версия для Windows. Она позволяет находить активные устройства, определяя открытые порты, версии сервисов, операционные системы и даже обнаруживать уязвимости на удалённых хостах.

### Основные цели использования `nmap`

- **Сканирование сети**: проверка активных устройств и открытых портов.
- **Определение ОС**: попытка определить версию операционной системы удалённого хоста.
- **Обнаружение служб**: определение запущенных сервисов и версий программного обеспечения.
- **Проверка безопасности**: выявление потенциальных уязвимостей путём анализа полученных результатов.

---

## Примеры использования

### Простые команды:

1. **Базовое сканирование сети**  
   Сканы одного конкретного IP адреса или диапазона адресов:
   
```bash
nmap 192.168.1.1
```

Или диапазон адресов:

```bash
nmap 192.168.1.1-254
```

2. **Сканирование всех открытых TCP-портов**  
   По умолчанию Nmap проверяет около тысячи наиболее популярных портов. Для полного списка используется ключ `-p-`.

```bash
nmap -sT -p- 192.168.1.1
```

3. **Определение версии службы**  
   Определение конкретных версий сервисов на открытых портах:

```bash
nmap -sV 192.168.1.1
```

4. **Определить операционную систему**  
   Пытаемся определить операционную систему удаленного хоста:

```bash
nmap -O 192.168.1.1
```

5. **Быстрое сканирование**  
   Если скорость важна больше точности, можно воспользоваться режимом быстрого сканирования (`-F`) и ограничением количества пакетов (`--min-rate`), ускоряя процесс:

```bash
nmap -F --min-rate=1000 192.168.1.1
```

---

### Более продвинутые команды:

1. **Использование скриптов NSE (Nmap Script Engine)**  
   Включаем использование встроенных сценариев для проверки уязвимостей и сбора дополнительной информации:

```bash
nmap --script vuln 192.168.1.1
```

Это запускает сценарии для обнаружения известных уязвимостей.

2. **Интерактивная трассировка маршрута**  
   Трассируем путь пакета от текущего узла до целевого хоста, используя ICMP эхо-запросы:

```bash
nmap --traceroute 192.168.1.1
```

3. **Полный SYN scan + OS detection + service version discovery**  
   Запускаем полный SYN scan с определением версии сервиса и ОС одновременно:

```bash
nmap -sS -A 192.168.1.1
```

4. **Скрытое сканирование**  
   Использование флага ACK, позволяющего обойти некоторые брандмауэры:

```bash
nmap -sA 192.168.1.1
```

5. **UDP scanning**  
   UDP-порты сложнее проверять, поскольку большинство запросов остаются без ответа. Но вот пример, как проверить первые 1000 UDP-портов:

```bash
nmap -sU -p1-1000 192.168.1.1
```

6. **Выделение целей по имени домена**  
   Вместо простого IP-адреса можно указывать DNS имя хоста:

```bash
nmap example.com
```

7. **Отчётность и сохранение результата**  
   Сохраняем вывод в удобочитаемом виде в файл:

```bash
nmap -oN output.txt 192.168.1.1
```

или XML формат для последующей обработки автоматизированными инструментами:

```bash
nmap -oX output.xml 192.168.1.1
```

---

Вот дополнительные сложные примеры использования утилиты `nmap`, демонстрирующие её возможности и гибкость конфигурации:

## Сложные примеры команд Nmap

### 1. Комбинированное сканирование SYN+ACK
Этот метод сочетает два типа сканирования: SYN и ACK. Это помогает обходить определённые виды фильтрации пакетов и улучшает шансы на успешное обнаружение порта:

```bash
nmap -sSA 192.168.1.1
```

### 2. Рандомизация порядка сканируемых портов
Чтобы затруднить распознавание сканера защитными механизмами, можно рандомизировать порядок проверок портов:

```bash
nmap -f --randomize-hosts 192.168.1.1
```

### 3. Параллельное сканирование нескольких сетей
Иногда полезно провести быстрое массовое сканирование сразу нескольких сетей или отдельных узлов:

```bash
nmap -iL targets.txt
```

Здесь `targets.txt` — это список IP адресов или диапазонов адресов.

### 4. Детектирование особенностей оборудования
Используя Nmap можно попытаться выявить аппаратные характеристики удалённой машины, такие как производитель железа, CPU и другие низкоуровневые данные:

```bash
nmap -O --osscan-guess 192.168.1.1
```

### 5. Медленное сканирование (для предотвращения блокировки)
Если цель имеет защиту против массовых сканирований, можно замедлить процесс отправки пакетов, делая менее заметным атаку:

```bash
nmap --max-retries 10 --host-timeout 1h --max-rtt-timeout 1m --initial-rtt-timeout 10ms --min-hostgroup 5 --min-parallelism 5 192.168.1.1
```

Эта команда уменьшает количество повторений попыток подключения и растягивает выполнение операции на длительное время.

### 6. Фрагментация пакетов
Некоторые файрволлы плохо обрабатывают фрагментированные пакеты, что даёт возможность проникнуть внутрь защищенной сети:

```bash
nmap -f -MTU 16 192.168.1.1
```

Флаг `-f` включает фрагментацию, а аргумент `-MTU` задаёт размер MTU каждого фрагмента.

### 7. Обход защиты файрволлов с использованием FTP bounce attack
FTP bounce атака возможна благодаря специфической особенности протокола FTP. Она позволяет пробовать обойти ограничения файрволла:

```bash
nmap -b ftp.example.com 192.168.1.1
```

### 8. Ограниченный временной интервал для выполнения задания
Можно задать жёсткое ограничение по времени, отведённому на завершение сканирования. Например, завершить операцию через 3 минуты независимо от статуса завершения:

```bash
nmap --timings 3m 192.168.1.1
```

### 9. Отключение механизма DNS разрешения имен
Иногда DNS запросы замедляют процесс сканирования или раскрывают личность атакующего. Можно отключить этот механизм, увеличив производительность:

```bash
nmap -n 192.168.1.1
```

### 10. Имитация легитимного трафика
Имитация трафика популярного браузера или другого приложения делает вашу активность похожей на обычный трафик:

```bash
nmap --spoof-mac="Microsoft" --data-length=500 --badsum 192.168.1.1
```

### 11. Выявление медленных машин и неполадок сети
Можно быстро обнаружить проблемы с оборудованием или качеством соединения:

```bash
nmap --packet-trace --reason --version-all 192.168.1.1
```

Команда показывает детальную информацию о каждом пакете и причинах его прохождения или отбрасывания.

---

Использование `nmap` для скрытого сканирования требует понимания механизмов работы сетевых фильтров и способов их обхода.

## Методы повышения скрытности сканирования с помощью `nmap`

### 1. Медленное сканирование
При помощи опции `--min-rate` и `--max-retries` можно снизить интенсивность сканирования, минимизируя риск блокировок:

```bash
nmap --min-rate 10 --max-retries 5 target_ip
```

### 2. Фрагментирование пакетов
Разбиение отправляемых пакетов снижает вероятность того, что сканер будет распознан:

```bash
nmap -f target_ip
```

Также можно дополнительно настроить максимальный размер сегмента MTU:

```bash
nmap -f --mtu 16 target_ip
```

### 3. Изменение исходящего MAC-адреса
Подмена MAC-адреса может усложнить идентификацию источника атаки:

```bash
nmap --spoof-mac Apple target_ip
```

Заменив `"Apple"` на другой известный бренд (например, Microsoft), можно имитировать поведение известного устройства.

### 4. Режим псевдорандомизации
Позволяет случайным образом менять порядок сканируемых портов, затрудняя фильтрацию сканеров по последовательности запросов:

```bash
nmap --randomize-hosts target_ip
```

### 5. Отключить DNS разрешение
Запросы DNS могут привлечь внимание администратора сети. Их отключение сделает ваш трафик менее подозрительным:

```bash
nmap -n target_ip
```

### 6. Работа через прокси-серверы
Если доступ осуществляется через прокси, вы можете скрываться за ним:

```bash
nmap --proxy socks5://localhost:9050 target_ip
```

### 7. Исключение часто используемых портов
У некоторых файрволлов есть защита от сканирования стандартных портов (например, HTTP/HTTPS). Чтобы избежать обнаружения, исключайте стандартные порты:

```bash
nmap -Pn -pT:1-65535,U:1-65535 --exclude-ports 80,443 target_ip
```

### 8. SYN Scanning
Метод полуоткрытого (SYN) сканирования сокращает количество инициируемых соединений, уменьшая шанс попасть в журналы регистрации:

```bash
nmap -sS target_ip
```

### 9. Использование IDLE Scans
IDLE сканирование маскирует ваше присутствие, пользуясь сторонним компьютером («zombie») в качестве посредника:

```bash
nmap -sI zombie_host target_ip
```

Важно выбрать неактивный компьютер-зомби для лучшей эффективности метода.

### 10. Задержка между пакетами
Интервал между посылкой пакетов снижает нагрузку на сеть и повышает шансы остаться незамеченным:
```bash
nmap --delay 5s target_ip
```

### 11. Поддельные данные в заголовке
Изменяйте TTL, IP ID и другие поля заголовков, создавая впечатление обычного сетевого траффика:
```bash
nmap --ttl 64 --ip-id 12345 target_ip
```

### 12. Вывление активных у-в в сети
```bash
sudo nmap -sP 192.168.56.0/24
```

### 13. Подробное исследование
```bash
sudo nmap -A 192.168.87.112
```

### 14. Установить точные версии приложений, работающих на каждом открытом порту
```bash
sudo nmap -sV 192.168.87.112
```
------------------------------

Для быстрого определения IP-адресов устройств в сети **192.168.87.0/24** (включая IP-телефон и коммутатор) можно использовать более эффективные методы, чем `nmap -sA` (ACK-сканирование, которое действительно может работать медленно).  

### 🔹 Быстрые способы определить IP-адреса устройств:

#### **1. Ping-сканирование (быстрое обнаружение активных хостов)**
```bash
sudo nmap -sn 192.168.87.0/24
```
- `-sn` (Ping-сканирование) — проверяет, какие устройства отвечают на ICMP-запросы (быстро и без сканирования портов).  
- Если телефон или свитч не отвечают на ping, попробуйте ARP-сканирование.

#### **2. ARP-сканирование (самый быстрый способ в локальной сети)**
```bash
sudo nmap -PR 192.168.87.0/24
```
или с помощью `arp-scan`:
```bash
sudo arp-scan --localnet
```
- ARP работает на канальном уровне и обнаруживает все устройства, даже если они не отвечают на ping.

#### **3. Быстрое сканирование основных портов (если нужно узнать открытые порты)**
```bash
sudo nmap -F 192.168.87.0/24
```
- `-F` (быстрое сканирование) — проверяет только 100 самых популярных портов.



###  Как определить IP телефона и коммутатора?
1. **IP-телефон** обычно имеет открытые порты SIP (5060) или HTTP (80, 8080 для веб-интерфейса):  
   ```bash
   sudo nmap -p 5060,80,8080 192.168.87.0/24 --open
   ```
2. **Коммутатор** (если управляемый) может отвечать на SSH (22), Telnet (23) или HTTP/HTTPS:  
   ```bash
   sudo nmap -p 22,23,80,443 192.168.87.0/24 --open
   ```


###  Альтернативные методы:
- **Посмотреть ARP-таблицу на роутере** (если у вас есть доступ):
  ```bash
  arp -a
  ```
- **Проверить DHCP-сервер** (если устройства получают IP автоматически).  
- **Использовать `fing`** (GUI-утилита для сканирования сети).

Если устройства не обнаруживаются, возможно, они:
- **Не подключены** к сети.
- **Имеют фильтрацию ICMP** (попробуйте ARP-сканирование).
- **Используют другой VLAN** (если сеть сегментирована).


Отлично! Вы обнаружили в своей сети устройства Yealink (IP-телефоны) и TP-Link (возможно, коммутатор или роутер). Однако `nmap -sn` не вывел их IP-адреса, только MAC-адреса.  

### 🔹 Как найти IP-адреса этих устройств?  

#### **1. Вариант 1: Использовать `nmap` с выводом IP + MAC + производителя**  
```bash
sudo nmap -sn 192.168.87.0/24 | grep -E 'Nmap scan|MAC Address'
```
- Это покажет все найденные устройства в формате:  
  ```
  Nmap scan report for 192.168.87.XX
  MAC Address: XX:XX:XX:XX:XX:XX (Yealink)
  ```

#### **2. Вариант 2: Использовать `arp-scan` (самый быстрый способ)**
```bash
sudo arp-scan --localnet | grep -iE 'yealink|tp-link'
```
- Вывод будет содержать **IP и MAC** всех устройств Yealink и TP-Link.  

#### **3. Вариант 3: Проверить ARP-кеш**
```bash
arp -a | grep -iE 'yealink|tp-link'
```
- Если устройства недавно были активны, их IP можно найти в ARP-таблице.  


### 🔹 Если устройства не отображаются в сканировании:
1. **Они могут быть отключены** — проверьте питание и подключение.  
2. **Фильтрация ICMP** — попробуйте `sudo nmap -PR` (ARP-сканирование).  
3. **Другой VLAN** — если сеть сегментирована, нужно сканировать нужный VLAN.  

Попробуйте `arp-scan` — он работает на уровне L2 и находит устройства, даже если они не отвечают на ping. 

---------------------
```bash
┌─ kirill ~ 
└─ $ sudo arp-scan --localnet | grep -iE 'yealink|tp-link'
192.168.87.58	80:5e:c0:78:f1:12	YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
192.168.87.119	48:22:54:08:b5:1c	TP-Link Corporation Limited
192.168.87.120	48:22:54:08:b3:bc	TP-Link Corporation Limited
192.168.87.140	00:15:65:d5:db:7b	XIAMEN YEALINK NETWORK TECHNOLOGY CO.,LTD
192.168.87.191	80:5e:0c:29:1d:d8	YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
192.168.87.203	48:22:54:08:bf:24	TP-Link Corporation Limited
192.168.87.207	80:5e:0c:2e:3f:9d	YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
┌─ kirill ~ 
└─ $ sudo nmap -sn 192.168.87.0/24 | grep -E  'Yealink'
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
MAC Address: 80:5E:C0:78:F1:12 (Yealink(Xiamen) Network Technology)
MAC Address: 00:15:65:D5:DB:7B (Xiamen Yealink Network Technology)
MAC Address: 80:5E:0C:29:1D:D8 (Yealink(Xiamen) Network Technology)
MAC Address: 80:5E:0C:2E:3F:9D (Yealink(Xiamen) Network Technology)
```
Чтобы обратиться к конкретному телефону Yealink и позвонить с Linux, вам нужно выполнить несколько шагов:

### 1. **Определить IP-адрес нужного телефона Yealink**
Из вывода `arp-scan` и `nmap` видно, что в сети есть несколько устройств Yealink:
```c
192.168.87.58    80:5e:c0:78:f1:12    YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
192.168.87.140   00:15:65:d5:db:7b    XIAMEN YEALINK NETWORK TECHNOLOGY CO.,LTD
192.168.87.191   80:5e:0c:29:1d:d8    YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
192.168.87.207   80:5e:0c:2e:3f:9d    YEALINK(XIAMEN) NETWORK TECHNOLOGY CO.,LTD.
```

Если вы не знаете, какой именно телефон ваш, можно:
- **Проверить веб-интерфейс** (перейдите в браузере по `http://<IP-телефона>`, логин/пароль по умолчанию обычно `admin/admin`).
- **Посмотреть MAC-адрес** на самом телефоне (обычно на наклейке сзади или в меню `Статус > Сеть`).
- (https://192.168.87.191/servlet?m=mod_data&p=status&q=load)

### 2. **Позвонить на телефон Yealink с Linux**
Есть несколько способов позвонить с Linux на SIP-телефон Yealink:

#### **Способ 1: Использовать SIP-клиент (например, Linphone, Jitsi, Twinkle)**
1. Установите SIP-клиент:
   ```bash
   sudo apt install linphone
   ```
2. Настройте SIP-аккаунт (если у вас есть SIP-сервер, например, Asterisk, FreePBX или облачный провайдер).
3. Наберите номер, зарегистрированный на телефоне Yealink.

#### **Способ 2: Отправить SIP-запрос через `sipgrep` или `sipsak`**
Если у вас есть SIP-сервер, можно отправить запрос напрямую:
```bash
sipsak -U -s sip:номер@IP-телефона
```
(Требуется установка `sipsak`)

#### **Способ 3: Использовать `curl` для отправки команды на телефон**
Некоторые Yealink поддерживают API. Например, можно отправить звонок через HTTP-запрос:
```bash
curl -X POST http://admin:admin@192.168.87.58/cgi-bin/ConfigManApp.com?key=autodial&number=100
curl -X POST http://admin:admin@192.168.87.191/cgi-bin/ConfigManApp.com?key=autodial&number=100
```
(Замените `192.168.87.58` на IP вашего телефона, `100` на номер для звонка.)

#### **Способ 4: Использовать Asterisk (если есть SIP-сервер)**
Если у вас настроен Asterisk, можно использовать:
```bash
asterisk -rx "channel originate SIP/100 extension 101@default"
```
(Где `100` — SIP-номер телефона Yealink, `101` — номер для вызова.)

### 3. **Как определить, какой телефон ваш?**
Если у вас несколько Yealink в сети, можно:
1. **Отключить телефон** от сети и проверить, какой IP пропадет из `arp-scan`.
2. **Зайти в веб-интерфейс** каждого и проверить настройки.
3. **Посмотреть MAC-адрес** на корпусе телефона и сопоставить с выводом `arp-scan`.

### Вывод
Самый простой способ позвонить — использовать SIP-клиент (Linphone) или отправить команду через веб-интерфейс телефона. Если у вас есть SIP-сервер, можно управлять звонками через Asterisk.

Если вам нужно что-то конкретное (например, автоматический вызов), уточните детали!
