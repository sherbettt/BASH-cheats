# **ИНСТРУКЦИЯ ПО ОЧИСТКЕ ДИСКОВОГО ПРОСТРАНСТВА В PROXMOX**

## **КОНТЕКСТ ПРОБЛЕМЫ**

**Исходная ситуация:**
- Сервер Proxmox с несколькими хранилищами
- Критическое заполнение дискового пространства
- Особенно проблемные разделы: `/home` (89%), `/stg/1tb` (87%)
- Контейнеры с 100% заполнением (например, контейнер 137 - Passbolt)

## **ОБЩИЙ ПРИНЦИП ДИАГНОСТИКИ**

### **1. Анализ использования дисков**
```bash
# Общая картина
df -h
df -kh
df -hT / /home /boot /var 2>/dev/null | grep -v "^tmpfs"

# Поиск больших файлов
find / -type f -size +250M -exec ls -lh {} + 2>/dev/null | sort -rh
```

### **2. Анализ по разделам**
```bash
# Самые большие директории в конкретном разделе
du -ah /path/to/mount 2>/dev/null | sort -rh | head -20
```

## **ОСНОВНЫЕ ИСТОЧНИКИ ПРОБЛЕМ**

### **A. Бэкапы Proxmox (VZDump)**
**Где находятся:** `/stg/8tb/dump/`
**Проблема:** Накопление старых бэкапов, слишком агрессивная политика ретеншена

**Решение:**
```bash
# 1. Найти старые бэкапы
find /stg/8tb/dump -name "*.tar.zst" -mtime +30 -exec ls -lh {} \;

# 2. Удалить старые бэкапы
find /stg/8tb/dump -name "*.tar.zst" -mtime +30 -delete

# 3. Удалить временные файлы бэкапов
rm -rf /stg/8tb/dump/*.tmp/

# 4. Удалить устаревшие форматы бэкапов
find /stg/8tb/dump -name "*.tar.dat" -delete
```

### **B. Внутренние бэкапы приложений (в контейнерах)**
**Пример:** Passbolt (контейнер 137) с ежедневными SQL-бэкапами

**Диагностика внутри контейнера:**
```bash
# Войти в контейнер
pct enter <CTID>

# Или выполнить команды без входа
pct exec <CTID> -- df -h
pct exec <CTID> -- du -ahx / 2>/dev/null | sort -rh | head -20
```

**Очистка внутри контейнера:**
```bash
# 1. Очистить кэш пакетов
pct exec <CTID> -- apt-get clean
pct exec <CTID> -- apt-get autoremove --purge -y

# 2. Очистить логи
pct exec <CTID> -- journalctl --vacuum-time=7d
pct exec <CTID> -- find /var/log -name "*.log" -type f -exec truncate -s 0 {} \;

# 3. Найти и очистить внутренние бэкапы
pct exec <CTID> -- find /var/lib -name "*.sql" -type f -exec ls -lh {} \;

# 4. Оставить только последние N бэкапов
pct exec <CTID> -- cd /path/to/backups && ls -t *.sql | tail -n +8 | xargs rm -f
```

### **C. Диски несуществующих виртуальных машин**
**Проблема:** После удаления VM их диски остаются в хранилище

**Решение:**
```bash
# 1. Проверить существующие VM
qm list
pct list

# 2. Найти диски несуществующих VM
ls -lh /home/images/
ls -lh /stg/*/images/

# 3. Удалить (если уверены, что VM не существует)
rm -rf /home/images/<VMID>/
```

### **D. Дублирующиеся ISO и шаблоны**
**Проблема:** Одинаковые ISO в разных хранилищах, несжатые дубликаты шаблонов

**Решение:**
```bash
# 1. Найти все ISO файлы
find / -name "*.iso" -type f -exec ls -lh {} + 2>/dev/null | sort -rh

# 2. Удалить дубликаты
rm /path/to/duplicate.iso

# 3. Очистить кэш шаблонов (удалить несжатые версии)
rm /path/to/template/cache/*.tar.gz
```

## **ЭТАПЫ ОЧИСТКИ**

### **ЭТАП 1: Безопасная очистка (низкий риск)**
1. Удаление временных файлов `.tmp`
2. Очистка логов старше N дней
3. Очистка кэша пакетов

### **ЭТАП 2: Умеренная очистка (средний риск)**
1. Удаление старых бэкапов (старше 30/90 дней)
2. Удаление дублирующихся ISO
3. Очистка кэша шаблонов

### **ЭТАП 3: Агрессивная очистка (высокий риск)**
1. Удаление дисков несуществующих VM
2. Очистка внутренних бэкапов приложений
3. Уменьшение глубины ретеншена бэкапов

## **ИНСТРУМЕНТЫ ДИАГНОСТИКИ**

### **Команды для анализа:**
```bash
# Размер файловых систем
df -h
df -kh

# Большие файлы во всей системе
find / -type f -size +100M -exec ls -lh {} + 2>/dev/null

# Большие директории в конкретном месте
du -ah /path 2>/dev/null | sort -rh | head -20

# Старые файлы
find /path -type f -mtime +30 -exec ls -lh {} \;

# Поиск по шаблону
find / -name "*.tar.zst" -type f -exec ls -lh {} + 2>/dev/null
```

### **Анализ контейнеров:**
```bash
# Проверить все контейнеры
pct list

# Проверить конкретный контейнер
pct exec <CTID> -- df -h
pct exec <CTID> -- du -ahx / 2>/dev/null | sort -rh | head -20
```

## **ПРОФИЛАКТИКА И ОПТИМИЗАЦИЯ**

### **1. Оптимизация политики бэкапов**
- Уменьшить частоту бэкапов для не-критических VM
- Настроить разумный ретеншен (7 daily, 4 weekly, 3 monthly)
- Использовать разные хранилища для бэкапов и рабочих дисков

### **2. Мониторинг**
```bash
# Скрипт для мониторинга
#!/bin/bash
THRESHOLD=80
df -h | grep -E "^/dev" | awk '{print $5 " " $6}' | while read output; do
    usage=$(echo $output | awk '{print $1}' | cut -d'%' -f1)
    partition=$(echo $output | awk '{print $2}')
    if [ $usage -ge $THRESHOLD ]; then
        echo "Критическое заполнение: $partition - $usage%"
    fi
done
```

### **3. Регулярная очистка**
```bash
# Еженедельная очистка логов
find /var/log -name "*.log" -type f -mtime +7 -exec truncate -s 0 {} \;

# Ежемесячная очистка старых бэкапов
find /stg/8tb/dump -name "*.tar.zst" -mtime +90 -delete
```

-----------------------


