### § Доступ к сетевому хранилищу
([Доступ к сетевому хранилищу](https://rh.schelcol.ru/curse%202/ch09.html)); 
([Autofs](https://www.altlinux.org/Autofs))

NFS (сетевая файловая система) — это стандартный протокол Интернета, это открытый стандарт, который активно разрабатывается и поддерживает систему разрешений Linux и функции файловой системы. 
<br/> NFS-серверы экспортируют общие каталоги. Клиенты NFS монтируют экспортированный общий каталог в локальную точку монтирования (каталог), которая должна существовать. Общие каталоги NFS можно смонтировать несколькими способами:
- вручную с помощью команды mount;
- автоматически во время загрузки системы с помощью записей /etc/fstab;
- по запросу, используя службу autofs или утилиту systemd.automount.

```
/etc/automaster
	/info /etc/auto.server
	/-		/etc/auto.direct

/etc/auto.server
	data	-ro serverb.lab.example.com:/shares/inderect/central

/etc/auto.direct
	/info5/storage	-ro serverb.lab.example.com:/shares/direct/external
```
Компания, занимающаяся ИТ-поддержкой, использует центральный сервер **serverb** для размещения некоторых общих каталогов в **/remote/shares** для своих групп и пользователей. Пользователи должны иметь возможность входить в систему, а их общие каталоги должны быть подключены по требованию и готовы к использованию в каталоге **/shares** на **servera**. 
1. Установить пакет NFS
	<br/>  `yum install autofs`
2. Протестируйте сервер NFS, прежде чем приступать к настройке автомонтера
   	<br/>  `mount -t nfs serverb.lab.example.com:/shares /mnt`
	```bash
	[root@servera ~]# ll /mnt/
	total 0
	dr-xr-xr-x. 17 root root       224 Sep 18  2020 ../
	drwxrwxr-x.  5 root root        59 Apr 26 20:06 ./
	drwxrws---.  2 root managers    25 Apr 26 20:06 management/
	drwxrws---.  2 root operators   25 Apr 26 20:06 operation/
	drwxrws---.  2 root production  25 Apr 26 20:06 production/
	```
3. Создать главный файл **/etc/auto.master.d/shares.autofs** и  прописать внутри следующее:
	<br/>  `vim /etc/auto.master.d/shares.autofs`
	<br/>  `/remote /etc/auto.shares`
4. Создать косвенный файл **/etc/auto.shares** , где указываем ссылку на другой сервер: 
	<br/> `vim /etc/auto.shares`
	<br/> `* -rw,sync,fstype=nfs4 serverb.lab.example.com:/shares/&`
5. Вуключить службу autofs
	<br/> `systemctl enable --now autofs`
6. Перезагрузить
	<br/> `systemctl reboot`
7. Зайти под другими пользователями и проверить общие директории
	```bash
	[root@serverb ~]# ls -alF /shares/
	total 0
	drwxrwxr-x.  5 root root        59 Apr 26 20:06 ./
	dr-xr-xr-x. 18 root root       238 Apr 26 20:06 ../
	drwxrws---.  2 root managers    25 Apr 26 20:06 management/
	drwxrws---.  2 root operators   25 Apr 26 20:06 operation/
	drwxrws---.  2 root production  25 Apr 26 20:06 production/
 	```
 8. Проверить параметры подключения для общего ресурса, автоматически подключаемого к NFS.
	```c
	[student@servera ~]$ mount | grep nfs
	rpc_pipefs on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw,relatime)
	serverb.lab.example.com:/shares/management on /remote/management type nfs4
	(rw,relatime,vers=4.2,rsize=262144,wsize=262144,namlen=255,
	sync,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=172.25.250.10,
	local_lock=none,addr=172.25.250.11)
	serverb.lab.example.com:/shares/operation on /remote/operation type nfs4
	(rw,relatime,vers=4.2,rsize=262144,wsize=262144,namlen=255,
	sync,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=172.25.250.10,
	local_lock=none,addr=172.25.250.11)
	serverb.lab.example.com:/shares/production on /remote/production type nfs4
	(rw,relatime,vers=4.2,rsize=262144,wsize=262144,namlen=255,
	sync,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=172.25.250.10,
	local_lock=none,addr=172.25.250.11)
 	```
----------------------------------------------
<br/> ([упражнение](https://rh.schelcol.ru/curse%202/ch09s04.html))
1. Настройте в средстве автомонтирования прямое сопоставление на servera с использованием общих каталогов из serverb. Создайте прямое сопоставление, используя файлы с именем /etc/auto.master.d/direct.autofs для главного файла сопоставления и /etc/auto.direct для файла сопоставления. Используйте каталог /external в качестве основной точки монтирования на servera.
	- Протестируйте NFS-сервер и общий каталог, прежде чем приступать к настройке средства автомонтирования.
	<br/> `mount -t nfs serverb.lab.example.com:/shares/direct/external /mnt`
	```bash color
	[root@servera ~]# mount -t nfs serverb.lab.example.com:/shares/direct/external /mnt
	[root@servera ~]# ls -alFS /mnt
	total 4
	dr-xr-xr-x. 17 root root        224 Apr 26 20:48 ../
	drwxrws---.  2 root contractors  24 Apr 26 20:51 ./
	-rw-r--r--.  1 root contractors  22 Apr 26 20:51 README.txt
	[root@servera ~]# cat /mnt/README.txt
	###External Folder###
	```
	- Создайте главный файл сопоставления с именем **/etc/auto.master.d/direct.autofs**, вставьте: `/-  /etc/auto.direct`
	- Создайте файл прямого сопоставления с именем **/etc/auto.direct**, вставьте:
	<br/>  `/external	-rw,sync,fstype=nfs4	serverb.lab.example.com:/shares/direct/external`

2. Настройте в средстве автомонтирования прямое сопоставление на servera, используя общие каталоги из serverb. Создайте косвенное сопоставление, используя файлы с именем /etc/auto.master.d/indirect.autofs для главного файла сопоставления и /etc/auto.indirect для файла сопоставления. Используйте каталог /internal в качестве основной точки монтирования на servera.
	- Протестируйте NFS-сервер и общий каталог, прежде чем приступать к настройке средства автомонтирования.
	```bash cmd
	[root@servera ~]# mount -t nfs serverb.lab.example.com:/shares/indirect /mnt
	[root@servera ~]# ls -alFS /mnt/
	total 0
	dr-xr-xr-x. 17 root root      224 Apr 26 20:48 ../
	drwxrws---.  5 root operators  45 Apr 26 20:51 ./
	drwxrws---.  2 root operators  24 Apr 26 20:51 central/
	drwxrws---.  2 root operators  24 Apr 26 20:51 east/
	drwxrws---.  2 root operators  24 Apr 26 20:51 west/
	[root@servera ~]# umount /mnt
	[root@servera ~]# ls -alFS /mnt/
	total 0
	dr-xr-xr-x. 17 root root 224 Apr 26 20:48 ../
	drwxr-xr-x.  2 root root   6 Aug 12  2018 ./
	```
	- Создайте главный файл сопоставления с именем **/etc/auto.master.d/indirect.autofs**, вставьте: `/internal	/etc/auto.indirect`
 	- Создайте файл косвенного сопоставления с именем **/etc/auto.indirect**, вставьте:
	<br/> `*	-rw,sync,fstype=nfs4	serverb.lab.example.com:/shares/indirect/&`
3. Запустите службу ***autofs*** на **servera** и включите ее для запуска во время загрузки системы. Перезапустите servera, чтобы убедиться, что служба autofs запускается автоматически.
	```bash
 	[root@servera ~]# systemctl enable --now autofs
	Created symlink /etc/systemd/system/multi-user.target.wants/autofs.service → /usr/lib/systemd/system/autofs.service.
	[root@servera ~]# systemctl reboot
	Connection to servera closed by remote host.
 	```
 4. Протестируйте прямое сопоставление с помощью средства автомонтирования от имени пользователя contractor1.
	```bash
	[student@servera ~]$ su - contractor1
	Password: redhat
	[contractor1@servera ~]$ ls -alFS /external/
	total 4
	dr-xr-xr-x. 20 root root        263 Apr 26 21:18 ../
	drwxrws---.  2 root contractors  24 Apr 26 20:51 ./
	-rw-r--r--.  1 root contractors  22 Apr 26 20:51 README.txt
	[contractor1@servera ~]$ cat /external/README.txt
	###External Folder###
	[contractor1@servera ~]$ echo testing-direct > /external/testing.txt
	[contractor1@servera ~]$ cat /external/testing.txt
	testing-direct
 	```
5. Протестируйте косвенное сопоставление с помощью средства автомонтирования от имени пользователя operator1, аналогично пунтком выше.

---------------------------------------------------------
Это Ubuntu машины:
- jira-new 192.168.87.219/24
- jira-cluster 192.168.87.140/24

Пусть на jira-cluster будет установлен NFS сервер.
Также пусть на jira-cluster будет создана общая папка /srv/jira/shared/


### **Установка и настройка NFS на Ubuntu (jira-cluster как сервер, jira-new как клиент)**  

#### **🔹 1. Настройка NFS-сервера на jira-cluster (192.168.87.140)**
**1.1. Установка NFS-сервера**  
```bash
sudo apt update
sudo apt install -y nfs-kernel-server
```

**1.2. Создание общей папки**  
```bash
sudo mkdir -p /srv/jira/shared
sudo chown -R jira:jira /srv/jira/shared
sudo chown -R nobody:nogroup /srv/jira/shared  # Убираем ограничения владельца (для теста)
sudo chmod -R 777 /srv/jira/shared             # Даем полные права (в продакшене лучше ограничить)
```

**1.3. Настройка экспорта папки (`/etc/exports`)**  
Открываем файл для редактирования:  
```bash
sudo vim /etc/exports
```
Добавляем строку для доступа с **jira-new (192.168.87.219)**:  
```
/srv/jira/shared 192.168.87.219(rw,sync,no_subtree_check,no_root_squash)
```
**Пояснение опций**:  
- `rw` – чтение и запись  
- `sync` – синхронная запись  
- `no_subtree_check` – отключает лишние проверки (лучше для производительности)  
- `no_root_squash` – позволяет root на клиенте иметь root-права (осторожно!)  

**1.4. Применяем настройки NFS**  
```bash
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
```

**1.5. Открываем порт в фаерволе (если включен)**  
```bash
sudo ufw allow from 192.168.87.219 to any port nfs
sudo ufw enable
```



#### **🔹 2. Настройка NFS-клиента на jira-new (192.168.87.219)**
**2.1. Установка NFS-клиента**  
```bash
sudo apt update
sudo apt install -y nfs-common
```

**2.2. Создание точки монтирования**  
```bash
sudo mkdir -p /mnt/jira_shared
```

**2.3. Монтирование NFS-папки вручную (для проверки)**  
```bash
sudo mount -t nfs 192.168.87.140:/srv/jira/shared /mnt/jira_shared
```

**2.4. Автоматическое монтирование при загрузке (`/etc/fstab`)**  
Открываем файл:  
```bash
sudo vim /etc/fstab
```
Добавляем строку:  
```
192.168.87.140:/srv/jira/shared  /mnt/jira_shared  nfs  defaults  0  0
```
Проверяем, что монтирование работает:  
```bash
sudo mount -a
```



#### **🔹 3. Проверка работы NFS**
**На сервере (jira-cluster):**  
```bash
echo "Test NFS file" | sudo tee /srv/jira/shared/test.txt
```

**На клиенте (jira-new):**  
```bash
cat /mnt/jira_shared/test.txt
```
Если видим `Test NFS file` — значит, NFS работает!  



### **🔹 4. Возможные проблемы и их решение**
1. **"Permission denied"**  
   - Проверьте права (`chmod` и `chown`) на сервере.  
   - Убедитесь, что в `/etc/exports` указан правильный IP клиента.  

2. **NFS не монтируется**  
   - Проверьте, что сервер запущен:  
     ```bash
     sudo systemctl status nfs-kernel-server
     ```
   - Проверьте фаервол (`ufw` или `iptables`).  

3. **Ошибка "RPC: Program not registered"**  
   - Перезапустите NFS на сервере:  
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```



### **🔹 5. Дополнительные настройки (опционально)**
- **Безопасность**: Вместо `no_root_squash` лучше использовать `root_squash` (клиентский root будет маппиться в `nobody`).  
- **Жесткая настройка прав**:  
  ```bash
  sudo chown -R jira-user:jira-group /srv/jira/shared
  sudo chmod -R 770 /srv/jira/shared
  ```
  (где `jira-user` и `jira-group` — пользователь и группа, которые должны иметь доступ).  


### **✅ Итог**  
- **NFS-сервер** работает на `jira-cluster (192.168.87.140)`, папка `/srv/jira/shared` экспортирована.  
- **NFS-клиент** на `jira-new (192.168.87.219)` монтирует эту папку в `/mnt/jira_shared`.  
- Доступ по сети настроен, можно использовать общие файлы.  

Если нужно добавить больше клиентов — просто укажите их IP в `/etc/exports` на сервере.

















