Call flow for 2 dialogs (Color by Request/Response)
```
                                                                                                                        │INVITE sip:989163640234@10.240.251.218:5060;user=ph
             10.190.9.11:5060            10.240.251.218:5060           10.240.251.218:5202             10.190.9.11:5060 │one SIP/2.0
          ──────────┬─────────          ──────────┬─────────          ──────────┬─────────          ──────────┬─────────│Via: SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6d
  15:06:41.474593   │        INVITE (SDP)         │                             │                             │         │aar6rga6pd983d3r9c7wrp
        +0.000910   │ ──────────────────────────> │                             │                             │         │Call-ID: wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.
  15:06:41.475503   │         100 Trying          │                             │                             │         │11
        +0.014839   │ <────────────────────────── │                             │                             │         │From: "6899"<sip:6899@10.190.9.11;user=phone>;tag=w
  15:06:41.490342   │                             │                             │        INVITE (SDP)         │         │7bpl34r
        +0.002924   │                             │                             │ ──────────────────────────> │         │To: 989163640234 <sip:989163640234@10.240.251.218;u
  15:06:41.493266   │  183 Session Progress (SDP) │                             │                             │         │ser=phone>
        +0.997144   │ <────────────────────────── │                             │                             │         │CSeq: 1 INVITE
  15:06:42.490410   │                             │                             │        INVITE (SDP)         │         │Contact: <sip:6899@10.190.9.11:5060;user=phone>;Cal
        +1.999988   │                             │                             │ ────────────────────────>>> │         │lLocation=EXTERNAL
  15:06:44.490398   │                             │                             │        INVITE (SDP)         │         │Allow: INVITE,ACK,OPTIONS,BYE,CANCEL,REGISTER,INFO,
        +4.000001   │                             │                             │ ────────────────────────>>> │         │PRACK,SUBSCRIBE,NOTIFY,UPDATE,PUBLISH
  15:06:48.490399   │                             │                             │        INVITE (SDP)         │         │Max-Forwards: 70
        +8.000003   │                             │                             │ ────────────────────────>>> │         │Content-Length: 576
  15:06:56.490402   │                             │                             │        INVITE (SDP)         │         │Content-Type: application/sdp
       +16.000003   │                             │                             │ ────────────────────────>>> │         │
  15:07:12.490405   │                             │                             │        INVITE (SDP)         │         │v=0
        +1.002061   │                             │                             │ ────────────────────────>>> │         │o=HuaweieSpaceV200R003C50SPC900 918742 918742 IN IP
  15:07:13.492466   │     408 Request Timeout     │                             │                             │         │4 10.190.9.11
        +0.008808   │ <────────────────────────── │                             │                             │         │s=A conversation
  15:07:13.501274   │             ACK             │                             │                             │         │c=IN IP4 10.190.24.40
                    │ ──────────────────────────> │                             │                             │         │t=0 0
                    │                             │                             │                             │         │m=audio 10006 RTP/AVP 0 8 102 18 4 97 108 9 109 101
                    │                             │                             │                             │         │a=rtpmap:0 PCMU/8000
                    │                             │                             │                             │         │a=rtpmap:8 PCMA/8000
                    │                             │                             │                             │         │a=rtpmap:102 G726-32/8000
                    │                             │                             │                             │         │a=rtpmap:18 G729/8000
                    │                             │                             │                             │         │a=fmtp:18 annexb=no
                    │                             │                             │                             │         │a=rtpmap:4 G723/8000
                    │                             │                             │                             │         │a=fmtp:4 bitrate=6.3;annexa=no
                    │                             │                             │                             │         │a=rtpmap:97 iLBC/8000
                    │                             │                             │                             │         │a=fmtp:97 mode=20
                    │                             │                             │                             │         │a=rtpmap:108 AMR/8000
                    │                             │                             │                             │         │a=fmtp:108 mode-set=7;octet-align=0
                    │                             │                             │                             │         │a=rtpmap:9 G722/8000
                    │                             │                             │                             │         │a=rtpmap:109 AMR-WB/16000
                    │                             │                             │                             │         │a=fmtp:109 mode-set=8;octet-align=0
                                                                                                                        │
```

### Проблема в SIP-вызове: **Таймаут запроса (408 Request Timeout)**  

#### Что происходит:  
1. **Исходный INVITE** отправлен с `10.190.9.11` на SIP-прокси (`10.240.251.218:5060`).  
2. Прокси отвечает **100 Trying** (подтверждает получение запроса).  
3. Прокси пересылает INVITE на конечное устройство (`10.240.251.218:5202`).  
4. Прокси отправляет обратно **183 Session Progress** (с SDP), что означает начало установки вызова.  
5. **INVITE повторно передаётся несколько раз** (через 1, 2, 4, 8, 16 сек), но **нет финального ответа** (180 Ringing или 200 OK) от конечного устройства.  
6. Через ~72 секунды прокси возвращает **408 Request Timeout**, так как устройство не ответило вовремя.  

#### Причины сбоя:  
- **Конечное устройство (`10.240.251.218:5202`) не отвечает** после **183 Session Progress**.  
- Возможные проблемы:  
  - **Сеть**: Пакеты не доходят (потеря UDP, блокировка фаерволом).  
  - **Устройство**: Оно выключено, перегружено или некорректно настроено.  
  - **SIP-стек**: Ошибка обработки INVITE на стороне получателя.  
  - **NAT/Фаервол**: Если устройство за NAT, возможны проблемы с маршрутизацией SIP/SDP.  

#### Что проверить:  
1. **Доступность `10.240.251.218:5202`** (ping, traceroute, проверка порта).  
2. **Логи SIP на конечном устройстве** (принимало ли оно INVITE?).  
3. **Потерю пакетов** между прокси (`5060`) и устройством (`5202`).  
4. **Регистрацию устройства** (если требуется).  
5. **Настройки таймеров SIP** (слишком агрессивные ретрансляции?).  
6. **Фаервол/NAT** (если устройство за NAT, нужна правильная настройка).  

-------------------

# Анализ SIP INVITE сообщения

Это SIP-запрос типа INVITE, который инициирует установку VoIP-сессии между двумя абонентами. Давайте разберём его по частям:

## SIP-заголовки

- **INVITE**: Запрос на установление сессии для номера `989163640234` на сервере `10.240.251.218:5060`
- **Via**: Указывает путь ответа через UDP на `10.190.9.11:5060`
- **Call-ID**: Уникальный идентификатор вызова
- **From**: Идентификатор вызывающего абонента "6899" с тегом `w7bpl34r`
- **To**: Целевой абонент `989163640234`
- **CSeq**: Порядковый номер команды (1 INVITE)
- **Contact**: Обратный адрес для ответов `sip:6899@10.190.9.11:5060`
- **Allow**: Поддерживаемые методы SIP
- **Max-Forwards**: Максимальное количество переходов (70)
- **Content-Type**: Тип содержимого - SDP (Session Description Protocol)

## SDP-часть (описание сессии)

- **v=0**: Версия SDP
- **o=**: Идентификатор сессии (Huawei eSpace V200R003C50SPC900)
- **s=**: Название сессии ("A conversation")
- **c=**: IP-адрес подключения (`10.190.24.40`)
- **m=audio**: Аудиопоток на порту 10006 с поддерживаемыми кодеками:
  - 0: PCMU (G.711 μ-law)
  - 8: PCMA (G.711 A-law)
  - 102: G.726-32
  - 18: G.729
  - 4: G.723.1 (6.3 kbps)
  - 97: iLBC (mode=20)
  - 108: AMR (mode-set 7)
  - 9: G.722
  - 109: AMR-WB (wideband, mode-set 8)

## Технические особенности

1. Оборудование: Huawei eSpace V200R003C50SPC900 (это IP-телефон или VoIP-шлюз Huawei)
2. Сеть: Внутренняя IP-сеть (адреса 10.x.x.x)
3. Поддержка широкого набора аудиокодеков от узкополосных (G.711, G.729) до широкополосных (G.722, AMR-WB)
4. CallLocation=EXTERNAL в заголовке Contact может указывать на то, что вызов идёт из внешней сети

Это типичный SIP-запрос для установки голосового вызова между VoIP-устройствами в корпоративной или операторской сети.

-------------------------------------------------
# **Анализ SIP-ответа "100 Trying**  

Это промежуточный ответ **SIP/100 Trying**, который сервер (в данном случае **FreeSWITCH**) отправляет вызывающей стороне, чтобы подтвердить, что запрос **INVITE** получен и обрабатывается.  



## **Разбор заголовков ответа**  

1. **`SIP/2.0 100 Trying`**  
   - **100 Trying** — временный ответ, означающий, что запрос принят и сервер его обрабатывает.  
   - Это стандартный механизм SIP для предотвращения таймаутов, пока сервер выполняет маршрутизацию или другие операции.  

2. **`Via: SIP/2.0/UDP 10.190.9.11:5060;branch=z9hG4bKr6daar6rga6pd983d3r9c7wrp`**  
   - Копируется из исходного **INVITE**, чтобы ответ вернулся по тому же пути.  
   - **branch=...** — уникальный идентификатор транзакции.  

3. **`From: "6899" <sip:6899@10.190.9.11;user=phone>;tag=w7bpl34r`**  
   - Идентификатор вызывающего абонента (**6899**).  
   - **tag=w7bpl34r** — тег диалога, который будет использоваться во всех последующих сообщениях этого вызова.  

4. **`To: 989163640234 <sip:989163640234@10.240.251.218;user=phone>`**  
   - Получатель вызова (**989163640234**).  
   - Пока без **tag**, так как диалог ещё не установлен (он появится в **200 OK**).  

5. **`Call-ID: wgwxpcb3brca6wg34agx9xgg9x7ab6ag@10.190.9.11`**  
   - Уникальный идентификатор вызова, совпадает с **INVITE**.  

6. **`CSeq: 1 INVITE`**  
   - Номер последовательности (1) и метод (**INVITE**).  

7. **`User-Agent: FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~64bit`**  
   - Сервер, обрабатывающий запрос — **FreeSWITCH** (SIP-сервер).  
   - Версия: **1.10.11** (сборка от 17 июня 2024).  

8. **`Content-Length: 0`**  
   - Тело сообщения пустое (у **100 Trying** нет SDP или других данных).  



## **Что означает этот ответ?**  
- Сервер **FreeSWITCH** получил **INVITE** и начал обработку.  
- Следующими ответами могут быть:  
  - **180 Ringing** (если абонент звонит)  
  - **200 OK** (если вызов принят)  
  - **4xx/5xx/6xx** (если ошибка, например, "404 Not Found" или "486 Busy")  

Это стандартный механизм SIP для предотвращения повторных запросов из-за таймаутов.  

-------------------------------------------------
# **Анализ нового SIP INVITE сообщения**

Это новый запрос на установление вызова, но уже в обратном направлении по сравнению с предыдущими сообщениями. Давайте разберем его детально.

## **Ключевые отличия от предыдущего INVITE**
1. **Направление вызова изменено**: теперь вызов идет от `6899@10.240.251.218` к `09163640234@10.190.9.11`
2. **Другой Call-ID**: `f97b2d9d-7393-123e-d88a-005056011a34` (новый вызов)
3. **Другой User-Agent**: тот же FreeSWITCH, но с новыми параметрами
4. **Упрощенный SDP**: только два кодека (PCMA и telephone-event)



## **Разбор SIP-заголовков**

### **1. Основные заголовки**
- **`INVITE sip:09163640234@10.190.9.11 SIP/2.0`**  
  Запрос на установление вызова к `09163640234` на сервере `10.190.9.11`.

- **`Via: SIP/2.0/UDP 10.240.251.218:5202;rport;branch=z9hG4bKKt5eK3rt157jK`**  
  - Транспорт: **UDP**
  - Исходный IP: `10.240.251.218:5202`
  - `rport` — запрос на возврат ответа на этот же порт
  - `branch` — уникальный идентификатор транзакции

- **`Max-Forwards: 68`**  
  Осталось 68 "прыжков" до отмены вызова (уменьшилось на 2 по сравнению с исходным `70`).

- **`From: "6899" <sip:6899@10.240.251.218>;tag=p2Ua0XBKgmKHp`**  
  - Исходящий абонент: **6899**
  - `tag` — идентификатор диалога (новый, не совпадает с предыдущим вызовом).

- **`To: <sip:09163640234@10.190.9.11>`**  
  - Получатель: **09163640234** (без `tag`, так как диалог ещё не установлен).

- **`Call-ID: f97b2d9d-7393-123e-d88a-005056011a34`**  
  Уникальный идентификатор вызова (UUID-формат).

- **`CSeq: 95991208 INVITE`**  
  - Номер последовательности (`95991208`) — очень высокий, возможно, глобальный счётчик.
  - Метод: **INVITE**.


### **2. Технические заголовки**
- **`Contact: <sip:NO_USER@10.240.251.218:5202;transport=udp;gw=4__4>`**  
  - Обратный адрес для ответов (`NO_USER` — возможно, системный вызов).
  - `gw=4__4` — возможно, идентификатор шлюза.

- **`User-Agent: FreeSWITCH-mod_sofia/1.10.11-release+git-20240617T225254Z~22502270fd~64bit`**  
  - Сервер: **FreeSWITCH** (версия от 17.06.2024).

- **`Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, MESSAGE, INFO, UPDATE, REGISTER, REFER, NOTIFY`**  
  Поддерживаемые SIP-методы.

- **`Supported: timer, path, replaces`**  
  - `timer` — поддержка keep-alive.
  - `path` — маршрутизация через прокси.
  - `replaces` — возможность замены диалога.

- **`Remote-Party-ID: "6899" <sip:6899@10.240.251.218>;party=calling;screen=yes;privacy=off`**  
  - Идентификатор вызывающего (`6899`).
  - `screen=yes` — номер проверен.
  - `privacy=off` — номер передаётся открыто.



## **Разбор SDP (Session Description Protocol)**
```
v=0
o=RUNTEL 1741057718 1741057719 IN IP4 10.240.251.218
s=RUNTEL
c=IN IP4 10.240.251.218
t=0 0
m=audio 32206 RTP/AVP 8 101
a=rtpmap:8 PCMA/8000
a=rtpmap:101 telephone-event/8000
a=fmtp:101 0-15
a=ptime:20
```

### **Ключевые параметры SDP**
1. **`o=RUNTEL ...`**  
   - Идентификатор сессии (`RUNTEL` — возможно, имя системы).
   - `10.240.251.218` — источник медиапотока.

2. **`c=IN IP4 10.240.251.218`**  
   - Адрес для RTP-трафика.

3. **`m=audio 32206 RTP/AVP 8 101`**  
   - Аудиопоток на порту **32206**.
   - Поддерживаемые кодеки:  
     - **8 (PCMA)** — G.711 A-law  
     - **101 (telephone-event)** — DTMF-тона (RFC 2833)

4. **`a=ptime:20`**  
   - Длительность пакета: **20 мс** (стандартное значение для VoIP).

-------------------------------------------------
# **Анализ маршрутов в SIP-вызове**

Этот INVITE демонстрирует обратное направление вызова (по сравнению с предыдущими сообщениями). Давайте разберём схему маршрутизации.

## **Топология маршрутов**

```
[Инициатор] 10.240.251.218:5202 (FreeSWITCH) → 10.190.9.11 (Получатель)
```

### **1. Исходная точка (From)**
- **`From: "6899" <sip:6899@10.240.251.218>;tag=p2Ua0XBKgmKHp`**
  - Вызов инициируется с сервера `10.240.251.218` (FreeSWITCH)
  - Внешний идентификатор: номер `6899`
  - `tag` создан сразу (необычно для INVITE, обычно появляется в ответе)

### **2. Назначение (To)**
- **`To: <sip:09163640234@10.190.9.11>`**
  - Вызов направлен напрямую на IP `10.190.9.11`
  - Номер назначения: `09163640234`
  - Отсутствие `tag` означает новый диалог

### **3. Маршрут ответа (Via)**
- **`Via: SIP/2.0/UDP 10.240.251.218:5202;rport;branch=z9hG4bKKt5eK3rt157jK`**
  - Ответы должны идти на `10.240.251.218:5202`
  - `rport` указывает, что ответный порт должен быть тем же (5202)
  - branch — уникальный идентификатор транзакции

### **4. Обратный адрес (Contact)**
- **`Contact: <sip:NO_USER@10.240.251.218:5202;transport=udp;gw=4__4>`**
  - Прямое соединение с шлюзом (`gw=4__4`)
  - `NO_USER` указывает на системный вызов (не пользовательский терминал)

## **Особенности маршрутизации**

1. **Прямая маршрутизация (без прокси)**
   - Нет заголовков `Route` или `Record-Route`
   - Вызов идёт напрямую на `10.190.9.11` (минуя промежуточные серверы)

2. **Асимметричные пути**
   - Исходный вызов: `10.190.9.11 → 10.240.251.218`
   - Обратный вызов: `10.240.251.218 → 10.190.9.11`
   - Это типично для сценариев callback или перевода вызова

3. **Использование разных портов**
   - Исходный вызов: порт `5060` (стандартный SIP)
   - Обратный вызов: порт `5202` (нестандартный, вероятно внутренний интерфейс FreeSWITCH)

## **SDP и медиамаршруты**


c=IN IP4 10.240.251.218
m=audio 32206 RTP/AVP 8 101
```
- Медиапоток пойдёт **напрямую** на `10.240.251.218:32206`
- Используется:
  - Кодек PCMA (G.711 A-law)
  - DTMF через RFC 2833 (телефонные события)

## **Выводы по маршрутизации**

1. **Схема вызова**:
   ```
   [FreeSWITCH:10.240.251.218] → [Устройство:10.190.9.11]
   ```
2. **Тип маршрутизации**: прямая (end-to-end)
3. **Особенности**:
   - Обратное направление относительно предыдущего диалога
   - Использование нестандартного порта 5202
   - Системный вызов (`NO_USER` в Contact)
   - Отсутствие промежуточных прокси

-------------------------------------------------


















