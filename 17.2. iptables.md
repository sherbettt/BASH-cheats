Таблица `iptables` — это мощный инструмент Linux для управления сетевыми пакетами, фильтрации трафика и NAT-трансляций. Давайте разберём её структуру и порядок обработки пакетов.

## Таблицы и цепи

### Основные таблицы (`tables`)

1. **filter**  
   Основная таблица для фильтрации входящего/исходящего трафика.
   
2. **nat**  
   Используется для трансляции адресов (NAT), переадресации портов и изменения исходящих IP-адресов.

3. **mangle**  
   Применяется для модификации полей заголовков пакета (например, TTL, Type of Service).

4. **raw**  
   Специальная таблица для пометки пакетов перед обработкой остальными таблицами.

### Цепочки (`chains`) внутри каждой таблицы

Каждая таблица имеет свою специфику цепей:

#### Таблица filter
- **INPUT**: пакеты, предназначенные локальному хосту (входящие).
- **OUTPUT**: пакеты от локального хоста (исходящие).
- **FORWARD**: транзитные пакеты, проходящие через машину.

#### Таблица nat
- **PREROUTING**: применяется до маршрута принимаемых пакетов (DNAT, изменение целевого адреса).  
- **POSTROUTING**: используется после маршрутизации отправляемых пакетов (SNAT, изменение исходящего адреса).  
- **OUTPUT**: применяется для локально генерируемых пакетов (используется редко).

#### Таблица mangle
- **PREROUTING**: применяемые правила перед маршрутом входящих пакетов.  
- **POSTROUTING**: применяются после маршрутизации исходящих пакетов.  
- **INPUT**, **OUTPUT**, **FORWARD**: используются реже, поскольку чаще всего модификация ограничивается изменениями, касающимися маршрутизации.

## Порядок прохождения цепей для различных типов пакетов

Рассмотрим процесс обработки пакета поэтапно:

### Входящий трафик
1. Интерфейс → Raw → Mangle → Nat (PREROUTING) → Routing decision → Filter (INPUT)
2. Если принятый пакет предназначен для другого интерфейса, добавляется этап: Mangle → Filter (FORWARD) → Nat (POSTROUTING) → Interface.

### Исходящий трафик
1. Local process → Raw → Mangle → Nat (OUTPUT) → Routing decision → Mangle → Nat (POSTROUTING) → Interface.

Таким образом, таблица `mangle`, вместе с таблицей `nat`, участвует в обработке каждого типа пакетов, позволяя изменять различные аспекты сети, такие как QoS (качество обслуживания), журналирование и оптимизацию маршрутов.

---

### Итоги

Итак, структура таблицы выглядит следующим образом:

| Table     | Chains               |
|-----------|----------------------|
| filter    | INPUT, OUTPUT, FORWARD|
| nat       | PREROUTING, POSTROUTING, OUTPUT |
| mangle    | PREROUTING, POSTROUTING, INPUT, OUTPUT, FORWARD |
| raw       | PREROUTING, OUTPUT   |

Порядок прохождения цепей зависит от направления движения пакетов, обеспечивая гибкость и детализированность контроля над сетевым трафиком.

Давайте подробно рассмотрим каждую составляющую схемы обработки сетевых пакетов в Linux с использованием инструмента `iptables`.

## Таблицы и их назначение

1. **Table `filter`:**
   Эта таблица предназначена для основного процесса фильтрации трафика и принятия решений о пропускании или блокировании пакетов. Она обрабатывает три ключевые цепочки:
   - **INPUT:** обработка поступающих пакетов, предназначенных для локальной машины.
   - **OUTPUT:** обработка исходящих пакетов, созданных самой системой.
   - **FORWARD:** обработка транзитных пакетов, проходящих через систему между интерфейсами.

2. **Table `nat`:**
   Использует механизм Network Address Translation (NAT), позволяющий менять IP-адреса и порты. Имеет следующие цепочки:
   - **PREROUTING:** принимает решение до выбора маршрута для входящих пакетов (Destination NAT — DNAT, меняется целевой адрес).
   - **POSTROUTING:** применяется после определения маршрута для исходящих пакетов (Source NAT — SNAT, изменяется исходящий адрес).
   - **OUTPUT:** применяется для пакетов, создаваемых самим сервером (редко используется).

3. **Table `mangle`:**
   Используется для изменения различных свойств пакетов, таких как поля заголовков, маркировка (marking), время жизни (TTL), приоритет и другие. Здесь находятся такие же цепочки, как и в таблице `filter`:
   - **PREROUTING:** для входящих пакетов перед выбором маршрута.
   - **POSTROUTING:** для исходящих пакетов после выбора маршрута.
   - **INPUT:** для поступивших пакетов, которые остаются на данной машине.
   - **OUTPUT:** для пакетов, генерируемых машиной.
   - **FORWARD:** для транзитных пакетов.

4. **Table `raw`:**
   Предназначается для предварительной обработки пакетов до всех остальных таблиц. Её цель — поставить метки на пакеты, влияющие на дальнейшую обработку.

## Последовательность обработки цепей

Чтобы лучше понять весь процесс, давайте представим шаги, которые проходит пакет, начиная с момента поступления на сетевую карту и заканчивая выходом наружу либо доставкой внутрь системы.

### Поступающий пакет ("inbound")
1. Пакет поступает на физический интерфейс устройства.
2. Прежде всего, пакет попадает в таблицу `raw`. Здесь можно добавить специальные отметки (маркировки), используемые позже для дальнейшей обработки.
3. Затем идёт обработка таблицы `mangle`, цепь `PREROUTING`, где возможно изменить некоторые свойства пакета, например TOS или TTL.
4. Далее обрабатывается таблица `nat`, цепь `PREROUTING`. Здесь выполняется Destination NAT (изменение цели назначения пакета), если оно требуется.
5. После этого принимается решение о маршрутизации (Routing Decision):
   - Если пакет направлен на саму машину, он переходит в таблицу `filter`, цепь `INPUT`.
   - Если пакет транзитом направляется дальше, он отправляется на следующую фазу обработки, минуя таблицу `filter`.
6. В конце концов, если это транзитный пакет, он продолжает двигаться дальше:
   - Опять проходит через таблицу `mangle`, цепь `FORWARD`.
   - Затем снова попадает в таблицу `filter`, цепь `FORWARD`.
7. Наконец, пакет выходит через таблицу `nat`, цепь `POSTROUTING`, где производится Source NAT (при необходимости изменений исходящего адреса).
8. Последний этап — выход через интерфейс.

### Исходящий пакет ("outbound")
1. Локальное приложение создаёт пакет и отправляет его в сеть.
2. Сначала пакет попадает в таблицу `raw`, цепь `OUTPUT`, где возможна предварительная отметка пакета.
3. Следующий шаг — таблица `mangle`, цепь `OUTPUT`, где опять-таки возможны небольшие изменения некоторых параметров.
4. Дальше пакет обрабатывается в таблице `nat`, цепь `OUTPUT`, где иногда применяют Source NAT для локальных приложений.
5. Выполняется процедура выбора маршрута (Routing Decision).
6. Теперь наступает очередь таблицы `mangle`, цепь `POSTROUTING`, где ещё раз проверяются и меняются необходимые параметры.
7. Заключительный этап — таблица `nat`, цепь `POSTROUTING`, где осуществляется финальная проверка Source NAT.
8. Затем пакет покидает устройство через нужный интерфейс.

## Детали конкретных цепей

Теперь немного подробнее о каждом этапе:

### Чейн `PREROUTING`
Этот чейн активируется сразу после приёма пакета устройством и перед определением маршрута. Это важный этап, особенно для реализации правил NAT (Destination NAT), которые меняют конечный пункт доставки пакета.

Например, допустим, у вас настроено правило, перенаправляющее входящие запросы на определённый внутренний сервис. Тогда именно здесь определяется новый адрес назначения.

### Чейн `POSTROUTING`
Эта фаза запускается после выбора маршрута и непосредственно перед передачей пакета следующему узлу сети. Обычно на данном этапе применяется Source NAT, когда внешний IP-адрес заменяется внутренним адресом устройства (или наоборот).

Это позволяет отправлять внутренние запросы, скрывая реальный источник трафика, предоставляя возможность прозрачной связи с внешним миром даже из частной сети.

### Таблица `mangle`
Хотя часто этот этап игнорируют, именно тут можно вносить тонкие настройки поведения пакетов. Например, установить маркировку (mark), которая потом позволит применять приоритеты QOS или направлять пакеты по различным каналам в зависимости от нагрузки.

Пример использования — изменение Time To Live (TTL) или установки особых приоритетов для VoIP-трафика.

### Дополнительные моменты
Стоит помнить, что каждый пакет последовательно проходит через несколько этапов обработки, и каждая операция накладывает дополнительные задержки. Поэтому важно аккуратно настраивать правила, минимизируя количество проверок и операций, чтобы избежать ненужных задержек и повышения нагрузки на систему.

---

### Резюме

Процесс обработки сетевых пакетов через систему `iptables` включает прохождение нескольких стадий: сначала выполняется ранняя маркировка, затем определяются маршруты и применяются операции NAT, далее происходят манипуляции с параметрами пакетов и принятие решения о прохождении фильтра. Каждый этап важен и влияет на поведение всей системы, будь то безопасность, производительность или качество сервиса.

----
----

Пример маршрутизации.

Для организации связи между машинами в разных подсетях (192.168.87.0/24 и 192.168.45.0/24) вам нужно настроить маршрутизацию и, возможно, правила iptables. Вот пошаговое решение:

### 1. Настройка маршрутизации на Proxmox (192.168.87.20):

Proxmox должен выступать в качестве шлюза для подсети 192.168.45.0/24.

```bash
# Добавить маршрут (временно)
ip route add 192.168.45.0/24 dev pgnet

# Для постоянного сохранения (Debian-based системы):
echo "192.168.45.0/24 dev pgnet" >> /etc/network/interfaces.d/pgnet
```

### 2. Настройка iptables на Proxmox для NAT (если нужно):

Если вам нужен доступ из 192.168.87.0/24 в 192.168.45.0/24, включите форвардинг и настройте NAT:

```bash
# Включить IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# Добавить правила iptables
iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o vmbr0 -j MASQUERADE
iptables -A FORWARD -i pgnet -o vmbr0 -j ACCEPT
iptables -A FORWARD -i vmbr0 -o pgnet -m state --state RELATED,ESTABLISHED -j ACCEPT

# Сохранить правила (для Debian-based)
apt install iptables-persistent
netfilter-persistent save
```

### 3. Настройка маршрута на ноутбуке (192.168.87.135):

```bash
# Добавить маршрут (временно)
sudo ip route add 192.168.45.0/24 via 192.168.87.20

# Для постоянного сохранения (зависит от дистрибутива):
# Для систем с NetworkManager:
nmcli connection modify "your-connection-name" +ipv4.routes "192.168.45.0/24 192.168.87.20"

# Или в /etc/network/interfaces:
# up ip route add 192.168.45.0/24 via 192.168.87.20
```

### 4. Настройка виртуальной машины (192.168.45.201):

Убедитесь, что у VM правильный шлюз:
```bash
ip route show
# Должно быть что-то вроде:
# default via 192.168.45.1 dev eth0
# 192.168.45.0/24 dev eth0 proto kernel scope link src 192.168.45.201
```

### 5. Проверка связи:

С ноутбука попробуйте:
```bash
ping 192.168.45.201
```

### Важные замечания:

1. Ваш текущий маршрут на ноутбуке `192.168.45.0/24 via 192.168.87.1` неверный - он должен вести через Proxmox (192.168.87.20)

2. На Proxmox интерфейс pgnet не имеет IPv4 адреса, что может вызвать проблемы. Возможно, стоит назначить ему адрес:
```bash
ip addr add 192.168.45.1/24 dev pgnet
```

3. Если используется firewalld/ufw, нужно добавить соответствующие правила.

4. Для постоянного сохранения настроек на Proxmox, добавьте их в `/etc/network/interfaces` в конфигурацию pgnet.
