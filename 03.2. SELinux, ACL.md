SELinux (Security Enhanced Linux) — это система мандатного контроля доступа (MAC), предназначенная для повышения безопасности операционной системы Linux путем ограничения привилегий процессов и пользователей. Она обеспечивает дополнительный уровень защиты помимо стандартных разрешений UNIX.

ACL (Access Control Lists) в контексте SELinux позволяют устанавливать дополнительные разрешения на файлы и каталоги, расширяя стандартные права владельца/группы/доступа всех остальных. Вот как правильно настроить и управлять файлами и директориями с использованием SELinux и ACL:

### Основные понятия

1. **Контекст файлов**: Каждый файл и каталог имеет метаданные SELinux, называемые контекстом файла. Контекст состоит из трех частей: user, role и type. Например, `system_u:object_r:httpd_sys_content_t:s0`.
   
2. **Типы файлов**: Тип определяет, каким образом процессы могут взаимодействовать с данным объектом. Для веб-серверов часто используется тип `httpd_sys_content_t`, позволяющий Apache/Nginx читать файлы сайта.

3. **Политики**: Политика SELinux контролирует взаимодействие между процессами и объектами. Существует два основных режима политики:
   - Enforcing (принудителеный режим)
   - Permissive (разрешающий режим).

### Работа с контекстами файлов

#### Просмотр текущего контекста файла
```bash
ls -Z /path/to/file
```
Пример вывода:
```
-rw-r--r--. root root system_u:object_r:httpd_sys_content_t:s0 file.txt
```

#### Изменение типа файла
Чтобы изменить тип файла вручную, используй команду `chcon`:
```bash
sudo chcon -t httpd_sys_content_t /var/www/html/index.html
```

Однако лучше использовать утилиту `semanage fcontext`, чтобы добавить правило, которое автоматически применит нужный контекст после перезагрузки или смены типов файлов:
```bash
sudo semanage fcontext -a -t httpd_sys_content_t "/var/www/html(/.*)?"
sudo restorecon -vR /var/www/html
```

#### Проверка статуса SELinux
Проверь состояние SELinux командой:
```bash
sestatus
```
Это покажет текущий режим (`enforcing`, `permissive`) и установленную политику.

### Управление политиками

#### Переход в разрешительный режим
Для временного отключения ограничений SELinux перейдите в разрешительный режим:
```bash
setenforce 0
```
или установите этот режим постоянно, отредактировав `/etc/selinux/config`:
```ini
SELINUX=permissive
```

**Внимание:** Постоянная работа в режиме permissive снижает безопасность вашей системы!

#### Возвращение в принудительный режим
Вернуть принудительный режим можно командами:
```bash
setenforce 1
```
или аналогично отредактируйте конфигурационный файл:
```ini
SELINUX=enforcing
```

### Использование Access Control List (ACL)

Стандартные права UNIX ограничены тремя группами (владелец, группа, другие). Если нужны более гибкие настройки прав, используются ACL.

#### Добавление ACL-прав
Например, предоставим группе www-data доступ на запись к папке `/var/www/uploads`:
```bash
sudo setfacl -m g:www-data:rwx /var/www/uploads
```

Проверяем установленные ACL:
```bash
getfacl /var/www/uploads
```

Удалить ACL можно следующим образом:
```bash
sudo setfacl -x g:www-data /var/www/uploads
```

### Совместимость SELinux и ACL

Важно помнить, что SELinux проверяет свои правила независимо от обычных прав и ACL. Даже если установлены нужные ACL-права, SELinux может запретить доступ, если политика этого требует.

Поэтому важно согласовать оба механизма:
- Настройте правильный контекст файла через `chcon` или `semanage fcontext`
- Используйте ACL для детализированного управления правами пользователей и групп.

Таким образом, правильное использование SELinux и ACL позволяет значительно повысить защиту ваших серверов и приложений, минимизируя риск несанкционированного доступа.

-----------------------------
