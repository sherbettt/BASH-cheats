Есть Ubuntu подобный роутер. На нём три интерфейса:
<br/> eth0 - 192.168.87.112 (смотрит в интернет), шлюз: 192.168.87.1;
<br/> eth1 - 192.168.56.1 (не смотрит в интернет, для связи с машинами);
<br/> eth2 - 192.168.96.113 (смотрит в интернет), шлюз: 192.168.96.1

Также есть две другие Ubuntu машины, подключённые к выше указанном роутеру с адресами:192.168.56.2/24; 192.168.56.3/24

Как настроить соединение NAT для машин при помощи команды ip route, 
<br/> чтобы они смотрели в интернет:192.168.56.2 -> 192.168.56.1 -> 192.168.87.112 (шлюз 192.168.87.1);192.168.56.3 -> 192.168.56.1 -> 192.168.96.113 (шлюз 192.168.96.1);

Для настройки NAT и маршрутизации на Ubuntu-роутере, чтобы машины `192.168.56.2` и `192.168.56.3` выходили в интернет через разные внешние интерфейсы, выполните следующие шаги:

### 1. Включите форвардинг пакетов:
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```
(Чтобы изменения сохранились после перезагрузки, добавьте в `/etc/sysctl.conf` строку `net.ipv4.ip_forward=1`.)

### 2. Настройте NAT для каждой внутренней машины:
#### Для `192.168.56.2` (через `eth0`):
```bash
iptables -t nat -A POSTROUTING -s 192.168.56.2 -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth1 -o eth0 -s 192.168.56.2 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -d 192.168.56.2 -j ACCEPT
```

#### Для `192.168.56.3` (через `eth2`):
```bash
iptables -t nat -A POSTROUTING -s 192.168.56.3 -o eth2 -j MASQUERADE
iptables -A FORWARD -i eth1 -o eth2 -s 192.168.56.3 -j ACCEPT
iptables -A FORWARD -i eth2 -o eth1 -d 192.168.56.3 -j ACCEPT
```

### 3. Настройте маршрутизацию на роутере:
Создайте отдельные таблицы маршрутизации для каждой машины.

#### Для `192.168.56.2`:
```bash
echo "100 eth0_table" >> /etc/iproute2/rt_tables
ip rule add from 192.168.56.2 lookup eth0_table
ip route add default via 192.168.87.1 dev eth0 table eth0_table
```

#### Для `192.168.56.3`:
```bash
echo "200 eth2_table" >> /etc/iproute2/rt_tables
ip rule add from 192.168.56.3 lookup eth2_table
ip route add default via 192.168.96.1 dev eth2 table eth2_table
```

### 4. Настройте маршруты на клиентских машинах:
#### На `192.168.56.2`:
```bash
ip r a 192.168.87.0/24 via 192.168.56.1
ip route add default via 192.168.56.1
```

#### На `192.168.56.3`:
```bash
ip r a 192.168.96.0/24 via 192.168.56.1
ip route add default via 192.168.56.1
```

### Проверка:
- Убедитесь, что трафик с `192.168.56.2` идет через `eth0`:
  ```bash
  traceroute 8.8.8.8
  ```
  Должен проходить через `192.168.87.1`.

- Убедитесь, что трафик с `192.168.56.3` идет через `eth2`:
  ```bash
  traceroute 8.8.8.8
  ```
  Должен проходить через `192.168.96.1`.

### Примечание:
Если нужно сохранить правила `iptables`, установите пакет `iptables-persistent`:
```bash
apt install iptables-persistent
netfilter-persistent save
```
