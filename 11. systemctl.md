### § Управление службами Linux
([Управление службами Linux](https://losst.pro/upravlenie-sluzhbami-linux))
([Управление процессом загрузки](https://rh.schelcol.ru/curse%202/ch10s03.html))

Цель **systemd** — это набор юнитов systemd, которые должны быть активированы, чтобы достичь нужного состояния системы. Наиболее важные из этих целей приведены в таблице ниже.
<br/> **graphical.target** - Система будет запущена в многопользовательском режиме, вход возможен через графический экран или текстовую консоль.
<br/> **multi-user.target** - Система будет запущена в многопользовательском режиме, вход возможен только через текстовую консоль.
<br/> **rescue.target** - Приглашение sulogin; базовая настройка и запуск системы выполнены.
<br/> **emergency.target** - Приглашение sulogin; переключение initramfs выполнено; корневая система смонтирована в / в режиме «только чтение».

- Список доступных типов юнитов
  <br/> `systemctl -t help`
- Список всех юнитов по типу target
  <br/> `systemctl -t target --all`
- Список зависимостей юнитов по типу target
  <br/> `systemctl list-dependencies graphical.target | grep target`
  <br/> `systemctl list-dependencies --type=service --all`
  <br/> `systemctl list-dependencies sshd.service`
- Список заданий
  <br/> `systemctl list-jobs`
- Просмотр отчётов о производительности системы
  <br/> `systemd-analyze`
- Отображение списка доступных целей
  <br/> `systemctl list-units --type=target --all`
  <br/> `systemctl list-units --type=service --all`
- Узнать режим, какой юнит по умолчанию
  <br/> `systemctl get-default`
- Переключение между графическим и многопользовательским режимами
  <br/> `systemctl isolate multi-user.target`
  <br/> `systemctl isolate graphical.target`
- Установить по умолчанию режим
  <br/> `systemctl set-default graphical.target`
  <br/> `systemctl set-default multi-user.target`
- Перезагрузка всех служб
  <br/> `systemctl daemon-reload`


```c
systemctl list-unit-files --type=service  # посмотреть список файлов конфигурации сервисных юнитов
systemctl list-unit-files --type=target  # посмотреть список файлов конфигурации целевых юнитов
systemctl list-unit-files --type=service | grep -v disabled  # список все включённых служб
systemctl show --property "Wants" multi-user.target  # активация целевого юнита
systemctl show --property "Requires" multi-user.target  # юниты для нормальной работы
service --status-all
```

Не все цели можно изолировать. Можно изолировать только те цели, в файлах юнитах которых задана переменная *AllowIsolate=yes*. Например, можно изолировать цель *graphical*, но не цель *cryptsetup*, узнать можно с помощью `systemctl cat graphical.target`

#### Выбор другой цели во время загрузки
  1. Загрузите или перезагрузите систему.
  2. Прервите обратный отсчет загрузчика, нажав любую клавишу, кроме Enter (ее нажатие приведет к обычной загрузке).
  3. Установите курсор на запись ядра, которое требуется загрузить.
  4. Нажмите **e** для редактирования текущей записи.
  5. Установите курсор на строку, начинающуюся с **linux**. Это командная строка ядра.
  6. Добавьте `systemd.unit=target.target`. Пример: `systemd.unit=emergency.target`.
  7. Нажмите **Ctrl+x**, чтобы выполнить загрузку с учетом изменений.

#### Сброс пароля root из загрузчика
  1. Загрузите или перезагрузите систему.
  2. Прервите обратный отсчет загрузчика, нажав любую клавишу, кроме Enter (ее нажатие приведет к обычной загрузке).
  3. Установите курсор на запись ядра, которое требуется загрузить.
  4. Нажмите **e** для редактирования текущей записи.
  5. Установите курсор на строку, начинающуюся с **linux**. Это командная строка ядра.
  6. Добавьте `rd.break`. С этой опцией система приостанавливает работу перед передачей управления от *initramfs* фактической системе.
  7. Нажмите **Ctrl+x**, чтобы выполнить загрузку с учетом изменений.

<br/> Система еще не включила SELinux, создаваемые вами файлы не имеют контекста SELinux. Некоторые утилиты (например, команда passwd) сначала создают временный файл, а затем заменяют им файл, который необходимо отредактировать, создавая новый файл без контекста SELinux. Поэтому, когда вы используете команду passwd с опцией rd.break, файл /etc/shadow не получает контекст SELinux.

<br/> В этот момент система открывает командную оболочку root, а фактическая корневая файловая система монтируется в режиме **«только чтение»** в **/sysroot**. Поскольку для устранения проблем часто требуется изменение корневой файловой системы, необходимо перевести ее в режим **«чтение/запись»**. 
  1. Перемонтировать **/sysroot** в режим rw: 
    <br/> `switch_root:/# mount -o remount,rw /sysroot`
  2. Переключиться на chroot jail, где **/sysroot** используется как корень дерева файловой системы: 
    <br/> `switch_root:/# chroot /sysroot`
  3. Задать новый пароль root: 
    <br/> `sh-4.4# passwd root`
  4. Убедиться, что все файлы без меток (в том числе /etc/shadow) получают метки во время загрузки: 
    <br/> `sh-4.4# touch /.autorelabel`
  5. Дваждый ввести **exit**, система продолжит загрузку, выполнит переустановку меток SELinux, а затем снова перезагрузится.








При использовании аварийной оболочки пользоваться systemctl daemon-reload после редактирования файла /etc/fstab
Опция nofail в записи в файле /etc/fstab позволяет системе загрузиться, даже если эта файловая система не была смонтирована




